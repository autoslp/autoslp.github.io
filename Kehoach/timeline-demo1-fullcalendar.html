<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Demo 1 - FullCalendar (Start→End)</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
  <style>
    body{font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial,sans-serif;background:#f6f8fb}
    .fc .fc-toolbar-title{font-weight:800}
  </style>
</head>
<body class="p-3">
  <div class="container-fluid">
    <h5 class="mb-3">Demo 1 - FullCalendar timeline lệnh (Ngày xuống → Ngày giao)</h5>
    <div id="calendar"></div>
  </div>

  <script>
    const GOOGLE_API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
    const SPREADSHEET_ID = '1UuIKiW0soNDv2U08HMhiuTn_Kxrzxlj_Z7GXK7ZM6Ic';

    function parseAnyDate(value){ if(!value) return null; if(/^\d{4}-\d{2}-\d{2}$/.test(value)){const d=new Date(value+'T00:00:00');return isNaN(d)?null:d;} if(/^\d{2}\/\d{2}\/\d{4}$/.test(value)){const [dd,mm,yyyy]=value.split('/').map(Number);const d=new Date(yyyy,mm-1,dd);return isNaN(d)?null:d;} const d=new Date(value); return isNaN(d)?null:d; }
    function toISO(d){ if(!(d instanceof Date)||isNaN(d)) return ''; const dd=String(d.getDate()).padStart(2,'0'); const mm=String(d.getMonth()+1).padStart(2,'0'); const yyyy=String(d.getFullYear()); return `${yyyy}-${mm}-${dd}`; }
    function pct(s){ if(!s) return null; const n=parseFloat(String(s).replace('%','').replace(',', '.')); return isNaN(n)?null:n; }

    async function loadEvents(){
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/4.%20Nhập%20Xuất%20Tồn!A8:AJ?key=${GOOGLE_API_KEY}`;
      const res = await fetch(url); const js = await res.json(); if(!js.values) return [];
      const rows = js.values.slice(1); const map={};
      rows.forEach(r=>{
        if(r.length<36) return; const po=r[34]||''; if(!po) return;
        const lenh=r[0]||''; const loai=(r[1]||'').trim(); const title = loai? `${lenh} (${loai})` : lenh;
        const ten=r[3]||''; const giao=parseAnyDate(r[35]||''); const xuong=parseAnyDate(r[26]||'');
        const tt=pct(r[20]); const cp=pct(r[21]);
        if(!map[po]) map[po]={po, ten, xuong, giao, events:[] , tt, cp};
        map[po].events.push(title);
        if(xuong && (!map[po].xuong || xuong<map[po].xuong)) map[po].xuong=xuong;
        if(giao && (!map[po].giao || giao<map[po].giao)) map[po].giao=giao;
      });
      const todayISO = toISO(new Date());
      const events = Object.values(map).map(it=>{
        let color='#60a5fa'; const days = it.giao? Math.round((new Date(toISO(it.giao)+'T00:00:00')-new Date(todayISO+'T00:00:00'))/(24*60*60*1000)) : 9999;
        if(it.tt>0 && it.cp>0 && it.tt>it.cp) color='#86c5ff';
        if(days<=2) color='#fb7185'; else if(days<=5) color='#fbbf24';
        return { title: `${it.po} - ${it.events.join('; ')}`, start: toISO(it.xuong||it.giao||new Date()), end: it.giao? toISO(it.giao) : toISO(it.xuong||new Date()), allDay:true, color };
      });
      return events;
    }

    document.addEventListener('DOMContentLoaded', async function() {
      const calendarEl = document.getElementById('calendar');
      const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'thirtyDay',
        views: {
          thirtyDay: { type: 'dayGrid', duration: { days: 30 }, buttonText: '30 ngày' }
        },
        headerToolbar: { left:'prev,next today', center:'title', right:'thirtyDay,dayGridMonth,timeGridWeek,timeGridDay,listMonth' },
        height: 'auto',
        events: await loadEvents(),
        eventClick: function(info){ alert(info.event.title); }
      });
      calendar.render();
    });
  </script>
</body>
</html>

