<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Nhập Xuất Tồn - Google Sheets</title>
     <!-- Bootstrap CSS -->
     <link href="https://api.autoslp.com/css/bootstrap.min.css" rel="stylesheet" />
     <link href="https://api.autoslp.com/css/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js (không sử dụng) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --aside-w: 74px;
            --bg: #f5f7fb;
            --card-bg: #ffffff;
            --border: #eef1f6;
            --text: #0f172a;
            --muted: #6b7280;
            --primary: #2b6ef2;
            --primary-100: #eef6ff;
            --success: #16a34a;
            --danger: #ef4444;
        }
        html, body { height: 100%; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        .hidden { display: none; }

        /* Layout */
        .app { display: grid; grid-template-columns: var(--aside-w) 1fr; min-height: 100vh; }
        .aside {
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            padding-top: 16px;
        }
        .aside .nav-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: grid; place-items: center;
            color: var(--muted);
            margin: 10px auto; cursor: pointer;
            transition: all .15s ease;
        }
        .aside .nav-icon.active, .aside .nav-icon:hover {
            background: var(--primary-100);
            color: var(--primary);
        }

        .topbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .topbar .input-group-text { background: #f3f6fb; border-color: #e9eef6; }
        .topbar input.form-control { border-color: #e9eef6; background: #f9fbff; }

        /* Cards */
        .hero-card, .kpi-card, .panel {
            border: 0; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15,23,42,0.04), 0 2px 8px rgba(15,23,42,0.06);
            background: var(--card-bg);
        }

        .metric { font-weight: 800; font-size: 1.35rem; letter-spacing: -0.02em; }
        .muted { color: var(--muted); }

        /* Soft badges & chips */
        .badge-soft { background: #eef2ff; color: var(--primary); border-radius: 999px; padding: .25rem .6rem; font-weight: 600; }
        .chip { background: var(--primary-100); color: var(--primary); border-radius: 10px; padding: .25rem .5rem; font-weight: 600; font-size: .8rem; }

        /* Table */
        .table { --bs-table-bg: transparent; }
        .table thead th { font-size: 11px; text-transform: none; color: #6b7280; letter-spacing: .02em; border-bottom-color: var(--border); }
        .table-hover tbody tr:hover { background: #f8fbff; }
        .table-responsive { border-radius: 12px; }
        .table thead { position: sticky; top: 0; z-index: 1; background: var(--card-bg); }
        /* PO column max width */
        #dataTable th:nth-child(2),
        #dataTable td:nth-child(2) { max-width:130px; width:130px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(4),
        #dataTable td:nth-child(4) { max-width:300px; width:300px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(9),
        #dataTable td:nth-child(9) { max-width:120px; width:120px; white-space: normal; word-break: break-word; }

        /* Buttons */
        .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 6px 12px rgba(43,110,242,.18); }
        .btn-primary:hover { filter: brightness(.95); }
        .btn-outline-secondary { border-color: #e4e8f0; color: #344256; }

        /* Utilities */
        .vr { border-left: 1px solid var(--border); height: 24px; }

        /* Mini progress (for Tiến độ) */
        .progress-mini { height: 6px; background: #eef2f7; border-radius: 8px; overflow: hidden; }
        .progress-mini .bar { height: 100%; border-radius: 8px; transition: width .3s ease; }
        .bar-success { background: #19c2a0; }
        .bar-warning { background: #f3ad2e; }
        .bar-danger { background: #f27b9b; }

        /* Pill badge for Đóng lệnh */
        .pill { display:inline-block; padding:.25rem .7rem; border-radius:999px; font-weight:600; font-size:.85rem; }
        .pill-closed { background:#d1fae5; color:#0f766e; }

        /* Dots */
        .dot { display:inline-block; width:8px; height:8px; border-radius:50%; }
        .dot-red { background:#f27b9b; }
        .dot-green { background:#19c2a0; }
        .text-good { color:#19c2a0;  }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="aside d-flex flex-column align-items-center">
            <div class="nav-icon active" title="Dashboard"><i class="bi bi-columns-gap"></i></div>
            <div class="nav-icon" title="Orders"><i class="bi bi-bag"></i></div>
            <div class="nav-icon" title="Customers"><i class="bi bi-people"></i></div>
            <div class="nav-icon" title="Reports"><i class="bi bi-graph-up"></i></div>
            <div class="mt-auto mb-3 nav-icon" title="Settings"><i class="bi bi-gear"></i></div>
        </aside>

        <!-- Main -->
        <main class="main bg-light">
            <!-- Topbar -->
            <div class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button id="loadDataBtn" class="btn btn-primary"><i class="bi bi-arrow-repeat me-1"></i>Tải dữ liệu</button>
                    <button id="refreshBtn" class="btn btn-outline-secondary">Làm mới</button>
                    <div class="vr d-none d-md-block"></div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="filterPO" type="text" class="form-control" placeholder="Lọc PO...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 260px;">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <input id="startDate" type="date" class="form-control">
                        <input id="endDate" type="date" class="form-control">
                    </div>
                    <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary">Xóa lọc</button>
                    <button id="exportCsvBtn" class="btn btn-sm btn-success"><i class="bi bi-file-earmark-arrow-down me-1"></i>Export CSV</button>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-bell"></i>
                    <i class="bi bi-person-circle fs-4"></i>
                </div>
            </div>

            <!-- Content -->
            <div class="container-fluid py-3">
                <!-- Hero card -->
                <div class="card hero-card mb-3">
                    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <div>
                            <h5 class="mb-1">Chúc mừng bạn!</h5>
                            <div class="muted">Bạn đã hoàn thành báo cáo tồn kho hôm nay</div>
                        </div>
                        <div class="text-end">
                            <div class="muted small">Cập nhật gần nhất</div>
                            <div class="fw-semibold" id="lastUpdated">--:--</div>
                        </div>
                    </div>
                </div>

                <!-- KPI row -->
                <div id="summaryCards" class="row g-3 hidden">
                    <div class="col-12 col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <div class="muted small">Tổng Nhập Kho</div>
                                <div class="metric" id="totalNhap">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <div class="muted small">Tổng SL Triển Khai</div>
                                <div class="metric" id="totalXuat">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-4">
                        <div class="card kpi-card">
                            <div class="card-body">
                                <div class="muted small">Tổng SL Sản Xuất</div>
                                <div class="metric" id="totalTon">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table panel -->
                <div id="tableContainer" class="card panel mt-3 hidden">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-hover align-middle mb-0">
                                <thead style="font-size: 12px!important;" class="table-light">
                                    <tr>
                                        <th>STT</th>
                                        <th>PO</th>
                                        <th>Lệnh Sản Xuất</th>
                                        <th>Thông tin</th>
                                        <th>Triển Khai
                                              (pcs)
                                        </th>
                                        <th>Sản Xuất
                                            (pcs)
                                        </th>
                                        <th>Nhập Kho
                                            (pcs)
                                        </th>
                                        <th>Ngày
                                            Xuống Lệnh</th>
                                        <th>Hao phí</th>
                                        <th>Tỷ lệ nhập kho</th>
                                        <th>Tiến độ</th>
                                        <th>Đóng lệnh</th>
                                    </tr>
                                </thead>
                                <tbody style="font-size: 12px;" id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Không cần Google API Scripts nữa vì sử dụng fetch trực tiếp -->
    <!-- Bootstrap JS Bundle -->
    <script src="https://api.autoslp.com/css/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD1Cj6j6c6b9l+8nt1pV0r1jDD6whzFZC+NcIb2FG+" crossorigin="anonymous"></script>
    <!-- Chart.js (không sử dụng, giữ guard nếu sau dùng) -->
    <script>
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not found from custom CDN, attempting fallback...');
        var s = document.createElement('script');
        s.src = 'https://api.autoslp.com/css/chart.js';
        document.head.appendChild(s);
      }
    </script>

    <script>
        // Cấu hình Google API
        const GOOGLE_API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
        // Sheet ID của bạn (sẽ được cập nhật sau khi tạo Data Bridge Sheet)
        const SPREADSHEET_ID = '1UuIKiW0soNDv2U08HMhiuTn_Kxrzxlj_Z7GXK7ZM6Ic';

        // DOM Elements
        const loadDataBtn = document.getElementById('loadDataBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const summaryCards = document.getElementById('summaryCards');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const totalNhap = document.getElementById('totalNhap');
        const totalXuat = document.getElementById('totalXuat');
        const totalTon = document.getElementById('totalTon');
        let autoRefreshTimer = null;
        let isLoading = false;

        // Utils: parse and format dates
        function parseAnyDate(value) {
            if (!value) return null;
            // Accept formats: YYYY-MM-DD, DD/MM/YYYY
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                const d = new Date(value + 'T00:00:00');
                return isNaN(d.getTime()) ? null : d;
            }
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                const [dd, mm, yyyy] = value.split('/').map(Number);
                const d = new Date(yyyy, mm - 1, dd);
                return isNaN(d.getTime()) ? null : d;
            }
            const d = new Date(value);
            return isNaN(d.getTime()) ? null : d;
        }
        function formatDateDDMMYYYY(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${dd}/${mm}/${yyyy}`;
        }
        function toISODate(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${yyyy}-${mm}-${dd}`;
        }
        function parsePercent(value) {
            if (value === undefined || value === null || value === '') return null;
            const n = parseFloat(String(value).toString().replace('%','').trim());
            if (isNaN(n)) return null;
            return n <= 1 ? n * 100 : n;
        }
        function formatPercent(n) {
            if (n === null || n === undefined || isNaN(n)) return '';
            const v = Math.round(n * 10) / 10; // 1 decimal
            return `${v}%`;
        }

        // Khởi tạo ứng dụng
        function initializeApp() {
            // Set default date range: last 30 days
            const endInput = document.getElementById('endDate');
            const startInput = document.getElementById('startDate');
            const now = new Date();
            const last30 = new Date(now);
            last30.setDate(now.getDate() - 30);
            if (startInput) startInput.value = toISODate(last30);
            if (endInput) endInput.value = toISODate(now);

            // Tải ngay và thiết lập tự động làm mới mỗi 50 giây
            loadData();
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                loadData();
            }, 50000);
        }

        // Tải dữ liệu từ Google Sheets (Data Bridge Sheet)
        async function loadData() {
            if (isLoading) return; // tránh gọi chồng
            isLoading = true;
            
            try {
                // Sử dụng API trực tiếp với sheet của bạn
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/4.%20Nhập%20Xuất%20Tồn!A8:AI?key=${GOOGLE_API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) return;

                // Xử lý dữ liệu
                processData(data.values);
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
            finally {
                isLoading = false;
            }
        }

        // Xử lý dữ liệu theo cấu trúc mới - gộp theo PO
        function processData(values) {
            console.log('Dữ liệu nhận được:', values);
            
            // Dữ liệu từ dòng A8:AI (dòng đầu tiên là header)
            const data = values.slice(1); // Bỏ qua dòng header
            
            // Object để gộp dữ liệu theo PO
            const groupedData = {};
            
            data.forEach((row, index) => {
                if (row.length < 35) return; // Bỏ qua dòng không đủ cột (cần đến cột AI)
                
                // Mapping theo yêu cầu mới:
                const po = row[34] || '';                    // AI (Số PO)
                const maCode = row[2] || '';                 // C (Mã code SP)
                const tenSanPham = row[3] || '';             // D (Tên sản phẩm)
                const khachHang = row[7] || '';              // H (Khách hàng)
                const lenhSanXuat = row[0] || '';            // A (Lệnh sản xuất)
                const loaiLenh = (row[1] || '').trim();      // B (Loại lệnh)
                const soLuongCanTrienKhai = parseFloat(row[5]) || 0;  // F (SL triển khai)
                const soLuongSanXuat = parseFloat(row[6]) || 0;       // G (SL Cần SX)
                const nhapKho = parseFloat(row[14]) || 0;             // O (NHẬP KHO)
                const tyLeNhapKhoVal = parsePercent(row[18]);         // S (Tỷ lệ nhập kho)
                const haoPhiThucTeVal = parsePercent(row[20]);        // U (Hao phí thực tế)
                const haoPhiChoPhepVal = parsePercent(row[21]);       // V (Hao phí cho phép)
                const ngayXuongLenhRaw = row[26] || '';      // AA (Ngày xuống lệnh)
                const ngayDate = parseAnyDate(ngayXuongLenhRaw);
                const ngayISO = ngayDate ? toISODate(ngayDate) : '';
                const ngayDisplay = ngayDate ? formatDateDDMMYYYY(ngayDate) : '';
                
                // Nếu PO chưa tồn tại, tạo mới
                if (!groupedData[po]) {
                    groupedData[po] = {
                        po: po,
                        lenhSanXuat: [],
                        maCode: maCode,
                        tenSanPham: tenSanPham,
                        khachHang: khachHang,
                        soLuongCanTrienKhai: 0,
                        soLuongSanXuat: 0,
                        nhapKho: 0,
                        ngayISO: ngayISO,
                        ngayDisplay: ngayDisplay,
                        haoPhiThucTe: null,
                        haoPhiChoPhep: null,
                        tyLeNhapKho: null
                    };
                }
                
                // Gộp dữ liệu
                const lenhHienThi = loaiLenh ? `${lenhSanXuat} ( ${loaiLenh} )` : `${lenhSanXuat}`;
                groupedData[po].lenhSanXuat.push(lenhHienThi);
                // Cập nhật thông tin mô tả (giữ thông tin đầu tiên nếu đã có)
                if (!groupedData[po].maCode && maCode) groupedData[po].maCode = maCode;
                if (!groupedData[po].tenSanPham && tenSanPham) groupedData[po].tenSanPham = tenSanPham;
                if (!groupedData[po].khachHang && khachHang) groupedData[po].khachHang = khachHang;
                groupedData[po].soLuongCanTrienKhai += soLuongCanTrienKhai;
                groupedData[po].soLuongSanXuat += soLuongSanXuat;
                groupedData[po].nhapKho += nhapKho;
                // Giữ ngày sớm nhất nếu có nhiều bản ghi
                if (ngayISO) {
                    if (!groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    } else if (ngayISO < groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    }
                }
                // Hao phí & tỷ lệ nhập kho (ưu tiên giá trị lớn nhất hợp lệ)
                if (haoPhiThucTeVal !== null) {
                    groupedData[po].haoPhiThucTe = groupedData[po].haoPhiThucTe === null ? haoPhiThucTeVal : Math.max(groupedData[po].haoPhiThucTe, haoPhiThucTeVal);
                }
                if (haoPhiChoPhepVal !== null) {
                    groupedData[po].haoPhiChoPhep = groupedData[po].haoPhiChoPhep === null ? haoPhiChoPhepVal : Math.max(groupedData[po].haoPhiChoPhep, haoPhiChoPhepVal);
                }
                if (tyLeNhapKhoVal !== null) {
                    groupedData[po].tyLeNhapKho = groupedData[po].tyLeNhapKho === null ? tyLeNhapKhoVal : Math.max(groupedData[po].tyLeNhapKho, tyLeNhapKhoVal);
                }
            });
            
            // Chuyển đổi object thành array và sắp xếp
            let processedData = Object.values(groupedData).filter(item => item.po !== '');
            
            let totalNhapValue = 0;
            let totalXuatValue = 0;
            let totalTonValue = 0;
            
            // Xóa dữ liệu cũ
            tableBody.innerHTML = '';
            
            const poFilter = (document.getElementById('filterPO')?.value || '').trim().toLowerCase();
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Lọc theo PO và khoảng ngày
            if (poFilter) {
                processedData = processedData.filter(i => (i.po || '').toLowerCase().includes(poFilter));
            }
            if (startDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO >= startDate);
            }
            if (endDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO <= endDate);
            }

            processedData.forEach((item, index) => {
                // Tính tổng cho summary
                totalNhapValue += item.nhapKho;
                totalXuatValue += item.soLuongCanTrienKhai;
                totalTonValue += item.soLuongSanXuat;
                
                // Tạo dòng bảng
                const tr = document.createElement('tr');
                const progress = item.soLuongCanTrienKhai > 0 ? Math.min(100, Math.round((item.nhapKho / item.soLuongCanTrienKhai) * 100)) : 0;
                const barClass = progress >= 80 ? 'bar-success' : (progress >= 30 ? 'bar-warning' : 'bar-danger');
                const isClosed = progress >= 100;
                const tyLeNhapKhoTxt = formatPercent(item.tyLeNhapKho);
                const tyLeNhapKhoHtml = item.tyLeNhapKho !== null && item.tyLeNhapKho >= 100 ? `<span class="text-good">${tyLeNhapKhoTxt}</span>` : `${tyLeNhapKhoTxt || ''}`;
                const haoThucTe = item.haoPhiThucTe;
                const haoChoPhep = item.haoPhiChoPhep;
                const hpDotClass = (haoThucTe !== null && haoChoPhep !== null && haoThucTe > haoChoPhep) ? 'dot-red' : 'dot-green';
                const haoPhiHtml = `
                    <div>
                        <div><span class="dot ${hpDotClass}"></span> ${formatPercent(haoThucTe) || ''} <span class="text-muted small">(thực tế)</span></div>
                        <div>${formatPercent(haoChoPhep) || ''} <span class="text-muted small">(cho phép)</span></div>
                    </div>`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="fw-semibold">${item.po}</div>
                        <div style="font-size: 8px;" class="text-muted">${item.maCode || ''}</div>
                    </td>
                    <td>${item.lenhSanXuat.join('<br>')}</td>
                    <td>
                        <div class="fw-semibold">${item.tenSanPham || ''}</div>
                        <div class="text-muted">${item.khachHang || ''}</div>
                    </td>
                    <td>${item.soLuongCanTrienKhai.toLocaleString()}</td>
                    <td>${item.soLuongSanXuat.toLocaleString()}</td>
                    <td>${item.nhapKho.toLocaleString()}</td>
                    <td>${item.ngayDisplay || ''}</td>
                    <td>${haoPhiHtml}</td>
                    <td>${tyLeNhapKhoHtml}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div style="min-width: 30px;" class="progress-mini flex-grow-1">
                                <div class="bar ${barClass}" style="width:${progress}%"></div>
                            </div>
                            <span class="small text-muted" style="min-width:8px; text-align:right">${progress}%</span>
                        </div>
                    </td>
                    <td>${isClosed ? '<span style="font-weight: 300;" class="pill pill-closed">Đóng lệnh</span>' : ''}</td>
                `;
                tableBody.appendChild(tr);
            });
            
            // Cập nhật tổng kết
            totalNhap.textContent = totalNhapValue.toLocaleString();
            totalXuat.textContent = totalXuatValue.toLocaleString();
            totalTon.textContent = totalTonValue.toLocaleString();
            
            // Hiển thị dữ liệu
            summaryCards.classList.remove('hidden');
            tableContainer.classList.remove('hidden');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) lastUpdatedEl.textContent = new Date().toLocaleString();
        }

        // (Đã bỏ status UI)

        // Lọc nhanh và Export CSV
        document.addEventListener('input', (e) => {
            if (e.target && (e.target.id === 'filterPO' || e.target.id === 'startDate' || e.target.id === 'endDate')) {
                // render lại dựa trên dữ liệu lần tải gần nhất
                // Đơn giản: gọi loadData() lại (có thể cải thiện bằng cache)
                loadData();
            }
        });
        document.getElementById('clearFilterBtn')?.addEventListener('click', () => {
            const f = document.getElementById('filterPO');
            const s = document.getElementById('startDate');
            const e = document.getElementById('endDate');
            if (f) f.value = '';
            if (s) s.value = '';
            if (e) e.value = '';
            loadData();
        });

        document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
            const rows = [];
            const header = ['STT','PO','Lệnh Sản Xuất','Thông tin','SL Cần Triển Khai','SL Sản Xuất','NHẬP KHO','Ngày Xuống Lệnh','Hao phí','Tỷ lệ nhập kho','Tiến độ','Đóng lệnh'];
            rows.push(header.join(','));
            const trs = document.querySelectorAll('#tableBody tr');
            trs.forEach(tr => {
                const tds = Array.from(tr.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"');
                rows.push(tds.join(','));
            });
            const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bao_cao_po.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        // Event Listeners
        loadDataBtn.addEventListener('click', loadData);
        refreshBtn.addEventListener('click', loadData);

        // Khởi tạo ứng dụng khi trang load
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
