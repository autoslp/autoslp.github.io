<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>B√°o C√°o Nh·∫≠p Xu·∫•t T·ªìn - Google Sheets</title>
     <!-- Bootstrap CSS -->
     <link href="https://api.autoslp.com/css/bootstrap.min.css" rel="stylesheet" />
     <link href="https://api.autoslp.com/css/bootstrap-icons.css" rel="stylesheet" />
  <!-- Chart.js (kh√¥ng s·ª≠ d·ª•ng) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --aside-w: 74px;
            --bg: #f5f7fb;
            --card-bg: #ffffff;
            --border: #eef1f6;
            --text: #0f172a;
            --muted: #6b7280;
            --primary: #2b6ef2;
            --primary-100: #eef6ff;
            --success: #16a34a;
            --danger: #ef4444;
        }
        html, body { height: 100%; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        .hidden { display: none; }

        /* Layout */
        .app { display: grid; grid-template-columns: var(--aside-w) 1fr; min-height: 100vh; }
        .aside {
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            padding-top: 16px;
        }
        .aside .nav-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: grid; place-items: center;
            color: var(--muted);
            margin: 10px auto; cursor: pointer;
            transition: all .15s ease;
        }
        .aside .nav-icon.active, .aside .nav-icon:hover {
            background: var(--primary-100);
            color: var(--primary);
        }

        .topbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .topbar .input-group-text { background: #f3f6fb; border-color: #e9eef6; }
        .topbar input.form-control { border-color: #e9eef6; background: #f9fbff; }

        /* Cards */
        .hero-card, .kpi-card, .panel {
            border: 0; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15,23,42,0.04), 0 2px 8px rgba(15,23,42,0.06);
            background: var(--card-bg);
        }

        .metric { font-weight: 800; font-size: 1.35rem; letter-spacing: -0.02em; }
        .muted { color: var(--muted); }

        /* Soft badges & chips */
        .badge-soft { background: #eef2ff; color: var(--primary); border-radius: 999px; padding: .25rem .6rem; font-weight: 600; }
        .chip { background: var(--primary-100); color: var(--primary); border-radius: 10px; padding: .25rem .5rem; font-weight: 600; font-size: .8rem; }

        /* Table */
        .table { --bs-table-bg: transparent; }
        .table thead th { font-size: 11px; text-transform: none; color: #6b7280; letter-spacing: .02em; border-bottom-color: var(--border); }
        .table-hover tbody tr:hover { background: #f8fbff; }
        .table-responsive { border-radius: 12px; }
        .table thead { position: sticky; top: 0; z-index: 1; background: var(--card-bg); }
        .table td, .table th { padding: .5rem .25rem; }
        #dataTable th:nth-child(1),
        #dataTable td:nth-child(1) { text-align: center;}
        /* PO column max width */
        #dataTable th:nth-child(2),
        #dataTable td:nth-child(2) { max-width:130px; width:130px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(3),
        #dataTable td:nth-child(3) { max-width:170px; width:170px; white-space: normal; word-break: break-word; font-size: 0.75rem; }

        #dataTable th:nth-child(4),
        #dataTable td:nth-child(4) { max-width:280px; width:280px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(9),
        #dataTable td:nth-child(9) { max-width:130px; width:130px; white-space: normal; word-break: break-word; }

        #dataTable th:nth-child(10),
        #dataTable td:nth-child(10) { max-width:80px; width:80px; white-space: normal; word-break: break-word; }


        #dataTable th:last-child,
        #dataTable td:last-child { max-width:90px; width:90px; white-space: normal; word-break: break-word;text-align: center; }


        /* Buttons */
        .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 6px 12px rgba(43,110,242,.18); }
        .btn-primary:hover { filter: brightness(.95); }
        .btn-outline-secondary { border-color: #e4e8f0; color: #344256; }

        /* Utilities */
        .vr { border-left: 1px solid var(--border); height: 24px; }

        /* Mini progress (for Ti·∫øn ƒë·ªô) */
        .progress-mini { height: 6px; background: #eef2f7; border-radius: 8px; overflow: hidden; }
        .progress-mini .bar { height: 100%; border-radius: 8px; transition: width .3s ease; }
        .bar-success { background: #19c2a0; }
        .bar-warning { background: #f3ad2e; }
        .bar-danger { background: #f27b9b; }

        /* Pill badge for ƒê√≥ng l·ªánh */
        .pill { display:inline-block; padding:.25rem .2rem; border-radius:999px;}
        .pill-closed { background:#d1fae5; color:#0f766e; }

        /* Dots */
        .dot { display:inline-block; width:8px; height:8px; border-radius:50%; }
        .dot-red { background:#f27b9b; }
        .dot-green { background:#19c2a0; }
        .text-good { color:#19c2a0;  }

        /* Status KPI colors */
        .kpi-danger { background:#ffe9ee; }
        .kpi-warning { background:#fff6e6; }
        .kpi-success { background:#e9fbf6; }
        .kpi-info { background:#eef6ff; }
        .kpi-mint { background:#ecfdf5; }

        /* Dashboard-like stat cards */
        .stat-card { border:0; border-radius:16px; box-shadow: 0 8px 24px rgba(15,23,42,0.06); padding:16px; height:100%; }
        .icon-circle { width:40px; height:40px; border-radius:50%; display:grid; place-items:center; font-size:18px; }
        .ic-danger { background:#ffd3dc; color:#b42335; }
        .ic-warning { background:#ffe4bd; color:#a45c00; }
        .ic-success { background:#c9f6ea; color:#0f766e; }
        .ic-info { background:#d9ecff; color:#2563eb; }
        .ic-mint { background:#c7f7ea; color:#0f766e; }
        .stat-value { font-weight:800; font-size:1.6rem; letter-spacing:-0.02em; }
        .stat-label { color:#6b7280; font-size:.9rem; }
        .stat-center{flex:1; text-align:center}
        /* Font size utilities like in sample */
        .fs-8{font-size:28px}
        .fs-7{font-size:20px}
        .fs-6{font-size:18px}
        .fs-5{font-size:16px}
        .fs-4{font-size:14px}
        .fs-3{font-size:12px}
        .fs-2{font-size:11px}
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="aside d-flex flex-column align-items-center">
            <div class="nav-icon active" title="Dashboard"><i class="bi bi-columns-gap"></i></div>
            <div class="nav-icon" title="Orders"><i class="bi bi-bag"></i></div>
            <div class="nav-icon" title="Customers"><i class="bi bi-people"></i></div>
            <div class="nav-icon" title="Reports"><i class="bi bi-graph-up"></i></div>
            <div class="mt-auto mb-3 nav-icon" title="Settings"><i class="bi bi-gear"></i></div>
        </aside>

        <!-- Main -->
        <main class="main bg-light">
            <!-- Topbar -->
            <div class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button id="loadDataBtn" class="btn btn-primary"><i class="bi bi-arrow-repeat me-1"></i>T·∫£i d·ªØ li·ªáu</button>
                    <button id="refreshBtn" class="btn btn-outline-secondary">L√†m m·ªõi</button>
                    <div class="vr d-none d-md-block"></div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="filterPO" type="text" class="form-control" placeholder="L·ªçc PO...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-gear"></i></span>
                        <input id="filterLenhSanXuat" type="text" class="form-control" placeholder="L·ªçc l·ªánh SX...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input id="filterKhachHang" type="text" class="form-control" placeholder="L·ªçc kh√°ch h√†ng...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 260px;">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <input id="startDate" type="date" class="form-control">
                        <input id="endDate" type="date" class="form-control">
                    </div>
                    <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary">X√≥a l·ªçc</button>
                    <button id="exportCsvBtn" class="btn btn-sm btn-success"><i class="bi bi-file-earmark-arrow-down me-1"></i>Export CSV</button>
                </div>
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-bell"></i>
                    <i class="bi bi-person-circle fs-4"></i>
                </div>
            </div>

            <!-- Content -->
            <div class="container-fluid py-3">
                <!-- Hero card -->
                <div class="card hero-card mb-3">
                    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <div>
                            <h5 class="mb-1">Ch√∫c m·ª´ng b·∫°n!</h5>
                            <div class="muted">B·∫°n ƒë√£ ho√†n th√†nh b√°o c√°o t·ªìn kho h√¥m nay</div>
                        </div>
                        <div class="text-end">
                            <div class="muted small">C·∫≠p nh·∫≠t g·∫ßn nh·∫•t</div>
                            <div class="fw-semibold" id="lastUpdated">--:--</div>
                        </div>
                    </div>
                </div>

          
                    
                    
                    
                  </div>
                <!-- KPI row -->
                <div id="summaryCards" class="container-fluid  row g-3 hidden">
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card align-items-center justify-content-between">
                            <div class="card-body">
                                <div class="muted small">T·ªïng Nh·∫≠p Kho</div>
                                <div class="metric" id="totalNhap">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card align-items-center justify-content-between">
                            <div class="card-body">
                                <div class="muted small">T·ªïng SL Tri·ªÉn Khai</div>
                                <div class="metric" id="totalXuat">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card align-items-center justify-content-between">
                            <div class="card-body">
                                <div class="muted small">T·ªïng SL S·∫£n Xu·∫•t</div>
                                <div class="metric" id="totalTon">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card align-items-center justify-content-between">
                            <div class="card-body">
                                <div class="muted small">T·ªïng NG</div>
                                <div class="metric" id="totalNG">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Status summary styled like dashboard cards -->
                <div id="statusSummary" class="container-fluid  row g-3 mt-1 hidden">
                    <div class="col-12 col-md-3 col-xl-3">
                        <div class="stat-card kpi-danger d-flex align-items-center justify-content-between">
                            <div class="stat-center">
                                <div class="stat-label">L·ªánh qu√° h·∫°n</div>
                                <div class="stat-value" id="countOverdue">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- <div class="col-12 col-md-3 col-xl-3">
                        <div class="stat-card kpi-warning d-flex align-items-center justify-content-between">
                            <div>
                                <div class="stat-label">L·ªánh c·∫£nh b√°o</div>
                                <div class="stat-value" id="countWarning">0</div>
                            </div>
                            <div class="icon-circle ic-warning">‚ö†Ô∏è</div>
                        </div>
                    </div> -->
                    <div class="col-12 col-md-3 col-xl-3">
                        <div class="stat-card kpi-success d-flex align-items-center justify-content-between">
                            <div class="stat-center">
                                <div class="stat-label">L·ªánh OK</div>
                                <div class="stat-value" id="countOk">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3 col-xl-3">
                        <div class="stat-card kpi-info d-flex align-items-center justify-content-between">
                            <div class="stat-center">
                                <div class="stat-label">V∆∞·ª£t hao ph√≠</div>
                                <div class="stat-value" id="countOverWaste">0</div>
                            </div>
                        </div>
                    </div>
                    <div class="col-12 col-md-3 col-xl-3">
                        <div class="stat-card kpi-mint d-flex align-items-center justify-content-between">
                            <div class="stat-center">
                                <div class="stat-label">Ch∆∞a ƒë√≥ng</div>
                                <div class="stat-value" id="countOpen">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table panel -->
                <div id="tableContainer" style="margin-left: 8px;margin-right: 8px;" class=" card panel mt-3 hidden">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-hover align-middle mb-0">
                                <thead style="font-size: 12px!important;" class="table-light">
                                    <tr>
                                        <th>STT</th>
                                        <th style="text-align: center;">PO</th>
                                        <th>L·ªánh S·∫£n Xu·∫•t</th>
                                        <th>Th√¥ng tin</th>
                                        <th>Tri·ªÉn Khai
                                              (pcs)
                                        </th>
                                        <th>Nh·∫≠p Kho/S·∫£n Xu·∫•t
                                            (pcs)
                                        </th>
                                        <th>Ng√†y
                                            Xu·ªëng/Giao</th>
                                        <th>T·ªïng NG</th>
                                        <th style="text-align: center;">Hao ph√≠</th>
                                        <th>T·ª∑ l·ªá nh·∫≠p kho</th>
                                        <th>Ti·∫øn ƒë·ªô</th>
                                        <th>ƒê√≥ng l·ªánh</th>
                                        <th>C·∫£nh b√°o</th>
                                    </tr>
                                </thead>
                                <tbody style="font-size: 12px;" id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Kh√¥ng c·∫ßn Google API Scripts n·ªØa v√¨ s·ª≠ d·ª•ng fetch tr·ª±c ti·∫øp -->
    <!-- Bootstrap JS Bundle -->
    <script src="https://api.autoslp.com/css/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD1Cj6j6c6b9l+8nt1pV0r1jDD6whzFZC+NcIb2FG+" crossorigin="anonymous"></script>
    <!-- Chart.js (kh√¥ng s·ª≠ d·ª•ng, gi·ªØ guard n·∫øu sau d√πng) -->
    <script>
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not found from custom CDN, attempting fallback...');
        var s = document.createElement('script');
        s.src = 'https://api.autoslp.com/css/chart.js';
        document.head.appendChild(s);
      }
    </script>

    <script>
        // C·∫•u h√¨nh Google API
        const GOOGLE_API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
        // Sheet ID c·ªßa b·∫°n (s·∫Ω ƒë∆∞·ª£c c·∫≠p nh·∫≠t sau khi t·∫°o Data Bridge Sheet)
        const SPREADSHEET_ID = '1UuIKiW0soNDv2U08HMhiuTn_Kxrzxlj_Z7GXK7ZM6Ic';
        // Webhook c·∫•u h√¨nh
        const WEBHOOK_URL = 'https://api.autoslp.com:5678/webhook-test/bao-cao-lenhsanxuat';

        // DOM Elements
        const loadDataBtn = document.getElementById('loadDataBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const summaryCards = document.getElementById('summaryCards');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const totalNhap = document.getElementById('totalNhap');
        const totalXuat = document.getElementById('totalXuat');
        const totalTon = document.getElementById('totalTon');
        let autoRefreshTimer = null;
        let isLoading = false;

        // G·ª≠i webhook cho l·∫ßn auto-refresh
        function sendWebhook(data) {
            try {
                const payload = {
                    event: 'auto-refresh',
                    timestamp: new Date().toISOString(),
                    ...((typeof data === 'object' && data) || {})
                };
                // D√πng no-cors ƒë·ªÉ h·∫°n ch·∫ø l·ªói CORS ph√≠a client
                fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors',
                    keepalive: true
                }).catch(() => {});
            } catch (err) {
                // B·ªè qua l·ªói webhook ƒë·ªÉ kh√¥ng ·∫£nh h∆∞·ªüng UI
            }
        }

        // Utils: parse and format dates
        function parseAnyDate(value) {
            if (!value) return null;
            // Accept formats: YYYY-MM-DD, DD/MM/YYYY
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                const d = new Date(value + 'T00:00:00');
                return isNaN(d.getTime()) ? null : d;
            }
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                const [dd, mm, yyyy] = value.split('/').map(Number);
                const d = new Date(yyyy, mm - 1, dd);
                return isNaN(d.getTime()) ? null : d;
            }
            const d = new Date(value);
            return isNaN(d.getTime()) ? null : d;
        }
        function formatDateDDMMYYYY(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${dd}/${mm}/${yyyy}`;
        }
        function toISODate(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${yyyy}-${mm}-${dd}`;
        }
        function parsePercent(value) {
            if (value === undefined || value === null || value === '') return null;
            const cleaned = String(value).toString().replace('%','').replace(/\s+/g,'').replace(',', '.');
            const n = parseFloat(cleaned);
            if (isNaN(n)) return null;
            return n <= 1 ? n * 100 : n;
        }
        // Parse s·ªë theo ƒë·ªãnh d·∫°ng VN: ch·∫•m l√† h√†ng ngh√¨n, ph·∫©y l√† th·∫≠p ph√¢n
        function parseNumberVN(value) {
            if (value === undefined || value === null || value === '') return 0;
            if (typeof value === 'number') return value;
            const s = String(value).toString().trim().replace(/\./g, '').replace(/,/g, '.');
            const n = parseFloat(s);
            return isNaN(n) ? 0 : n;
        }
        function formatPercent(n) {
            if (n === null || n === undefined || isNaN(n)) return '';
            const v = Math.round(n * 10) / 10; // 1 decimal
            return `${v}%`;
        }

        // Function ƒëi·ªÅu ch·ªânh font ch·ªØ cho loaiLenh d·ª±a tr√™n t√™n c·ª• th·ªÉ
        function formatLenhWithSmallFont(lenhSanXuat, loaiLenh) {
            if (!lenhSanXuat) return '';
            
            if (loaiLenh) {
                let fontSize = '0.5rem'; // m·∫∑c ƒë·ªãnh
                
                // Set font size c·ª• th·ªÉ cho t·ª´ng lo·∫°i l·ªánh
                switch (loaiLenh) {
                    case 'M·∫´u k√®m h√†ng':
                        fontSize = '0.55rem';
                        break;
                    case 'Gh√©p PO':
                        fontSize = '0.65rem';
                        break;
                    case 'B√π gh√©p':
                        fontSize = '0.65rem';
                        break;
                    case 'L·∫Øp r√°p':
                        fontSize = '0.65rem';
                        break;
                    case 'B√π':
                        fontSize = '0.7rem';
                        break;    
                    default:
                        // N·∫øu c√≥ lo·∫°i l·ªánh kh√°c, t√≠nh theo ƒë·ªô d√†i
                        const totalLength = lenhSanXuat.length + loaiLenh.length + 3;
                        if (totalLength > 25) {
                            fontSize = '0.6rem';
                        } else if (totalLength > 20) {
                            fontSize = '0.65rem';
                        }
                }
                
                return `${lenhSanXuat} <span style="font-size: ${fontSize}; color: #6b7280;">(${loaiLenh})</span>`;
            } else {
                return lenhSanXuat;
            }
        }

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng
        function initializeApp() {
            // Set default date range: last 30 days
            const endInput = document.getElementById('endDate');
            const startInput = document.getElementById('startDate');
            const now = new Date();
            const last30 = new Date(now);
            last30.setDate(now.getDate() - 30);
            if (startInput) startInput.value = toISODate(last30);
            if (endInput) endInput.value = toISODate(now);

            // T·∫£i ngay v√† thi·∫øt l·∫≠p t·ª± ƒë·ªông l√†m m·ªõi m·ªói 50 gi√¢y
            loadData();
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                loadData();
                // G·ª≠i webhook m·ªói l·∫ßn auto-refresh
                sendWebhook({ reason: 'interval-50s' });
            }, 50000);
        }

        // T·∫£i d·ªØ li·ªáu t·ª´ Google Sheets (Data Bridge Sheet)
        async function loadData() {
            if (isLoading) return; // tr√°nh g·ªçi ch·ªìng
            isLoading = true;
            
            try {
                // S·ª≠ d·ª•ng API tr·ª±c ti·∫øp v·ªõi sheet c·ªßa b·∫°n
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/4.%20Nh·∫≠p%20Xu·∫•t%20T·ªìn!A8:AJ?key=${GOOGLE_API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) return;

                // X·ª≠ l√Ω d·ªØ li·ªáu
                processData(data.values);
                
            } catch (error) {
                console.error('L·ªói khi t·∫£i d·ªØ li·ªáu:', error);
            }
            finally {
                isLoading = false;
            }
        }

        // X·ª≠ l√Ω d·ªØ li·ªáu theo c·∫•u tr√∫c m·ªõi - g·ªôp theo PO
        function processData(values) {
            console.log('D·ªØ li·ªáu nh·∫≠n ƒë∆∞·ª£c:', values);
            
            // D·ªØ li·ªáu t·ª´ d√≤ng A8:AJ (d√≤ng ƒë·∫ßu ti√™n l√† header)
            const data = values.slice(1); // B·ªè qua d√≤ng header
            
            // Object ƒë·ªÉ g·ªôp d·ªØ li·ªáu theo PO
            const groupedData = {};
            
            data.forEach((row, index) => {
                if (row.length < 36) return; // B·ªè qua d√≤ng kh√¥ng ƒë·ªß c·ªôt (c·∫ßn ƒë·∫øn c·ªôt AJ)
                
                // Mapping theo y√™u c·∫ßu m·ªõi:
                const po = row[34] || '';                    // AI (S·ªë PO)
                const maCode = row[2] || '';                 // C (M√£ code SP)
                const tenSanPham = row[3] || '';             // D (T√™n s·∫£n ph·∫©m)
                const khachHang = row[7] || '';              // H (Kh√°ch h√†ng)
                const lenhSanXuat = row[0] || '';            // A (L·ªánh s·∫£n xu·∫•t)
                const loaiLenh = (row[1] || '').trim();      // B (Lo·∫°i l·ªánh)
                const soLuongCanTrienKhai = parseFloat(row[5]) || 0;  // F (SL tri·ªÉn khai)
                const soLuongSanXuat = parseFloat(row[6]) || 0;       // G (SL C·∫ßn SX)
                const nhapKho = parseFloat(row[14]) || 0;             // O (NH·∫¨P KHO)
                const tongNG = parseFloat(row[19]) || 0;               // T (T·ªïng NG)
                const tyLeNhapKhoVal = parsePercent(row[18]);         // S (T·ª∑ l·ªá nh·∫≠p kho)
                const haoPhiThucTeVal = row[20] || '';        // U (Hao ph√≠ th·ª±c t·∫ø)
                const haoPhiChoPhepVal = row[21] || '';       // V (Hao ph√≠ cho ph√©p)
                const ngayXuongLenhRaw = row[26] || '';      // AA (Ng√†y xu·ªëng l·ªánh)
                const ngayGiaoHangRaw = row[35] || '';       // AJ (Ng√†y giao h√†ng)
                const ngayDate = parseAnyDate(ngayXuongLenhRaw);
                const ngayISO = ngayDate ? toISODate(ngayDate) : '';
                const ngayDisplay = ngayDate ? formatDateDDMMYYYY(ngayDate) : '';
                const giaoDate = parseAnyDate(ngayGiaoHangRaw);
                const giaoISO = giaoDate ? toISODate(giaoDate) : '';
                const giaoDisplay = giaoDate ? formatDateDDMMYYYY(giaoDate) : '';
                
                // N·∫øu PO ch∆∞a t·ªìn t·∫°i, t·∫°o m·ªõi
                if (!groupedData[po]) {
                    groupedData[po] = {
                        po: po,
                        lenhSanXuat: [],
                        maCode: maCode,
                        tenSanPham: tenSanPham,
                        khachHang: khachHang,
                        soLuongCanTrienKhai: 0,
                        soLuongSanXuat: 0,
                        nhapKho: 0,
                        tongNG: 0,
                        ngayISO: ngayISO,
                        ngayDisplay: ngayDisplay,
                        haoPhiThucTe: null,
                        haoPhiChoPhep: null,
                        tyLeNhapKho: null,
                        giaoISO: giaoISO,
                        giaoDisplay: giaoDisplay
                    };
                }
                
                // G·ªôp d·ªØ li·ªáu
                const lenhHienThi = formatLenhWithSmallFont(lenhSanXuat, loaiLenh);
                groupedData[po].lenhSanXuat.push(lenhHienThi);
                // C·∫≠p nh·∫≠t th√¥ng tin m√¥ t·∫£ (gi·ªØ th√¥ng tin ƒë·∫ßu ti√™n n·∫øu ƒë√£ c√≥)
                if (!groupedData[po].maCode && maCode) groupedData[po].maCode = maCode;
                if (!groupedData[po].tenSanPham && tenSanPham) groupedData[po].tenSanPham = tenSanPham;
                if (!groupedData[po].khachHang && khachHang) groupedData[po].khachHang = khachHang;
                groupedData[po].soLuongCanTrienKhai += soLuongCanTrienKhai;
                groupedData[po].soLuongSanXuat += soLuongSanXuat;
                groupedData[po].nhapKho += nhapKho;
                groupedData[po].tongNG += tongNG;
                // Gi·ªØ ng√†y s·ªõm nh·∫•t n·∫øu c√≥ nhi·ªÅu b·∫£n ghi
                if (ngayISO) {
                    if (!groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    } else if (ngayISO < groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    }
                }
                // Ng√†y giao s·ªõm nh·∫•t (∆∞u ti√™n ng√†y s·ªõm h∆°n)
                if (giaoISO) {
                    if (!groupedData[po].giaoISO) {
                        groupedData[po].giaoISO = giaoISO; groupedData[po].giaoDisplay = giaoDisplay;
                    } else if (giaoISO < groupedData[po].giaoISO) {
                        groupedData[po].giaoISO = giaoISO; groupedData[po].giaoDisplay = giaoDisplay;
                    }
                }
                // Hao ph√≠ & t·ª∑ l·ªá nh·∫≠p kho (l·∫•y gi√° tr·ªã m·ªõi nh·∫•t h·ª£p l·ªá)
                if (haoPhiThucTeVal !== null) {
                    groupedData[po].haoPhiThucTe = haoPhiThucTeVal;
                }
                if (haoPhiChoPhepVal !== null) {
                    groupedData[po].haoPhiChoPhep = haoPhiChoPhepVal;
                }
                if (tyLeNhapKhoVal !== null) {
                    groupedData[po].tyLeNhapKho = tyLeNhapKhoVal;
                }
            });
            
            // Chuy·ªÉn ƒë·ªïi object th√†nh array v√† s·∫Øp x·∫øp
            let processedData = Object.values(groupedData).filter(item => item.po !== '');
            
            let totalNhapValue = 0;
            let totalXuatValue = 0;
            let totalTonValue = 0;
            let totalNGValue = 0;
            let countOverdue = 0;
            let countWarning = 0;
            let countOk = 0;
            let countOverWaste = 0;
            let countOpen = 0;
            
            // X√≥a d·ªØ li·ªáu c≈©
            tableBody.innerHTML = '';
            
            const poFilter = (document.getElementById('filterPO')?.value || '').trim().toLowerCase();
            const lenhSanXuatFilter = (document.getElementById('filterLenhSanXuat')?.value || '').trim().toLowerCase();
            const khachHangFilter = (document.getElementById('filterKhachHang')?.value || '').trim().toLowerCase();
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // L·ªçc theo PO, l·ªánh s·∫£n xu·∫•t, kh√°ch h√†ng v√† kho·∫£ng ng√†y
            if (poFilter) {
                processedData = processedData.filter(i => (i.po || '').toLowerCase().includes(poFilter));
            }
            if (lenhSanXuatFilter) {
                processedData = processedData.filter(i => {
                    // Ki·ªÉm tra trong t·∫•t c·∫£ l·ªánh s·∫£n xu·∫•t c·ªßa PO n√†y
                    return i.lenhSanXuat.some(lenh => lenh.toLowerCase().includes(lenhSanXuatFilter));
                });
            }
            if (khachHangFilter) {
                processedData = processedData.filter(i => (i.khachHang || '').toLowerCase().includes(khachHangFilter));
            }
            if (startDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO >= startDate);
            }
            if (endDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO <= endDate);
            }

            processedData.forEach((item, index) => {
                // T√≠nh t·ªïng cho summary
                totalNhapValue += item.nhapKho;
                totalXuatValue += item.soLuongCanTrienKhai;
                totalTonValue += item.soLuongSanXuat;
                totalNGValue += item.tongNG;
                
                // Chu·∫©n b·ªã c√°c gi√° tr·ªã tr∆∞·ªõc khi ƒë·∫øm/tr√¨nh b√†y
                const computedTyLe = item.soLuongSanXuat > 0 ? (item.nhapKho / item.soLuongSanXuat) * 100 : null; // T·ª∑ l·ªá nh·∫≠p kho = Nh·∫≠p kho / S·∫£n xu·∫•t
                const progress = (computedTyLe !== null && computedTyLe !== undefined)
                    ? Math.max(0, Math.min(100, Math.round(computedTyLe)))
                    : (item.soLuongCanTrienKhai > 0 ? Math.min(100, Math.round((item.nhapKho / item.soLuongCanTrienKhai) * 100)) : 0);
                const isClosed = (computedTyLe !== null && computedTyLe !== undefined)
                    ? (computedTyLe >= 100)
                    : (progress >= 100);

                // ƒê·∫øm th·ªëng k√™ tr·∫°ng th√°i


                // Ch∆∞a ƒë√≥ng: t·∫•t c·∫£ l·ªánh ch∆∞a ƒë√≥ng
                if (!isClosed) {
                    countOpen++;
                }
                
                // L·ªánh qu√° h·∫°n: ch∆∞a ƒë√≥ng v√† c√≥ ng√†y giao h√†ng ƒë√£ qu√° h·∫°n
                if (!isClosed && item.giaoISO) {
                    const todayISO = toISODate(new Date());
                    const diffMs = (new Date(item.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                    const days = Math.round(diffMs / (24*60*60*1000));
                    
                    if (days < 0) {
                        countOverdue++;
                    }
                }
                
                // L·ªánh OK: ƒë√£ ƒë√≥ng ho·∫∑c ch∆∞a ƒë√≥ng nh∆∞ng c√≤n th·ªùi gian
                if (isClosed) {
                    countOk++;
                } else if (item.giaoISO) {
                    const todayISO = toISODate(new Date());
                    const diffMs = (new Date(item.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                    const days = Math.round(diffMs / (24*60*60*1000));
                    
                    if (days >= 0) {
                        countOk++;
                    }
                } else {
                    // Ch∆∞a c√≥ ng√†y giao h√†ng th√¨ coi nh∆∞ OK
                    countOk++;
                }
                
                // V∆∞·ª£t hao ph√≠: c√≥ d·ªØ li·ªáu hao ph√≠ v√† th·ª±c t·∫ø > cho ph√©p
                const haoThucTeForCount = parseFloat((item.haoPhiThucTe || '').replace(',', '.').replace('%', ''));
                const haoChoPhepForCount = parseFloat((item.haoPhiChoPhep || '').replace(',', '.').replace('%', ''));
                if (haoThucTeForCount > 0 && haoChoPhepForCount > 0 && haoThucTeForCount > haoChoPhepForCount) {
                    countOverWaste++;
                }

                // T·∫°o d√≤ng b·∫£ng
                const tr = document.createElement('tr');
                const barClass = progress >= 80 ? 'bar-success' : (progress >= 30 ? 'bar-warning' : 'bar-danger');
                // C·∫£nh b√°o (AQ): ƒê√≥ng l·ªánh ‚Üí OK; n·∫øu ch∆∞a ƒë√≥ng v√† ng√†y giao h√†ng ‚â§2 ‚Üí B√°o ƒë·ªông; ‚â§5 ‚Üí Ch√∫ √Ω; c√≤n l·∫°i OK
                let canhBaoHtml = '';
                if (isClosed) {
                    canhBaoHtml = '‚úÖ OK';
                } else if (item.giaoISO) {
                    const today = new Date();
                    const todayISO = toISODate(today);
                    const diffMs = (new Date(item.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                    const days = Math.round(diffMs / (24*60*60*1000));
                    if (days <= 2) {
                        canhBaoHtml = 'üö® B√°o ƒë·ªông';
                    } else if (days <= 5) {
                        canhBaoHtml = '‚ö†Ô∏è Ch√∫ √Ω';
                    } else {
                        canhBaoHtml = '‚úÖ OK';
                    }
                } else {
                    canhBaoHtml = '‚úÖ OK';
                }
                const tyLeNhapKhoTxt = formatPercent(computedTyLe);
                const tyLeNhapKhoHtml = computedTyLe !== null && computedTyLe >= 100 ? `<span class="text-good">${tyLeNhapKhoTxt}</span>` : `${tyLeNhapKhoTxt || ''}`;
                const haoThucTe = item.haoPhiThucTe;
                const haoChoPhep = item.haoPhiChoPhep;
                // Chuy·ªÉn ƒë·ªïi ph·∫ßn trƒÉm th√†nh s·ªë ƒë·ªÉ so s√°nh
                const haoThucTeForDisplay = parseFloat((haoThucTe || '').replace(',', '.').replace('%', ''));
                const haoChoPhepForDisplay = parseFloat((haoChoPhep || '').replace(',', '.').replace('%', ''));
                const hpDotClass = (haoThucTeForDisplay > 0 && haoChoPhepForDisplay > 0 && haoThucTeForDisplay > haoChoPhepForDisplay) ? 'dot-red' : 'dot-green';
                const haoPhiHtml = `
                    <div>
                        <div><span class="dot ${hpDotClass}"></span> ${haoThucTe || ''} <span class="text-muted small">(th·ª±c t·∫ø)</span></div>
                        <div>${haoChoPhep || ''} <span class="text-muted small">(cho ph√©p)</span></div>
                    </div>`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="fw-semibold">${item.po}</div>
                        <div style="font-size: 8px;" class="text-muted">${item.maCode || ''}</div>
                    </td>
                    <td>${item.lenhSanXuat.join('<br>')}</td>
                    <td>
                        <div class="fw-semibold">${item.tenSanPham || ''}</div>
                        <div style="font-size: 9px;" class="text-muted">${item.khachHang || ''}</div>
                    </td>
                    <td>${item.soLuongCanTrienKhai.toLocaleString()}</td>
                    <td> 
                      <div class="fw-semibold">${item.nhapKho.toLocaleString()} / ${item.soLuongSanXuat.toLocaleString()}</div>
                    </td>
                    <td>
                        <div class="text-muted">${item.ngayDisplay || ''}</div>
                        <div class="text-muted">${item.giaoDisplay || ''}</div>
                    </td>
                    <td>${(item.tongNG || 0).toLocaleString()}</td>
                    <td>${haoPhiHtml}</td>
                    <td>${tyLeNhapKhoHtml}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div style="min-width: 30px;" class="progress-mini flex-grow-1">
                                <div class="bar ${barClass}" style="width:${progress}%"></div>
                            </div>
                            <span class="small text-muted" style="min-width:8px; text-align:right">${progress}%</span>
                        </div>
                    </td>
                    <td>${isClosed ? '<span style="font-weight: 300;font-size: 10px;width: 60px;text-align: center;}" class="pill pill-closed">ƒê√≥ng l·ªánh</span>' : ''}</td>
                    <td>${canhBaoHtml}</td>
                `;
                tableBody.appendChild(tr);
            });
            
            // C·∫≠p nh·∫≠t t·ªïng k·∫øt
            totalNhap.textContent = totalNhapValue.toLocaleString();
            totalXuat.textContent = totalXuatValue.toLocaleString();
            totalTon.textContent = totalTonValue.toLocaleString();
            const totalNG = document.getElementById('totalNG');
            if (totalNG) totalNG.textContent = totalNGValue.toLocaleString();
            // Bind to dashboard cards
            const elDashTotalNhap = document.getElementById('dashTotalNhap');
            if (elDashTotalNhap) elDashTotalNhap.textContent = totalNhapValue.toLocaleString();
            // C·∫≠p nh·∫≠t th·ªëng k√™ th·∫ª
            const elOverdue = document.getElementById('countOverdue');
            const elWarning = document.getElementById('countWarning');
            const elOk = document.getElementById('countOk');
            const elOverWaste = document.getElementById('countOverWaste');
            const elOpen = document.getElementById('countOpen');
            if (elOverdue) elOverdue.textContent = countOverdue.toLocaleString();
            if (elWarning) elWarning.textContent = countWarning.toLocaleString();
            if (elOk) elOk.textContent = countOk.toLocaleString();
            if (elOverWaste) elOverWaste.textContent = countOverWaste.toLocaleString();
            if (elOpen) elOpen.textContent = countOpen.toLocaleString();
            // Bind to top dashboard right list
            const dashOverdue = document.getElementById('dashOverdue');
            if (dashOverdue) dashOverdue.textContent = countOverdue.toLocaleString();
            const dashWarning = document.getElementById('dashWarning');
            if (dashWarning) dashWarning.textContent = countWarning.toLocaleString();
            const dashOk = document.getElementById('dashOk');
            if (dashOk) dashOk.textContent = countOk.toLocaleString();
            const dashOpen = document.getElementById('dashOpen');
            if (dashOpen) dashOpen.textContent = countOpen.toLocaleString();
            const dashClosedPct = document.getElementById('dashClosedPct');
            const totalOrders = countOpen + countOk + countWarning + countOverdue;
            const closedPct = totalOrders > 0 ? Math.round(((totalOrders - countOpen) / totalOrders) * 100) : 0;
            if (dashClosedPct) dashClosedPct.textContent = closedPct + '%';
            
            // Hi·ªÉn th·ªã d·ªØ li·ªáu
            summaryCards.classList.remove('hidden');
            tableContainer.classList.remove('hidden');
            const statusSummary = document.getElementById('statusSummary');
            if (statusSummary) statusSummary.classList.remove('hidden');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) lastUpdatedEl.textContent = new Date().toLocaleString();
        }

        // (ƒê√£ b·ªè status UI)

        // L·ªçc nhanh v√† Export CSV
        document.addEventListener('input', (e) => {
            if (e.target && (e.target.id === 'filterPO' || e.target.id === 'filterLenhSanXuat' || e.target.id === 'filterKhachHang' || e.target.id === 'startDate' || e.target.id === 'endDate')) {
                // render l·∫°i d·ª±a tr√™n d·ªØ li·ªáu l·∫ßn t·∫£i g·∫ßn nh·∫•t
                // ƒê∆°n gi·∫£n: g·ªçi loadData() l·∫°i (c√≥ th·ªÉ c·∫£i thi·ªán b·∫±ng cache)
                loadData();
            }
        });
        document.getElementById('clearFilterBtn')?.addEventListener('click', () => {
            const f = document.getElementById('filterPO');
            const l = document.getElementById('filterLenhSanXuat');
            const k = document.getElementById('filterKhachHang');
            const s = document.getElementById('startDate');
            const e = document.getElementById('endDate');
            if (f) f.value = '';
            if (l) l.value = '';
            if (k) k.value = '';
            if (s) s.value = '';
            if (e) e.value = '';
            loadData();
        });

        document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
            const rows = [];
            const header = ['STT','PO','L·ªánh S·∫£n Xu·∫•t','Th√¥ng tin','SL C·∫ßn Tri·ªÉn Khai','Nh·∫≠p Kho/S·∫£n Xu·∫•t','Ng√†y Xu·ªëng/Giao','T·ªïng NG','Hao ph√≠','T·ª∑ l·ªá nh·∫≠p kho','Ti·∫øn ƒë·ªô','ƒê√≥ng l·ªánh','C·∫£nh b√°o'];
            rows.push(header.join(','));
            const trs = document.querySelectorAll('#tableBody tr');
            trs.forEach(tr => {
                const tds = Array.from(tr.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"');
                rows.push(tds.join(','));
            });
            const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bao_cao_po.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        // Event Listeners
        loadDataBtn.addEventListener('click', loadData);
        refreshBtn.addEventListener('click', loadData);

        // Kh·ªüi t·∫°o ·ª©ng d·ª•ng khi trang load
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
