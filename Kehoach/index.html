<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Báo Cáo Nhập Xuất Tồn - Google Sheets</title>
     <!-- Bootstrap CSS -->
     <link href="https://api.autoslp.com/css/bootstrap.min.css" rel="stylesheet">
     <link href="https://api.autoslp.com/css/bootstrap-icons.css" rel="stylesheet">
  <!-- Chart.js (không sử dụng) -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        :root {
            --aside-w: 74px;
            --bg: #f5f7fb;
            --card-bg: #ffffff;
            --border: #eef1f6;
            --text: #0f172a;
            --muted: #6b7280;
            --primary: #2b6ef2;
            --primary-100: #eef6ff;
            --success: #16a34a;
            --danger: #ef4444;
        }
        html, body { height: 100%; }
        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: 'Inter', system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, sans-serif;
        }
        .hidden { display: none; }

        /* Layout */
        .app { display: grid; grid-template-columns: var(--aside-w) 1fr; min-height: 100vh; }
        .aside {
            background: var(--card-bg);
            border-right: 1px solid var(--border);
            padding-top: 16px;
        }
        .aside .nav-icon {
            width: 44px; height: 44px; border-radius: 12px;
            display: grid; place-items: center;
            color: var(--muted);
            margin: 10px auto; cursor: pointer;
            transition: all .15s ease;
        }
        .aside .nav-icon.active, .aside .nav-icon:hover {
            background: var(--primary-100);
            color: var(--primary);
        }

        .topbar {
            background: var(--card-bg);
            border-bottom: 1px solid var(--border);
        }
        .topbar .input-group-text { background: #f3f6fb; border-color: #e9eef6; }
        .topbar input.form-control { border-color: #e9eef6; background: #f9fbff; }

        /* Cards */
        .hero-card, .kpi-card, .panel {
            border: 0; border-radius: 16px;
            box-shadow: 0 10px 30px rgba(15,23,42,0.04), 0 2px 8px rgba(15,23,42,0.06);
            background: var(--card-bg);
        }

        .metric { font-weight: 800; font-size: 1.35rem; letter-spacing: -0.02em; }
        .muted { color: var(--muted); }

        /* Soft badges & chips */
        .badge-soft { background: #eef2ff; color: var(--primary); border-radius: 999px; padding: .25rem .6rem; font-weight: 600; }
        .chip { background: var(--primary-100); color: var(--primary); border-radius: 10px; padding: .25rem .5rem; font-weight: 600; font-size: .8rem; }

        /* Table */
        .table { --bs-table-bg: transparent; }
        .table thead th { font-size: 11px; text-transform: none; color: #6b7280; letter-spacing: .02em; border-bottom-color: var(--border); }
        .table-hover tbody tr:hover { background: #f8fbff; }
        .table-responsive { border-radius: 12px; }
        .table thead { position: sticky; top: 0; z-index: 1; background: var(--card-bg); }
        .table td, .table th { padding: .5rem .25rem; }
        #dataTable th:nth-child(1),
        #dataTable td:nth-child(1) { text-align: center;}
        /* PO column max width */
        #dataTable th:nth-child(2),
        #dataTable td:nth-child(2) { max-width:130px; width:130px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(3),
        #dataTable td:nth-child(3) { max-width:170px; width:170px; white-space: normal; word-break: break-word; font-size: 0.75rem; }

        #dataTable th:nth-child(4),
        #dataTable td:nth-child(4) { max-width:280px; width:280px; white-space: normal; word-break: break-word; }
        /* PO column max width */
        #dataTable th:nth-child(9),
        #dataTable td:nth-child(9) { max-width:130px; width:130px; white-space: normal; word-break: break-word; }

        #dataTable th:nth-child(10),
        #dataTable td:nth-child(10) { max-width:80px; width:80px; white-space: normal; word-break: break-word; }


        #dataTable th:last-child,
        #dataTable td:last-child { max-width:90px; width:90px; white-space: normal; word-break: break-word;text-align: center; }


        /* Buttons */
        .btn-primary { background: var(--primary); border-color: var(--primary); box-shadow: 0 6px 12px rgba(43,110,242,.18); }
        .btn-primary:hover { filter: brightness(.95); }
        .btn-outline-secondary { border-color: #e4e8f0; color: #344256; }

        /* Utilities */
        .vr { border-left: 1px solid var(--border); height: 24px; }

        /* Mini progress (for Tiến độ) */
        .progress-mini { height: 6px; background: #eef2f7; border-radius: 8px; overflow: hidden; }
        .progress-mini .bar { height: 100%; border-radius: 8px; transition: width .3s ease; }
        .bar-success { background: #19c2a0; }
        .bar-warning { background: #f3ad2e; }
        .bar-danger { background: #f27b9b; }

        /* Pill badge for Đóng lệnh */
        .pill { display:inline-block; padding:.25rem .2rem; border-radius:999px;}
        .pill-closed { background:#d1fae5; color:#0f766e; }

        /* Dots */
        .dot { display:inline-block; width:8px; height:8px; border-radius:50%; }
        .dot-red { background:#f27b9b; }
        .dot-green { background:#19c2a0; }
        .text-good { color:#19c2a0;  }

        /* Status KPI colors */
        .kpi-danger { background:#ffe9ee; }
        .kpi-warning { background:#fff6e6; }
        .kpi-success { background:#e9fbf6; }
        .kpi-info { background:#eef6ff; }
        .kpi-mint { background:#ecfdf5; }

        /* Dashboard-like stat cards */
        .stat-card { border:0; border-radius:16px; box-shadow: 0 8px 24px rgba(15,23,42,0.06); padding:16px; height:100%; position: relative; }
        .icon-circle { width:40px; height:40px; border-radius:50%; display:grid; place-items:center; font-size:18px; }
        .ic-danger { background:#ffd3dc; color:#b42335; }
        .ic-warning { background:#ffe4bd; color:#a45c00; }
        .ic-success { background:#c9f6ea; color:#0f766e; }
        .ic-info { background:#d9ecff; color:#2563eb; }
        .ic-mint { background:#c7f7ea; color:#0f766e; }
        .stat-value { font-weight:800; font-size:1.6rem; letter-spacing:-0.02em; }
        .stat-label { color:#6b7280; font-size:.9rem; }
        .stat-center{flex:1; text-align:center}
        /* Font size utilities like in sample */
        .fs-8{font-size:28px}
        .fs-7{font-size:20px}
        .fs-6{font-size:18px}
        .fs-5{font-size:16px}
        .fs-4{font-size:14px}
        .fs-3{font-size:12px}
        .fs-2{font-size:11px}
        
        /* Suggestions dropdown */
        .suggestions-dropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            background: white;
            border: 1px solid #e9ecef;
            border-radius: 0.375rem;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
            z-index: 1000;
            max-height: 200px;
            overflow-y: auto;
            width: 400px;
        }
        .suggestion-item {
            padding: 0.5rem 0.75rem;
            cursor: pointer;
            border-bottom: 1px solid #f8f9fa;
            font-size: 0.875rem;
        }
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }
        .suggestion-item:last-child {
            border-bottom: none;
        }
        .suggestion-item.highlighted {
            background-color: #e3f2fd;
        }
        
        /* KPI Cards styling like dashboard-demo.html */
        .kpi-card {
            border: 1px solid #e9ecef;
            border-radius: 8px;
            box-shadow: none;
            transition: transform 0.2s ease-in-out;
            background: white;
            padding: 24px 16px;
        }
        
        .kpi-card:hover {
            transform: translateY(-2px);
        }
        
        .kpi-card.bg-gradient-start-3 { 
            background: linear-gradient(135deg, #e3f2fd 0%, #bbdefb 100%);
        }
        .kpi-card.bg-gradient-start-2 { 
            background: linear-gradient(135deg, #e8f5e8 0%, #c8e6c9 100%);
        }
        .kpi-card.bg-gradient-start-5 { 
            background: linear-gradient(135deg, #fff3e0 0%, #ffcc02 100%);
        }
        .kpi-card.bg-gradient-start-4 { 
            background: linear-gradient(135deg, #fce4ec 0%, #f8bbd9 100%);
        }
        
        .kpi-card .card-title {
            color: #6b7280;
            font-size: 0.875rem;
            font-weight: 500;
            margin-bottom: 0.5rem;
        }
        
        .kpi-card .metric {
            color: #1f2937;
            font-size: 1.5rem;
            font-weight: 600;
            margin-bottom: 0.25rem;
        }
        
        .kpi-card .change-text {
            color: #6b7280;
            font-size: 0.75rem;
        }
        
        .kpi-card .icon-container {
            width: 64px;
            height: 64px;
            border-radius: 16px;
            background: rgba(255,255,255,0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            margin-right: 20px;
        }
        
        .kpi-card .icon-inner {
            width: 40px;
            height: 40px;
            border-radius: 8px;
            display: flex;
            justify-content: center;
            align-items: center;
            color: white;
            font-size: 1.25rem;
        }
        
        .kpi-card .icon-primary { background: #2563eb; }
        .kpi-card .icon-success { background: #16a34a; }
        .kpi-card .icon-warning { background: #f59e0b; }
        .kpi-card .icon-danger { background: #ef4444; }
        
        /* Additional utility classes for dashboard-demo style */
        .text-secondary-light { color: #6b7280; }
        .text-success-main { color: #16a34a; }
        .text-danger-main { color: #ef4444; }
        .bg-success-focus { background-color: #dcfce7; }
        .bg-danger-focus { background-color: #fee2e2; }
        .text-md { font-size: 0.875rem; }
        .text-sm { font-size: 0.75rem; }
        .fw-medium { font-weight: 500; }
        .fw-semibold { font-weight: 600; }
        .rounded-2 { border-radius: 0.25rem; }
        .px-1 { padding-left: 0.25rem; padding-right: 0.25rem; }
        .mb-8 { margin-bottom: 0.5rem; }
        .my-1 { margin-top: 0.25rem; margin-bottom: 0.25rem; }
        
        /* Active state for status filter */
        .stat-card.active { box-shadow: 0 0 0 2px #2563eb inset, 0 8px 24px rgba(15,23,42,0.06); }
        
        /* Info icon styling */
        .info-icon {
            position: relative;
            display: inline-block;
            cursor: help;
        }
        
        .info-icon .info-tooltip {
            visibility: hidden;
            width: 280px;
            background-color: #1f2937;
            color: #fff;
            text-align: left;
            border-radius: 8px;
            padding: 12px;
            position: absolute;
            z-index: 1000;
            bottom: 125%;
            left: 50%;
            margin-left: -140px;
            opacity: 0;
            transition: opacity 0.3s;
            font-size: 0.875rem;
            line-height: 1.4;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .info-icon .info-tooltip::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: #1f2937 transparent transparent transparent;
        }
        
        .info-icon:hover .info-tooltip {
            visibility: visible;
            opacity: 1;
        }
        
        .info-icon i {
            color: #6b7280;
            font-size: 0.875rem;
            margin-left: 4px;
        }
    </style>
</head>
<body>
    <div class="app">
        <!-- Sidebar -->
        <aside class="aside d-flex flex-column align-items-center">
            <div class="nav-icon active" title="Dashboard"><i class="bi bi-columns-gap"></i></div>
            <div class="nav-icon" title="Orders"><i class="bi bi-bag"></i></div>
            <div class="nav-icon" title="Customers"><i class="bi bi-people"></i></div>
            <div class="nav-icon" title="Reports"><i class="bi bi-graph-up"></i></div>
            <div class="mt-auto mb-3 nav-icon" title="Settings"><i class="bi bi-gear"></i></div>
        </aside>

        <!-- Main -->
        <main class="main bg-light">
            <!-- Topbar -->
            <div class="topbar px-3 py-2 d-flex align-items-center justify-content-between">
                <div class="d-flex align-items-center gap-2 flex-wrap">
                    <button id="loadDataBtn" class="btn btn-primary"><i class="bi bi-arrow-repeat me-1"></i>Tải dữ liệu</button>
                    <button id="refreshBtn" style="display: none;" class="btn btn-outline-secondary">Làm mới</button>
                    <div class="vr d-none d-md-block"></div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-search"></i></span>
                        <input id="filterPO" type="text" class="form-control" placeholder="Lọc PO...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 220px;">
                        <span class="input-group-text"><i class="bi bi-gear"></i></span>
                        <input id="filterLenhSanXuat" type="text" class="form-control" placeholder="Lọc lệnh SX...">
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 220px; position: relative;">
                        <span class="input-group-text"><i class="bi bi-person"></i></span>
                        <input id="filterKhachHang" type="text" class="form-control" placeholder="Lọc khách hàng..." autocomplete="off">
                        <div id="khachHangSuggestions" class="suggestions-dropdown" style="display: none;"></div>
                    </div>
                    <div class="input-group input-group-sm" style="max-width: 260px;">
                        <span class="input-group-text"><i class="bi bi-calendar"></i></span>
                        <input id="startDate" type="date" class="form-control">
                        <input id="endDate" type="date" class="form-control">
                    </div>
                    <button id="clearFilterBtn" class="btn btn-sm btn-outline-secondary">Xóa lọc</button>
                    <!-- <button id="exportCsvBtn" class="btn btn-sm btn-success"><i class="bi bi-file-earmark-arrow-down me-1"></i>Export CSV</button> -->
                </div>
                <div class="d-flex align-items-center gap-3">
                    <i class="bi bi-bell"></i>
                    <i class="bi bi-person-circle fs-4"></i>
                </div>
            </div>

            <!-- Content -->
            <div class="container-fluid py-3">
                <!-- Hero card -->
                <div class="card hero-card mb-3">
                    <div class="card-body d-flex flex-wrap align-items-center justify-content-between gap-3">
                        <div>
                            <h5 class="mb-1">Chúc mừng bạn!</h5>
                            <div class="muted">Bạn đã hoàn thành báo cáo xuất nhập tồn kho hôm nay</div>
                        </div>
                        <div class="text-end">
                            <div class="muted small">Cập nhật gần nhất</div>
                            <div class="fw-semibold" id="lastUpdated">--:--</div>
                        </div>
                    </div>
                </div>


                    
                    
                    
                  </div>
                <!-- KPI row -->
                <div id="summaryCards" class="container-fluid row g-3 hidden">
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card bg-gradient-start-3">
                            <div class="card-body p-0">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                                  <div class="d-flex align-items-center">
                                        <div class="icon-container">
                                            <div class="icon-inner icon-primary">
                                                <i class="bi bi-box-seam"></i>
                                  </div>
                                  </div>
                                  <div>
                                            <span class="mb-2 fw-medium text-secondary-light text-md">
                                                Tổng Nhập Kho
                                                <div class="info-icon">
                                                    <i class="bi bi-info-circle"></i>
                                                    <div class="info-tooltip">
                                                        Tổng số lượng sản phẩm đã nhập kho từ tất cả các lệnh sản xuất. Đây là số liệu thực tế đã hoàn thành.
                                  </div>
                                  </div>
                                            </span>
                                            <h3 class="fw-semibold my-1" id="totalNhap">0</h3>
                                            <p class="text-sm mb-0">Tăng 
                                                <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm">+200</span> trong tuần này
                                            </p>
                                  </div>
                                  </div>
                                  </div>
                                  </div>
                                  </div>
                            </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card bg-gradient-start-2">
                            <div class="card-body p-0">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-container">
                                            <div class="icon-inner icon-success">
                                                <i class="bi bi-gear"></i>
                          </div>
                              </div>
                              <div>
                                            <span class="mb-2 fw-medium text-secondary-light text-md">
                                                Tổng SL Triển Khai
                                                <div class="info-icon">
                                                    <i class="bi bi-info-circle"></i>
                                                    <div class="info-tooltip">
                                                        Tổng số lượng sản phẩm cần triển khai theo kế hoạch. Đây là số liệu dự kiến cần sản xuất.
                              </div>
                            </div>
                                </span>
                                            <h3 class="fw-semibold my-1" id="totalXuat">0</h3>
                                            <p class="text-sm mb-0">Tăng 
                                                <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm">+200</span> trong tuần này
                                            </p>
                            </div>
                          </div>
                            </div>
                            </div>
                          </div>
                        </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card bg-gradient-start-5">
                            <div class="card-body p-0">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-container">
                                            <div class="icon-inner icon-warning">
                                                <i class="bi bi-cpu"></i>
                      </div>
                    </div>
                                        <div>
                                            <span class="mb-2 fw-medium text-secondary-light text-md">
                                                Tổng SL Cần Sản Xuất
                                                <div class="info-icon">
                                                    <i class="bi bi-info-circle"></i>
                                                    <div class="info-tooltip">
                                                        Tổng số lượng sản phẩm cần sản xuất theo đơn hàng. Đây là số liệu kế hoạch sản xuất.
                              </div>
                            </div>
                                </span>
                                            <h3 class="fw-semibold my-1" id="totalTon">0</h3>
                                            <p class="text-sm mb-0">Tăng 
                                                <span class="bg-success-focus px-1 rounded-2 fw-medium text-success-main text-sm">+200</span> trong tuần này
                                            </p>
                            </div>
                          </div>
                            </div>
                            </div>
                          </div>
                        </div>
                    <div class="col-12 col-md-3">
                        <div class="card kpi-card bg-gradient-start-4">
                            <div class="card-body p-0">
                                <div class="d-flex flex-wrap align-items-center justify-content-between gap-1 mb-8">
                                    <div class="d-flex align-items-center">
                                        <div class="icon-container">
                                            <div class="icon-inner icon-danger">
                                                <i class="bi bi-exclamation-triangle"></i>
                      </div>
                    </div>
                                        <div>
                                            <span class="mb-2 fw-medium text-secondary-light text-md">
                                                Tổng NG
                                                <div class="info-icon">
                                                    <i class="bi bi-info-circle"></i>
                                                    <div class="info-tooltip">
                                                        Tổng số lượng sản phẩm không đạt chất lượng (NG - No Good). Đây là số liệu sản phẩm lỗi cần xử lý.
                              </div>
                            </div>
                                </span>
                                            <h3 class="fw-semibold my-1" id="totalNG">0</h3>
                                            <p class="text-sm mb-0">Tăng 
                                                <span class="bg-danger-focus px-1 rounded-2 fw-medium text-danger-main text-sm">-200</span> trong tuần này
                                            </p>
                            </div>
                          </div>
                            </div>
                            </div>
                          </div>
                        </div>
                      </div>

                <!-- Status summary styled like dashboard cards -->
                <div id="statusSummary" class="container-fluid row g-3 mt-1 hidden">
                    <!-- Tổng số lệnh -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-info d-flex align-items-center justify-content-between" data-status="total">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Tổng số lệnh
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Tổng số lệnh sản xuất (PO) được tải từ hệ thống. Mỗi lệnh đại diện cho một đơn hàng sản xuất.
                  </div>
                            </div>
                        </div>
                                <div class="stat-value" id="totalOrders">0</div>
                    </div>
                            </div>
                        </div>
                    <!-- Lệnh báo động -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-danger d-flex align-items-center justify-content-between" data-status="alert">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Lệnh báo động
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Lệnh chưa đóng và còn ≤2 ngày đến hạn giao hàng. Cần xử lý ngay lập tức.
                    </div>
                            </div>
                        </div>
                                <div class="stat-value" id="countAlert">0</div>
                    </div>
                            </div>
                        </div>
                    <!-- Lệnh chú ý -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-warning d-flex align-items-center justify-content-between" data-status="warning">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Lệnh chú ý
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Lệnh chưa đóng và còn 3-5 ngày đến hạn giao hàng. Cần theo dõi chặt chẽ.
                            </div>
                        </div>
                    </div>
                                <div class="stat-value" id="countWarning">0</div>
                            </div>
                        </div>
                            </div>
                    <!-- Lệnh vượt hao phí -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-info d-flex align-items-center justify-content-between" data-status="overwaste">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Vượt hao phí
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Lệnh có hao phí thực tế vượt quá hao phí cho phép. Cần kiểm tra quy trình sản xuất.
                            </div>
                        </div>
                    </div>
                                <div class="stat-value" id="countOverWaste">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- Lệnh chưa đóng -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-mint d-flex align-items-center justify-content-between" data-status="open">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Chưa đóng
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Lệnh chưa hoàn thành (tỷ lệ nhập kho < 100%). Cần tiếp tục sản xuất.
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-value" id="countOpen">0</div>
                            </div>
                        </div>
                    </div>
                    <!-- Lệnh đã đóng -->
                    <div class="col-12 col-md-2 col-xl-2">
                        <div class="stat-card kpi-success d-flex align-items-center justify-content-between" data-status="closed">
                            <div class="stat-center">
                                <div class="stat-label">
                                    Đã đóng
                                    <div class="info-icon">
                                        <i class="bi bi-info-circle"></i>
                                        <div class="info-tooltip">
                                            Lệnh đã hoàn thành (tỷ lệ nhập kho ≥ 100%). Sản xuất đã kết thúc.
                                        </div>
                                    </div>
                                </div>
                                <div class="stat-value" id="countClosed">0</div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Table panel -->
                <div id="tableContainer" style="margin-left: 8px;margin-right: 8px;" class=" card panel mt-3 hidden">
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table id="dataTable" class="table table-hover align-middle mb-0">
                                <thead style="font-size: 12px!important;" class="table-light">
                                    <tr>
                                        <th>STT</th>
                                        <th style="text-align: center;">PO</th>
                                        <th>Lệnh Sản Xuất</th>
                                        <th>Thông tin</th>
                                        <th>Triển Khai
                                              (pcs)
                                        </th>
                                        <th>Nhập Kho/Sản Xuất
                                            (pcs)
                                        </th>
                                        <th>Ngày
                                            Xuống/Giao</th>
                                        <th>Tổng NG</th>
                                        <th style="text-align: center;">Hao phí</th>
                                        <th>Tỷ lệ nhập kho</th>
                                        <th>Tiến độ</th>
                                        <th>Đóng lệnh</th>
                                        <th>Cảnh báo</th>
                                    </tr>
                                </thead>
                                <tbody style="font-size: 12px;" id="tableBody"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- Không cần Google API Scripts nữa vì sử dụng fetch trực tiếp -->
    <!-- Bootstrap JS Bundle -->
    <script src="https://api.autoslp.com/css/bootstrap.bundle.min.js" integrity="sha384-ENjdO4Dr2bkBIFxQpeoA6DQD1Cj6j6c6b9l+8nt1pV0r1jDD6whzFZC+NcIb2FG+" crossorigin="anonymous"></script>
    <!-- Chart.js (không sử dụng, giữ guard nếu sau dùng) -->
    <script>
      if (typeof Chart === 'undefined') {
        console.warn('Chart.js not found from custom CDN, attempting fallback...');
        var s = document.createElement('script');
        s.src = 'https://api.autoslp.com/css/chart.js';
        document.head.appendChild(s);
      }
    </script>

    <script>
        // Cấu hình Google API
        const GOOGLE_API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
        // Sheet ID của bạn (sẽ được cập nhật sau khi tạo Data Bridge Sheet)
        const SPREADSHEET_ID = '1UuIKiW0soNDv2U08HMhiuTn_Kxrzxlj_Z7GXK7ZM6Ic';
        // Webhook cấu hình
        const WEBHOOK_URL = 'https://api.autoslp.com:5678/webhook-test/bao-cao-lenhsanxuat';

        // DOM Elements
        const loadDataBtn = document.getElementById('loadDataBtn');
        const refreshBtn = document.getElementById('refreshBtn');
        const summaryCards = document.getElementById('summaryCards');
        const tableContainer = document.getElementById('tableContainer');
        const tableBody = document.getElementById('tableBody');
        const totalNhap = document.getElementById('totalNhap');
        const totalXuat = document.getElementById('totalXuat');
        const totalTon = document.getElementById('totalTon');
        let autoRefreshTimer = null;
        let isLoading = false;
        let lastSheetValues = null; // cache raw values
        let currentStatusFilter = null; // 'total'|'alert'|'warning'|'overwaste'|'open'|'closed'|null

        // Gửi webhook cho lần auto-refresh
        function sendWebhook(data) {
            try {
                const payload = {
                    event: 'auto-refresh',
                    timestamp: new Date().toISOString(),
                    ...((typeof data === 'object' && data) || {})
                };
                // Dùng no-cors để hạn chế lỗi CORS phía client
                fetch(WEBHOOK_URL, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload),
                    mode: 'no-cors',
                    keepalive: true
                }).catch(() => {});
            } catch (err) {
                // Bỏ qua lỗi webhook để không ảnh hưởng UI
            }
        }

        // Utils: parse and format dates
        function parseAnyDate(value) {
            if (!value) return null;
            // Accept formats: YYYY-MM-DD, DD/MM/YYYY
            if (/^\d{4}-\d{2}-\d{2}$/.test(value)) {
                const d = new Date(value + 'T00:00:00');
                return isNaN(d.getTime()) ? null : d;
            }
            if (/^\d{2}\/\d{2}\/\d{4}$/.test(value)) {
                const [dd, mm, yyyy] = value.split('/').map(Number);
                const d = new Date(yyyy, mm - 1, dd);
                return isNaN(d.getTime()) ? null : d;
            }
            const d = new Date(value);
            return isNaN(d.getTime()) ? null : d;
        }
        function formatDateDDMMYYYY(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${dd}/${mm}/${yyyy}`;
        }
        function toISODate(dateObj) {
            if (!(dateObj instanceof Date) || isNaN(dateObj)) return '';
            const dd = String(dateObj.getDate()).padStart(2, '0');
            const mm = String(dateObj.getMonth() + 1).padStart(2, '0');
            const yyyy = String(dateObj.getFullYear());
            return `${yyyy}-${mm}-${dd}`;
        }
        function parsePercent(value) {
            if (value === undefined || value === null || value === '') return null;
            const cleaned = String(value).toString().replace('%','').replace(/\s+/g,'').replace(',', '.');
            const n = parseFloat(cleaned);
            if (isNaN(n)) return null;
            return n <= 1 ? n * 100 : n;
        }
        // Parse số theo định dạng VN: chấm là hàng nghìn, phẩy là thập phân
        function parseNumberVN(value) {
            if (value === undefined || value === null || value === '') return 0;
            if (typeof value === 'number') return value;
            const s = String(value).toString().trim().replace(/\./g, '').replace(/,/g, '.');
            const n = parseFloat(s);
            return isNaN(n) ? 0 : n;
        }
        function formatPercent(n) {
            if (n === null || n === undefined || isNaN(n)) return '';
            const v = Math.round(n * 10) / 10; // 1 decimal
            return `${v}%`;
        }

        // Function điều chỉnh font chữ cho loaiLenh dựa trên tên cụ thể
        function formatLenhWithSmallFont(lenhSanXuat, loaiLenh) {
            if (!lenhSanXuat) return '';
            
            if (loaiLenh) {
                let fontSize = '0.5rem'; // mặc định
                
                // Set font size cụ thể cho từng loại lệnh
                switch (loaiLenh) {
                    case 'Mẫu kèm hàng':
                        fontSize = '0.55rem';
                        break;
                    case 'Ghép PO':
                        fontSize = '0.65rem';
                        break;
                    case 'Bù ghép':
                        fontSize = '0.65rem';
                        break;
                    case 'Lắp ráp':
                        fontSize = '0.65rem';
                        break;
                    case 'Bù':
                        fontSize = '0.7rem';
                        break;    
                    default:
                        // Nếu có loại lệnh khác, tính theo độ dài
                        const totalLength = lenhSanXuat.length + loaiLenh.length + 3;
                        if (totalLength > 25) {
                            fontSize = '0.6rem';
                        } else if (totalLength > 20) {
                            fontSize = '0.65rem';
                        }
                }
                
                return `${lenhSanXuat} <span style="font-size: ${fontSize}; color: #6b7280;">(${loaiLenh})</span>`;
            } else {
                return lenhSanXuat;
            }
        }

        // Khởi tạo ứng dụng
        function initializeApp() {
            // Set default date range: last 30 days
            const endInput = document.getElementById('endDate');
            const startInput = document.getElementById('startDate');
            const now = new Date();
            const last30 = new Date(now);
            last30.setDate(now.getDate() - 30);
            if (startInput) startInput.value = toISODate(last30);
            if (endInput) endInput.value = toISODate(now);

            // Tải ngay và thiết lập tự động làm mới mỗi 50 giây
            loadData();
            if (autoRefreshTimer) clearInterval(autoRefreshTimer);
            autoRefreshTimer = setInterval(() => {
                loadData();
                // Gửi webhook mỗi lần auto-refresh
                sendWebhook({ reason: 'interval-50s' });
            }, 50000);
            
            // Thiết lập autocomplete cho khách hàng
            setupKhachHangAutocomplete();
        }

        // Tải dữ liệu từ Google Sheets (Data Bridge Sheet)
        async function loadData() {
            if (isLoading) return; // tránh gọi chồng
            isLoading = true;
            
            try {
                // Sử dụng API trực tiếp với sheet của bạn
                const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/4.%20Nhập%20Xuất%20Tồn!A8:AJ?key=${GOOGLE_API_KEY}`;
                
                const response = await fetch(url);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                
                if (!data.values || data.values.length === 0) return;

                // Xử lý dữ liệu
                lastSheetValues = data.values;
                processData(lastSheetValues);
                
            } catch (error) {
                console.error('Lỗi khi tải dữ liệu:', error);
            }
            finally {
                isLoading = false;
            }
        }

        // Xử lý dữ liệu theo cấu trúc mới - gộp theo PO
        function processData(values) {
            console.log('Dữ liệu nhận được:', values);
            
            // Dữ liệu từ dòng A8:AJ (dòng đầu tiên là header)
            const data = values.slice(1); // Bỏ qua dòng header
            
            // Object để gộp dữ liệu theo PO
            const groupedData = {};
            
            data.forEach((row, index) => {
                if (row.length < 36) return; // Bỏ qua dòng không đủ cột (cần đến cột AJ)
                
                // Mapping theo yêu cầu mới:
                const po = row[34] || '';                    // AI (Số PO)
                const maCode = row[2] || '';                 // C (Mã code SP)
                const tenSanPham = row[3] || '';             // D (Tên sản phẩm)
                const khachHang = row[7] || '';              // H (Khách hàng)
                const lenhSanXuat = row[0] || '';            // A (Lệnh sản xuất)
                const loaiLenh = (row[1] || '').trim();      // B (Loại lệnh)
                const soLuongCanTrienKhai = parseFloat(row[5]) || 0;  // F (SL triển khai)
                const soLuongSanXuat = parseFloat(row[6]) || 0;       // G (SL Cần SX)
                const nhapKho = parseFloat(row[14]) || 0;             // O (NHẬP KHO)
                const tongNG = parseFloat(row[19]) || 0;               // T (Tổng NG)
                const tyLeNhapKhoVal = parsePercent(row[18]);         // S (Tỷ lệ nhập kho)
                const haoPhiThucTeVal = row[20] || '';        // U (Hao phí thực tế)
                const haoPhiChoPhepVal = row[21] || '';       // V (Hao phí cho phép)
                const ngayXuongLenhRaw = row[26] || '';      // AA (Ngày xuống lệnh)
                const ngayGiaoHangRaw = row[35] || '';       // AJ (Ngày giao hàng)
                const ngayDate = parseAnyDate(ngayXuongLenhRaw);
                const ngayISO = ngayDate ? toISODate(ngayDate) : '';
                const ngayDisplay = ngayDate ? formatDateDDMMYYYY(ngayDate) : '';
                const giaoDate = parseAnyDate(ngayGiaoHangRaw);
                const giaoISO = giaoDate ? toISODate(giaoDate) : '';
                const giaoDisplay = giaoDate ? formatDateDDMMYYYY(giaoDate) : '';
                
                // Nếu PO chưa tồn tại, tạo mới
                if (!groupedData[po]) {
                    groupedData[po] = {
                        po: po,
                        lenhSanXuat: [],
                        maCode: maCode,
                        tenSanPham: tenSanPham,
                        khachHang: khachHang,
                        soLuongCanTrienKhai: 0,
                        soLuongSanXuat: 0,
                        nhapKho: 0,
                        tongNG: 0,
                        ngayISO: ngayISO,
                        ngayDisplay: ngayDisplay,
                        haoPhiThucTe: null,
                        haoPhiChoPhep: null,
                        tyLeNhapKho: null,
                        giaoISO: giaoISO,
                        giaoDisplay: giaoDisplay
                    };
                }
                
                // Gộp dữ liệu
                const lenhHienThi = formatLenhWithSmallFont(lenhSanXuat, loaiLenh);
                groupedData[po].lenhSanXuat.push(lenhHienThi);
                // Cập nhật thông tin mô tả (giữ thông tin đầu tiên nếu đã có)
                if (!groupedData[po].maCode && maCode) groupedData[po].maCode = maCode;
                if (!groupedData[po].tenSanPham && tenSanPham) groupedData[po].tenSanPham = tenSanPham;
                if (!groupedData[po].khachHang && khachHang) groupedData[po].khachHang = khachHang;
                groupedData[po].soLuongCanTrienKhai += soLuongCanTrienKhai;
                groupedData[po].soLuongSanXuat += soLuongSanXuat;
                groupedData[po].nhapKho += nhapKho;
                groupedData[po].tongNG += tongNG;
                // Giữ ngày sớm nhất nếu có nhiều bản ghi
                if (ngayISO) {
                    if (!groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    } else if (ngayISO < groupedData[po].ngayISO) {
                        groupedData[po].ngayISO = ngayISO; groupedData[po].ngayDisplay = ngayDisplay;
                    }
                }
                // Ngày giao sớm nhất (ưu tiên ngày sớm hơn)
                if (giaoISO) {
                    if (!groupedData[po].giaoISO) {
                        groupedData[po].giaoISO = giaoISO; groupedData[po].giaoDisplay = giaoDisplay;
                    } else if (giaoISO < groupedData[po].giaoISO) {
                        groupedData[po].giaoISO = giaoISO; groupedData[po].giaoDisplay = giaoDisplay;
                    }
                }
                // Hao phí & tỷ lệ nhập kho (lấy giá trị mới nhất hợp lệ)
                if (haoPhiThucTeVal !== null) {
                    groupedData[po].haoPhiThucTe = haoPhiThucTeVal;
                }
                if (haoPhiChoPhepVal !== null) {
                    groupedData[po].haoPhiChoPhep = haoPhiChoPhepVal;
                }
                if (tyLeNhapKhoVal !== null) {
                    groupedData[po].tyLeNhapKho = tyLeNhapKhoVal;
                }
            });
            
            // Chuyển đổi object thành array và sắp xếp
            let processedData = Object.values(groupedData).filter(item => item.po !== '');
            
            // Thu thập danh sách khách hàng duy nhất cho autocomplete
            window.khachHangList = [...new Set(processedData.map(item => item.khachHang).filter(kh => kh && kh.trim() !== ''))].sort();
            
            let totalNhapValue = 0;
            let totalXuatValue = 0;
            let totalTonValue = 0;
            let totalNGValue = 0;
            let totalOrders = 0;
            let countAlert = 0;        // Lệnh báo động (≤2 ngày)
            let countWarning = 0;      // Lệnh chú ý (3-5 ngày)
            let countOverWaste = 0;    // Vượt hao phí
            let countOpen = 0;         // Chưa đóng
            let countClosed = 0;       // Đã đóng
            
            // Xóa dữ liệu cũ
            tableBody.innerHTML = '';
            
            const poFilter = (document.getElementById('filterPO')?.value || '').trim().toLowerCase();
            const lenhSanXuatFilter = (document.getElementById('filterLenhSanXuat')?.value || '').trim().toLowerCase();
            const khachHangFilter = (document.getElementById('filterKhachHang')?.value || '').trim();
            const startDate = document.getElementById('startDate')?.value;
            const endDate = document.getElementById('endDate')?.value;

            // Lọc theo PO, lệnh sản xuất, khách hàng, trạng thái và khoảng ngày
            if (poFilter) {
                processedData = processedData.filter(i => (i.po || '').toLowerCase().includes(poFilter));
            }
            if (lenhSanXuatFilter) {
                processedData = processedData.filter(i => {
                    // Kiểm tra trong tất cả lệnh sản xuất của PO này
                    return i.lenhSanXuat.some(lenh => lenh.toLowerCase().includes(lenhSanXuatFilter));
                });
            }
            if (khachHangFilter) {
                processedData = processedData.filter(i => (i.khachHang || '').toLowerCase().includes(khachHangFilter.toLowerCase()));
            }
            // Lọc theo trạng thái nếu có
            if (currentStatusFilter) {
                processedData = processedData.filter(i => {
                    const computedTyLe = i.soLuongSanXuat > 0 ? (i.nhapKho / i.soLuongSanXuat) * 100 : null;
                    const progress = (computedTyLe !== null && computedTyLe !== undefined)
                        ? Math.max(0, Math.min(100, Math.round(computedTyLe)))
                        : (i.soLuongCanTrienKhai > 0 ? Math.min(100, Math.round((i.nhapKho / i.soLuongCanTrienKhai) * 100)) : 0);
                    const isClosed = (computedTyLe !== null && computedTyLe !== undefined)
                        ? (computedTyLe >= 100)
                        : (progress >= 100);
                    if (currentStatusFilter === 'closed') return isClosed;
                    if (currentStatusFilter === 'open') return !isClosed;
                    if (currentStatusFilter === 'overwaste') {
                        const t = parseFloat((i.haoPhiThucTe || '').replace(',', '.').replace('%', ''));
                        const p = parseFloat((i.haoPhiChoPhep || '').replace(',', '.').replace('%', ''));
                        return t > 0 && p > 0 && t > p;
                    }
                    if (currentStatusFilter === 'alert' || currentStatusFilter === 'warning') {
                        if (isClosed || !i.giaoISO) return false;
                        const todayISO = toISODate(new Date());
                        const diffMs = (new Date(i.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                        const days = Math.round(diffMs / (24*60*60*1000));
                        if (currentStatusFilter === 'alert') return days <= 2;
                        return days > 2 && days <= 5;
                    }
                    // total
                    return true;
                });
            }
            if (startDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO >= startDate);
            }
            if (endDate) {
                processedData = processedData.filter(i => !i.ngayISO || i.ngayISO <= endDate);
            }

            processedData.forEach((item, index) => {
                // Tính tổng cho summary
                totalNhapValue += item.nhapKho;
                totalXuatValue += item.soLuongCanTrienKhai;
                totalTonValue += item.soLuongSanXuat;
                totalNGValue += item.tongNG;
                totalOrders++; // Tổng số lệnh
                
                // Chuẩn bị các giá trị trước khi đếm/trình bày
                const computedTyLe = item.soLuongSanXuat > 0 ? (item.nhapKho / item.soLuongSanXuat) * 100 : null; // Tỷ lệ nhập kho = Nhập kho / Sản xuất
                const progress = (computedTyLe !== null && computedTyLe !== undefined)
                    ? Math.max(0, Math.min(100, Math.round(computedTyLe)))
                    : (item.soLuongCanTrienKhai > 0 ? Math.min(100, Math.round((item.nhapKho / item.soLuongCanTrienKhai) * 100)) : 0);
                const isClosed = (computedTyLe !== null && computedTyLe !== undefined)
                    ? (computedTyLe >= 100)
                    : (progress >= 100);

                // Đếm thống kê trạng thái mới
                if (isClosed) {
                    countClosed++; // Đã đóng
                } else {
                    countOpen++; // Chưa đóng
                    
                    // Kiểm tra cảnh báo dựa trên ngày giao hàng
                    if (item.giaoISO) {
                    const todayISO = toISODate(new Date());
                    const diffMs = (new Date(item.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                    const days = Math.round(diffMs / (24*60*60*1000));
                    
                        if (days <= 2) {
                            countAlert++; // Báo động (≤2 ngày)
                        } else if (days <= 5) {
                            countWarning++; // Chú ý (3-5 ngày)
                        }
                    }
                }
                
                // Vượt hao phí: có dữ liệu hao phí và thực tế > cho phép
                const haoThucTeForCount = parseFloat((item.haoPhiThucTe || '').replace(',', '.').replace('%', ''));
                const haoChoPhepForCount = parseFloat((item.haoPhiChoPhep || '').replace(',', '.').replace('%', ''));
                if (haoThucTeForCount > 0 && haoChoPhepForCount > 0 && haoThucTeForCount > haoChoPhepForCount) {
                    countOverWaste++;
                }

                // Tạo dòng bảng
                const tr = document.createElement('tr');
                const barClass = progress >= 80 ? 'bar-success' : (progress >= 30 ? 'bar-warning' : 'bar-danger');
                // Cảnh báo (AQ): Đóng lệnh → OK; nếu chưa đóng và ngày giao hàng ≤2 → Báo động; ≤5 → Chú ý; còn lại OK
                let canhBaoHtml = '';
                if (isClosed) {
                    canhBaoHtml = '✅ OK';
                } else if (item.giaoISO) {
                    const today = new Date();
                    const todayISO = toISODate(today);
                    const diffMs = (new Date(item.giaoISO + 'T00:00:00')) - (new Date(todayISO + 'T00:00:00'));
                    const days = Math.round(diffMs / (24*60*60*1000));
                    if (days <= 2) {
                        canhBaoHtml = '🚨 Báo động';
                    } else if (days <= 5) {
                        canhBaoHtml = '⚠️ Chú ý';
                    } else {
                        canhBaoHtml = '✅ OK';
                    }
                } else {
                    canhBaoHtml = '✅ OK';
                }
                const tyLeNhapKhoTxt = formatPercent(computedTyLe);
                const tyLeNhapKhoHtml = computedTyLe !== null && computedTyLe >= 100 ? `<span class="text-good">${tyLeNhapKhoTxt}</span>` : `${tyLeNhapKhoTxt || ''}`;
                const haoThucTe = item.haoPhiThucTe;
                const haoChoPhep = item.haoPhiChoPhep;
                // Chuyển đổi phần trăm thành số để so sánh
                const haoThucTeForDisplay = parseFloat((haoThucTe || '').replace(',', '.').replace('%', ''));
                const haoChoPhepForDisplay = parseFloat((haoChoPhep || '').replace(',', '.').replace('%', ''));
                const hpDotClass = (haoThucTeForDisplay > 0 && haoChoPhepForDisplay > 0 && haoThucTeForDisplay > haoChoPhepForDisplay) ? 'dot-red' : 'dot-green';
                const haoPhiHtml = `
                    <div>
                        <div><span class="dot ${hpDotClass}"></span> ${haoThucTe || ''} <span class="text-muted small">(thực tế)</span></div>
                        <div>${haoChoPhep || ''} <span class="text-muted small">(cho phép)</span></div>
                    </div>`;
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>
                        <div class="fw-semibold">${item.po}</div>
                        <div style="font-size: 8px;" class="text-muted">${item.maCode || ''}</div>
                    </td>
                    <td>${item.lenhSanXuat.join('<br>')}</td>
                    <td>
                        <div class="fw-semibold">${item.tenSanPham || ''}</div>
                        <div style="font-size: 9px;" class="text-muted">${item.khachHang || ''}</div>
                    </td>
                    <td>${item.soLuongCanTrienKhai.toLocaleString()}</td>
                    <td> 
                      <div class="fw-semibold">${item.nhapKho.toLocaleString()} / ${item.soLuongSanXuat.toLocaleString()}</div>
                    </td>
                    <td>
                        <div class="text-muted">${item.ngayDisplay || ''}</div>
                        <div class="text-muted">${item.giaoDisplay || ''}</div>
                    </td>
                    <td>${(item.tongNG || 0).toLocaleString()}</td>
                    <td>${haoPhiHtml}</td>
                    <td>${tyLeNhapKhoHtml}</td>
                    <td>
                        <div class="d-flex align-items-center gap-2">
                            <div style="min-width: 30px;" class="progress-mini flex-grow-1">
                                <div class="bar ${barClass}" style="width:${progress}%"></div>
                            </div>
                            <span class="small text-muted" style="min-width:8px; text-align:right">${progress}%</span>
                        </div>
                    </td>
                    <td>${isClosed ? '<span style="font-weight: 300;font-size: 10px;width: 60px;text-align: center;}" class="pill pill-closed">Đóng lệnh</span>' : ''}</td>
                    <td>${canhBaoHtml}</td>
                `;
                tableBody.appendChild(tr);
            });
            
            // Cập nhật tổng kết
            totalNhap.textContent = totalNhapValue.toLocaleString();
            totalXuat.textContent = totalXuatValue.toLocaleString();
            totalTon.textContent = totalTonValue.toLocaleString();
            const totalNG = document.getElementById('totalNG');
            if (totalNG) totalNG.textContent = totalNGValue.toLocaleString();
            // Bind to dashboard cards
            const elDashTotalNhap = document.getElementById('dashTotalNhap');
            if (elDashTotalNhap) elDashTotalNhap.textContent = totalNhapValue.toLocaleString();
            // Cập nhật thống kê thẻ mới
            const elTotalOrders = document.getElementById('totalOrders');
            const elAlert = document.getElementById('countAlert');
            const elWarning = document.getElementById('countWarning');
            const elOverWaste = document.getElementById('countOverWaste');
            const elOpen = document.getElementById('countOpen');
            const elClosed = document.getElementById('countClosed');
            
            if (elTotalOrders) elTotalOrders.textContent = totalOrders.toLocaleString();
            if (elAlert) elAlert.textContent = countAlert.toLocaleString();
            if (elWarning) elWarning.textContent = countWarning.toLocaleString();
            if (elOverWaste) elOverWaste.textContent = countOverWaste.toLocaleString();
            if (elOpen) elOpen.textContent = countOpen.toLocaleString();
            if (elClosed) elClosed.textContent = countClosed.toLocaleString();
            // Bind to top dashboard right list (legacy - keeping for compatibility)
            const dashOverdue = document.getElementById('dashOverdue');
            if (dashOverdue) dashOverdue.textContent = countAlert.toLocaleString();
            const dashWarning = document.getElementById('dashWarning');
            if (dashWarning) dashWarning.textContent = countWarning.toLocaleString();
            const dashOk = document.getElementById('dashOk');
            if (dashOk) dashOk.textContent = countClosed.toLocaleString();
            const dashOpen = document.getElementById('dashOpen');
            if (dashOpen) dashOpen.textContent = countOpen.toLocaleString();
            const dashClosedPct = document.getElementById('dashClosedPct');
            const closedPct = totalOrders > 0 ? Math.round((countClosed / totalOrders) * 100) : 0;
            if (dashClosedPct) dashClosedPct.textContent = closedPct + '%';
            
            // Hiển thị dữ liệu
            summaryCards.classList.remove('hidden');
            tableContainer.classList.remove('hidden');
            const statusSummary = document.getElementById('statusSummary');
            if (statusSummary) statusSummary.classList.remove('hidden');
            const lastUpdatedEl = document.getElementById('lastUpdated');
            if (lastUpdatedEl) lastUpdatedEl.textContent = new Date().toLocaleString();
        }

        // (Đã bỏ status UI)

        // Lọc nhanh và Export CSV
        document.addEventListener('input', (e) => {
            if (e.target && (e.target.id === 'filterPO' || e.target.id === 'filterLenhSanXuat' || e.target.id === 'filterKhachHang' || e.target.id === 'startDate' || e.target.id === 'endDate')) {
                // render lại dựa trên dữ liệu lần tải gần nhất
                // Đơn giản: gọi loadData() lại (có thể cải thiện bằng cache)
                if (lastSheetValues) {
                    processData(lastSheetValues);
                } else {
                    loadData();
                }
            }
        });
        document.getElementById('clearFilterBtn')?.addEventListener('click', () => {
            const f = document.getElementById('filterPO');
            const l = document.getElementById('filterLenhSanXuat');
            const k = document.getElementById('filterKhachHang');
            const s = document.getElementById('startDate');
            const e = document.getElementById('endDate');
            if (f) f.value = '';
            if (l) l.value = '';
            if (k) k.value = '';
            if (s) s.value = '';
            if (e) e.value = '';
            currentStatusFilter = null;
            document.querySelectorAll('.stat-card[data-status]').forEach(el => el.classList.remove('active'));
            if (lastSheetValues) {
                processData(lastSheetValues);
            } else {
                loadData();
            }
        });

        document.getElementById('exportCsvBtn')?.addEventListener('click', () => {
            const rows = [];
            const header = ['STT','PO','Lệnh Sản Xuất','Thông tin','SL Cần Triển Khai','Nhập Kho/Sản Xuất','Ngày Xuống/Giao','Tổng NG','Hao phí','Tỷ lệ nhập kho','Tiến độ','Đóng lệnh','Cảnh báo'];
            rows.push(header.join(','));
            const trs = document.querySelectorAll('#tableBody tr');
            trs.forEach(tr => {
                const tds = Array.from(tr.querySelectorAll('td')).map(td => '"' + td.innerText.replace(/"/g,'""') + '"');
                rows.push(tds.join(','));
            });
            const blob = new Blob([rows.join('\n')], {type: 'text/csv;charset=utf-8;'});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url; a.download = 'bao_cao_po.csv';
            document.body.appendChild(a); a.click(); a.remove();
            URL.revokeObjectURL(url);
        });

        // Autocomplete cho khách hàng
        function setupKhachHangAutocomplete() {
            const input = document.getElementById('filterKhachHang');
            const suggestions = document.getElementById('khachHangSuggestions');
            let currentIndex = -1;
            
            if (!input || !suggestions) return;
            
            function showSuggestions(query) {
                if (!window.khachHangList || !query.trim()) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                const filtered = window.khachHangList.filter(khachHang => 
                    khachHang.toLowerCase().includes(query.toLowerCase())
                );
                
                if (filtered.length === 0) {
                    suggestions.style.display = 'none';
                    return;
                }
                
                suggestions.innerHTML = '';
                filtered.forEach((khachHang, index) => {
                    const item = document.createElement('div');
                    item.className = 'suggestion-item';
                    item.textContent = khachHang;
                    item.addEventListener('click', () => {
                        input.value = khachHang;
                        suggestions.style.display = 'none';
                        loadData();
                    });
                    suggestions.appendChild(item);
                });
                
                suggestions.style.display = 'block';
                currentIndex = -1;
            }
            
            function hideSuggestions() {
                setTimeout(() => {
                    suggestions.style.display = 'none';
                }, 200);
            }
            
            function highlightItem(index) {
                const items = suggestions.querySelectorAll('.suggestion-item');
                items.forEach((item, i) => {
                    item.classList.toggle('highlighted', i === index);
                });
            }
            
            input.addEventListener('input', (e) => {
                showSuggestions(e.target.value);
            });
            
            input.addEventListener('keydown', (e) => {
                const items = suggestions.querySelectorAll('.suggestion-item');
                
                if (e.key === 'ArrowDown') {
                    e.preventDefault();
                    currentIndex = Math.min(currentIndex + 1, items.length - 1);
                    highlightItem(currentIndex);
                } else if (e.key === 'ArrowUp') {
                    e.preventDefault();
                    currentIndex = Math.max(currentIndex - 1, -1);
                    highlightItem(currentIndex);
                } else if (e.key === 'Enter') {
                    e.preventDefault();
                    if (currentIndex >= 0 && items[currentIndex]) {
                        input.value = items[currentIndex].textContent;
                        suggestions.style.display = 'none';
                        loadData();
                    }
                } else if (e.key === 'Escape') {
                    suggestions.style.display = 'none';
                    currentIndex = -1;
                }
            });
            
            input.addEventListener('blur', hideSuggestions);
            input.addEventListener('focus', (e) => {
                if (e.target.value.trim()) {
                    showSuggestions(e.target.value);
                }
            });
        }

        // Event Listeners
        loadDataBtn.addEventListener('click', loadData);
        refreshBtn.addEventListener('click', loadData);

        // Click handlers for whole status cards
        document.addEventListener('click', (e) => {
            const card = e.target.closest('.stat-card[data-status]');
            if (!card) return;
            const status = card.getAttribute('data-status');
            // toggle behavior: clicking same active eye clears filter
            if (currentStatusFilter === status) {
                currentStatusFilter = null;
                card.classList.remove('active');
            } else {
                currentStatusFilter = status;
                document.querySelectorAll('.stat-card[data-status]').forEach(el => el.classList.remove('active'));
                card.classList.add('active');
            }
            if (lastSheetValues) {
                processData(lastSheetValues);
            } else {
                loadData();
            }
        });

        // Khởi tạo ứng dụng khi trang load
        window.addEventListener('load', initializeApp);
    </script>
</body>
</html>
