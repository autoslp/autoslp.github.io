<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Yêu Cầu Sửa Chữa Máy - Phòng Cơ Điện</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      /* padding-top: 2rem; */
      padding-bottom: 2rem;
    }

    .form-container {
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0,0,0,0.15);
      position: relative;
      padding: 2.5rem;
      margin-top: 3rem;
    }

    .form-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .form-icon i {
      font-size: 2rem;
      color: #333;
    }

    .form-title {
      margin-top: 2rem;
      margin-bottom: 2rem;
      color: #333;
      font-weight: 600;
      text-align: center;
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn-submit {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      color: #333;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn-submit:hover {
      background: linear-gradient(135deg, #e0a800, #d39e00);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .btn-submit:disabled {
      opacity: 0.7;
      transform: none;
    }

    .auto-field {
      background-color: #f8f9fa;
      color: #6c757d;
    }

    .file-upload-area {
      border: 2px dashed #dee2e6;
      border-radius: 8px;
      padding: 2rem;
      text-align: center;
      transition: all 0.3s ease;
      cursor: pointer;
    }

    .file-upload-area:hover {
      border-color: #007bff;
      background-color: #f8f9fa;
    }

    .file-upload-area.dragover {
      border-color: #007bff;
      background-color: #e3f2fd;
    }

    /* Ẩn 4 thẻ đầu form */
    #sttDisplay, #thoigianyeucauDisplay, #nguoiyeucau, #quanlyxacnhan,
    label[for="stt"], label[for="thoigianyeucau"], label[for="nguoiyeucau"], label[for="quanlyxacnhan"],
    input#stt, input#thoigianyeucau, input#nguoiyeucau, input#quanlyxacnhan {
      display: none !important;
    }

    /* Ẩn luôn phần text 'STT (ID Công việc):' bằng cách thêm class hoặc id cho div chứa label này và áp dụng display: none cho cả label và div bao ngoài. */
    #row-stt-thoigian,
    #col-stt, #col-thoigian,
    #sttDisplay, #thoigianyeucauDisplay, #nguoiyeucau, #quanlyxacnhan,
    label[for="stt"], label[for="thoigianyeucau"], label[for="nguoiyeucau"], label[for="quanlyxacnhan"],
    input#stt, input#thoigianyeucau, input#nguoiyeucau, input#quanlyxacnhan {
      display: none !important;
    }

    @media (max-width: 768px) {
      .form-container {
        margin: 1rem;
        padding: 1.5rem;
        border-radius: 10px;
      }
      
      .form-icon {
        width: 60px;
        height: 60px;
        top: -30px;
      }
      
      .form-icon i {
        font-size: 1.5rem;
      }
      
      .form-title {
        font-size: 1.25rem;
        margin-top: 1.5rem;
      }
    }

    @media (max-width: 576px) {
      body {
        padding-top: 1rem;
      }
      
      .form-container {
        margin: 0.5rem;
        padding: 1rem;
      }
      
      .form-title {
        font-size: 1.1rem;
      }
    }

    /* Header User Info Styling */
    .header-user-info {
      background: rgba(255, 255, 255, 0.18);
      backdrop-filter: blur(8px);
      border-radius: 22px;
      padding: 4px 12px;
      margin-top: 10px;
      border: 1px solid rgba(255, 255, 255, 0.18);
      transition: all 0.3s ease;
      display: flex;
      align-items: center;
      gap: 10px;
      min-height: 40px;
      max-width: 420px;
      margin-left: auto;
      margin-right: auto;
    }
    .header-user-info:hover {
      background: rgba(255, 255, 255, 0.22);
      transform: translateY(-1px);
    }
    .user-avatar {
      width: 30px;
      height: 30px;
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      font-weight: 700;
      font-size: 15px;
      box-shadow: 0 1px 4px rgba(255, 193, 7, 0.18);
      flex-shrink: 0;
    }
    .user-name {
      color: white;
      font-weight: 600;
      font-size: 13px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.13);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      max-width: 180px;
    }
    .logout-btn {
      background: transparent;
      border: 1px solid white;
      border-radius: 12px;
      padding: 4px 10px;
      color: white;
      font-weight: 500;
      font-size: 12px;
      transition: all 0.3s ease;
      margin-left: auto;
    }
    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.13);
      color: white;
    }
    .logout-btn:active {
      transform: scale(0.97);
    }
    @media (max-width: 768px) {
      .header-user-info {
        padding: 4px 8px;
        border-radius: 12px;
        min-height: 36px;
        max-width: 98vw;
        gap: 6px;
      }
      .user-avatar {
        width: 26px;
        height: 26px;
        font-size: 13px;
      }
      .user-name {
        font-size: 12px;
        max-width: 90px;
      }
      .logout-btn {
        padding: 4px 8px;
        font-size: 11px;
        border-radius: 10px;
      }
    }
    .header-section {
      padding: 0.6rem 0 0.7rem 0 !important;
      margin-bottom: 0.7rem !important;
      border-radius: 15px;
      text-align: center;
    }
    .header-section h1 {
      font-size: 1.35rem !important;
      margin-bottom: 0.1rem !important;
    }
    .header-section .btn, .header-section button, .header-section a {
      font-size: 0.95rem !important;
      padding: 0.25rem 0.7rem !important;
    }
  </style>
</head>
  <body>
    <script>
      // Hàm hiển thị popup đăng nhập mới
      function showLoginPopup() {
        let popup = document.getElementById('loginPopup');
        if (!popup) {
          popup = document.createElement('div');
          popup.id = 'loginPopup';
          popup.style.position = 'fixed';
          popup.style.top = '0';
          popup.style.left = '0';
          popup.style.width = '100vw';
          popup.style.height = '100vh';
          popup.style.background = 'rgba(0,0,0,0.25)';
          popup.style.display = 'flex';
          popup.style.alignItems = 'center';
          popup.style.justifyContent = 'center';
          popup.style.zIndex = '9999';
          popup.innerHTML = `
            <div class="login-modal">
              <div class="login-header">
                <i class="bi bi-person-circle login-icon"></i>
                <h4>Đăng nhập nhân viên</h4>
              </div>
              <form id="loginForm" autocomplete="off">
                <div class="mb-3">
                  <label for="usercode" class="form-label">Mã nhân viên</label>
                  <input type="text" class="form-control" id="usercode" required autofocus autocomplete="off">
                </div>
                <div class="mb-3">
                  <label for="password" class="form-label">Mật khẩu</label>
                  <input type="password" class="form-control" id="password" required autocomplete="off">
                </div>
                <div class="mb-2" id="userNameDisplay" style="font-weight:600;color:#007bff;"></div>
                <button type="submit" class="btn btn-primary w-100" id="loginBtn">
                  <i class="bi bi-box-arrow-in-right me-1"></i>Đăng nhập
                </button>
                <div id="loginError" class="text-danger mt-2" style="display:none;"></div>
              </form>
            </div>
            <style>
              .login-modal {
                background: #fff;
                border-radius: 18px;
                box-shadow: 0 8px 32px rgba(0,0,0,0.18);
                padding: 36px 28px 28px 28px;
                min-width: 340px;
                max-width: 95vw;
                animation: popupFadeIn 0.4s;
                position: relative;
              }
              .login-header {
                text-align: center;
                margin-bottom: 18px;
              }
              .login-icon {
                font-size: 3rem;
                color: #6a5acd;
                margin-bottom: 8px;
              }
              #loginForm .form-control {
                border-radius: 10px;
                border: 2px solid #e9ecef;
                font-size: 1.1rem;
              }
              #loginForm .form-control:focus {
                border-color: #6a5acd;
                box-shadow: 0 0 0 0.15rem rgba(106,90,205,0.15);
              }
              #loginBtn {
                border-radius: 10px;
                font-weight: 600;
                background: linear-gradient(135deg, #6a5acd, #ffc107);
                border: none;
              }
              #loginBtn:hover {
                background: linear-gradient(135deg, #ffc107, #6a5acd);
              }
              @keyframes popupFadeIn {
                from { transform: scale(0.95); opacity: 0; }
                to { transform: scale(1); opacity: 1; }
              }
            </style>
          `;
          document.body.appendChild(popup);
        }
        popup.style.display = 'flex';
        document.body.style.overflow = 'hidden';
      }

      function hideLoginPopup() {
        let popup = document.getElementById('loginPopup');
        if (popup) popup.style.display = 'none';
        document.body.style.overflow = '';
      }

      // Lấy danh sách mã nhân viên, tên, mật khẩu từ Google Sheets
      let userList = [];
      async function fetchUserListWithPassword() {
        try {
          const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
          const SHEET_ID = '18ZLZbC8RjCvSyk_sLBvh3obi-_4TzgIlrDX09LkBXyo';
          const RANGE = 'Data!J2:O100';
          const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
          const response = await fetch(url);
          const data = await response.json();
          if (data.values) {
            userList = data.values.map(row => ({
              code: row[0]?.trim(),
              name: row[1]?.trim(),
              password: row[5]?.trim() // cột O là index 5 (J=0, K=1, L=2, M=3, N=4, O=5)
            }));
          }
        } catch (e) { userList = []; }
      }

      // Kiểm tra đăng nhập
      async function checkLogin() {
        if (!localStorage.getItem('slp_user') || !localStorage.getItem('slp_name')) {
          await fetchUserListWithPassword();
          showLoginPopup();
          setTimeout(() => {
            const userInput = document.getElementById('usercode');
            const passInput = document.getElementById('password');
            const nameDisplay = document.getElementById('userNameDisplay');
            userInput.addEventListener('input', function() {
              const val = userInput.value.trim();
              const found = userList.find(u => u.code && u.code.toUpperCase() === val.toUpperCase());
              if (found) {
                nameDisplay.textContent = found.name;
                nameDisplay.style.color = '#007bff';
              } else {
                nameDisplay.textContent = '';
              }
            });
            document.getElementById('loginForm').addEventListener('submit', function(e) {
              e.preventDefault();
              const val = userInput.value.trim();
              const pass = passInput.value.trim();
              const found = userList.find(u => u.code && u.code.toUpperCase() === val.toUpperCase());
              if (found && found.password === pass) {
                localStorage.setItem('slp_user', found.code);
                localStorage.setItem('slp_name', found.name);
                hideLoginPopup();
                window.location.reload();
              } else {
                document.getElementById('loginError').textContent = 'Mã nhân viên hoặc mật khẩu không đúng!';
                document.getElementById('loginError').style.display = '';
              }
            });
          }, 300);
        } else {
          hideLoginPopup();
        }
      }
      // Đăng xuất
      function logoutSLP() {
        localStorage.removeItem('slp_user');
        localStorage.removeItem('slp_name');
        window.location.reload();
      }
      // Hiển thị tên nhân viên đã đăng nhập
      function showUserInfo() {
        // Nếu đã đăng nhập thì hiện nút Đăng xuất
        if (localStorage.getItem('slp_user') && localStorage.getItem('slp_name')) {
          document.getElementById('logoutBtnHeader').style.display = '';
        } else {
          document.getElementById('logoutBtnHeader').style.display = 'none';
        }
      }
      window.addEventListener('DOMContentLoaded', async function() {
        await checkLogin();
        showUserInfo();
      });
    </script>
    <!-- Header giống work-list.html -->
    <!-- Đã xóa header-section -->

    <div class="container mt-4">
      <div class="row justify-content-center">
        <div class="col-12 col-md-10 col-lg-8">
          <div class="form-container">
            <div class="form-icon">
              <i class="bi bi-tools"></i>
            </div>
            <div class="d-flex justify-content-center mt-3">
              <a href="home.html" class="btn btn-light btn-sm text-dark fw-semibold">
                <i class="bi bi-house-fill me-1"></i>Trang Chủ
              </a>
            </div>
            
            <h2 class="form-title">YÊU CẦU SỬA CHỮA MÁY - PHÒNG CƠ ĐIỆN SLP</h2>
            
            <form id="workForm" onsubmit="submitForm(event)">
            <!-- STT và Thời gian yêu cầu trên cùng một hàng -->
            <div class="row mb-3" id="row-stt-thoigian">
              <div class="col-md-6" id="col-stt">
                <label class="form-label">STT (ID Công việc):</label>
                <div id="sttDisplay" class="form-control auto-field">CD-0001</div>
                <input type="hidden" id="stt" name="stt" value="CD-0001">
              </div>
              <div class="col-md-6" id="col-thoigian">
                <label for="thoigianyeucau" class="form-label">Thời gian yêu cầu:</label>
                <div id="thoigianyeucauDisplay" class="form-control auto-field">10/07/2025 12:30 AM</div>
                <input type="hidden" id="thoigianyeucau" name="thoigianyeucau" value="10/07/2025 12:30 AM">
              </div>
            </div>
            
            <!-- Khu vực và Máy trên cùng một dòng -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="khuvuc" class="form-label">Khu vực:</label>
                <select class="form-select" id="khuvuc" name="khuvuc" required>
                  <option value="">-- Chọn khu vực --</option>
                </select>
              </div>
              <div class="col-md-6">
                <label for="may" class="form-label">Máy:</label>
                <select class="form-select" id="may" name="may" required>
                  <option value="">-- Chọn máy --</option>
                </select>
              </div>
            </div>
            
            <!-- Hiện trạng lỗi -->
            <div class="mb-3">
              <label for="hientrangloi" class="form-label">Hiện trạng lỗi:</label>
              <textarea class="form-control" id="hientrangloi" name="hientrangloi" rows="3" 
                        placeholder="Mô tả chi tiết hiện trạng lỗi của máy" required></textarea>
            </div>
            
            <!-- Người yêu cầu và Quản lý xác nhận trên cùng một dòng -->
            <div class="row mb-3">
              <div class="col-md-6">
                <label for="nguoiyeucau" class="form-label">Người yêu cầu:</label>
                <input type="text" class="form-control auto-field" id="nguoiyeucau" name="nguoiyeucau" readonly>
              </div>
              <div class="col-md-6">
                <label for="quanlyxacnhan" class="form-label">Quản lý xác nhận:</label>
                <input type="text" class="form-control auto-field" id="quanlyxacnhan" name="quanlyxacnhan" readonly>
              </div>
            </div>
            
            <!-- Hình ảnh -->
            <div class="mb-4">
              <label for="hinhanh" class="form-label">Hình ảnh:</label>
              <div class="file-upload-area" onclick="document.getElementById('hinhanh').click()">
                <i class="bi bi-cloud-upload fs-1 text-muted mb-3"></i>
                <p class="mb-2">Nhấp để chọn hình ảnh hoặc kéo thả file vào đây</p>
                <p class="text-muted small">Hỗ trợ: JPG, PNG, GIF (Tối đa 5MB)</p>
                <input type="file" class="d-none" id="hinhanh" name="hinhanh" 
                       accept="image/*" multiple onchange="handleFileSelect(this)">
              </div>
              <div id="filePreview" class="mt-3"></div>
            </div>
            
            <!-- Submit button -->
            <button type="submit" class="btn btn-submit" id="submitBtn">
              <i class="bi bi-send me-2"></i>Gửi yêu cầu
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Google Apps Script URL
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbxJNkqD-S_lUfG3izhoW4AD5SS6eDQH9Khm_BiLp_Vwu13gulpqhsapaGDpo2tLlB7s/exec';
    
    // Google Sheets API để đọc dữ liệu công khai
    const SHEET_ID = '18ZLZbC8RjCvSyk_sLBvh3obi-_4TzgIlrDX09LkBXyo';
    const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
    const RANGE = 'Tonghop!A3:A100'; // Đọc cột A từ dòng 3 đến 100
    
    // Danh sách nhân viên mặc định (fallback)
    const DEFAULT_EMPLOYEES = [
      'Mr Mạnh', 'Mr Chính', 'Mr Đạt', 'Mr Dũng', 'Mr Quân', 
      'Mr Đại', 'Mr Hoàng Anh', 'Mr Hoàng', 'Mr Công'
    ];

    // Thông tin Google Sheet cho khu vực và máy
    const DATA_SHEET_ID = SHEET_ID; // Dùng chung file
    const DATA_RANGE = 'Data!A2:H50';
    const NGUOIYEUCAU_RANGE = 'Data!K2:K100';
    const QUANLYXACNHAN_RANGE = 'Data!L2:L100';

    // Load danh sách nhân viên khi trang được tải
    document.addEventListener('DOMContentLoaded', function() {
      generateNextSTT();
      loadKhuVucAndMay();
      // Tự động điền Người yêu cầu và Quản lý xác nhận
      autoFillNguoiYeuCauVaQuanLy();
      // Hiển thị thời gian hiện tại khi mở form
      const now = new Date();
      const timeString = now.toLocaleString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('thoigianyeucau').value = timeString;
      document.getElementById('thoigianyeucauDisplay').textContent = timeString;
    });

    // Hàm tạo STT tự động theo dữ liệu thực tế trên Google Sheet
    async function generateNextSTT() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        console.log('DATA GOOGLE SHEET:', data);

        let maxNumber = 0;
        if (data.values && data.values.length > 0) {
          data.values.forEach(row => {
            const id = row[0];
            if (id && /^CD-\d{4}$/.test(id)) {
              const num = parseInt(id.slice(3), 10);
              if (num > maxNumber) maxNumber = num;
            }
          });
        }
        const nextNumber = (maxNumber + 1).toString().padStart(4, '0');
        const nextID = `CD-${nextNumber}`;
        document.getElementById('stt').value = nextID;
        document.getElementById('sttDisplay').textContent = nextID;
      } catch (error) {
        console.error('Lỗi khi tạo STT:', error);
        const now = new Date();
        const timestamp = now.getTime().toString().slice(-4);
        const stt = `CD-${timestamp}`;
        document.getElementById('stt').value = stt;
        document.getElementById('sttDisplay').textContent = stt;
      }
    }

    // Hàm load danh sách Người yêu cầu từ cột K sheet Data
    async function loadNguoiYeuCau() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${DATA_SHEET_ID}/values/${NGUOIYEUCAU_RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        let employees = [];
        if (data.values && data.values.length > 0) {
          employees = data.values
            .map(row => row[0])
            .filter(name => name && name.toString().trim() !== '')
            .map(name => name.toString().trim())
            .filter((name, index, array) => array.indexOf(name) === index)
            .sort();
        }
        const select = document.getElementById('nguoiyeucau');
        select.innerHTML = '<option value="">-- Chọn người yêu cầu --</option>';
        employees.forEach(employee => {
          const option = document.createElement('option');
          option.value = employee;
          option.textContent = employee;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Lỗi khi load Người yêu cầu:', error);
      }
    }

    // Hàm load danh sách Quản lý xác nhận từ cột L sheet Data
    async function loadQuanLyXacNhan() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${DATA_SHEET_ID}/values/${QUANLYXACNHAN_RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        let managers = [];
        if (data.values && data.values.length > 0) {
          managers = data.values
            .map(row => row[0])
            .filter(name => name && name.toString().trim() !== '')
            .map(name => name.toString().trim())
            .filter((name, index, array) => array.indexOf(name) === index)
            .sort();
        }
        const select = document.getElementById('quanlyxacnhan');
        select.innerHTML = '<option value="">-- Chọn quản lý xác nhận --</option>';
        managers.forEach(manager => {
          const option = document.createElement('option');
          option.value = manager;
          option.textContent = manager;
          select.appendChild(option);
        });
      } catch (error) {
        console.error('Lỗi khi load Quản lý xác nhận:', error);
      }
    }

    // Hàm load khu vực và máy
    async function loadKhuVucAndMay() {
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${DATA_SHEET_ID}/values/${DATA_RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        if (!data.values || data.values.length < 1) return;
        const header = data.values[0]; // A2:H2
        const columns = [];
        for (let i = 0; i < header.length; i++) {
          columns.push({
            name: header[i],
            values: data.values.slice(1).map(row => row[i]).filter(v => v && v.trim() !== '')
          });
        }
        // Đổ khu vực vào select
        const khuvucSelect = document.getElementById('khuvuc');
        khuvucSelect.innerHTML = '<option value="">-- Chọn khu vực --</option>';
        columns.forEach(col => {
          if (col.name && col.name.trim() !== '') {
            const option = document.createElement('option');
            option.value = col.name.trim();
            option.textContent = col.name.trim();
            khuvucSelect.appendChild(option);
          }
        });
        // Khi chọn khu vực thì load máy tương ứng
        khuvucSelect.onchange = function() {
          const selected = khuvucSelect.value;
          const col = columns.find(c => c.name === selected);
          const maySelect = document.getElementById('may');
          maySelect.innerHTML = '<option value="">-- Chọn máy --</option>';
          if (col) {
            col.values.forEach(may => {
              const option = document.createElement('option');
              option.value = may;
              option.textContent = may;
              maySelect.appendChild(option);
            });
          }
        };
      } catch (e) {
        console.error('Lỗi load khu vực/máy:', e);
      }
    }

    // Xử lý file upload
    function handleFileSelect(input) {
      const files = input.files;
      const preview = document.getElementById('filePreview');
      preview.innerHTML = '';

      for (let i = 0; i < files.length; i++) {
        const file = files[i];
        if (file.type.startsWith('image/')) {
          const reader = new FileReader();
          reader.onload = function(e) {
            const div = document.createElement('div');
            div.className = 'col-md-3 mb-2';
            div.innerHTML = `
              <div class="card">
                <img src="${e.target.result}" class="card-img-top" style="height: 100px; object-fit: cover;">
                <div class="card-body p-2">
                  <small class="text-muted">${file.name}</small>
                </div>
              </div>
            `;
            preview.appendChild(div);
          };
          reader.readAsDataURL(file);
        }
      }
    }

    // Drag and drop functionality
    const uploadArea = document.querySelector('.file-upload-area');
    
    uploadArea.addEventListener('dragover', function(e) {
      e.preventDefault();
      this.classList.add('dragover');
    });
    
    uploadArea.addEventListener('dragleave', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
    });
    
    uploadArea.addEventListener('drop', function(e) {
      e.preventDefault();
      this.classList.remove('dragover');
      
      const files = e.dataTransfer.files;
      document.getElementById('hinhanh').files = files;
      handleFileSelect(document.getElementById('hinhanh'));
    });

    function submitForm(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalHTML = submitBtn.innerHTML;
      
      // Cập nhật thời gian yêu cầu
      const now = new Date();
      const timeString = now.toLocaleString('vi-VN', {
        year: 'numeric',
        month: '2-digit',
        day: '2-digit',
        hour: '2-digit',
        minute: '2-digit',
        second: '2-digit'
      });
      document.getElementById('thoigianyeucau').value = timeString;
      document.getElementById('thoigianyeucauDisplay').textContent = timeString;
      
      // Hiển thị trạng thái đang gửi
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Đang lưu...';
      submitBtn.disabled = true;
      
      // Lấy dữ liệu từ form theo cấu trúc 23 cột
      const formData = new FormData(document.getElementById('workForm'));
      const data = {
        stt: formData.get('stt'),
        khuvuc: formData.get('khuvuc'),
        may: formData.get('may'),
        thoigianyeucau: formData.get('thoigianyeucau'),
        hientrangloi: formData.get('hientrangloi'),
        nguoiyeucau: formData.get('nguoiyeucau'),
        quanlyxacnhan: formData.get('quanlyxacnhan'),
        quanlyxacnhan2: '', // Để trống
        hinhanh: 'Có hình ảnh đính kèm',
        hangmuc: '', // Để trống - sẽ điền sau
        phanloai: '', // Để trống - sẽ điền sau
        vitri: '', // Để trống - sẽ điền sau
        hientrang: 'Chờ xử lý', // Trạng thái mặc định
        nguyennhan: '', // Để trống - sẽ điền sau
        phuonganhxuly: '', // Để trống - sẽ điền sau
        vattuthaythe: '', // Để trống - sẽ điền sau
        thoigianbangiao: '', // Để trống - sẽ điền sau
        losstime: '', // Để trống - sẽ điền sau
        ketqua: '', // Để trống - sẽ điền sau
        sxxacnhan: '', // Để trống - sẽ điền sau
        thuchienboy1: '', // Để trống - sẽ điền sau
        thuchienboy2: '', // Để trống - sẽ điền sau
        qlxacnhan: '', // Để trống - sẽ điền sau
        ghichu: ''
      };
      
      // Gửi dữ liệu đến Google Sheets
      fetch('https://script.google.com/macros/s/AKfycbxJNkqD-S_lUfG3izhoW4AD5SS6eDQH9Khm_BiLp_Vwu13gulpqhsapaGDpo2tLlB7s/exec', {
        method: 'POST',
        mode: 'no-cors', // Nếu chạy từ file:// hoặc localhost
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(() => {
        // Reset form và nút về trạng thái ban đầu
        document.getElementById('workForm').reset();
        document.getElementById('filePreview').innerHTML = '';
        if (typeof generateNextSTT === 'function') generateNextSTT();
        submitBtn.innerHTML = originalHTML;
        submitBtn.classList.remove('btn', 'btn-success', 'btn-danger');
        submitBtn.classList.add('btn-submit');
        submitBtn.disabled = false;

        // Hiện popup/thông báo
        const popup = document.createElement('div');
        popup.innerHTML = `
          <div style="
            position: fixed; top: 0; left: 0; width: 100vw; height: 100vh;
            background: rgba(0,0,0,0.25); display: flex; align-items: center; justify-content: center; z-index: 9999;">
            <div style="background: #fffbe6; color: #856404; border-radius: 12px; padding: 32px 40px; font-size: 1.3rem; font-weight: 600; box-shadow: 0 2px 16px #0002;">
              <i class="bi bi-check-circle-fill me-2" style="color:#28a745;font-size:2rem;vertical-align:middle"></i>
              Đã lưu thành công!<br><span style="font-size:1rem;font-weight:400;">Đang chuyển sang danh sách công việc...</span>
            </div>
          </div>
        `;
        document.body.appendChild(popup);

        setTimeout(() => {
          window.location.href = 'congviec.html';
        }, 2000);
      })
      .catch(() => {
        // Reset nút về trạng thái ban đầu (nếu có lỗi)
        submitBtn.innerHTML = originalHTML;
        submitBtn.classList.remove('btn', 'btn-success', 'btn-danger');
        submitBtn.classList.add('btn-submit');
        submitBtn.disabled = false;
      });
    }

    // Tự động điền Người yêu cầu và Quản lý xác nhận
    async function autoFillNguoiYeuCauVaQuanLy() {
      // Điền tên nhân viên đăng nhập
      const userName = localStorage.getItem('slp_name') || '';
      const userCode = localStorage.getItem('slp_user') || '';
      document.getElementById('nguoiyeucau').value = userName;

      // Lấy thông tin quản lý từ Google Sheets
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/Data!J2:M100?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.values) {
          const found = data.values.find(row => row[0] && row[0].toUpperCase() === userCode.toUpperCase());
          if (found && found[2]) {
            document.getElementById('quanlyxacnhan').value = found[2];
          } else {
            document.getElementById('quanlyxacnhan').value = '';
          }
        }
      } catch (e) {
        document.getElementById('quanlyxacnhan').value = '';
      }
    }
  </script>
</body>
</html>
