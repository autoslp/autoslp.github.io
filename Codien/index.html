<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Form Công Việc Phòng Cơ Điện</title>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
  
  <style>
    body {
      background-color: #e6ebf1;
      background-image: url("https://www.transparenttextures.com/patterns/graphy.png");
      min-height: 100vh;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }

    .form-container {
      background-color: #fff;
      border-radius: 15px;
      box-shadow: 0 0 30px rgba(0,0,0,0.15);
      position: relative;
      padding: 2.5rem;
      margin-top: 3rem;
    }

    .form-icon {
      width: 80px;
      height: 80px;
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border-radius: 50%;
      display: flex;
      justify-content: center;
      align-items: center;
      position: absolute;
      top: -40px;
      left: 50%;
      transform: translateX(-50%);
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .form-icon i {
      font-size: 2rem;
      color: #333;
    }

    .form-title {
      margin-top: 2rem;
      margin-bottom: 2rem;
      color: #333;
      font-weight: 600;
      text-align: center;
    }

    .form-label {
      font-weight: 600;
      color: #333;
      margin-bottom: 0.5rem;
    }

    .form-control, .form-select {
      border: 2px solid #e9ecef;
      border-radius: 8px;
      padding: 0.75rem 1rem;
      transition: all 0.3s ease;
    }

    .form-control:focus, .form-select:focus {
      border-color: #007bff;
      box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    }

    .btn-submit {
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border: none;
      border-radius: 8px;
      padding: 0.75rem 2rem;
      font-weight: 600;
      color: #333;
      transition: all 0.3s ease;
      width: 100%;
    }

    .btn-submit:hover {
      background: linear-gradient(135deg, #e0a800, #d39e00);
      transform: translateY(-2px);
      box-shadow: 0 4px 15px rgba(255, 193, 7, 0.3);
    }

    .btn-submit:disabled {
      opacity: 0.7;
      transform: none;
    }

    .date-label {
      font-weight: 600;
      color: #333;
      font-size: 0.9rem;
      margin-bottom: 0.25rem;
    }

    @media (max-width: 768px) {
      .form-container {
        margin: 1rem;
        padding: 1.5rem;
        border-radius: 10px;
      }
      
      .form-icon {
        width: 60px;
        height: 60px;
        top: -30px;
      }
      
      .form-icon i {
        font-size: 1.5rem;
      }
      
      .form-title {
        font-size: 1.25rem;
        margin-top: 1.5rem;
      }
    }

    @media (max-width: 576px) {
      body {
        padding-top: 1rem;
      }
      
      .form-container {
        margin: 0.5rem;
        padding: 1rem;
      }
      
      .form-title {
        font-size: 1.1rem;
      }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="row justify-content-center">
      <div class="col-12 col-md-8 col-lg-6">
        <div class="form-container">
          <div class="form-icon">
            <i class="bi bi-gear-fill"></i>
          </div>
          
          <h2 class="form-title">THÔNG TIN CÔNG VIỆC PHÒNG CƠ ĐIỆN SLP</h2>
          
          <form id="workForm" onsubmit="submitForm(event)">
            <!-- Tên công việc -->
            <div class="mb-3">
              <label for="tencongviec" class="form-label">Tên công việc:</label>
              <input type="text" class="form-control" id="tencongviec" name="tencongviec" 
                     placeholder="Nhập tên công việc" required>
            </div>
            
            <!-- Vị trí làm và Máy -->
            <div class="row mb-3">
              <div class="col-md-6 mb-2 mb-md-0">
                <label for="vitrilam" class="form-label">Vị trí làm:</label>
                <input type="text" class="form-control" id="vitrilam" name="vitrilam" 
                       placeholder="Vị trí làm" required>
              </div>
              <div class="col-md-6">
                <label for="may" class="form-label">Máy:</label>
                <input type="text" class="form-control" id="may" name="may" 
                       placeholder="Máy" required>
              </div>
            </div>
            
            <!-- Người thực hiện chính -->
            <div class="mb-3">
              <label for="nguoithuchienchinh" class="form-label">Người thực hiện chính:</label>
              <select class="form-select" id="nguoithuchienchinh" name="nguoithuchienchinh" required>
                <option value="">-- Chọn người thực hiện chính --</option>
                <!-- Options sẽ được load từ Google Sheets -->
              </select>
            </div>
            
            <!-- Người thực hiện phụ -->
            <div class="row mb-3">
              <div class="col-md-6 mb-2 mb-md-0">
                <label for="nguoithuchienph1" class="form-label">Người thực hiện phụ 1:</label>
                <select class="form-select" id="nguoithuchienph1" name="nguoithuchienph1">
                  <option value="">-- Người thực hiện phụ 1 --</option>
                  <!-- Options sẽ được load từ Google Sheets -->
                </select>
              </div>
              <div class="col-md-6">
                <label for="nguoithuchienph2" class="form-label">Người thực hiện phụ 2:</label>
                <select class="form-select" id="nguoithuchienph2" name="nguoithuchienph2">
                  <option value="">-- Người thực hiện phụ 2 --</option>
                  <!-- Options sẽ được load từ Google Sheets -->
                </select>
              </div>
            </div>
            
            <!-- Thời gian thực hiện -->
            <div class="row mb-3">
              <div class="col-md-6 mb-2 mb-md-0">
                <label class="date-label">Từ:</label>
                <input type="date" class="form-control" name="ngaybatdau" required>
              </div>
              <div class="col-md-6">
                <label class="date-label">Đến:</label>
                <input type="date" class="form-control" name="ngayketthuc">
              </div>
            </div>
            
            <!-- Trạng thái -->
            <div class="mb-3">
              <label for="trangthai" class="form-label">Trạng thái:</label>
              <select class="form-select" id="trangthai" name="trangthai">
                <option value="">-- Chọn trạng thái --</option>
                <option value="Chưa làm">Chưa làm</option>
                <option value="Đang làm">Đang làm</option>
                <option value="Hoàn thành">Hoàn thành</option>
              </select>
            </div>
            
            <!-- Ghi chú -->
            <div class="mb-4">
              <label for="ghichu" class="form-label">Ghi chú:</label>
              <textarea class="form-control" id="ghichu" name="ghichu" rows="3" 
                        placeholder="Nhập ghi chú (nếu có)"></textarea>
            </div>
            
            <!-- Submit button -->
            <button type="submit" class="btn btn-submit" id="submitBtn">
              <i class="bi bi-save me-2"></i>Lưu Công Việc
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <script>
    // Thay thế URL này bằng URL Google Apps Script của bạn
    const GOOGLE_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbytNKhQuNr-t5v3HVqGykKQL95cIONpy2Zig5K7U3tjcHNtoquW74xbRf42MOSC7Rsefw/exec';
    
    // Google Sheets API để đọc dữ liệu công khai
    const SHEET_ID = '1JKDZD9EctJQn8oP5O9b2gsfDW_rHCLzVHOh5ggpGItI';
    const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME'; // Cần tạo API key từ Google Cloud Console
    const RANGE = 'Data!J:J'; // Đọc cột J từ sheet Data
    
    // Danh sách nhân viên mặc định (fallback)
    const DEFAULT_EMPLOYEES = [
      'Mr Mạnh', 'Mr Chính', 'Mr Đạt', 'Mr Dũng', 'Mr Quân', 
      'Mr Đại', 'Mr Hoàng Anh', 'Mr Hoàng', 'Mr Công'
    ];

    // Load danh sách nhân viên khi trang được tải
    document.addEventListener('DOMContentLoaded', function() {
      loadEmployees();
    });

    // Hàm load danh sách nhân viên từ Google Sheets
    async function loadEmployees() {
      try {
        console.log('Đang tải danh sách nhân viên từ Google Sheets...');
        
        // URL để gọi Google Sheets API
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        
        const response = await fetch(url);
        
        if (!response.ok) {
          throw new Error(`HTTP error! status: ${response.status}`);
        }
        
        const data = await response.json();
        
        if (data.values && data.values.length > 0) {
          // Lọc và làm sạch dữ liệu
          const employees = data.values
            .map(row => row[0]) // Lấy giá trị đầu tiên của mỗi hàng
            .filter(name => name && name.toString().trim() !== '') // Loại bỏ giá trị rỗng
            .map(name => name.toString().trim()) // Làm sạch khoảng trắng
            .filter((name, index, array) => array.indexOf(name) === index) // Loại bỏ trùng lặp
            .sort(); // Sắp xếp theo alphabet
          
          console.log('Đã tải thành công danh sách nhân viên:', employees);
          populateEmployeeSelects(employees);
        } else {
          console.warn('Không có dữ liệu trong sheet, sử dụng danh sách mặc định');
          populateEmployeeSelects(DEFAULT_EMPLOYEES);
        }
        
      } catch (error) {
        console.error('Lỗi khi load danh sách nhân viên từ Google Sheets:', error);
        console.log('Sử dụng danh sách nhân viên mặc định');
        // Sử dụng danh sách mặc định nếu có lỗi
        populateEmployeeSelects(DEFAULT_EMPLOYEES);
      }
    }

    // Hàm điền danh sách nhân viên vào các select
    function populateEmployeeSelects(employees) {
      const selects = [
        'nguoithuchienchinh',
        'nguoithuchienph1', 
        'nguoithuchienph2'
      ];

      selects.forEach(selectId => {
        const selectElement = document.getElementById(selectId);
        
        // Xóa các option cũ (trừ option đầu tiên)
        while (selectElement.children.length > 1) {
          selectElement.removeChild(selectElement.lastChild);
        }
        
        // Thêm các option mới
        employees.forEach(employee => {
          if (employee && employee.trim()) {
            const option = document.createElement('option');
            option.value = employee.trim();
            option.textContent = employee.trim();
            selectElement.appendChild(option);
          }
        });
      });
    }

    function submitForm(event) {
      event.preventDefault();
      
      const submitBtn = document.getElementById('submitBtn');
      const originalHTML = submitBtn.innerHTML;
      
      // Hiển thị trạng thái đang gửi
      submitBtn.innerHTML = '<span class="spinner-border spinner-border-sm me-2" role="status"></span>Đang lưu...';
      submitBtn.disabled = true;
      
      // Lấy dữ liệu từ form
      const formData = new FormData(document.getElementById('workForm'));
      const data = {
        tencongviec: formData.get('tencongviec'),
        vitrilam: formData.get('vitrilam'),
        may: formData.get('may'),
        nguoithuchienchinh: formData.get('nguoithuchienchinh'),
        nguoithuchienph1: formData.get('nguoithuchienph1'),
        nguoithuchienph2: formData.get('nguoithuchienph2'),
        ngaybatdau: formData.get('ngaybatdau'),
        ngayketthuc: formData.get('ngayketthuc'),
        trangthai: formData.get('trangthai'),
        ghichu: formData.get('ghichu')
      };
      
      // Gửi dữ liệu đến Google Sheets
      fetch(GOOGLE_SCRIPT_URL, {
        method: 'POST',
        mode: 'no-cors',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
      })
      .then(() => {
        // Thành công
        submitBtn.innerHTML = '<i class="bi bi-check-circle me-2"></i>Đã lưu thành công!';
        submitBtn.classList.remove('btn-submit');
        submitBtn.classList.add('btn', 'btn-success');
        
        // Reset form sau 2 giây
        setTimeout(() => {
          document.getElementById('workForm').reset();
          submitBtn.innerHTML = originalHTML;
          submitBtn.classList.remove('btn', 'btn-success');
          submitBtn.classList.add('btn-submit');
          submitBtn.disabled = false;
        }, 2000);
      })
      .catch((error) => {
        console.error('Lỗi:', error);
        submitBtn.innerHTML = '<i class="bi bi-exclamation-triangle me-2"></i>Lỗi! Thử lại';
        submitBtn.classList.remove('btn-submit');
        submitBtn.classList.add('btn', 'btn-danger');
        
        // Khôi phục nút sau 3 giây
        setTimeout(() => {
          submitBtn.innerHTML = originalHTML;
          submitBtn.classList.remove('btn', 'btn-danger');
          submitBtn.classList.add('btn-submit');
          submitBtn.disabled = false;
        }, 3000);
      });
    }
  </script>
</body>
</html>
