<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Danh Sách Công Việc - Quản Lý Xác Nhận</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet" />
  <style>
    body {
      background-color: #f8f9fa;
      min-height: 100vh;
      padding-top: 2rem;
      padding-bottom: 2rem;
    }

    .header-section {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 1.1rem 0 1.2rem 0;
      margin-bottom: 1.2rem;
      border-radius: 15px;
      text-align: center;
    }

    .table-container {
      background: white;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      overflow: hidden;
    }

    .table-header {
      /* background: linear-gradient(135deg, #ffc107, #e0a800); */
      color: #333;
      padding: 1.5rem;
      font-weight: 600;
      font-size: 1.2rem;
    }

    .filter-section {
      background: white;
      padding: 1.5rem;
      border-radius: 15px;
      box-shadow: 0 4px 15px rgba(0,0,0,0.1);
      margin-bottom: 2rem;
      /* display: none; */
    }

    .table thead th {
      background: #f8f9fa;
      color: #333;
      font-weight: 600;
      text-align: center;
      border-bottom: 2px solid #dee2e6;
      padding: 0.5rem 0.75rem;
    }

    .table tbody td {
      vertical-align: middle;
      text-align: center;
      padding: 0.5rem 0.75rem;
    }



    .table-hover tbody tr:hover {
      background-color: rgba(0,123,255,0.05);
    }

    /* Mobile card styling - giống như hình */
    @media (max-width: 768px) {
      .header-section {
        padding: 1.5rem 0;
      }
      
      /* Mobile card styling */
      .mobile-card {
        background: white;
        border-radius: 12px;
        margin-bottom: 1rem;
        box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        overflow: hidden;
      }
      
      .mobile-card-header {
        background: #a6a6a6;
        color: white;
        padding: 12px 16px;
        display: flex;
        justify-content: space-between;
        align-items: center;
        font-weight: 600;
      }
      
      .mobile-card-title {
        font-size: 14px;
        font-weight: 600;
      }
      
      .mobile-status-badge {
        background: rgba(255,255,255,0.9);
        color: #333;
        padding: 4px 8px;
        border-radius: 12px;
        font-size: 11px;
        font-weight: 600;
      }
      
      .mobile-card-body {
        padding: 16px;
      }
      
      .mobile-info-row {
        display: flex;
        margin-bottom: 12px;
        /* border-left: 3px solid #007bff; */ /* Xóa border này */
        padding-left: 12px;
      }
      
      .mobile-info-content {
        flex: 1;
      }
      
      .mobile-info-label {
        font-size: 12px;
        color: #666;
        margin-bottom: 2px;
        font-weight: 500;
      }
      
      .mobile-info-value {
        font-size: 14px;
        color: #333;
        font-weight: 600;
        word-wrap: break-word;
        line-height: 1.3;
      }
      
      .mobile-buttons {
        display: flex;
        gap: 8px;
        margin-top: 16px;
      }
      
      .mobile-btn {
        flex: 1;
        padding: 10px 16px;
        border-radius: 8px;
        font-size: 13px;
        font-weight: 600;
        border: none;
        transition: all 0.3s ease;
      }
      
      .mobile-btn-primary {
        background: #28a745;
        color: white;
      }
      
      .mobile-btn-primary:hover {
        background: #218838;
        color: white;
      }
      
      .mobile-btn-secondary {
        background: #dc3545;
        color: white;
      }
      
      .mobile-btn-secondary:hover {
        background: #c82333;
        color: white;
      }
      
      .mobile-approved {
        background: #28a745;
        color: white;
        padding: 8px 16px;
        border-radius: 20px;
        font-size: 12px;
        font-weight: 600;
        text-align: center;
        display: inline-flex;
        align-items: center;
        gap: 4px;
        margin-top: 16px;
      }
      
      /* Hide desktop table on mobile */
      .desktop-table {
        display: none;
      }
      
      /* Show mobile cards only on mobile */
      .mobile-cards {
        display: block;
      }
    }
    
    /* Desktop styles */
    @media (min-width: 769px) {
      .mobile-cards {
        display: none;
      }
      
      .desktop-table {
        display: block;
      }
    }

    /* Header User Info Styling */
    .header-user-info {
      background: rgba(255, 255, 255, 0.15);
      backdrop-filter: blur(10px);
      border-radius: 25px;
      padding: 8px 16px;
      margin-top: 0.5rem;
      margin-bottom: 0;
      border: 1px solid rgba(255, 255, 255, 0.2);
      transition: all 0.3s ease;
    }

    .header-user-info:hover {
      background: rgba(255, 255, 255, 0.2);
      transform: translateY(-2px);
    }

    .user-avatar {
      width: 35px;
      height: 35px;
      background: linear-gradient(135deg, #ffc107, #e0a800);
      border-radius: 50%;
      display: flex;
      align-items: center;
      justify-content: center;
      color: #333;
      font-weight: 700;
      font-size: 14px;
      box-shadow: 0 2px 8px rgba(255, 193, 7, 0.3);
    }

    .user-name {
      color: white;
      font-weight: 600;
      font-size: 14px;
      text-shadow: 0 1px 2px rgba(0, 0, 0, 0.2);
    }

    .logout-btn {
      background: transparent;
      border: 1px solid white;
      border-radius: 15px;
      padding: 6px 12px;
      color: white;
      font-weight: 500;
      font-size: 12px;
      transition: all 0.3s ease;
    }

    .logout-btn:hover {
      background: rgba(255, 255, 255, 0.1);
      color: white;
    }

    .logout-btn:active {
      transform: scale(0.95);
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .header-user-info .user-avatar {
        display: none;
      }

      .header-user-info .user-name {
        display: none;
      }

      .header-user-info {
        padding: 8px 12px;
        border-radius: 15px;
      }

      .logout-btn {
        padding: 8px 16px;
        font-size: 12px;
        border-radius: 15px;
      }
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      justify-content: flex-end;
      align-items: center;
      flex-wrap: wrap;
      margin-top: 0.5rem;
    }
    .toggle-btn {
      display: flex;
      align-items: center;
      gap: 4px;
      font-weight: 600;
      border: none;
      border-radius: 6px;
      padding: 6px 12px;
      font-size: 0.8rem;
      background: #f1f3f6;
      color: #333;
      box-shadow: 0 2px 8px #0001;
      transition: background 0.2s, color 0.2s;
      cursor: pointer;
      max-width: 150px;
      min-width: 120px;
    }
    .toggle-btn.active {
      background: #007bff;
      color: #fff;
    }
    .toggle-btn .bi {
      font-size: 0.9em;
    }

    /* Mobile responsive adjustments */
    @media (max-width: 768px) {
      .toggle-group {
        gap: 4px;
        margin-top: 0.25rem;
      }
      
      .toggle-btn {
        padding: 4px 6px;
        font-size: 0.7rem;
        min-width: 80px;
        gap: 2px;
      }
      
      .toggle-btn .bi {
        font-size: 0.8em;
      }
      
      /* Mobile filter adjustments */
      .filter-section .row .col-md-2,
      .filter-section .row .col-md-8 {
        margin-bottom: 0.75rem;
      }
      
      .filter-section .form-label {
        font-size: 0.9rem;
        margin-bottom: 0.25rem;
      }
      
      .filter-section .form-control {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>
  <script>
    // Lấy danh sách mã nhân viên, tên, mật khẩu, chức vụ từ Google Sheets
    let userList = [];
    async function fetchUserListWithPassword() {
      try {
        const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
        const SHEET_ID = '18ZLZbC8RjCvSyk_sLBvh3obi-_4TzgIlrDX09LkBXyo';
        const RANGE = 'Data!J2:O100';
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const response = await fetch(url);
        const data = await response.json();
        if (data.values) {
          userList = data.values.map(row => ({
            code: row[0]?.trim(),         // J - Mã NV
            name: row[1]?.trim(),         // K - Tên NV
            manager: row[2]?.trim(),      // L - Quản lý
            department: row[3]?.trim(),   // M - Bộ phận
            role: row[4]?.trim(),         // N - Chức vụ
            password: row[5]?.trim()      // O - Mật khẩu
          }));
        }
      } catch (e) { userList = []; }
    }

    // Hàm hiển thị popup đăng nhập
    function showLoginPopup() {
      let popup = document.getElementById('loginPopup');
      if (!popup) {
        popup = document.createElement('div');
        popup.id = 'loginPopup';
        popup.style.position = 'fixed';
        popup.style.top = '0';
        popup.style.left = '0';
        popup.style.width = '100vw';
        popup.style.height = '100vh';
        popup.style.background = 'rgba(0,0,0,0.3)';
        popup.style.display = 'flex';
        popup.style.alignItems = 'center';
        popup.style.justifyContent = 'center';
        popup.innerHTML = `
          <div style="background:#fff;padding:32px 24px;border-radius:12px;min-width:320px;box-shadow:0 2px 16px #0002;max-width:90vw;">
            <h4 class="mb-3 text-center">Đăng nhập nhân viên</h4>
            <form id="loginForm">
              <div class="mb-3">
                <label for="usercode" class="form-label">Mã nhân viên</label>
                <input type="text" class="form-control" id="usercode" required autofocus autocomplete="off">
              </div>
              <div class="mb-3">
                <label for="password" class="form-label">Mật khẩu</label>
                <input type="password" class="form-control" id="password" required autocomplete="off">
              </div>
              <div class="mb-2" id="userNameDisplay" style="font-weight:600;color:#007bff;"></div>
              <button type="submit" class="btn btn-primary w-100">Đăng nhập</button>
              <div id="loginError" class="text-danger mt-2" style="display:none;"></div>
            </form>
          </div>
        `;
        document.body.appendChild(popup);
      }
      popup.style.display = 'flex';
      document.body.style.overflow = 'hidden';
    }
    function hideLoginPopup() {
      let popup = document.getElementById('loginPopup');
      if (popup) popup.style.display = 'none';
      document.body.style.overflow = '';
    }

    // Kiểm tra đăng nhập
    async function checkLogin() {
      if (!localStorage.getItem('slp_user') || !localStorage.getItem('slp_name')) {
        await fetchUserListWithPassword();
        showLoginPopup();
        setTimeout(() => {
          const userInput = document.getElementById('usercode');
          const passInput = document.getElementById('password');
          const nameDisplay = document.getElementById('userNameDisplay');
          userInput.addEventListener('input', function() {
            const val = userInput.value.trim();
            const found = userList.find(u => u.code && u.code.toUpperCase() === val.toUpperCase());
            if (found) {
              nameDisplay.textContent = found.name;
              nameDisplay.style.color = '#007bff';
            } else {
              nameDisplay.textContent = '';
            }
          });
          document.getElementById('loginForm').addEventListener('submit', function(e) {
            e.preventDefault();
            const val = userInput.value.trim();
            const pass = passInput.value.trim();
            const found = userList.find(u => u.code && u.code.toUpperCase() === val.toUpperCase());
            if (found && found.password === pass) {
              localStorage.setItem('slp_user', found.code);
              localStorage.setItem('slp_name', found.name);
              // Xác định role
              if (found.role && found.role.toLowerCase() === 'quản lý') {
                localStorage.setItem('slp_role', 'quanly');
              } else {
                localStorage.setItem('slp_role', 'nhanvien');
              }
              hideLoginPopup();
              window.location.reload();
            } else {
              document.getElementById('loginError').textContent = 'Mã nhân viên hoặc mật khẩu không hợp lệ!';
              document.getElementById('loginError').style.display = '';
            }
          });
        }, 300);
      } else {
        hideLoginPopup();
      }
    }
    // Đăng xuất
    function logoutSLP() {
      localStorage.removeItem('slp_user');
      localStorage.removeItem('slp_name');
      window.location.reload();
    }
    // Hiển thị tên nhân viên đã đăng nhập
    function showUserInfo() {
      if (localStorage.getItem('slp_user') && localStorage.getItem('slp_name')) {
        const userName = localStorage.getItem('slp_name');
        const userInitial = userName.charAt(0).toUpperCase();
        
        // Tìm header section và thêm user info vào đó
        const headerSection = document.querySelector('.header-section');
        if (headerSection) {
          // Kiểm tra xem đã có user info chưa
          let existingUserInfo = headerSection.querySelector('.header-user-info');
          if (!existingUserInfo) {
            const userRole = localStorage.getItem('slp_role') === 'quanly' ? 'Quản lý' : 'Nhân viên';
            const userInfoHTML = `
            <div class="header-user-info d-flex align-items-center justify-content-center gap-3">
              <div class="user-avatar">${userInitial}</div>
              <div class="user-name">${userName} - ${userRole}</div>
              <button onclick="logoutSLP()" class="logout-btn">
                Đăng xuất
              </button>
            </div>
            `;
            headerSection.insertAdjacentHTML('beforeend', userInfoHTML);
          }
        }
      }
    }
    window.addEventListener('DOMContentLoaded', async function() {
      await checkLogin();
      showUserInfo();
    });
  </script>

  <div class="container">
    <div class="header-section">
      <h1><i class="bi bi-list-task me-3"></i>DANH SÁCH CÔNG VIỆC</h1>
      <p class="mb-0">Quản Lý Xác Nhận - Phòng Cơ Điện SLP</p>
      <div class="mt-3">
        <a href="home.html" class="btn btn-light me-2">
          <i class="bi bi-house-fill me-1"></i>Trang Chủ
        </a>
        <button class="btn btn-outline-light" onclick="loadCongViec()">
          <i class="bi bi-arrow-clockwise me-1"></i>Làm Mới
        </button>
      </div>
    </div>
    <div class="filter-section">
      <div class="row">
        <div class="col-md-2 mb-2">
          <label for="filterNguoi" class="form-label">Người yêu cầu:</label>
          <select class="form-control" id="filterNguoi" onchange="locCongViec()">
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="col-md-2 mb-2">
          <label for="filterMay" class="form-label">Máy:</label>
          <select class="form-control" id="filterMay" onchange="locCongViec()">
            <option value="">Tất cả</option>
          </select>
        </div>
        <div class="col-md-8 mb-2">
          <label class="form-label">&nbsp;</label>
          <div class="toggle-group">
            <button class="toggle-btn active" id="btnPending" onclick="toggleSection('Pending')">
              <i class="bi bi-hourglass-split"></i> Cần xác nhận
            </button>
            <button class="toggle-btn" id="btnApproved" onclick="toggleSection('Approved')">
              <i class="bi bi-check2-circle"></i> Đã duyệt
            </button>
            <button class="toggle-btn" id="btnRejected" onclick="toggleSection('Rejected')">
              <i class="bi bi-x-circle"></i> Không được duyệt
            </button>
          </div>
        </div>
      </div>
    </div>
    <div id="sectionPending">
      <div class="table-container">
        <div class="table-header">
          <i class="bi bi-table me-2"></i>Danh Sách Công Việc Cần Xác Nhận
        </div>
        <!-- Desktop Table: Chờ xác nhận -->
        <div class="table-responsive desktop-table">
          <table class="table table-hover align-middle mb-0" id="congviecTablePending">
            <thead>
              <tr>
                <th>STT</th>
                <th>Người yêu cầu</th>
                <th>Máy</th>
                <th>Hiện trạng lỗi</th>
                <th>Xác nhận</th>
              </tr>
            </thead>
            <tbody id="tableBodyPending">
              <tr><td colspan="5">Đang tải dữ liệu...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- Mobile Cards: Chờ xác nhận -->
        <div class="mobile-cards" id="mobileCardsPending">
          <div class="text-center p-3">Đang tải dữ liệu...</div>
        </div>
      </div>
    </div>
    <div id="sectionApproved">
      <div class="table-container">
        <div class="table-header">
          <i class="bi bi-check2-circle me-2"></i>Danh Sách Công Việc Đã Duyệt
        </div>
        <!-- Desktop Table: Đã duyệt -->
        <div class="table-responsive desktop-table">
          <table class="table table-hover align-middle mb-0" id="congviecTableApproved">
            <thead>
              <tr>
                <th>STT</th>
                <th>Người yêu cầu</th>
                <th>Máy</th>
                <th>Hiện trạng lỗi</th>
                <th>Xác nhận</th>
              </tr>
            </thead>
            <tbody id="tableBodyApproved">
              <tr><td colspan="5">Đang tải dữ liệu...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- Mobile Cards: Đã duyệt -->
        <div class="mobile-cards" id="mobileCardsApproved">
          <div class="text-center p-3">Đang tải dữ liệu...</div>
        </div>
      </div>
    </div>
    <div id="sectionRejected">
      <div class="table-container">
        <div class="table-header">
          <i class="bi bi-x-circle me-2"></i>Danh Sách Công Việc Không Được Duyệt
        </div>
        <!-- Desktop Table: Không được duyệt -->
        <div class="table-responsive desktop-table">
          <table class="table table-hover align-middle mb-0" id="congviecTableRejected">
            <thead>
              <tr>
                <th>STT</th>
                <th>Người yêu cầu</th>
                <th>Máy</th>
                <th>Hiện trạng lỗi</th>
                <th>Xác nhận</th>
              </tr>
            </thead>
            <tbody id="tableBodyRejected">
              <tr><td colspan="5">Đang tải dữ liệu...</td></tr>
            </tbody>
          </table>
        </div>
        <!-- Mobile Cards: Không được duyệt -->
        <div class="mobile-cards" id="mobileCardsRejected">
          <div class="text-center p-3">Đang tải dữ liệu...</div>
        </div>
      </div>
    </div>
  </div>
  <script>
    const SHEET_ID = '18ZLZbC8RjCvSyk_sLBvh3obi-_4TzgIlrDX09LkBXyo';
    const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
    const RANGE = 'Tonghop!A4:U100';
    let allRows = [];

    async function loadCongViec() {
      document.getElementById('tableBodyPending').innerHTML = '<tr><td colspan="5">Đang tải dữ liệu...</td></tr>';
      document.getElementById('tableBodyApproved').innerHTML = '<tr><td colspan="5">Đang tải dữ liệu...</td></tr>';
      document.getElementById('tableBodyRejected').innerHTML = '<tr><td colspan="5">Đang tải dữ liệu...</td></tr>';
      document.getElementById('mobileCardsPending').innerHTML = '<div class="text-center p-3">Đang tải dữ liệu...</div>';
      document.getElementById('mobileCardsApproved').innerHTML = '<div class="text-center p-3">Đang tải dữ liệu...</div>';
      document.getElementById('mobileCardsRejected').innerHTML = '<div class="text-center p-3">Đang tải dữ liệu...</div>';
      try {
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
        const res = await fetch(url);
        const data = await res.json();
        allRows = data.values || [];
        // Sort theo thời gian yêu cầu (cột 3), nếu không có thì sort theo STT
        allRows.sort((a, b) => {
          const getNum = r => parseInt((r[0] || '').replace(/\D/g, '')) || 0;
          return getNum(b) - getNum(a);
        });
        populateFilterOptions(allRows);
        renderTableSplit(allRows);
        renderMobileCardsSplit(allRows);
        updateStatistics(allRows);
      } catch (error) {
        document.getElementById('tableBodyPending').innerHTML = '<tr><td colspan="5">Có lỗi khi tải dữ liệu</td></tr>';
        document.getElementById('tableBodyApproved').innerHTML = '<tr><td colspan="5">Có lỗi khi tải dữ liệu</td></tr>';
        document.getElementById('tableBodyRejected').innerHTML = '<tr><td colspan="5">Có lỗi khi tải dữ liệu</td></tr>';
        document.getElementById('mobileCardsPending').innerHTML = '<div class="text-center p-3">Có lỗi khi tải dữ liệu</div>';
        document.getElementById('mobileCardsApproved').innerHTML = '<div class="text-center p-3">Có lỗi khi tải dữ liệu</div>';
        document.getElementById('mobileCardsRejected').innerHTML = '<div class="text-center p-3">Có lỗi khi tải dữ liệu</div>';
      }
    }

    function populateFilterOptions(rows) {
      const nguoiSet = new Set();
      const maySet = new Set();
      
      rows.forEach(row => {
        const nguoi = (row[5] || '').trim();
        const may = (row[2] || '').trim();
        
        if (nguoi) nguoiSet.add(nguoi);
        if (may) maySet.add(may);
      });
      
      // Populate Người yêu cầu dropdown
      const filterNguoi = document.getElementById('filterNguoi');
      filterNguoi.innerHTML = '<option value="">Tất cả</option>';
      Array.from(nguoiSet).sort().forEach(nguoi => {
        filterNguoi.innerHTML += `<option value="${nguoi}">${nguoi}</option>`;
      });
      
      // Populate Máy dropdown
      const filterMay = document.getElementById('filterMay');
      filterMay.innerHTML = '<option value="">Tất cả</option>';
      Array.from(maySet).sort().forEach(may => {
        filterMay.innerHTML += `<option value="${may}">${may}</option>`;
      });
    }

    function updateStatistics(rows) {
      const total = rows.length;
      const confirmed = rows.filter(row => row[13] && row[13].trim() !== '').length;
      const pending = total - confirmed;
      const rate = total > 0 ? Math.round((confirmed / total) * 100) : 0;
      console.log(`Statistics: Total: ${total}, Confirmed: ${confirmed}, Pending: ${pending}, Rate: ${rate}%`);
    }

    async function fetchManagerCodes() {
      // Lấy danh sách mã nhân viên quản lý từ Data!J1:O20
      const API_KEY = 'AIzaSyC1Rsi6v-NoDqTFVDzB_YVCP0g1aHyvMME';
      const SHEET_ID = '18ZLZbC8RjCvSyk_sLBvh3obi-_4TzgIlrDX09LkBXyo';
      const RANGE = 'Data!J1:O20';
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${SHEET_ID}/values/${RANGE}?key=${API_KEY}`;
      const response = await fetch(url);
      const data = await response.json();
      let managerCodes = [];
      if (data.values) {
        data.values.forEach(row => {
          row.forEach(code => {
            if (code && code.trim() !== '') managerCodes.push(code.trim().toUpperCase());
          });
        });
      }
      return managerCodes;
    }

    function normalizeName(name) {
      return (name || '').toLowerCase().replace(/\s+/g, ' ').trim();
    }

    function renderTableSplit(rows) {
      const tbodyPending = document.getElementById('tableBodyPending');
      const tbodyApproved = document.getElementById('tableBodyApproved');
      const tbodyRejected = document.getElementById('tableBodyRejected');
      tbodyPending.innerHTML = '';
      tbodyApproved.innerHTML = '';
      tbodyRejected.innerHTML = '';
      let hasPending = false, hasApproved = false, hasRejected = false;
      rows.forEach((row) => {
        const stt = row[0] || '';
        const may = row[2] || '';
        const hientrang = row[4] || '';
        const nguoi = row[5] || '';
        const colH = row[7] || '';
        const trangthaiU = row[20] || '';
        const trangthaiV = row[21] || '';
        const colHValue = colH.trim().toLowerCase();
        const isConfirmed = colHValue === 'đã duyệt';
        const isRejected = colHValue === 'không duyệt';
        const isDoing = (trangthaiU && trangthaiU.trim() !== '') || (trangthaiV && trangthaiV.trim() !== '');
        
        // Debug: Log dữ liệu cột U và V
        if (stt === 'CD-0001' || stt === 'CD-0002') {
          console.log(`STT: ${stt}, Toàn bộ row:`, row);
          console.log(`Cột U (index 20): "${trangthaiU}", Cột V (index 21): "${trangthaiV}", isDoing: ${isDoing}`);
        }

        const currentRole = localStorage.getItem('slp_role');
        const currentUser = localStorage.getItem('slp_user') || '';
        const maQuanLy = row[6] || ''; // Cột G

        const tr = `
          <tr>
            <td><strong>${stt}</strong></td>
            <td>${nguoi}</td>
            <td>${may}</td>
            <td style="text-align:left;max-width:300px;white-space:pre-line;">${hientrang}</td>
            <td>
              ${
                isConfirmed
                  ? `
                    <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">
                      <span class='btn btn-success btn-sm'><i class="bi bi-check-circle me-1"></i>Đã duyệt</span>
                      ${
                        isDoing
                          ? `<span class="btn btn-success btn-sm" style="background-color: #7be495; border-color: #7be495; color: #155724;"><i class="bi bi-play-circle me-1"></i>Đang làm</span>`
                          : `<span class="btn btn-secondary btn-sm"><i class="bi bi-pause-circle me-1"></i>Chưa làm</span>`
                      }
                    </div>
                  `
                  : isRejected
                  ? `
                    <div class="d-flex align-items-center justify-content-center gap-2 flex-wrap">
                      
                      ${
                        (currentRole === 'quanly' && maQuanLy.includes(currentUser))
                        ? `<button class='btn btn-success btn-sm' onclick='duyetCongViec("${stt}", true)' style="font-size:0.8rem;padding:4px 8px;">
                            <i class="bi bi-check me-1"></i>Duyệt lại
                          </button>`
                        : ''
                      }
                    </div>
                  `
                  : (
                    (currentRole === 'quanly' && maQuanLy.includes(currentUser))
                    ? `<div class="d-flex gap-2 justify-content-center">
                        <button class='btn btn-success btn-sm' onclick='duyetCongViec("${stt}", true)' style="font-size:0.8rem;padding:4px 8px;">
                          <i class="bi bi-check me-1"></i>Duyệt
                        </button>
                        <button class='btn btn-danger btn-sm' onclick='duyetCongViec("${stt}", false)' style="font-size:0.8rem;padding:4px 8px;">
                          <i class="bi bi-x me-1"></i>Không Duyệt
                        </button>
                      </div>`
                    : ''
                  )
              }
            </td>
          </tr>
        `;
        if (isConfirmed) {
          tbodyApproved.innerHTML += tr;
          hasApproved = true;
        } else if (isRejected) {
          tbodyRejected.innerHTML += tr;
          hasRejected = true;
        } else {
          tbodyPending.innerHTML += tr;
          hasPending = true;
        }
      });
      if (!hasPending) tbodyPending.innerHTML = '<tr><td colspan="5">Không có dữ liệu</td></tr>';
      if (!hasApproved) tbodyApproved.innerHTML = '<tr><td colspan="5">Không có dữ liệu</td></tr>';
      if (!hasRejected) tbodyRejected.innerHTML = '<tr><td colspan="5">Không có dữ liệu</td></tr>';
    }

    function renderMobileCardsSplit(rows) {
      const mobileCardsPending = document.getElementById('mobileCardsPending');
      const mobileCardsApproved = document.getElementById('mobileCardsApproved');
      const mobileCardsRejected = document.getElementById('mobileCardsRejected');
      mobileCardsPending.innerHTML = '';
      mobileCardsApproved.innerHTML = '';
      mobileCardsRejected.innerHTML = '';
      let hasPending = false, hasApproved = false, hasRejected = false;
      rows.forEach((row) => {
        const stt = row[0] || '';
        const may = row[2] || '';
        const hientrang = row[4] || '';
        const nguoi = row[5] || '';
        const colH = row[7] || '';
        const trangthaiU = row[20] || ''; // Cột U là index 20 (A=0, ..., U=20)
        const trangthaiV = row[21] || ''; // Thử cột V nếu U không đúng
        const colHValue = colH.trim().toLowerCase();
        const isConfirmed = colHValue === 'đã duyệt';
        const isRejected = colHValue === 'không duyệt';
        const isDoing = (trangthaiU && trangthaiU.trim() !== '') || (trangthaiV && trangthaiV.trim() !== '');
        
        // Debug: Log dữ liệu cột U và V
        if (stt === 'CD-0001' || stt === 'CD-0002') {
          console.log(`Mobile - STT: ${stt}, Toàn bộ row:`, row);
          console.log(`Cột U (index 20): "${trangthaiU}", Cột V (index 21): "${trangthaiV}", isDoing: ${isDoing}`);
        }
        
        const currentRole = localStorage.getItem('slp_role');
        const currentUser = localStorage.getItem('slp_user') || '';
        const maQuanLy = row[6] || ''; // Cột G

        const cardHTML = `
          <div class="mobile-card">
            <div class="mobile-card-header">
              <div class="mobile-card-title">STT: ${stt}</div>
              <div class="mobile-status-badge">${isConfirmed ? 'Đã duyệt' : isRejected ? 'Không duyệt' : 'Chờ xử lý'}</div>
            </div>
            <div class="mobile-card-body">
              <div class="mobile-info-row">
                <div class="mobile-info-content">
                  <div class="mobile-info-label">Người yêu cầu</div>
                  <div class="mobile-info-value">${nguoi}</div>
                </div>
              </div>
              <div class="mobile-info-row">
                <div class="mobile-info-content">
                  <div class="mobile-info-label">Máy</div>
                  <div class="mobile-info-value">${may}</div>
                </div>
              </div>
              <div class="mobile-info-row">
                <div class="mobile-info-content">
                  <div class="mobile-info-label">Hiện trạng lỗi</div>
                  <div class="mobile-info-value">${hientrang}</div>
                </div>
              </div>
              ${!isConfirmed && !isRejected && currentRole === 'quanly' && maQuanLy.includes(currentUser) ? `
                <div class="mobile-buttons">
                  <button class='mobile-btn mobile-btn-primary' onclick='duyetCongViec("${stt}", true)'>
                    <i class="bi bi-check me-1"></i>Duyệt
                  </button>
                  <button class='mobile-btn mobile-btn-secondary' onclick='duyetCongViec("${stt}", false)'>
                    <i class="bi bi-x me-1"></i>Không Duyệt
                  </button>
                </div>
              ` : ''}
            </div>
          </div>
        `;
        if (isConfirmed) {
          mobileCardsApproved.innerHTML += cardHTML;
          hasApproved = true;
        } else if (isRejected) {
          mobileCardsRejected.innerHTML += cardHTML;
          hasRejected = true;
        } else {
          mobileCardsPending.innerHTML += cardHTML;
          hasPending = true;
        }
      });
      if (!hasPending) mobileCardsPending.innerHTML = '<div class="text-center p-3">Không có dữ liệu</div>';
      if (!hasApproved) mobileCardsApproved.innerHTML = '<div class="text-center p-3">Không có dữ liệu</div>';
      if (!hasRejected) mobileCardsRejected.innerHTML = '<div class="text-center p-3">Không có dữ liệu</div>';
    }

    function locCongViec() {
      const filterNguoi = document.getElementById('filterNguoi').value;
      const filterMay = document.getElementById('filterMay').value;
      
      let filtered = allRows;
      
      // Filter theo Người yêu cầu
      if (filterNguoi) {
        filtered = filtered.filter(row => {
          const nguoi = (row[5] || '').trim();
          return nguoi === filterNguoi;
        });
      }
      
      // Filter theo Máy
      if (filterMay) {
        filtered = filtered.filter(row => {
          const may = (row[2] || '').trim();
          return may === filterMay;
        });
      }
      
      renderTableSplit(filtered);
      renderMobileCardsSplit(filtered);
      updateStatistics(filtered);
    }


    function duyetCongViec(stt, isDuyet) {
      const value = isDuyet ? 'Đã duyệt' : 'Không duyệt';
      if (confirm(`Bạn có chắc chắn muốn ${value.toLowerCase()} công việc ${stt}?`)) {
        // Tìm và ẩn nút duyệt ngay lập tức
        const buttons = document.querySelectorAll(`button[onclick*="${stt}"]`);
        buttons.forEach(btn => {
          const td = btn.closest('td');
          if (td) {
            if (isDuyet) {
              td.innerHTML = `<span class='btn btn-success btn-sm'><i class="bi bi-check-circle me-1"></i>Đã duyệt</span>`;
            } else {
              td.innerHTML = `<span class='btn btn-danger btn-sm'><i class="bi bi-x-circle me-1"></i>Không duyệt</span>`;
            }
          }
        });

        // Tìm và ẩn nút duyệt trong mobile cards
        const mobileCards = document.querySelectorAll('.mobile-card');
        mobileCards.forEach(card => {
          const cardTitle = card.querySelector('.mobile-card-title');
          if (cardTitle && cardTitle.textContent.includes(stt)) {
            const buttonsDiv = card.querySelector('.mobile-buttons');
            if (buttonsDiv) {
              if (isDuyet) {
                buttonsDiv.innerHTML = `
                  <div class="mobile-approved">
                    <i class="bi bi-check-circle me-1"></i>Đã được duyệt
                  </div>
                `;
              } else {
                buttonsDiv.innerHTML = `
                  <div class="mobile-approved" style="background: #dc3545; color: white;">
                    <i class="bi bi-x-circle me-1"></i>Không được duyệt
                  </div>
                `;
              }
            }
          }
        });

        // Gửi dữ liệu lên server với format đúng cho duyệt công việc
        fetch('https://script.google.com/macros/s/AKfycbx7whQ56_qf4XfeoAvsJvKEvedSV5rqV8EkDH461KyAlWPhkpjm5TT84dfQdtY039D7/exec', {
          method: 'POST',
          body: JSON.stringify({
            stt: stt,
            value: value,
            column: 'H'  // Thêm trường này để phân biệt với thêm mới
          })
        })
        .then(res => res.json())
        .then(json => {
          if (json.status === 'success') {
            // Không cần làm gì thêm, UI đã được cập nhật
          } else {
            alert('Lỗi: ' + (json.message || 'Không xác định'));
            // Nếu lỗi thì load lại để khôi phục trạng thái ban đầu
            loadCongViec();
          }
        })
        .catch(() => {
          
          // Nếu lỗi thì load lại để khôi phục trạng thái ban đầu
          loadCongViec();
        });
      }
    }

    function toggleSection(type) {
      const section = document.getElementById('section' + type);
      const btn = document.getElementById('btn' + type);
      if (section && btn) {
        const isHidden = section.style.display === 'none';
        section.style.display = isHidden ? '' : 'none';
        btn.classList.toggle('active', isHidden);
      }
    }

    window.onload = async function() {
      await checkLogin();
      showUserInfo();
      // Ẩn 2 section Approved và Rejected, chỉ hiện Pending khi load trang
      document.getElementById('sectionApproved').style.display = 'none';
      document.getElementById('sectionRejected').style.display = 'none';
      document.getElementById('sectionPending').style.display = '';
      // Đặt lại trạng thái active cho các nút toggle
      document.getElementById('btnPending').classList.add('active');
      document.getElementById('btnApproved').classList.remove('active');
      document.getElementById('btnRejected').classList.remove('active');
      loadCongViec();
    };
  </script>
</body>
</html>
