<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart AC Management - Hệ Thống Quản Lý Điều Hòa Thông Minh</title>
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Bootstrap Icons -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" rel="stylesheet">
    <!-- Google Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    
    <style>
        :root {
            --primary: #667eea;
            --primary-dark: #5a67d8;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --info: #4299e1;
            --light: #f7fafc;
            --dark: #2d3748;
            --gradient-1: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --gradient-2: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            --gradient-3: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%);
            --gradient-4: linear-gradient(135deg, #43e97b 0%, #38f9d7 100%);
            --shadow-sm: 0 2px 4px rgba(0,0,0,0.1);
            --shadow-md: 0 4px 12px rgba(0,0,0,0.15);
            --shadow-lg: 0 10px 25px rgba(0,0,0,0.2);
            --border-radius: 16px;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #c3cfe2 100%);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }

        /* Navbar Styles */
        .navbar-custom {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 1rem 0;
            position: fixed;
            top: 0;
            width: 100%;
            z-index: 1000;
            transition: all 0.3s ease;
        }

        .navbar-brand {
            font-weight: 700;
            font-size: 1.5rem;
            background: var(--gradient-1);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-link {
            font-weight: 500;
            color: var(--dark) !important;
            position: relative;
            transition: all 0.3s ease;
        }

        .nav-link:hover {
            color: var(--primary) !important;
        }

        .nav-link::after {
            content: '';
            position: absolute;
            bottom: -5px;
            left: 50%;
            width: 0;
            height: 3px;
            background: var(--gradient-1);
            transition: all 0.3s ease;
            transform: translateX(-50%);
            border-radius: 2px;
        }

        .nav-link:hover::after {
            width: 80%;
        }

        /* Hero Section */
        .hero-section {
            background: var(--gradient-1);
            color: white;
            padding: 8rem 0 4rem;
            margin-top: 80px;
            position: relative;
            overflow: hidden;
        }

        .hero-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: url('data:image/svg+xml,<svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 100 100"><defs><pattern id="grain" width="100" height="100" patternUnits="userSpaceOnUse"><circle cx="50" cy="50" r="1" fill="white" opacity="0.1"/></pattern></defs><rect width="100" height="100" fill="url(%23grain)"/></svg>');
            opacity: 0.3;
        }

        .hero-content {
            position: relative;
            z-index: 2;
        }

        .hero-title {
            font-size: 3.5rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            text-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }

        .hero-subtitle {
            font-size: 1.25rem;
            opacity: 0.9;
            margin-bottom: 2rem;
        }

        /* Card Styles */
        .smart-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            border: none;
            overflow: hidden;
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            position: relative;
        }

        .smart-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--gradient-1);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .smart-card:hover {
            transform: translateY(-8px);
            box-shadow: var(--shadow-lg);
        }

        .smart-card:hover::before {
            transform: scaleX(1);
        }

        /* Stats Cards */
        .stat-card {
            background: white;
            border-radius: var(--border-radius);
            padding: 2rem;
            text-align: center;
            box-shadow: var(--shadow-md);
            border: none;
            position: relative;
            overflow: hidden;
            transition: all 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--gradient-1);
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .stat-card:hover::before {
            opacity: 0.1;
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 auto 1rem;
            font-size: 1.5rem;
            color: white;
            background: var(--gradient-1);
        }

        .stat-number {
            font-size: 2.5rem;
            font-weight: 700;
            color: var(--dark);
            margin-bottom: 0.5rem;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        /* Status Badges */
        .status-excellent { background: rgba(72, 187, 120, 0.2); color: #48bb78; border: 1px solid #48bb78; }
        .status-good { background: rgba(72, 187, 120, 0.15); color: #38a169; border: 1px solid #38a169; }
        .status-maintenance { background: rgba(237, 137, 54, 0.2); color: #ed8936; border: 1px solid #ed8936; }
        .status-repair { background: rgba(245, 101, 101, 0.2); color: #f56565; border: 1px solid #f56565; }
        .status-broken { background: rgba(229, 62, 62, 0.2); color: #e53e3e; border: 1px solid #e53e3e; }

        /* Table Styles - Simple Design */
        .ac-table {
            background: white;
            border-radius: 6px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
            overflow: hidden;
            margin-bottom: 2rem;
            border: 1px solid #dee2e6;
        }

        .table {
            margin: 0;
            font-size: 0.85rem;
        }

        .table thead th {
            background-color: var(--primary);
            color: white;
            border: none;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.75rem;
            padding: 0.75rem 0.5rem;
            text-align: center;
        }

        .table tbody td {
            padding: 0.5rem;
            vertical-align: middle;
            border-color: #dee2e6;
            font-size: 0.8rem;
        }

        .table tbody tr:hover {
            background-color: #f8f9fa;
        }

        .status-badge-table {
            padding: 0.2rem 0.5rem;
            border-radius: 10px;
            font-size: 0.65rem;
            font-weight: 600;
            text-transform: uppercase;
            display: inline-block;
            min-width: 60px;
            text-align: center;
        }

        .status-excellent { background-color: #28a745; color: white; }
        .status-good { background-color: #20c997; color: white; }
        .status-maintenance { background-color: #ffc107; color: #212529; }
        .status-repair { background-color: #dc3545; color: white; }
        .status-broken { background-color: #6c757d; color: white; }

        .capacity-badge {
            background-color: #17a2b8;
            color: white;
            padding: 0.2rem 0.4rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .brand-badge {
            background-color: #e9ecef;
            color: #495057;
            padding: 0.2rem 0.4rem;
            border-radius: 6px;
            font-size: 0.7rem;
            font-weight: 500;
        }

        .action-btn-sm {
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            border-radius: 4px;
            margin: 0.05rem;
            min-width: 35px;
            border: none;
            background: transparent;
            color: #6c757d;
        }

        .action-btn-sm:hover {
            color: #495057;
            background: rgba(108, 117, 125, 0.1);
        }

        /* Dropdown in table */
        .dropdown-menu {
            border: none;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            border-radius: 8px;
            padding: 0.5rem 0;
            min-width: 150px;
        }

        .dropdown-item {
            padding: 0.5rem 1rem;
            font-size: 0.8rem;
            border-radius: 0;
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .date-text {
            font-size: 0.75rem;
            color: #6c757d;
        }

        .code-text {
            font-weight: 700;
            color: #007bff;
            font-size: 0.8rem;
        }

        .location-text {
            font-weight: 500;
            color: #212529;
            font-size: 0.8rem;
        }

        .location-area {
            font-size: 0.7rem;
            color: #6c757d;
        }

        /* Filter Section */
        .filter-card {
            background: white;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-md);
            padding: 2rem;
            margin-bottom: 2rem;
        }

        .form-control, .form-select {
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            transition: all 0.3s ease;
        }

        .form-control:focus, .form-select:focus {
            border-color: var(--primary);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .btn-modern {
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1.5rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .btn-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            transition: left 0.5s ease;
        }

        .btn-modern:hover::before {
            left: 100%;
        }

        .btn-maintenance { background: var(--gradient-3); color: white; }
        .btn-repair { background: var(--gradient-2); color: white; }
        .btn-detail { background: var(--gradient-1); color: white; }

        /* Modal Styles */
        .modal-content {
            border-radius: var(--border-radius);
            border: none;
            box-shadow: var(--shadow-lg);
        }

        .modal-header {
            background: var(--gradient-1);
            color: white;
            border-bottom: none;
        }

        .modal-footer {
            border-top: 1px solid #e2e8f0;
            background: #f8fafc;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .hero-title { 
                font-size: 2.5rem; 
            }
            .navbar-brand { 
                font-size: 1.25rem; 
            }
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .animate-fade-up {
            animation: fadeInUp 0.8s ease-out;
        }

        /* Loading Animation */
        .loading-skeleton {
            background: linear-gradient(90deg, #f0f0f0 25%, #e0e0e0 50%, #f0f0f0 75%);
            background-size: 200% 100%;
            animation: shimmer 1.5s infinite;
            border-radius: 8px;
        }

        @keyframes shimmer {
            0% { background-position: -200% 0; }
            100% { background-position: 200% 0; }
        }

        /* Simple animations for buttons */
        .smart-card, .stat-card {
            transition: all 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }

        .table tbody tr {
            transition: background-color 0.2s ease;
        }

        .btn {
            transition: all 0.3s ease;
        }

        .btn:hover {
            transform: translateY(-2px);
        }
    </style>
</head>
<body>
    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg navbar-custom">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="bi bi-snow2 me-2"></i>
ĐIỀU HÒA CƠ ĐIỆN </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav ms-auto">
                    <li class="nav-item">
                        <a class="nav-link" href="#dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#maintenance">Bảo Dưỡng</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="#reports">Báo Cáo</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="caidat-hethong.html">
                            <i class="bi bi-gear-fill me-1"></i>Cài Đặt
                        </a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="home.html">
                            <i class="bi bi-house-fill me-1"></i>Trang Chủ
                        </a>
                    </li>
                </ul>
            </div>
        </div>
    </nav>

    <!-- Hero Section -->
    <section class="hero-section" id="dashboard">
        <div class="container">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="hero-content animate-fade-up">
                        <h1 class="hero-title">
                            Quản Lý Điều Hòa
                            <span style="background: var(--gradient-4); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">Thông Minh</span>
                        </h1>
                        <p class="hero-subtitle">
                            Hệ thống quản lý bảo dưỡng và sửa chữa điều hòa hiện đại với theo dõi hình ảnh chi tiết
                        </p>
                        <div class="d-flex gap-3">
                            <button class="btn btn-light btn-lg btn-modern" onclick="showAddModal()">
                                <i class="bi bi-plus-circle me-2"></i>Thêm Điều Hòa
                            </button>
                            <button class="btn btn-outline-light btn-lg btn-modern" onclick="window.location.href='bao-cao.html'">
                                <i class="bi bi-graph-up me-2"></i>Xem Báo Cáo
                            </button>
                            <button class="btn btn-outline-light btn-lg btn-modern" onclick="window.location.href='them-ghi-chu-hang-loat.html'">
                                <i class="bi bi-clipboard-plus me-2"></i>Ghi Chú Hàng Loạt
                            </button>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="text-center">
                        <div style="font-size: 8rem; opacity: 0.3;">
                            <i class="bi bi-snow2"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </section>

    <div class="container my-5">
        <!-- Statistics -->
        <div class="row mb-5">
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card animate-fade-up">
                    <div class="stat-icon">
                        <i class="bi bi-check-circle"></i>
                    </div>
                    <div class="stat-number" id="totalGood">0</div>
                    <div class="stat-label">Hoạt Động Tốt</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card animate-fade-up" style="animation-delay: 0.1s;">
                    <div class="stat-icon">
                        <i class="bi bi-tools"></i>
                    </div>
                    <div class="stat-number" id="totalMaintenance">0</div>
                    <div class="stat-label">Cần Bảo Dưỡng</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card animate-fade-up" style="animation-delay: 0.2s;">
                    <div class="stat-icon">
                        <i class="bi bi-wrench"></i>
                    </div>
                    <div class="stat-number" id="totalRepair">0</div>
                    <div class="stat-label">Cần Sửa Chữa</div>
                </div>
            </div>
            <div class="col-lg-3 col-md-6 mb-4">
                <div class="stat-card animate-fade-up" style="animation-delay: 0.3s;">
                    <div class="stat-icon">
                        <i class="bi bi-snow2"></i>
                    </div>
                    <div class="stat-number" id="totalUnits">0</div>
                    <div class="stat-label">Tổng Điều Hòa</div>
                </div>
            </div>
        </div>

        <!-- Quick Schedule Alert -->
        <div class="smart-card mb-4" style="background: var(--gradient-1); color: white;">
            <div class="p-4">
                <h5 class="mb-3">
                    <i class="bi bi-bell me-2"></i>
                    Lịch Bảo Dưỡng Sắp Tới
                </h5>
                <div id="upcomingSchedule">
                    <div class="d-flex align-items-center">
                        <div class="loading-skeleton" style="width: 100%; height: 20px;"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Filter Section -->
        <div class="filter-card" id="maintenance">
            <h5 class="mb-4">
                <i class="bi bi-funnel me-2"></i>
                Bộ Lọc & Tìm Kiếm
            </h5>
            <div class="row">
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label fw-semibold">Khu vực</label>
                    <select class="form-select" id="filterArea">
                        <option value="">Tất cả khu vực</option>
                        <option value="Tầng 1">Tầng 1</option>
                        <option value="Tầng 2">Tầng 2</option>
                        <option value="Tầng 3">Tầng 3</option>
                        <option value="Xưởng sản xuất">Xưởng sản xuất</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label fw-semibold">Trạng thái</label>
                    <select class="form-select" id="filterStatus">
                        <option value="">Tất cả trạng thái</option>
                        <option value="excellent">Hoạt động xuất sắc</option>
                        <option value="good">Hoạt động tốt</option>
                        <option value="maintenance">Cần bảo dưỡng</option>
                        <option value="repair">Cần sửa chữa</option>
                        <option value="broken">Hỏng</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label fw-semibold">Loại điều hòa</label>
                    <select class="form-select" id="filterType">
                        <option value="">Tất cả loại</option>
                        <option value="split">Điều hòa treo tường</option>
                        <option value="multi">Điều hòa cây</option>
                        <option value="central">Điều hòa trung tâm</option>
                        <option value="cassette">Điều hòa âm trần</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6 mb-3">
                    <label class="form-label fw-semibold">Tìm kiếm</label>
                    <input type="text" class="form-control" id="searchInput" placeholder="Mã, vị trí, hãng...">
                </div>
            </div>
            <div class="row">
                <div class="col-12">
                    <button class="btn btn-detail btn-modern me-2" onclick="applyFilter()">
                        <i class="bi bi-search me-1"></i>Tìm kiếm
                    </button>
                    <button class="btn btn-outline-secondary btn-modern me-2" onclick="resetFilter()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Đặt lại
                    </button>
                    <button class="btn btn-outline-info btn-modern" onclick="forceRefresh()">
                        <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
                    </button>
                </div>
            </div>
        </div>

        <!-- AC List -->
        <div id="airConditionerList">
            <!-- Dynamic content -->
        </div>
    </div>

    <!-- Modal Add/Edit AC -->
    <div class="modal fade" id="acModal" tabindex="-1">
        <div class="modal-dialog modal-xl">
            <div class="modal-content" style="border-radius: var(--border-radius); border: none;">
                <div class="modal-header" style="background: var(--gradient-1); color: white; border: none;">
                    <h5 class="modal-title" id="modalTitle">Thêm Điều Hòa Mới</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-4">
                    <form id="acForm">
                        <div class="row">
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Mã điều hòa *</label>
                                    <input type="text" class="form-control" id="acCode" required>
                                    <input type="hidden" id="acId">
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Loại điều hòa *</label>
                                    <select class="form-select" id="acType" required>
                                        <option value="">Chọn loại</option>
                                        <option value="split">Điều hòa treo tường</option>
                                        <option value="multi">Điều hòa cây</option>
                                        <option value="central">Điều hòa trung tâm</option>
                                        <option value="cassette">Điều hòa âm trần</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Serial</label>
                                    <input type="text" class="form-control" id="acSerial" placeholder="Nhập số serial">
                        </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Công suất (BTU)</label>
                                    <select class="form-select" id="acCapacity">
                                        <option value="">Chọn công suất</option>
                                        <option value="9000">9,000 BTU</option>
                                        <option value="12000">12,000 BTU</option>
                                        <option value="18000">18,000 BTU</option>
                                        <option value="24000">24,000 BTU</option>
                                        <option value="48000">48,000 BTU</option>
                                        <option value="120000">120,000 BTU</option>
                                        <option value="240000">240,000 BTU</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Khu vực *</label>
                                    <select class="form-select" id="acArea" required>
                                        <option value="">Chọn khu vực</option>
                                        <option value="Tầng 1">Tầng 1</option>
                                        <option value="Tầng 2">Tầng 2</option>
                                        <option value="Tầng 3">Tầng 3</option>
                                        <option value="Xưởng sản xuất">Xưởng sản xuất</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Vị trí cụ thể *</label>
                                    <select class="form-select" id="acLocation" required>
                                        <option value="">Chọn vị trí</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Hãng sản xuất</label>
                                    <select class="form-select" id="acBrand">
                                        <option value="">Chọn hãng</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Trạng thái hiện tại</label>
                                    <select class="form-select" id="acStatus">
                                        <option value="excellent">Hoạt động xuất sắc</option>
                                        <option value="good">Hoạt động tốt</option>
                                        <option value="maintenance">Cần bảo dưỡng</option>
                                        <option value="repair">Cần sửa chữa</option>
                                        <option value="broken">Hỏng</option>
                                    </select>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Ngày lắp đặt</label>
                                    <input type="date" class="form-control" id="acInstallDate">
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Bảo hành đến</label>
                                    <input type="date" class="form-control" id="acWarrantyDate">
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Ảnh đại diện</label>
                                    <input type="file" class="form-control" id="acAvatar" accept="image/*">
                        </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Ảnh điều hòa</label>
                                    <input type="file" class="form-control" id="acImages" accept="image/*" multiple>
                                </div>
                            </div>
                            <div class="col-md-4">
                                <div class="mb-3">
                                    <label class="form-label fw-semibold">Ảnh giấy tờ</label>
                                    <input type="file" class="form-control" id="acDocuments" accept="image/*" multiple>
                                </div>
                            </div>
                            <div class="col-md-12">
                        <div class="mb-3">
                            <label class="form-label fw-semibold">Ghi chú</label>
                            <textarea class="form-control" id="acNotes" rows="3"></textarea>
                                </div>
                            </div>
                        </div>
                    </form>
                </div>
                <div class="modal-footer" style="border: none; background: #f8fafc;">
                    <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">Hủy</button>
                    <button type="button" class="btn btn-detail btn-modern" onclick="saveAirConditioner()">
                        <i class="bi bi-save me-1"></i>Lưu
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Image Preview Modal -->
    <div class="modal fade" id="imageModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content" style="border-radius: var(--border-radius); border: none;">
                <div class="modal-header" style="background: var(--gradient-1); color: white; border: none;">
                    <h5 class="modal-title">Xem Ảnh</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body text-center p-0">
                    <img id="previewImage" src="" alt="Preview" style="max-width: 100%; height: auto;">
                </div>
                <div class="modal-footer" style="border: none; background: #f8fafc;">
                    <button type="button" class="btn btn-outline-secondary btn-modern" data-bs-dismiss="modal">Đóng</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <!-- Settings Manager -->
    <script src="settings-manager.js"></script>
    <!-- Smart AC API Manager -->
    <script src="smart-ac-api.js"></script>
    
    <script>
        // API Configuration
        const API_BASE_URL = 'https://autoslp.duckdns.org/api/data';
        const WEBHOOK_BASE_URL = 'https://autoslp.duckdns.org:5678/webhook';

        // Global data variables
        let airConditioners = [];
        let filteredAirConditioners = [];
        let statistics = {};

        // Hàm chuyển đổi URL Google Drive sang URL hiển thị trực tiếp
        function convertGoogleDriveUrl(url) {
            if (!url) return '';
            
            try {
                // Kiểm tra xem URL có phải là Google Drive không
                if (url.includes('drive.google.com/file/d/')) {
                    // Trích xuất ID file từ URL
                    const fileIdMatch = url.match(/\/d\/([^\/]+)/);
                    if (fileIdMatch && fileIdMatch[1]) {
                        const fileId = fileIdMatch[1];
                        // Phương pháp 1: URL trực tiếp với tham số đầy đủ
                        // return `https://drive.google.com/uc?id=${fileId}&export=view&authuser=0`;
                        
                        // Phương pháp 2 (nếu phương pháp 1 không hoạt động):
                        return `https://lh3.googleusercontent.com/d/${fileId}`;
                        
                        // Phương pháp 3 (nếu các phương pháp trên không hoạt động):
                        // return `https://drive.google.com/thumbnail?id=${fileId}&sz=w1000`;
                    }
                }
                
                // Thử kiểm tra dạng URL chia sẻ khác
                if (url.includes('drive.google.com/open?id=')) {
                    const fileIdMatch = url.match(/id=([^&]+)/);
                    if (fileIdMatch && fileIdMatch[1]) {
                        const fileId = fileIdMatch[1];
                        return `https://drive.google.com/uc?id=${fileId}&export=view&authuser=0`;
                    }
                }
            } catch (e) {
                console.error('Lỗi khi chuyển đổi URL Google Drive:', e);
            }
            
            // Nếu không phải URL Google Drive hoặc có lỗi, trả về URL gốc
            return url;
        }

        // API Functions
        async function fetchAirConditioners() {
            try {
                // Lấy danh sách điều hòa từ API mới với tiền tố air_
                const response = await fetch(`${API_BASE_URL}/air_conditioners`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                
                // Transform data to match frontend format
                airConditioners = Array.isArray(data) ? data.map(ac => ({
                    id: ac.id,
                    code: ac.ma_dieu_hoa || ac.code,
                    type: ac.loai || ac.type,
                    area: ac.khu_vuc || ac.area,
                    location: ac.vi_tri || ac.location,
                    capacity: ac.cong_suat || ac.capacity,
                    brand: ac.hang || ac.brand,
                    installDate: ac.ngay_lap_dat || ac.install_date,
                    warrantyDate: ac.ngay_bao_hanh || ac.warranty_date,
                    status: ac.trang_thai || ac.status,
                    lastMaintenance: ac.bao_duong_gan_nhat || ac.last_maintenance,
                    nextMaintenance: ac.bao_duong_tiep_theo || ac.next_maintenance,
                    notes: ac.ghi_chu || ac.notes || '',
                    totalWorks: ac.tong_cong_viec || 0,
                    maintenanceCount: ac.so_lan_bao_duong || 0,
                    repairCount: ac.so_lan_sua_chua || 0,
                    totalCost: ac.tong_chi_phi || 0,
                    lastContractorName: ac.nha_thau_gan_nhat || '',
                    serial: ac.serial || ac.so_serial || '',
                    avatar_url: ac.avatar_url || '',
                    images_urls: ac.images_urls || [],
                    documents_urls: ac.documents_urls || [],
                    workHistory: []
                })) : [];
                
                filteredAirConditioners = [...airConditioners];
                return airConditioners;
            } catch (error) {
                console.error('Error fetching air conditioners:', error);
                showNotification('Lỗi khi tải dữ liệu điều hòa: ' + error.message, 'error');
                return [];
            }
        }

        async function fetchWorkHistory() {
            try {
                const response = await fetch(`${API_BASE_URL}/work_history`);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                const data = await response.json();
                return Array.isArray(data) ? data : [];
            } catch (error) {
                console.error('Error fetching work history:', error);
                return [];
            }
        }

        async function fetchStatistics() {
            try {
                // Calculate statistics from current air conditioners data
                const stats = {
                    ac_by_status: {},
                    total_acs: airConditioners.length,
                    upcoming_maintenance: []
                };
                
                // Count by status
                airConditioners.forEach(ac => {
                    const status = ac.status || 'good';
                    stats.ac_by_status[status] = (stats.ac_by_status[status] || 0) + 1;
                });
                
                // Find upcoming maintenance
                const now = new Date();
                const thirtyDaysFromNow = new Date(now.getTime() + 30 * 24 * 60 * 60 * 1000);
                
                stats.upcoming_maintenance = airConditioners
                    .filter(ac => ac.nextMaintenance && new Date(ac.nextMaintenance) <= thirtyDaysFromNow)
                    .sort((a, b) => new Date(a.nextMaintenance) - new Date(b.nextMaintenance))
                    .slice(0, 5);
                
                statistics = stats;
                return stats;
            } catch (error) {
                console.error('Error calculating statistics:', error);
                return {
                    ac_by_status: {},
                    total_acs: 0,
                    upcoming_maintenance: []
                };
            }
        }

        async function saveAirConditionerData(data, isEdit = false, id = null) {
            try {
                // Prepare data for webhook
                const webhookData = {
                    action: isEdit ? 'update' : 'create',
                    data: {
                        ma_dieu_hoa: data.code,
                        loai: data.type,
                        khu_vuc: data.area,
                        vi_tri: data.location,
                        cong_suat: data.capacity,
                        hang: data.brand,
                        ngay_lap_dat: data.install_date,
                        ngay_bao_hanh: data.warranty_date,
                        trang_thai: data.status,
                        bao_duong_tiep_theo: data.next_maintenance,
                        ghi_chu: data.notes
                    },
                    id: id,
                    timestamp: new Date().toISOString()
                };
                
                // Send to webhook
                const response = await fetch(`${WEBHOOK_BASE_URL}/air_conditioner`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(webhookData)
                });
                
                if (!response.ok) {
                    throw new Error(`Webhook error! status: ${response.status}`);
                }
                
                return { success: true };
            } catch (error) {
                console.error('Error saving air conditioner:', error);
                throw error;
            }
        }

        // Initialize
        document.addEventListener('DOMContentLoaded', async function() {
            console.log('Starting initialization...');
            showNotification('Đang tải dữ liệu...', 'info');
            
            // Initialize settings manager and update dropdowns
            settingsManager.updateFormDropdowns();
            
            try {
                console.log('Fetching data from API...');
                // Try to load data from API
                const apiData = await fetchAirConditioners();
                
                if (apiData && apiData.length > 0) {
                    console.log('API data loaded:', airConditioners.length);
                    await fetchStatistics();
                    updateStats();
                    updateUpcomingSchedule();
                    displayAirConditioners();
                    showNotification('Tải dữ liệu từ API thành công!', 'success');
                } else {
                    showNotification('Không có dữ liệu điều hòa nào', 'info');
                    displayAirConditioners(); // Hiển thị bảng trống
                }
            } catch (error) {
                console.error('Error fetching from API:', error);
                showNotification('Lỗi kết nối API: ' + error.message, 'error');
                displayAirConditioners(); // Hiển thị bảng trống
            }
        });

        // Update statistics
        async function updateStats() {
            try {
                // Use API statistics if available, otherwise calculate from current data
                let stats;
                if (statistics.ac_by_status) {
                    stats = {
                        excellent: statistics.ac_by_status.excellent || 0,
                        good: statistics.ac_by_status.good || 0,
                        maintenance: statistics.ac_by_status.maintenance || 0,
                        repair: statistics.ac_by_status.repair || 0,
                        total: statistics.total_acs || 0
                    };
                } else {
                    // Fallback to local calculation
                    stats = {
                        excellent: airConditioners.filter(ac => ac.status === 'excellent').length,
                        good: airConditioners.filter(ac => ac.status === 'good').length,
                        maintenance: airConditioners.filter(ac => ac.status === 'maintenance').length,
                        repair: airConditioners.filter(ac => ac.status === 'repair').length,
                        total: airConditioners.length
                    };
                }

                document.getElementById('totalGood').textContent = stats.excellent + stats.good;
                document.getElementById('totalMaintenance').textContent = stats.maintenance;
                document.getElementById('totalRepair').textContent = stats.repair;
                document.getElementById('totalUnits').textContent = stats.total;
            } catch (error) {
                console.error('Error updating stats:', error);
            }
        }

        // Update upcoming schedule
        async function updateUpcomingSchedule() {
            try {
                const scheduleEl = document.getElementById('upcomingSchedule');
                
                // Use API upcoming maintenance if available
                let upcoming;
                if (statistics.upcoming_maintenance && statistics.upcoming_maintenance.length > 0) {
                    upcoming = statistics.upcoming_maintenance;
                } else {
                    // Fallback to local calculation
                    upcoming = airConditioners
                        .filter(ac => ac.nextMaintenance && new Date(ac.nextMaintenance) <= new Date(Date.now() + 30 * 24 * 60 * 60 * 1000))
                        .sort((a, b) => new Date(a.nextMaintenance) - new Date(b.nextMaintenance))
                        .slice(0, 5);
                }
                
                if (upcoming.length === 0) {
                    scheduleEl.innerHTML = '<p class="mb-0 opacity-75">✅ Không có lịch bảo dưỡng khẩn cấp trong 30 ngày tới</p>';
                    return;
                }

                const scheduleHTML = upcoming.map(item => {
                    const ac = item.code ? item : airConditioners.find(a => a.id === item.id);
                    if (!ac) return '';
                    
                    return `
                        <div class="d-flex justify-content-between align-items-center mb-2 p-2 rounded" style="background: rgba(255,255,255,0.1);">
                            <div>
                                <strong>${ac.code}</strong> - ${ac.location}
                                <br><small class="opacity-75">${ac.area}</small>
                            </div>
                            <span class="badge bg-light text-dark px-3 py-2">
                                ${new Date(ac.nextMaintenance || ac.next_maintenance).toLocaleDateString('vi-VN')}
                            </span>
                        </div>
                    `;
                }).filter(Boolean).join('');

                scheduleEl.innerHTML = scheduleHTML;
            } catch (error) {
                console.error('Error updating upcoming schedule:', error);
            }
        }

        // Display air conditioners in table format
        function displayAirConditioners() {
            const container = document.getElementById('airConditionerList');
            
            console.log('Displaying air conditioners:', filteredAirConditioners.length, 'items');
            
            if (filteredAirConditioners.length === 0) {
                container.innerHTML = `
                    <div class="ac-table">
                        <div class="text-center py-5">
                            <div style="font-size: 4rem; opacity: 0.3;">
                                <i class="bi bi-search"></i>
                            </div>
                            <h4 class="mt-3 text-muted">Không tìm thấy điều hòa nào</h4>
                            <p class="text-muted">Thử thay đổi bộ lọc hoặc thêm điều hòa mới</p>
                        </div>
                    </div>
                `;
                return;
            }

            const tableHTML = `
                <div class="ac-table">
                    <div class="table-responsive">
                        <table class="table table-hover table-sm">
                            <thead>
                                <tr>
                                    <th style="width: 8%;">Mã</th>
                                    <th style="width: 15%;">Vị Trí</th>
                                    <th style="width: 15%;">Loại</th>
                                    <th style="width: 8%;">Hãng</th>
                                    <th style="width: 8%;">BTU</th>
                                    <th style="width: 12%;">Trạng Thái</th>
                                    <th style="width: 10%;">BĐ Cuối</th>
                                    <th style="width: 10%;">BĐ Tiếp</th>
                                    <th style="width: 14%;">Thao Tác</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredAirConditioners.map(ac => `
                                    <tr>
                                        <td class="text-center">
                                            <span class="code-text">${ac.code}</span>
                                        </td>
                                        <td>
                                            <div class="location-text">${ac.location}</div>
                                            <div class="location-area">${ac.area}</div>
                                        </td>
                                        <td class="text-center">
                                            <span class="brand-badge">${getTypeText(ac.type)}</span>
                                        </td>
                                        <td class="text-center">
                                            <span class="brand-badge">${ac.brand || '-'}</span>
                                        </td>
                                        <td class="text-center">
                                            ${ac.capacity ? `<span class="capacity-badge">${(ac.capacity/1000).toFixed(0)}K</span>` : '<span class="text-muted">-</span>'}
                                        </td>
                                        <td class="text-center">
                                            <span class="status-badge-table status-${ac.status}">
                                                ${getStatusText(ac.status).replace('Hoạt động ', '').replace('Cần ', '')}
                                            </span>
                                        </td>
                                        <td class="text-center">
                                            <div class="date-text">
                                                ${ac.lastMaintenance ? formatVietnameseDate(ac.lastMaintenance) : '-'}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="date-text">
                                                ${ac.nextMaintenance ? formatVietnameseDate(ac.nextMaintenance) : '-'}
                                            </div>
                                        </td>
                                        <td class="text-center">
                                            <div class="d-flex justify-content-center gap-1">
                                                <button class="action-btn-sm" onclick="showDetail(${ac.id})" title="Xem chi tiết">
                                                    <i class="bi bi-eye"></i>
                                                </button>
                                                <div class="dropdown d-inline">
                                                    <button class="action-btn-sm" type="button" data-bs-toggle="dropdown" title="Xem thêm">
                                                        <i class="bi bi-three-dots"></i>
                                                    </button>
                                                    <ul class="dropdown-menu dropdown-menu-end">
                                                        <li><a class="dropdown-item" href="#" onclick="performMaintenance(${ac.id})">
                                                            <i class="bi bi-tools me-2"></i>Bảo dưỡng
                                                        </a></li>
                                                        <li><a class="dropdown-item" href="#" onclick="performRepair(${ac.id})">
                                                            <i class="bi bi-wrench me-2"></i>Sửa chữa
                                                        </a></li>
                                                        <li><hr class="dropdown-divider"></li>
                                                        <li><a class="dropdown-item" href="#" onclick="editAirConditioner(${ac.id})">
                                                            <i class="bi bi-pencil me-2"></i>Chỉnh sửa
                                                        </a></li>
                                                    </ul>
                                                </div>
                                            </div>
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    
                    <!-- Table Summary -->
                    <div class="p-2 bg-light border-top">
                        <div class="row align-items-center">
                            <div class="col-md-6">
                                <small class="text-muted">
                                    <i class="bi bi-info-circle me-1"></i>
                                    <strong>${filteredAirConditioners.length}</strong>/${airConditioners.length} điều hòa
                                </small>
                            </div>
                            <div class="col-md-6 text-md-end">
                                <div class="d-flex justify-content-md-end gap-1 mt-1 mt-md-0">
                                    <button class="btn btn-outline-primary btn-sm" onclick="exportToExcel()">
                                        <i class="bi bi-download"></i> Excel
                                    </button>
                                    <button class="btn btn-outline-secondary btn-sm" onclick="printTable()">
                                        <i class="bi bi-printer"></i> In
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            container.innerHTML = tableHTML;
        }

        // Utility functions
        function getStatusText(status) {
            const statusMap = {
                'excellent': 'Hoạt động xuất sắc',
                'good': 'Hoạt động tốt',
                'maintenance': 'Cần bảo dưỡng',
                'repair': 'Cần sửa chữa',
                'broken': 'Hỏng'
            };
            return statusMap[status] || status;
        }

        function getTypeText(type) {
            const typeMap = {
                'split': 'Điều hòa treo tường',
                'multi': 'Điều hòa cây',
                'central': 'Điều hòa trung tâm',
                'cassette': 'Điều hòa Âm trần'
            };
            // Chuyển về chữ thường để so sánh không phân biệt hoa thường
            const lowerType = type ? type.toLowerCase() : '';
            return typeMap[lowerType] || type;
        }

        function getWorkTypeText(type) {
            const typeMap = {
                'maintenance': 'Bảo dưỡng định kỳ',
                'repair': 'Sửa chữa',
                'inspection': 'Kiểm tra',
                'cleaning': 'Vệ sinh',
                'replacement': 'Thay thế linh kiện'
            };
            return typeMap[type] || type;
        }

        // Filter functions
        function applyFilter() {
            const area = document.getElementById('filterArea').value;
            const status = document.getElementById('filterStatus').value;
            const type = document.getElementById('filterType').value;
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredAirConditioners = airConditioners.filter(ac => {
                return (!area || ac.area === area) &&
                       (!status || ac.status === status) &&
                       (!type || ac.type === type) &&
                       (!search || ac.code.toLowerCase().includes(search) || 
                        ac.location.toLowerCase().includes(search) ||
                        (ac.brand && ac.brand.toLowerCase().includes(search)));
            });

            displayAirConditioners();
        }

        function resetFilter() {
            document.getElementById('filterArea').value = '';
            document.getElementById('filterStatus').value = '';
            document.getElementById('filterType').value = '';
            document.getElementById('searchInput').value = '';
            filteredAirConditioners = [...airConditioners];
            displayAirConditioners();
        }

        // Force refresh function for testing
        function forceRefresh() {
            console.log('Force refreshing data...');
            showNotification('Đang làm mới dữ liệu...', 'info');
            
            // Reload data from API
            fetchAirConditioners().then(() => {
            fetchStatistics().then(() => {
                updateStats();
                updateUpcomingSchedule();
                displayAirConditioners();
                showNotification('Dữ liệu đã được làm mới!', 'success');
                });
            });
        }

        // Modal functions
        function showAddModal() {
            document.getElementById('modalTitle').textContent = 'Thêm Điều Hòa Mới';
            document.getElementById('acForm').reset();
            document.getElementById('acId').value = '';
            
            // Cài đặt giá trị mặc định
            const today = new Date().toISOString().split('T')[0]; // Định dạng YYYY-MM-DD
            // Tính ngày bảo hành (ngày hiện tại + 24 tháng)
            const warrantyDate = new Date();
            warrantyDate.setMonth(warrantyDate.getMonth() + 24);
            const warrantyDateStr = warrantyDate.toISOString().split('T')[0];
            
            // Loại điều hòa mặc định: split
            setTimeout(() => {
                // Tìm kiếm option có value='split'
                const typeSelect = document.getElementById('acType');
                const splitOption = Array.from(typeSelect.options).find(option => option.value === 'split');
                if (splitOption) {
                    typeSelect.value = 'split';
                } else {
                    // Nếu không có option 'split', chọn option đầu tiên nếu có
                    if (typeSelect.options.length > 1) {
                        typeSelect.selectedIndex = 1;
                    }
                }
            }, 100);
            
            // Công suất mặc định: 12000 BTU
            document.getElementById('acCapacity').value = '12000';
            
            // Ngày lắp đặt mặc định: Hôm nay
            document.getElementById('acInstallDate').value = today;
            
            // Ngày bảo hành mặc định: Hôm nay + 24 tháng
            document.getElementById('acWarrantyDate').value = warrantyDateStr;
            
            // Trạng thái mặc định: good
            document.getElementById('acStatus').value = 'good';
            
            // Cập nhật dropdown loại/khu vực/hãng/vị trí
            settingsManager.updateFormDropdowns();
            
            // Khu vực mặc định: Tầng 1
            document.getElementById('acArea').value = 'Tầng 1';
            
            updateLocationDropdown();
            updateBrandDropdown();
            
            // Hãng sản xuất mặc định: Daikin (nếu có)
            const brands = settingsManager.getBrandOptions();
            if (brands.some(brand => brand.value === 'Daikin')) {
                document.getElementById('acBrand').value = 'Daikin';
            }
            
            // Chọn vị trí đầu tiên (nếu có)
            setTimeout(() => {
                const locationSelect = document.getElementById('acLocation');
                if (locationSelect.options.length > 1) {
                    locationSelect.selectedIndex = 1; // Chọn option đầu tiên sau placeholder
                }
            }, 100);
            
            const modal = new bootstrap.Modal(document.getElementById('acModal'));
            modal.show();
        }

        // Cập nhật danh sách vị trí (không còn lọc theo khu vực)
        function updateLocationDropdown() {
            const locationSelect = document.getElementById('acLocation');
            // Lấy toàn bộ danh sách vị trí
            const locations = settingsManager.getLocationOptions();
            if (locations.length === 0) {
                locationSelect.innerHTML = '<option value="">Chọn vị trí</option>' +
                    '<option value="" disabled>Không có vị trí nào, hãy thêm ở trang Cài Đặt</option>';
            } else {
                locationSelect.innerHTML = '<option value="">Chọn vị trí</option>' +
                    locations.map(loc => `<option value="${loc.value}">${loc.text}</option>`).join('');
            }
        }

        // Cập nhật danh sách hãng
        function updateBrandDropdown() {
            const brandSelect = document.getElementById('acBrand');
            const brands = settingsManager.getBrandOptions();
            brandSelect.innerHTML = '<option value="">Chọn hãng</option>' +
                brands.map(brand => `<option value="${brand.value}">${brand.text}</option>`).join('');
        }

        // Khi thay đổi khu vực thì cập nhật lại vị trí
        document.addEventListener('change', function(e) {
            if (e.target.id === 'acArea') {
                updateLocationDropdown();
            }
        });

        function editAirConditioner(id) {
            const ac = airConditioners.find(a => a.id === id);
            if (!ac) return;
            
            console.log('Editing AC:', ac); // Debug để kiểm tra dữ liệu

            document.getElementById('modalTitle').textContent = 'Chỉnh Sửa Điều Hòa';
            document.getElementById('acForm').reset();
            
            // Thiết lập ID trước
            document.getElementById('acId').value = ac.id;
            
            // Cập nhật các dropdown 
            settingsManager.updateFormDropdowns();
            updateLocationDropdown();
            updateBrandDropdown();
            
            // Tăng thời gian timeout để đảm bảo dropdown đã được cập nhật hoàn toàn
            setTimeout(() => {
                console.log('Setting values after timeout');
                console.log('AC data:', ac, 'Serial field:', ac.serial);
                
                // Thiết lập giá trị cơ bản trước
                document.getElementById('acCode').value = ac.code || '';
                // Kiểm tra serial hoặc các tên trường thay thế
                if (ac.serial !== undefined) {
                    document.getElementById('acSerial').value = ac.serial;
                    console.log('Set serial from ac.serial:', ac.serial);
                } else if (ac.so_serial !== undefined) {
                    document.getElementById('acSerial').value = ac.so_serial;
                    console.log('Set serial from ac.so_serial:', ac.so_serial);
                } else {
                    document.getElementById('acSerial').value = '';
                    console.log('Serial field not found in data');
                }
                document.getElementById('acNotes').value = ac.notes || '';
                
                // Đặt giá trị cho các dropdown, xử lý đặc biệt nếu cần
                if (ac.type) {
                    const typeSelect = document.getElementById('acType');
                    // Kiểm tra xem giá trị có trong dropdown không
                    const typeExists = Array.from(typeSelect.options).some(option => option.value === ac.type);
                    if (typeExists) {
                        typeSelect.value = ac.type;
                    } else {
                        console.warn("Loại điều hòa không tìm thấy trong danh sách:", ac.type);
                        // Thêm tạm thời option cho loại điều hòa
                        let typeName = ac.type;
                        // Map lại tên hiển thị cho type
                        const typeMap = {
                            'split': 'Điều hòa treo tường',
                            'multi': 'Điều hòa cây',
                            'central': 'Điều hòa trung tâm',
                            'cassette': 'Điều hòa âm trần'
                        };
                        if (typeMap[ac.type]) {
                            typeName = typeMap[ac.type];
                        }
                        const option = new Option(typeName, ac.type);
                        typeSelect.add(option);
                        typeSelect.value = ac.type;
                    }
                }
                
                // Khu vực và vị trí
                if (ac.area) {
            document.getElementById('acArea').value = ac.area;
                    // Cập nhật lại dropdown vị trí sau khi đã chọn khu vực
                    updateLocationDropdown();
                    
                    // Đợi thêm một chút để vị trí được cập nhật
                    setTimeout(() => {
                        if (ac.location) {
            document.getElementById('acLocation').value = ac.location;
                            if (!document.getElementById('acLocation').value) {
                                console.warn("Không tìm thấy vị trí phù hợp:", ac.location);
                            }
                        }
                    }, 100);
                }
                
                // Công suất
                if (ac.capacity) {
                    const capacitySelect = document.getElementById('acCapacity');
                    const capacityExists = Array.from(capacitySelect.options).some(option => option.value == ac.capacity);
                    if (capacityExists) {
                        capacitySelect.value = ac.capacity;
                    } else {
                        // Thêm tạm thời option cho capacity
                        console.warn("Thêm tạm option công suất:", ac.capacity);
                        const option = new Option(ac.capacity + ' BTU', ac.capacity);
                        capacitySelect.add(option);
                        capacitySelect.value = ac.capacity;
                    }
                }
                
                // Hãng sản xuất
                if (ac.brand) {
                    document.getElementById('acBrand').value = ac.brand;
                }
                
                // Trạng thái
                if (ac.status) {
            document.getElementById('acStatus').value = ac.status;
                }
                
                // Ngày tháng
                if (ac.installDate) {
                    try {
                        const installDate = typeof ac.installDate === 'string' ? ac.installDate.split('T')[0] : '';
                        document.getElementById('acInstallDate').value = installDate;
                    } catch (e) {
                        console.error("Lỗi khi xử lý ngày lắp đặt:", e);
                    }
                }
                
                if (ac.warrantyDate) {
                    try {
                        const warrantyDate = typeof ac.warrantyDate === 'string' ? ac.warrantyDate.split('T')[0] : '';
                        document.getElementById('acWarrantyDate').value = warrantyDate;
                    } catch (e) {
                        console.error("Lỗi khi xử lý ngày bảo hành:", e);
                    }
                }
                
                // Hiển thị ảnh đại diện nếu có
                if (ac.avatar_url) {
                    try {
                        // Xử lý URL nếu là chuỗi JSON
                        const avatarUrl = typeof ac.avatar_url === 'string' && ac.avatar_url.startsWith('[') ? 
                            JSON.parse(ac.avatar_url)[0] : ac.avatar_url;
                        
                        // Chuyển đổi URL Google Drive nếu cần
                        const displayUrl = convertGoogleDriveUrl(avatarUrl);
                        
                        const previewContainer = document.createElement('div');
                        previewContainer.className = 'mt-2';
                        previewContainer.innerHTML = `
                            <img src="${displayUrl}" alt="Ảnh đại diện" style="max-height: 80px; max-width: 100%;" class="rounded border">
                            <p class="small text-muted mt-1">Ảnh hiện tại</p>
                        `;
                        document.getElementById('acAvatar').parentNode.appendChild(previewContainer);
                    } catch (e) {
                        console.error("Lỗi khi xử lý ảnh đại diện:", e);
                    }
                }
                
                // Hiển thị ảnh điều hòa nếu có
                if (ac.images_urls) {
                    try {
                        // Parse chuỗi JSON nếu cần
                        let imageUrls = ac.images_urls;
                        if (typeof ac.images_urls === 'string') {
                            try {
                                imageUrls = JSON.parse(ac.images_urls);
                                console.log("Parsed images_urls:", imageUrls);
                            } catch (jsonErr) {
                                console.error("Error parsing images_urls JSON:", jsonErr);
                                imageUrls = ac.images_urls.split(','); // Fallback: thử tách theo dấu phẩy
                            }
                        }
                        
                        // Đảm bảo imageUrls là mảng
                        if (!Array.isArray(imageUrls)) {
                            imageUrls = [imageUrls];
                        }
                        
                        if (imageUrls && imageUrls.length > 0) {
                            const previewContainer = document.createElement('div');
                            previewContainer.className = 'mt-2 d-flex gap-2 flex-wrap';
                            
                            imageUrls.forEach(url => {
                                if (!url) return; // Bỏ qua URL rỗng
                                
                                // Chuyển đổi URL Google Drive nếu cần
                                const displayUrl = convertGoogleDriveUrl(url);
                                
                                const imgDiv = document.createElement('div');
                                imgDiv.innerHTML = `<img src="${displayUrl}" alt="Ảnh điều hòa" style="height: 60px; width: auto;" class="rounded border">`;
                                previewContainer.appendChild(imgDiv);
                            });
                            
                            previewContainer.innerHTML += `<p class="small text-muted w-100 mt-1">Đã có ${imageUrls.length} ảnh</p>`;
                            document.getElementById('acImages').parentNode.appendChild(previewContainer);
                        }
                    } catch (e) {
                        console.error("Lỗi khi xử lý ảnh điều hòa:", e);
                    }
                }
                
                // Hiển thị ảnh giấy tờ nếu có
                if (ac.documents_urls) {
                    try {
                        // Parse chuỗi JSON nếu cần
                        let docUrls = ac.documents_urls;
                        if (typeof ac.documents_urls === 'string') {
                            try {
                                docUrls = JSON.parse(ac.documents_urls);
                                console.log("Parsed documents_urls:", docUrls);
                            } catch (jsonErr) {
                                console.error("Error parsing documents_urls JSON:", jsonErr);
                                docUrls = ac.documents_urls.split(','); // Fallback: thử tách theo dấu phẩy
                            }
                        }
                        
                        // Đảm bảo docUrls là mảng
                        if (!Array.isArray(docUrls)) {
                            docUrls = [docUrls];
                        }
                        
                        if (docUrls && docUrls.length > 0) {
                            const previewContainer = document.createElement('div');
                            previewContainer.className = 'mt-2 d-flex gap-2 flex-wrap';
                            
                            docUrls.forEach(url => {
                                if (!url) return; // Bỏ qua URL rỗng
                                
                                // Chuyển đổi URL Google Drive nếu cần
                                const displayUrl = convertGoogleDriveUrl(url);
                                
                                const imgDiv = document.createElement('div');
                                imgDiv.innerHTML = `<img src="${displayUrl}" alt="Ảnh giấy tờ" style="height: 60px; width: auto;" class="rounded border">`;
                                previewContainer.appendChild(imgDiv);
                            });
                            
                            previewContainer.innerHTML += `<p class="small text-muted w-100 mt-1">Đã có ${docUrls.length} ảnh</p>`;
                            document.getElementById('acDocuments').parentNode.appendChild(previewContainer);
                        }
                    } catch (e) {
                        console.error("Lỗi khi xử lý ảnh giấy tờ:", e);
                    }
                }
                
            }, 300);  // Tăng thời gian chờ lên 300ms

            const modal = new bootstrap.Modal(document.getElementById('acModal'));
            modal.show();
        }

        async function saveAirConditioner() {
            // Lấy dữ liệu form và file
            const code = document.getElementById('acCode').value;
            const type = document.getElementById('acType').value;
            const area = document.getElementById('acArea').value;
            const location = document.getElementById('acLocation').value;
            const capacity = document.getElementById('acCapacity').value;
            const brand = document.getElementById('acBrand').value;
            const install_date = document.getElementById('acInstallDate').value;
            const warranty_date = document.getElementById('acWarrantyDate').value;
            const status = document.getElementById('acStatus').value;
            const notes = document.getElementById('acNotes').value;
            const serial = document.getElementById('acSerial').value;
            const acId = document.getElementById('acId').value;
            const isEdit = !!acId;
            const avatar = document.getElementById('acAvatar').files[0];
            const images = document.getElementById('acImages').files;
            const documents = document.getElementById('acDocuments').files;

            if (!code || !type || !area || !location) {
                alert('Vui lòng điền đầy đủ các trường bắt buộc!');
                return;
            }

            const formData = new FormData();
            formData.append('ma_dieu_hoa', code);
            formData.append('loai', type);
            formData.append('khu_vuc', area);
            formData.append('vi_tri', location);
            formData.append('cong_suat', capacity);
            formData.append('hang', brand);
            formData.append('ngay_lap_dat', install_date);
            formData.append('ngay_bao_hanh', warranty_date);
            formData.append('trang_thai', status);
            formData.append('ghi_chu', notes);
            formData.append('serial', serial);
            
            // Thêm id và action cho chỉnh sửa
            if (isEdit) {
                formData.append('id', acId);
                formData.append('action', 'update');
            } else {
                formData.append('action', 'create');
                // Tính ngày bảo dưỡng tiếp theo (6 tháng) chỉ khi thêm mới
                    const nextMaintenanceDate = new Date();
                nextMaintenanceDate.setDate(nextMaintenanceDate.getDate() + 180);
                formData.append('bao_duong_tiep_theo', nextMaintenanceDate.toISOString().split('T')[0]);
            }
            
            // Ảnh đại diện
            if (avatar) formData.append('avatar', avatar);
            // Ảnh điều hòa
            for (let i = 0; i < images.length; i++) {
                formData.append('images', images[i]);
            }
            // Ảnh giấy tờ bàn giao
            for (let i = 0; i < documents.length; i++) {
                formData.append('documents', documents[i]);
            }

            try {
                const response = await fetch('https://autoslp.duckdns.org:5678/webhook/themdieuhoa', {
                    method: 'POST',
                    body: formData
                });
                if (!response.ok) throw new Error('Lỗi khi gửi dữ liệu lên webhook!');
                // Có thể lấy kết quả trả về nếu cần
                // const result = await response.json();

                // Làm mới dữ liệu
                await fetchAirConditioners();
                updateStats();
                updateUpcomingSchedule();
                displayAirConditioners();

                const modal = bootstrap.Modal.getInstance(document.getElementById('acModal'));
                modal.hide();
                showNotification(isEdit ? 'Cập nhật thành công!' : 'Thêm mới thành công!', 'success');
            } catch (error) {
                console.error('Error saving air conditioner:', error);
                showNotification('Lỗi khi lưu dữ liệu: ' + error.message, 'error');
            }
        }

        // Detail Modal Functions
        function showDetail(id) {
            const ac = airConditioners.find(a => a.id === id);
            if (!ac) return;

            // Redirect to detail page with AC code parameter
            window.location.href = `chitietdieuhoa.html?ma_dieu_hoa=${ac.code}`;
        }

        function previewImage(src) {
            document.getElementById('previewImage').src = src;
            const modal = new bootstrap.Modal(document.getElementById('imageModal'));
            modal.show();
        }

        // Action functions
        async function performMaintenance(id) {
            if (confirm('Xác nhận thực hiện bảo dưỡng điều hòa này?')) {
                try {
                    const ac = airConditioners.find(a => a.id === id);
                    if (!ac) {
                        showNotification('Không tìm thấy điều hòa!', 'error');
                        return;
                    }

                    // Prepare maintenance data
                    const maintenanceData = {
                        action: 'maintenance',
                        air_conditioner: {
                            id: ac.id,
                            code: ac.code,
                            area: ac.area,
                            location: ac.location
                        },
                        work_data: {
                            work_date: new Date().toISOString().split('T')[0],
                            type: 'maintenance',
                            description: 'Bảo dưỡng định kỳ',
                            worker_name: 'Nhân viên kỹ thuật',
                            status: 'completed',
                            notes: 'Thực hiện bảo dưỡng qua hệ thống'
                        },
                        timestamp: new Date().toISOString()
                    };

                    // Send to webhook
                    const response = await fetch(`${WEBHOOK_BASE_URL}/maintenance`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(maintenanceData)
                    });

                    if (response.ok) {
                        // Update local data
                        ac.lastMaintenance = new Date().toISOString().split('T')[0];
                        ac.nextMaintenance = new Date(Date.now() + 180 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
                        ac.status = ac.status === 'maintenance' ? 'good' : ac.status;
                        
                        updateStats();
                        updateUpcomingSchedule();
                        displayAirConditioners();
                        
                        showNotification('Đã ghi nhận thực hiện bảo dưỡng!', 'success');
                    } else {
                        throw new Error('Lỗi khi gửi dữ liệu bảo dưỡng');
                    }
                } catch (error) {
                    console.error('Error performing maintenance:', error);
                    showNotification('Lỗi khi thực hiện bảo dưỡng: ' + error.message, 'error');
                }
            }
        }

        async function performRepair(id) {
            if (confirm('Xác nhận thực hiện sửa chữa điều hòa này?')) {
                try {
                    const ac = airConditioners.find(a => a.id === id);
                    if (!ac) {
                        showNotification('Không tìm thấy điều hòa!', 'error');
                        return;
                    }

                    // Prepare repair data
                    const repairData = {
                        action: 'repair',
                        air_conditioner: {
                            id: ac.id,
                            code: ac.code,
                            area: ac.area,
                            location: ac.location
                        },
                        work_data: {
                            work_date: new Date().toISOString().split('T')[0],
                            type: 'repair',
                            description: 'Sửa chữa hỏng hóc',
                            worker_name: 'Nhân viên kỹ thuật',
                            status: 'completed',
                            notes: 'Thực hiện sửa chữa qua hệ thống'
                        },
                        timestamp: new Date().toISOString()
                    };

                    // Send to webhook
                    const response = await fetch(`${WEBHOOK_BASE_URL}/repair`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(repairData)
                    });

                    if (response.ok) {
                        // Update local data
                        ac.status = 'good';
                        
                        updateStats();
                        displayAirConditioners();
                        
                        showNotification('Đã ghi nhận thực hiện sửa chữa!', 'success');
                    } else {
                        throw new Error('Lỗi khi gửi dữ liệu sửa chữa');
                    }
                } catch (error) {
                    console.error('Error performing repair:', error);
                    showNotification('Lỗi khi thực hiện sửa chữa: ' + error.message, 'error');
                }
            }
        }

        function viewReports() {
            alert('Chức năng báo cáo đang được phát triển!');
        }

        // Data refresh function
        // Removed refresh functionality

        // Add refresh button to interface
        // Removed refresh button functionality

        // Utility function to format Vietnamese date
        function formatVietnameseDate(dateString) {
            if (!dateString) return '-';
            try {
                const date = new Date(dateString);
                return date.toLocaleDateString('vi-VN');
            } catch (error) {
                return dateString;
            }
        }

        // Utility function to format currency
        function formatCurrency(amount) {
            if (!amount || amount === 0) return '0₫';
            return new Intl.NumberFormat('vi-VN', {
                style: 'currency',
                currency: 'VND'
            }).format(amount);
        }

        // Notification function
        function showNotification(message, type = 'info') {
            const alertClass = type === 'success' ? 'alert-success' : type === 'error' ? 'alert-danger' : 'alert-info';
            const notification = document.createElement('div');
            notification.className = `alert ${alertClass} alert-dismissible fade show position-fixed`;
            notification.style.cssText = 'top: 100px; right: 20px; z-index: 9999; min-width: 300px;';
            notification.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            
            document.body.appendChild(notification);
            
            setTimeout(() => {
                if (notification.parentNode) {
                    notification.parentNode.removeChild(notification);
                }
            }, 5000);
        }

        // Export and Print functions
        function exportToExcel() {
            // Tạo dữ liệu cho Excel
            const data = filteredAirConditioners.map(ac => ({
                'Mã điều hòa': ac.code,
                'Khu vực': ac.area,
                'Vị trí': ac.location,
                'Loại': getTypeText(ac.type),
                'Hãng': ac.brand || 'Chưa có',
                'Công suất (BTU)': ac.capacity || 'Chưa có',
                'Trạng thái': getStatusText(ac.status),
                'Ngày lắp đặt': ac.installDate ? new Date(ac.installDate).toLocaleDateString('vi-VN') : 'Chưa có',
                'Bảo dưỡng cuối': new Date(ac.lastMaintenance).toLocaleDateString('vi-VN'),
                'Bảo dưỡng tiếp': new Date(ac.nextMaintenance).toLocaleDateString('vi-VN'),
                'Ghi chú': ac.notes || ''
            }));

            // Tạo CSV content
            const headers = Object.keys(data[0]);
            const csvContent = [
                headers.join(','),
                ...data.map(row => headers.map(field => `"${row[field]}"`).join(','))
            ].join('\n');

            // Download file
            const blob = new Blob(['\uFEFF' + csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement('a');
            if (link.download !== undefined) {
                const url = URL.createObjectURL(blob);
                link.setAttribute('href', url);
                link.setAttribute('download', `danh_sach_dieu_hoa_${new Date().toISOString().split('T')[0]}.csv`);
                link.style.visibility = 'hidden';
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
            }

            showNotification('Đã xuất file Excel thành công!', 'success');
        }

        function printTable() {
            const printWindow = window.open('', '_blank');
            const printContent = `
                <html>
                <head>
                    <title>Danh Sách Điều Hòa</title>
                    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
                    <style>
                        body { font-family: Arial, sans-serif; }
                        .header { text-align: center; margin-bottom: 30px; }
                        .table { font-size: 12px; }
                        .status-excellent { background: #d4edda; color: #155724; }
                        .status-good { background: #d4edda; color: #155724; }
                        .status-maintenance { background: #fff3cd; color: #856404; }
                        .status-repair { background: #f8d7da; color: #721c24; }
                        .status-broken { background: #f8d7da; color: #721c24; }
                        @media print {
                            .no-print { display: none; }
                        }
                    </style>
                </head>
                <body>
                    <div class="container-fluid">
                        <div class="header">
                            <h2>DANH SÁCH ĐIỀU HÒA CÔNG TY</h2>
                            <p>Ngày in: ${new Date().toLocaleDateString('vi-VN')}</p>
                        </div>
                        <table class="table table-bordered table-striped">
                            <thead class="table-dark">
                                <tr>
                                    <th>STT</th>
                                    <th>Mã ĐH</th>
                                    <th>Vị Trí</th>
                                    <th>Loại</th>
                                    <th>Hãng</th>
                                    <th>Công Suất</th>
                                    <th>Trạng Thái</th>
                                    <th>Bảo Dưỡng Cuối</th>
                                    <th>Bảo Dưỡng Tiếp</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${filteredAirConditioners.map((ac, index) => `
                                    <tr>
                                        <td>${index + 1}</td>
                                        <td><strong>${ac.code}</strong></td>
                                        <td>${ac.area} - ${ac.location}</td>
                                        <td>${getTypeText(ac.type)}</td>
                                        <td>${ac.brand || 'Chưa có'}</td>
                                        <td>${ac.capacity ? ac.capacity.toLocaleString() + ' BTU' : '-'}</td>
                                        <td><span class="status-${ac.status} px-2 py-1 rounded">${getStatusText(ac.status)}</span></td>
                                        <td>${new Date(ac.lastMaintenance).toLocaleDateString('vi-VN')}</td>
                                        <td>${new Date(ac.nextMaintenance).toLocaleDateString('vi-VN')}</td>
                                    </tr>
                                    ${ac.notes ? `
                                        <tr>
                                            <td colspan="9" class="text-muted" style="font-size: 11px;">
                                                <em>Ghi chú: ${ac.notes}</em>
                                            </td>
                                        </tr>
                                    ` : ''}
                                `).join('')}
                            </tbody>
                        </table>
                        <div class="mt-4">
                            <p><strong>Tổng số điều hòa:</strong> ${filteredAirConditioners.length}</p>
                            <p><strong>Người lập:</strong> _________________ &nbsp;&nbsp;&nbsp; <strong>Ngày:</strong> _________________</p>
                        </div>
                    </div>
                </body>
                </html>
            `;
            
            printWindow.document.write(printContent);
            printWindow.document.close();
            printWindow.focus();
            
            setTimeout(() => {
                printWindow.print();
                printWindow.close();
            }, 250);
        }

        // Search on Enter key
        document.getElementById('searchInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                applyFilter();
            }
        });

        // Area change handler for location suggestions
        document.addEventListener('change', function(e) {
            if (e.target.id === 'acArea') {
                settingsManager.onAreaChange(e.target.value);
            }
        });
    </script>
</body>
</html>
