<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công đoạn Xén - Carton Manager</title>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Font Awesome -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <!-- Universal Stage CSS -->
  <link rel="stylesheet" href="universal-stage.css">
  <!-- Sidebar Generator -->
  <script src="sidebar-generator.js"></script>
  <!-- Custom Logout Handler -->
  <script>
    // Định nghĩa handleLogout trước khi auth.js load
    window.handleLogout = function() {
      // Xóa session
      localStorage.removeItem('user_session');
      
      // Ẩn thông tin user
      updateUserInfo();
      
      // Hiển thị login popup
      showLoginPopup({
        onLoginSuccess: function(userData) {
          updateUserInfo();
          refreshData();
        }
      });
    };
  </script>
  
  <!-- Auth Manager -->
  <script src="../js/auth.js"></script>
  <!-- Login Popup Component -->
  <script src="../js/login-popup.js"></script>

  <!-- Custom CSS for Shifts Tab -->
  <style>
    /* Shifts Tab Styles */
    .shifts-container {
      padding: 0;
    }
    
    .shifts-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1rem;
      padding-bottom: 0.5rem;
      border-bottom: 1px solid #e9ecef;
    }
    
    .shifts-header h6 {
      margin: 0;
      color: #495057;
      font-weight: 600;
    }
    
    .shifts-loading {
      display: flex;
      align-items: center;
      color: #6c757d;
      font-size: 0.875rem;
    }
    
    .shifts-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .shifts-stats {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
      margin-bottom: 20px;
    }

    .stat-card {
      background: #f8fafc;
      padding: 16px;
      border-radius: 12px;
      text-align: center;
      border: 1px solid #e2e8f0;
    }

    .stat-number {
      font-size: 24px;
      font-weight: 700;
      color: #2563eb;
      margin-bottom: 4px;
    }

    .stat-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .shift-item {
      background: white;
      border: 1px solid #e2e8f0;
      border-radius: 12px;
      padding: 20px;
      transition: all 0.3s ease;
      position: relative;
      overflow: hidden;
    }

    .shift-item:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
      border-color: #2563eb;
    }

    .shift-item::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      width: 4px;
      height: 100%;
      background: #2563eb;
    }
    
    .shift-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 16px;
    }
    
    .shift-title {
      display: flex;
      align-items: center;
      gap: 8px;
      font-weight: 600;
      color: #1f2937;
    }

    .shift-title i {
      color: #2563eb;
      font-size: 16px;
    }
    
    .shift-status {
      padding: 4px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }
    
    .shift-status.completed {
      background: #dcfce7;
      color: #16a34a;
    }
    
    .shift-status.in_progress {
      background: #fef3c7;
      color: #ca8a04;
    }
    
    .shift-status.waiting {
      background: #e0e7ff;
      color: #2563eb;
    }
    
    .shift-status.paused {
      background: #fecaca;
      color: #dc2626;
    }
    
    .shift-status.handed_over {
      background: #cffafe;
      color: #0891b2;
    }
    
    .shift-details {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 16px;
    }
    
    .shift-detail {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }
    
    .shift-detail-label {
      font-size: 12px;
      color: #6b7280;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      font-weight: 500;
    }
    
    .shift-detail-value {
      font-size: 14px;
      font-weight: 600;
      color: #1f2937;
    }
    
    .shift-times {
      display: flex;
      gap: 24px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
      font-size: 13px;
      color: #6b7280;
    }

    .shift-times span {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .shift-times i {
      font-size: 14px;
    }

    .shift-progress {
      margin-top: 12px;
      padding: 12px;
      background: #f8fafc;
      border-radius: 8px;
    }

    .progress-bar {
      height: 6px;
      background: #e5e7eb;
      border-radius: 3px;
      overflow: hidden;
      margin-bottom: 8px;
    }

    .progress-fill {
      height: 100%;
      background: linear-gradient(90deg, #16a34a, #2563eb);
      border-radius: 3px;
      transition: width 0.3s ease;
    }

    .progress-text {
      font-size: 12px;
      color: #6b7280;
      text-align: center;
    }

    .shift-actions {
      display: flex;
      gap: 8px;
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid #e2e8f0;
    }

    .btn-action {
      padding: 6px 12px;
      border: none;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .btn-view {
      background: #2563eb;
      color: white;
    }

    .btn-view:hover {
      background: #1d4ed8;
      color: white;
    }

    .btn-edit {
      background: #ca8a04;
      color: white;
    }

    .btn-edit:hover {
      background: #a16207;
      color: white;
    }

    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: #6b7280;
    }

    .empty-state i {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h5 {
      margin-bottom: 8px;
      color: #1f2937;
    }

    .empty-state p {
      margin: 0;
      font-size: 14px;
    }

    @media (max-width: 768px) {
      .shifts-stats {
        grid-template-columns: 1fr;
      }
      
      .shift-details {
        grid-template-columns: 1fr;
      }
      
      .shift-times {
        flex-direction: column;
        gap: 8px;
      }
    }
    
    .shift-summary {
      background: #e9ecef;
      border-radius: 6px;
      padding: 1rem;
      margin-top: 1rem;
    }
    
    .shift-summary h6 {
      margin-bottom: 0.75rem;
      color: #495057;
      font-weight: 600;
    }
    
    .summary-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(120px, 1fr));
      gap: 0.75rem;
    }
    
    .summary-stat {
      text-align: center;
      padding: 0.5rem;
      background: white;
      border-radius: 4px;
    }
    
    .summary-stat-value {
      font-size: 1.25rem;
      font-weight: 600;
      color: #495057;
    }
    
    .summary-stat-label {
      font-size: 0.75rem;
      color: #6c757d;
      margin-top: 0.25rem;
    }
    
    .no-shifts {
      text-align: center;
      padding: 2rem;
      color: #6c757d;
    }
    
    .no-shifts i {
      font-size: 2rem;
      margin-bottom: 1rem;
      opacity: 0.5;
    }
    
    .shifts-container {
      min-height: 200px;
      border: 1px solid #ddd;
      padding: 15px;
      background: #fff;
    }
    
    /* Button styles for shift handover */
    .btn-info-custom {
      background: linear-gradient(135deg, #17a2b8, #138496);
      color: white;
      border: none;
      padding: 8px 16px;
      border-radius: 6px;
      font-size: 0.875rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      display: flex;
      align-items: center;
      gap: 6px;
      min-width: 120px;
      justify-content: center;
    }
    
    .btn-info-custom:hover {
      background: linear-gradient(135deg, #138496, #117a8b);
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(23, 162, 184, 0.3);
    }
    
    .btn-info-custom:active {
      transform: translateY(0);
      box-shadow: 0 2px 4px rgba(23, 162, 184, 0.3);
    }
  </style>

</head>
<body data-stage="xen">
  <!-- Sidebar will be generated by JavaScript -->

  <!-- Main Content -->
  <div class="main-content sidebar-collapsed" id="mainContent">
    <div class="content-area">
    <div class="container-fluid p-4">
      
      <!-- Stage Header -->
      <div class="stage-header">
        <div class="d-flex justify-content-between align-items-center">
          <div>
            <h1>
              <i class="bi bi-bullseye me-2"></i>
              Công đoạn Xén
            </h1>

            <p class="mb-0">Xén giấy - Quản lý chi tiết sản xuất</p>
          </div>
          
          <div class="user-controls">
            <div class="user-info d-flex align-items-center me-3">
              <i class="fas fa-user-circle me-2"></i>
              <span id="userName" class="fw-bold me-2">Loading...</span>
              <!-- <span class="badge bg-primary" id="userRole">...</span> -->
            </div>
            <button class="btn btn-outline-primary btn-sm" onclick="handleLogout()">
              <i class="fas fa-sign-out-alt me-1"></i>Đăng xuất
            </button>
          </div>
        </div>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4" id="stageStats">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Tổng lệnh</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalPlan">0</div>
            <div class="stat-label">SL Kế hoạch</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalGood">0</div>
            <div class="stat-label">SL Đạt</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalNg">0</div>
            <div class="stat-label">SL NG</div>
          </div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
                          <h5 class="mb-0">Danh sách lệnh sản xuất </h5>
          <div class="d-flex align-items-center">

            <!-- Main Actions -->
            <button class="btn btn-primary me-2" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
            </button>
            <button class="btn btn-outline-primary me-2" onclick="loadDataWithDateFilter()">
              <i class="bi bi-calendar-range me-1"></i>Tải theo ngày
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filters -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="bi bi-funnel me-2"></i>Bộ lọc dữ liệu
                </h6>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Xóa tất cả bộ lọc">
                  <i class="bi bi-x-circle me-1"></i>Xóa bộ lọc
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label fw-bold">
                    <i class="bi bi-calendar me-1"></i>Từ ngày:
                  </label>
                  <input type="date" class="form-control" id="fromDateFilter" placeholder="Chọn ngày bắt đầu">
                </div>
                <div class="col-md-3">
                  <label class="form-label fw-bold">
                    <i class="bi bi-calendar me-1"></i>Đến ngày:
                  </label>
                  <input type="date" class="form-control" id="toDateFilter" placeholder="Chọn ngày kết thúc">
                </div>
                <!-- <div class="col-md-2">
                  <label class="form-label fw-bold">
                    <i class="bi bi-clock me-1"></i>Ca:
                  </label>
                  <select class="form-select" id="shiftFilter">
                    <option value="">Tất cả</option>
                    <option value="Ca 1">Ca 1</option>
                    <option value="Ca 2">Ca 2</option>
                    <option value="Ca 3">Ca 3</option>
                    <option value="Kíp 1">Kíp 1</option>
                    <option value="Kíp 2">Kíp 2</option>
                  </select>
                </div> -->
                <!-- <div class="col-md-2">
                  <label class="form-label fw-bold">
                    <i class="bi bi-gear me-1"></i>Máy:
                  </label>
                  <select class="form-select" id="machineFilter">
                    <option value="">Tất cả</option>
                    <option value="Xả 1">Xả 1</option>
                    <option value="Xả 2">Xả 2</option>
                    <option value="Xả 3">Xả 3</option>
                  </select>
                </div> -->
                <div class="col-md-5">
                  <label class="form-label fw-bold">
                    <i class="bi bi-search me-1"></i>Tìm kiếm:
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã lệnh, sản phẩm, máy, thợ...">
                    <button class="btn btn-primary" type="button" onclick="applyFilters()">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <!-- <small class="text-muted">Tự động tìm kiếm khi nhập (300ms delay)</small> -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabs Navigation -->
          <ul class="nav nav-tabs mb-3" id="machineTabs" role="tablist">
            <!-- Dynamic tabs will be generated here -->
          </ul>
          
          <!-- Tab Content -->
          <div class="tab-content" id="machineTabContent">
            <!-- Dynamic tab content will be generated here -->
          </div>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // === CẤU HÌNH CÔNG ĐOẠN HIỆN TẠI ===
    const $stage_now = 'xen'; // Thay đổi giá trị này để chuyển sang công đoạn khác: xa, xen, in_offset, boi, be, dan, kho
    
    // === CẤU HÌNH STAGE TỰ ĐỘNG ===
    const STAGE_CONFIGS = {
        xa: { KEY: 'xa', NAME: 'XẢ', DISPLAY: 'XẢ GIẤY CUỘN' },
        xen: { KEY: 'xen', NAME: 'XÉN', DISPLAY: 'XÉN GIẤY' },
        in_offset: { KEY: 'in_offset', NAME: 'IN OFFSET', DISPLAY: 'IN OFFSET' },
        boi: { KEY: 'boi', NAME: 'BỒI', DISPLAY: 'BỒI GIẤY' },
        be: { KEY: 'be', NAME: 'BẾ', DISPLAY: 'BẾ GIẤY' },
        dan: { KEY: 'dan', NAME: 'DÁN', DISPLAY: 'DÁN GIẤY' },
        kho: { KEY: 'kho', NAME: 'KHO', DISPLAY: 'KHO THÀNH PHẨM' }
    };
    
    const STAGE_CONFIG = STAGE_CONFIGS[$stage_now];
    
    // === HELPER FUNCTIONS FOR DYNAMIC FIELD NAMES ===
    function getFieldName(field) {
        return `${STAGE_CONFIG.KEY}_${field}`;
    }
    
    function getOrderField(order, field) {
        const fieldName = getFieldName(field);
        return order[fieldName] || order[field] || 0;
    }
    
    function setOrderField(order, field, value) {
        const fieldName = getFieldName(field);
        order[fieldName] = value;
    }
    
    /**
     * =================================================================
     * ${STAGE_CONFIG.NAME} STAGE MANAGEMENT - QUẢN LÝ CÔNG ĐOẠN ${STAGE_CONFIG.NAME}
     * =================================================================
     * Chức năng chính:
     * 1. Hiển thị danh sách lệnh sản xuất ở công đoạn ${STAGE_CONFIG.NAME}
     * 2. Hoàn thành công đoạn ${STAGE_CONFIG.NAME} (cập nhật số lượng OK, NG)
     * 3. Bàn giao sang công đoạn tiếp theo theo workflow_definition
     */

    // === CẤU HÌNH API & WEBHOOK ===
    const API_BASE_URL = 'https://api.autoslp.com/api';
    const WEBHOOK_BASE_URL = 'https://api.autoslp.com:5678/webhook';

    // === BIẾN GLOBAL ===
    let ordersData = [];        // Dữ liệu lệnh sản xuất
    let currentEditingOrder = null;  // Đơn hàng đang chỉnh sửa
    let machineStatusData = []; // Dữ liệu trạng thái máy

    /**
     * =================================================================
     * MACHINE STATUS FUNCTIONS - HÀM QUẢN LÝ TRẠNG THÁI MÁY
     * =================================================================
     */

    /**
     * Tải dữ liệu trạng thái máy từ API
     */
    async function loadMachineStatus() {
        try {
            console.log('🔍 Loading machine status from API...');
            const response = await fetch(`${API_BASE_URL}/data/production_machines`);
            if (response.ok) {
                machineStatusData = await response.json();
                console.log('✅ Machine status loaded:', machineStatusData);
            } else {
                console.error('❌ Lỗi khi tải dữ liệu máy:', response.status);
                machineStatusData = [];
            }
        } catch (error) {
            console.error('❌ Lỗi khi tải dữ liệu máy:', error);
            machineStatusData = [];
        }
    }

    /**
     * Kiểm tra xem máy có đang sản xuất lệnh nào không
     * @param {string} machineName - Tên máy
     * @returns {object|null} - Thông tin lệnh đang sản xuất hoặc null
     */
    function getMachineCurrentOrder(machineName) {
        if (!machineStatusData || machineStatusData.length === 0) {
            return null;
        }
        
        const machine = machineStatusData.find(m => m.machine_name === machineName);
        return machine && machine.current_order_id ? machine : null;
    }

    /**
     * Kiểm tra xem máy cụ thể có đang chạy lệnh không
     * @param {string} machineName - Tên máy cần kiểm tra
     * @returns {object} - { isRunning: boolean, runningOrder: object|null }
     */
    function checkMachineStatus(machineName) {
        const machine = machineStatusData.find(m => m.machine_name === machineName);
        
        if (!machine) {
            return { isRunning: false, runningOrder: null };
        }
        
        const isRunning = !!(machine.current_order_id && machine.current_order_id !== null);
        
        return {
            isRunning: isRunning,
            runningOrder: isRunning ? machine : null
        };
    }

    /**
     * Kiểm tra xem lệnh có thuộc máy nào không
     * @param {object} order - Lệnh sản xuất
     * @returns {string|null} - Tên máy hoặc null
     */
    function getOrderMachine(order) {
        const assignedMachine = order.assigned_machine || '';
        
        // Lọc các máy thuộc Stage_${STAGE_CONFIG.KEY}
        const MStageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Tìm máy ${STAGE_CONFIG.NAME} trong danh sách máy được gán
        for (const MStageMachine of MStageMachines) {
            if (assignedMachine.includes(MStageMachine.machine_name)) {
                return MStageMachine.machine_name;
            }
        }
        
        return null;
    }



    /**
     * Kiểm tra xem lệnh có đang chạy không
     * @param {object} order - Lệnh sản xuất
     * @returns {object} - { isRunning: boolean, reason: string }
     */
    function isOrderRunning(order) {
        // Kiểm tra xem có máy nào đang sản xuất lệnh này không
        const machineWithThisOrder = machineStatusData.find(machine => 
            machine.current_order_id == order.id
        );

        // Nếu lệnh này đang được sản xuất bởi một máy nào đó
        if (machineWithThisOrder) {
            return { isRunning: true, reason: `Lệnh hiện tại của máy ${machineWithThisOrder.machine_name}` };
        }

        // Nếu không có máy nào đang sản xuất lệnh này
        return { isRunning: false, reason: 'Lệnh không đang được sản xuất' };
    }

    /**
     * =================================================================
     * ENHANCED API FUNCTIONS - API CẢI TIẾN
     * =================================================================
     */

    /**
     * Fetch với timeout và retry
     */
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    /**
     * Fetch với retry logic
     */
    async function fetchWithRetry(url, options = {}, maxRetries = 3) {
        let lastError;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const timeout = attempt === 1 ? 10000 : 3000;
                const response = await fetchWithTimeout(url, options, timeout);
                
                if (response.ok) {
                    return response;
                }
                
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                lastError = error;
                
                if (attempt < maxRetries) {
                    const delay = Math.min(1000 * attempt, 2000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        throw lastError;
    }


    /**
     * Cache key cho filter ngày
     */
    const DATE_FILTER_CACHE_KEY = `date_filter_${STAGE_CONFIG.KEY}`;
    
    /**
     * Lưu giá trị filter ngày vào cache
     */
    function saveDateFilterToCache() {
        const fromDateInput = document.getElementById('fromDateFilter');
        const toDateInput = document.getElementById('toDateFilter');
        
        if (fromDateInput && toDateInput) {
            const cacheData = {
                fromDate: fromDateInput.value,
                toDate: toDateInput.value,
                timestamp: Date.now()
            };
            localStorage.setItem(DATE_FILTER_CACHE_KEY, JSON.stringify(cacheData));
        }
    }
    
    /**
     * Khôi phục giá trị filter ngày từ cache
     */
    function loadDateFilterFromCache() {
        const fromDateInput = document.getElementById('fromDateFilter');
        const toDateInput = document.getElementById('toDateFilter');
        
        if (!fromDateInput || !toDateInput) return false;
        
        try {
            const cachedData = localStorage.getItem(DATE_FILTER_CACHE_KEY);
            if (cachedData) {
                const data = JSON.parse(cachedData);
                
                // Kiểm tra cache có hợp lệ không (không quá 7 ngày)
                const cacheAge = Date.now() - data.timestamp;
                const maxAge = 7 * 24 * 60 * 60 * 1000; // 7 ngày
                
                if (cacheAge < maxAge && data.fromDate && data.toDate) {
                    fromDateInput.value = data.fromDate;
                    toDateInput.value = data.toDate;
                    return true;
                }
            }
        } catch (error) {
            console.error('Lỗi khi load cache filter ngày:', error);
        }
        
        return false;
    }
    
    /**
     * Set giá trị mặc định cho filter ngày
     */
    function setDefaultDateFilter() {
        const fromDateInput = document.getElementById('fromDateFilter');
        const toDateInput = document.getElementById('toDateFilter');
        
        if (fromDateInput && toDateInput) {
            // Thử load từ cache trước
            const cacheLoaded = loadDateFilterFromCache();
            
            // Nếu không có cache, set giá trị mặc định
            if (!cacheLoaded) {
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                
                fromDateInput.value = oneWeekAgo.toISOString().split('T')[0];
                toDateInput.value = today.toISOString().split('T')[0];
            }
        }
    }
    
    /**
     * Reset filter ngày về giá trị mặc định và xóa cache
     */
    function resetDateFilter() {
        const fromDateInput = document.getElementById('fromDateFilter');
        const toDateInput = document.getElementById('toDateFilter');
        
        if (fromDateInput && toDateInput) {
            // Xóa cache
            localStorage.removeItem(DATE_FILTER_CACHE_KEY);
            
            // Set giá trị mặc định
            const today = new Date();
            const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
            
            fromDateInput.value = oneWeekAgo.toISOString().split('T')[0];
            toDateInput.value = today.toISOString().split('T')[0];
            
            // Reload dữ liệu
            refreshData();
            
            showNotification('Đã reset filter ngày về mặc định', 'info');
        }
    }

    /**
     * Tải dữ liệu với filter ngày cụ thể
     */
    async function loadDataWithDateFilter() {
        const fromDateFilter = document.getElementById('fromDateFilter')?.value;
        const toDateFilter = document.getElementById('toDateFilter')?.value;
        
        if (!fromDateFilter || !toDateFilter) {
            showNotification('Vui lòng chọn cả ngày bắt đầu và ngày kết thúc', 'warning');
            return;
        }
        
        if (fromDateFilter > toDateFilter) {
            showNotification('Ngày bắt đầu không thể lớn hơn ngày kết thúc', 'warning');
            return;
        }
        
        showLoading('Đang tải dữ liệu theo khoảng ngày...');
        await loadOrdersData();
        hideLoading();
        showNotification(`Đã tải dữ liệu từ ${fromDateFilter} đến ${toDateFilter}`, 'success');
    }

    /**
     * Tải dữ liệu lệnh sản xuất từ API
     */
    async function loadOrdersData() {
        const timingKey = 'loadOrdersData';
        try {
            // Load dữ liệu máy trước
            await loadMachineStatus();
            // Load dữ liệu theo ngày từ filter hoặc mặc định 30 ngày trước
            const fromDateFilter = document.getElementById('fromDateFilter')?.value;
            const toDateFilter = document.getElementById('toDateFilter')?.value;
            
            // Thêm event listener cho filter ngày
            const fromDateInput = document.getElementById('fromDateFilter');
            const toDateInput = document.getElementById('toDateFilter');
            if (fromDateInput && toDateInput) {
                // Set giá trị mặc định: từ 1 tuần trước đến hôm nay
                if (!fromDateInput.value && !toDateInput.value) {
                    const today = new Date();
                    const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                    fromDateInput.value = oneWeekAgo.toISOString().split('T')[0];
                    toDateInput.value = today.toISOString().split('T')[0];
                }
                
                fromDateInput.addEventListener('change', () => {
                    // Lưu cache khi thay đổi ngày
                    saveDateFilterToCache();
                    
                    if (fromDateInput.value && toDateInput.value) {
                        refreshData(); // Reload dữ liệu khi có đủ cả 2 ngày
                    }
                });
                toDateInput.addEventListener('change', () => {
                    // Lưu cache khi thay đổi ngày
                    saveDateFilterToCache();
                    
                    if (fromDateInput.value && toDateInput.value) {
                        refreshData(); // Reload dữ liệu khi có đủ cả 2 ngày
                    }
                });
            }
            
            let fromDate, toDate;
            if (fromDateFilter && toDateFilter) {
                // Sử dụng ngày từ filter
                fromDate = fromDateFilter;
                toDate = toDateFilter;
            } else {
                // Mặc định 1 tuần trước đến hiện tại
                const today = new Date();
                const oneWeekAgo = new Date(today.getTime() - (7 * 24 * 60 * 60 * 1000));
                fromDate = oneWeekAgo.toISOString().split('T')[0];
                toDate = today.toISOString().split('T')[0];
            }
            
            // Sử dụng date range thay vì limit để tránh quá tải
            const url = `${API_BASE_URL}/data/production_orders?stage=${STAGE_CONFIG.KEY}&from_date=${fromDate}&to_date=${toDate}`;
            
            // Gọi API để lấy tất cả dữ liệu
            const response = await fetchWithRetry(url, {}, 3);
            const apiData = await response.json();
            
            // Kiểm tra dữ liệu raw từ API
            if (apiData.length > 0) {
                // Log các mẫu để kiểm tra start_time
                apiData.slice(0, 3).forEach((record, idx) => {
                    // Sample data logging removed
                });
                
                // Đếm số bản ghi có start_time
                const recordsWithStartTime = apiData.filter(r => getOrderField(r, 'start_time')).length;
            }
            
            const allData = Array.isArray(apiData) ? apiData : [];
            ordersData = transformApiData(allData);
            
            // Kiểm tra dữ liệu sau khi transform và lọc
            if (ordersData.length > 0) {
                // Log các mẫu để kiểm tra start_time
                ordersData.slice(0, 3).forEach((record, idx) => {
                    // Sample transformed data logging removed
                });
                
                // Đếm số bản ghi có start_time
                const recordsWithStartTime = ordersData.filter(r => getOrderField(r, 'start_time')).length;
            }
            
            // Lưu dữ liệu gốc cho filtering
            originalOrdersData = [...ordersData];
            filteredOrdersData = [...ordersData];
            
            // Log sample data để debug
            if (ordersData.length > 0) {
                // Sample orders data logging removed
            }
        } catch (error) {
            ordersData = [];
            showNotification('Không thể tải dữ liệu: ' + error.message, 'error');
        }
    }

    /**
     * Transform API data
     */
    function transformApiData(apiData) {
        if (!Array.isArray(apiData)) {
            return [];
        }

        const transformedData = [];
        
        for (let i = 0; i < apiData.length; i++) {
            transformedData[i] = transformOrder(apiData[i]);
        }
        
        return transformedData;
    }

    /**
     * Transform một order
     */
    function transformOrder(order) {
        let workflowDef = order.workflow_definition;
        
        // Log dữ liệu thô từ API để debug
        
        if (getOrderField(order, 'start_time')) {
            // API Data logging removed
        }
        
        const nextStage = getNextStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY);
        
        // Tạo đối tượng kết quả
        const transformedOrder = {
            id: order.id || order.order_id || order.production_order_id,
            production_order: order.order_code || order.production_order,
            order_type: order.order_type || '', // Thêm trường loại LSX
            product_name: order.product_name,
            internal_product_code: order.internal_product_code,
            customer_name: order.customer_name,
            total_quantity: order.quantity || order.total_quantity,
            deployed_quantity: order.deployed_quantity || 0, // Thêm deployed_quantity
            sheet_count: order.sheet_count || 0, // Thêm sheet_count
            [getFieldName('input_quantity')]: order.quantity || order.total_quantity || 0,
            [getFieldName('output_quantity')]: getOrderField(order, 'output_quantity'),
            [getFieldName('good_quantity')]: getOrderField(order, 'good_quantity'),
            [getFieldName('ng_quantity')]: getOrderField(order, 'ng_quantity'),
            [getFieldName('handover_quantity')]: getOrderField(order, 'handover_quantity'),
            [getFieldName('status')]: getOrderField(order, 'status') || 'waiting',
            [getFieldName('machine_name')]: getOrderField(order, 'machine_name'),
            [getFieldName('worker_name')]: getOrderField(order, 'worker_name'),
            [getFieldName('note')]: getOrderField(order, 'note') || order.notes || '',
            [getFieldName('start_time')]: getOrderField(order, 'start_time'),
            [getFieldName('end_time')]: getOrderField(order, 'end_time'),
            paper_type: order.paper_type || '',
            paper_weight: order.paper_weight || 0,
            paper_length: order.paper_length  || 0,
            paper_width: order.paper_width  || 0,
            blank_count: order.blank_count|| 0, // Số phôi
            [getFieldName('shift')]: getOrderField(order, 'shift'),
            delivery_date: order.delivery_date,
            deployment_date: order.deployment_date || order.created_at,
            assigned_machine: order.assigned_machine || '', // Thêm trường assigned_machine
            workflow_definition: workflowDef,
            next_stage: nextStage,
            previous_stage: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY),
            
            // Dữ liệu từ stage trước
            previous_stage_good_quantity: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_good_quantity`] || 0) : 0,
            previous_stage_ng_quantity: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_ng_quantity`] || 0) : 0,
            previous_stage_handover_quantity: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_handover_quantity`] || 0) : 0,
            previous_stage_status: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_status`] || 'waiting') : null,
            previous_stage_worker_name: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_worker_name`] || '') : '',
            previous_stage_machine_name: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_machine_name`] || '') : '',
            previous_stage_start_time: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_start_time`] || null) : null,
            previous_stage_end_time: getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY) ? (order[`${getPreviousStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY)}_end_time`] || null) : null,
            
            // Dữ liệu từ stage tiếp theo
            next_stage_good_quantity: nextStage ? (order[`${nextStage}_good_quantity`] || 0) : 0,
            next_stage_ng_quantity: nextStage ? (order[`${nextStage}_ng_quantity`] || 0) : 0,
            next_stage_handover_quantity: nextStage ? (order[`${nextStage}_handover_quantity`] || 0) : 0,
            next_stage_status: nextStage ? (order[`${nextStage}_status`] || 'waiting') : null,
            next_stage_worker_name: nextStage ? (order[`${nextStage}_worker_name`] || '') : '',
            next_stage_machine_name: nextStage ? (order[`${nextStage}_machine_name`] || '') : '',
            next_stage_start_time: nextStage ? (order[`${nextStage}_start_time`] || null) : null,
            next_stage_end_time: nextStage ? (order[`${nextStage}_end_time`] || null) : null,
            
            created_at: order.created_at,
            updated_at: order.updated_at
        };
        
        // Log dữ liệu sau khi transform để debug
        if (transformedOrder[getFieldName('start_time')]) {
            // Transformed data logging removed
        }
        
        return transformedOrder;
    }

    /**
     * =================================================================
     * WORKFLOW FUNCTIONS - HÀM XỬ LÝ WORKFLOW
     * =================================================================
     */

    /**
     * Lấy stage tiếp theo từ workflow definition
     * @param {string} workflowDef - Workflow definition (VD: "xa,xen,in" hoặc "xa,in_offset")
     * @param {string} currentStage - Stage hiện tại
     * @returns {string|null} Stage tiếp theo hoặc null nếu là stage cuối
     */
    function getNextStageFromWorkflow(workflowDef, currentStage) {
        if (!workflowDef) {
            return null;
        }
        
        const stages = workflowDef.split(',').map(s => s.trim());
        const currentIndex = stages.indexOf(currentStage);
        
        if (currentIndex === -1 || currentIndex >= stages.length - 1) {
            return null; // Không tìm thấy hoặc đã là stage cuối
        }
        
        const nextStage = stages[currentIndex + 1];
        return nextStage;
    }

    /**
     * Lấy stage trước đó từ workflow
     * @param {string} workflowDef - Định nghĩa workflow
     * @param {string} currentStage - Stage hiện tại
     * @returns {string|null} Stage trước đó hoặc null nếu là stage đầu
     */
    function getPreviousStageFromWorkflow(workflowDef, currentStage) {
        if (!workflowDef) {
            return null;
        }
        
        const stages = workflowDef.split(',').map(s => s.trim());
        const currentIndex = stages.indexOf(currentStage);
        
        if (currentIndex === -1 || currentIndex <= 0) {
            return null; // Không tìm thấy hoặc đã là stage đầu
        }
        
        const previousStage = stages[currentIndex - 1];
        return previousStage;
    }

    /**
     * Lấy tên hiển thị của stage
     * @param {string} stageKey - Key của stage
     * @returns {string} Tên hiển thị
     */
    function getStageDisplayName(stageKey) {
        const stageNames = {
            'xa': 'Xả',
            'xen': 'Xén', 
            'in_offset': 'In Offset',
            'boi': 'Bồi',
            'be': 'Bế',
            'dan': 'Dán',
            'kho': 'Kho'
        };
        
        return stageNames[stageKey] || stageKey.toUpperCase();
    }

    /**
     * Lấy màu sắc theo stage
     * @param {string} stageKey - Key của stage
     * @returns {string} CSS class màu sắc
     */
    function getStageColor(stageKey) {
        const stageColors = {
            'xa': 'primary',
            'xen': 'success',
            'in_offset': 'purple',
            'boi': 'warning',
            'be': 'danger',
            'dan': 'dark',
            'kho': 'secondary'
        };
        
        return stageColors[stageKey] || 'secondary';
    }

        

    /**
     * =================================================================
     * KHỞI TẠO TRANG - PAGE INITIALIZATION
     * =================================================================
     */
    
    // Khởi tạo khi trang được load
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    /**
     * Khởi tạo trang - load dữ liệu và setup UI
     */
    async function initializePage() {

        
        try {
            showLoading('Đang tải dữ liệu...');
            
            // Set giá trị mặc định cho filter ngày
            setDefaultDateFilter();
            
            // Tải dữ liệu từ API
            await loadOrdersData();
            await loadMachineStatus();
            
            // Khởi tạo tabs trước khi render
            await initializeTabs();
            
            // Cập nhật filter options sau khi có dữ liệu máy
            updateMachineFilterOptions();
            
            // Render giao diện
            renderOrdersTable();
            updateStatistics();
            
            // Khởi tạo filters
            setupFilterChangeListeners();
            setupSearchDebounce();
            
            // Log tổng thời gian
            // logTotalLoadTime();
            
            // showNotification('Đã tải dữ liệu thành công', 'success');
            
        } catch (error) {
            showNotification('Lỗi tải dữ liệu: ' + error.message, 'error');
            
   
            
            renderOrdersTable();
            updateStatistics();
        } finally {
            hideLoading();
        }
    }

    

    /**
     * Render bảng danh sách lệnh sản xuất với tab structure
     */
    function renderOrdersTable() {
        // Kiểm tra có dữ liệu không
        if (ordersData.length === 0) {
            // Hiển thị thông báo trống cho tất cả các tab
            const emptyMessage = `
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Không có lệnh sản xuất nào cho công đoạn ${STAGE_CONFIG.NAME}
                    </td>
                </tr>
            `;
            
            // Lấy tất cả các tab body đã được tạo động
            const tabBodies = document.querySelectorAll('[id$="TableBody"]');
            tabBodies.forEach(tbody => {
                tbody.innerHTML = emptyMessage;
            });
            
            // Cập nhật số lượng cho các tab
            updateTabCountsDynamic();
            return;
        }
        
        // Lọc các máy thuộc Stage_${STAGE_CONFIG.KEY}
        const MStageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Phân loại dữ liệu theo máy (hiển thị tất cả lệnh chưa bàn giao, kể cả chưa sẵn sàng)
        const machineOrders = {};
        MStageMachines.forEach(machine => {
            const machineName = machine.machine_name;
            machineOrders[machineName] = ordersData.filter(order => {
                const assignedMachine = order.assigned_machine || '';
                const inputQuantity = getInputQuantityFromPreviousStage(order);
                
                // Tính tổng số lượng bàn giao và input
                const previousStageHandover = order.previous_stage_handover_quantity || 0;
                const currentStageHandover = getOrderField(order, 'handover_quantity') || 0;
                const currentStageInput = getOrderField(order, 'input_quantity') || 0;
                
 
                
                return assignedMachine.includes(machineName);
            });
        });
        
        // Render từng tab máy
        MStageMachines.forEach(machine => {
            const machineName = machine.machine_name;
            const machineId = `machine-${machineName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            const tableBodyId = `${machineId}TableBody`;
            renderTabTable(tableBodyId, machineOrders[machineName] || []);
        });
        
        // Render tab "Tất cả" (hiển thị tất cả lệnh, kể cả đã hoàn thành)
        const activeOrders = ordersData.filter(order => {
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            
            // Tính tổng số lượng bàn giao và input
            const previousStageHandover = order.previous_stage_handover_quantity || 0;
            const currentStageHandover = getOrderField(order, 'handover_quantity') || 0;
            const currentStageInput = getOrderField(order, 'input_quantity') || 0;
            

            
            return true; // Hiển thị tất cả lệnh
        });
        renderTabTable('allTableBody', activeOrders);
        
        // Cập nhật số lượng cho các tab
        updateTabCountsDynamic(machineOrders);
        
        // Load dữ liệu báo cáo
        loadReportData();
    }
    

    
    /**
     * Render bảng cho một tab cụ thể
     */
    function renderTabTable(tableBodyId, orders) {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) {
            console.error(`Table body not found: ${tableBodyId}`);
            return;
        }
        
        // Xóa dữ liệu cũ
        tableBody.innerHTML = '';
        
        // Kiểm tra có dữ liệu không
        if (orders.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Không có lệnh sản xuất nào
                    </td>
                </tr>
            `;
            return;
        }

        // Sắp xếp orders: lệnh sẵn sàng lên đầu, sau đó lệnh bị disable, cuối cùng theo thời gian bắt đầu
        const sortedOrders = [...orders].sort((a, b) => {
            // Kiểm tra lệnh nào đang chạy
            const aIsRunning = isOrderRunning(a).isRunning;
            const bIsRunning = isOrderRunning(b).isRunning;
            
            // Kiểm tra lệnh nào sẵn sàng (không bị disable)
            const aIsReady = isPreviousStageReady(a) && getOrderMachine(a);
            const bIsReady = isPreviousStageReady(b) && getOrderMachine(b);
            
            // Ưu tiên 1: Lệnh đang chạy
            if (aIsRunning && !bIsRunning) return -1;
            if (!aIsRunning && bIsRunning) return 1;
            
            // Ưu tiên 2: Lệnh sẵn sàng (không bị disable) lên đầu
            if (aIsReady && !bIsReady) return -1;
            if (!aIsReady && bIsReady) return 1;
            
            // Ưu tiên 3: Nếu cả hai đều sẵn sàng hoặc đều không sẵn sàng, sắp xếp theo thời gian bắt đầu
            const aStartTime = getOrderField(a, 'start_time') ? new Date(getOrderField(a, 'start_time')).getTime() : 0;
            const bStartTime = getOrderField(b, 'start_time') ? new Date(getOrderField(b, 'start_time')).getTime() : 0;
            
            // Lệnh bắt đầu sớm hơn lên đầu (thời gian lớn hơn = mới hơn)
            return bStartTime - aStartTime;
        });

        
        const fragment = document.createDocumentFragment();
        
        sortedOrders.forEach((order, index) => {
            try {
                const row = createOrderTableRow(order, index);
                fragment.appendChild(row);
            } catch (error) {
                console.error(`Error creating row for order ${order.id}:`, error);
                // Create a simple error row
                const errorRow = document.createElement('tr');
                errorRow.innerHTML = `
                    <td colspan="13" class="text-center text-danger">
                        Lỗi hiển thị lệnh ${order.id || 'N/A'}
                    </td>
                `;
                fragment.appendChild(errorRow);
            }
        });
        
        tableBody.appendChild(fragment);
    }
    
    /**
     * Cập nhật số lượng hiển thị trên các tab động
     */
    function updateTabCountsDynamic(machineOrders = {}) {
        // Lọc các máy thuộc Stage hiện tại
        const stageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Cập nhật số lượng cho từng máy
        stageMachines.forEach(machine => {
            const machineName = machine.machine_name;
            const machineId = `machine-${machineName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            const countElement = document.getElementById(`${machineId}-count`);
            if (countElement) {
                const orderCount = machineOrders[machineName] ? machineOrders[machineName].length : 0;
                countElement.textContent = orderCount;
            }
        });
        
        // Cập nhật số lượng cho tab "Tất cả" (chỉ lệnh chưa bàn giao)
        const allCountElement = document.getElementById('all-count');
        if (allCountElement) {
            const activeOrders = ordersData.filter(order => {
                const inputQuantity = getInputQuantityFromPreviousStage(order);
                return inputQuantity > 0;
            });
            allCountElement.textContent = activeOrders.length;
        }
        
        // Cập nhật số lượng cho tab "Báo cáo"
        const handedOverOrders = ordersData.filter(order => {
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            
            // Tính tổng số lượng bàn giao và input
            const previousStageHandover = order.previous_stage_handover_quantity || 0;
            const currentStageHandover = getOrderField(order, 'handover_quantity') || 0;
            const currentStageInput = getOrderField(order, 'input_quantity') || 0;

            
            return inputQuantity <= 0 && previousStageHandover > 0;
        });
        updateReportCount(handedOverOrders.length);
    }


    /**
     * Khởi tạo tab functionality
     */
    async function initializeTabs() {
        // Tải dữ liệu máy từ API
        await loadMachineStatus();
        
        // Tạo các tab động dựa trên dữ liệu máy
        await createDynamicTabs();
        
        // Thêm event listeners cho các tab
        const tabs = document.querySelectorAll('#machineTabs .nav-link');
        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                // Cập nhật active state
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Hiển thị tab content tương ứng
                const targetId = this.getAttribute('data-bs-target');
                const targetContent = document.querySelector(targetId);
                
                if (targetContent) {
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    targetContent.classList.add('show', 'active');
                }
                
                // Nếu click vào tab báo cáo, load dữ liệu báo cáo
                if (targetId === '#report-content') {
                    loadReportData();
                }
                
                // Cập nhật URL hash để bookmark
                window.location.hash = targetId.replace('#', '');
            });
        });
        
        // Khôi phục tab từ URL hash nếu có
        const hash = window.location.hash;
        if (hash) {
            const targetTab = document.querySelector(`[data-bs-target="${hash}"]`);
            if (targetTab) {
                // Xóa active class từ tất cả tabs và content
                document.querySelectorAll('.nav-link').forEach(link => {
                    link.classList.remove('active');
                    link.setAttribute('aria-selected', 'false');
                });
                document.querySelectorAll('.tab-pane').forEach(pane => {
                    pane.classList.remove('show', 'active');
                });
                
                // Kích hoạt tab được chỉ định
                targetTab.classList.add('active');
                targetTab.setAttribute('aria-selected', 'true');
                
                const targetContent = document.querySelector(hash);
                if (targetContent) {
                    targetContent.classList.add('show', 'active');
                }
            }
        }
    }
    
    /**
     * Tạo các tab động dựa trên dữ liệu máy từ production_machines
     */
    async function createDynamicTabs() {
        const machineTabsContainer = document.getElementById('machineTabs');
        const tabContentContainer = document.getElementById('machineTabContent');
        
        console.log('🔍 Creating dynamic tabs for stage:', STAGE_CONFIG.KEY);
        console.log('🔍 Available machines:', machineStatusData);
        
        // Lưu tab "Báo cáo" nếu có
        const reportTab = machineTabsContainer.querySelector('#report-tab');
        const reportContent = tabContentContainer.querySelector('#report-content');
        
        // Xóa nội dung cũ (nhưng giữ lại tab "Báo cáo")
        machineTabsContainer.innerHTML = '';
        tabContentContainer.innerHTML = '';
        
        // Lọc các máy thuộc Stage_${STAGE_CONFIG.KEY}
        const MStageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        console.log('🔍 Filtered machines for stage:', MStageMachines);
        
        // Tạo tab cho từng máy ${STAGE_CONFIG.NAME}
        MStageMachines.forEach((machine, index) => {
            const machineName = machine.machine_name;
            // Tạo ID an toàn cho CSS selector (không bắt đầu bằng số)
            const machineId = `machine-${machineName.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
            const tabId = `${machineId}-tab`;
            const contentId = `${machineId}-content`;
            
            // Tạo tab navigation
            const tabItem = document.createElement('li');
            tabItem.className = 'nav-item';
            tabItem.setAttribute('role', 'presentation');
            
            const isFirstTab = index === 0;
            tabItem.innerHTML = `
                <button class="nav-link ${isFirstTab ? 'active' : ''}" id="${tabId}" 
                        data-bs-toggle="tab" data-bs-target="#${contentId}" 
                        type="button" role="tab" aria-controls="${contentId}" 
                        aria-selected="${isFirstTab}">
                    <i class="bi bi-gear me-1"></i>${machineName}
                    <!-- <span class="badge bg-primary ms-1" id="${machineId}-count">0</span> -->
                </button>
            `;
            
            machineTabsContainer.appendChild(tabItem);
            
            // Tạo tab content
            const tabPane = document.createElement('div');
            tabPane.className = `tab-pane fade ${isFirstTab ? 'show active' : ''}`;
            tabPane.id = contentId;
            tabPane.setAttribute('role', 'tabpanel');
            tabPane.setAttribute('aria-labelledby', tabId);
            
            tabPane.innerHTML = `
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                                <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                                <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                                <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                                <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                                <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                                <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                                <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                                <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                            </tr>
                        </thead>
                        <tbody id="${machineId}TableBody">
                        </tbody>
                    </table>
                </div>
            `;
            
            tabContentContainer.appendChild(tabPane);
        });
        
        // Thêm tab "Tất cả" ở cuối
        const allTabItem = document.createElement('li');
        allTabItem.className = 'nav-item';
        allTabItem.setAttribute('role', 'presentation');
        
        // Nếu không có máy nào, "Tất cả" tab sẽ là active mặc định
        const isAllTabActive = MStageMachines.length === 0;
        
        allTabItem.innerHTML = `
            <button class="nav-link ${isAllTabActive ? 'active' : ''}" id="all-tab" 
                    data-bs-toggle="tab" data-bs-target="#all-content" 
                    type="button" role="tab" aria-controls="all-content" 
                    aria-selected="${isAllTabActive}">
                <i class="bi bi-list-ul me-1"></i>Tất cả
                <span class="badge bg-secondary ms-1" id="all-count">0</span>
            </button>
        `;
        
        machineTabsContainer.appendChild(allTabItem);
        
        // Thêm content cho tab "Tất cả"
        const allTabPane = document.createElement('div');
        allTabPane.className = `tab-pane fade ${isAllTabActive ? 'show active' : ''}`;
        allTabPane.id = 'all-content';
        allTabPane.setAttribute('role', 'tabpanel');
        allTabPane.setAttribute('aria-labelledby', 'all-tab');
        
        allTabPane.innerHTML = `
            <div class="table-container">
                <table class="table table-striped table-hover">
                    <thead>
                        <tr>
                            <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                            <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                            <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                            <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                            <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                            <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                            <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                            <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                            <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT ${STAGE_CONFIG.KEY}</th>
                            <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT ${STAGE_CONFIG.KEY}</th>
                            <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                            <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                            <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                        </tr>
                    </thead>
                    <tbody id="allTableBody">
                    </tbody>
                </table>
            </div>
        `;
        
        tabContentContainer.appendChild(allTabPane);
        
        // Thêm lại tab "Báo cáo" nếu có
        if (reportTab) {
            machineTabsContainer.appendChild(reportTab);
        } else {
            // Tạo tab "Báo cáo" nếu chưa có
            const reportTabItem = document.createElement('li');
            reportTabItem.className = 'nav-item';
            reportTabItem.setAttribute('role', 'presentation');
            
            reportTabItem.innerHTML = `
                <button class="nav-link" id="report-tab" 
                        data-bs-toggle="tab" data-bs-target="#report-content" 
                        type="button" role="tab" aria-controls="report-content" 
                        aria-selected="false">
                    <i class="bi bi-file-earmark-text me-1"></i>Báo cáo
                    <span class="badge bg-info ms-1" id="report-count">0</span>
                </button>
            `;
            
            machineTabsContainer.appendChild(reportTabItem);
        }
        
        if (reportContent) {
            tabContentContainer.appendChild(reportContent);
        } else {
            // Tạo content cho tab "Báo cáo" nếu chưa có
            const reportTabPane = document.createElement('div');
            reportTabPane.className = 'tab-pane fade';
            reportTabPane.id = 'report-content';
            reportTabPane.setAttribute('role', 'tabpanel');
            reportTabPane.setAttribute('aria-labelledby', 'report-tab');
            
            reportTabPane.innerHTML = `
                <div class="table-container">
                    <table class="table table-striped table-hover">
                        <thead>
                            <tr>
                                <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                                <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                                <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                                <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                                <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                                <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                                <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                                <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                                <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                                <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                            </tr>
                        </thead>
                        <tbody id="reportTableBody">
                        </tbody>
                    </table>
                </div>
            `;
            
            tabContentContainer.appendChild(reportTabPane);
        }
        
        // Load dữ liệu báo cáo ngay khi tạo tab
        loadReportData();
    }

    /**
     * Lọc dữ liệu theo tab hiện tại
     */
    function filterDataByCurrentTab() {
        const activeTab = document.querySelector('#machineTabs .nav-link.active');
        if (!activeTab) return ordersData;
        
        const tabId = activeTab.id;
        
        // Nếu là tab "Tất cả"
        if (tabId === 'all-tab') {
            return ordersData;
        }
        
        // Lấy tên máy từ tab ID
        const machineName = tabId.replace('-tab', '').replace(/-/g, ' ');
        
        // Lọc theo máy được gán
        return ordersData.filter(order => {
            const assignedMachine = order.assigned_machine || '';
            return assignedMachine.includes(machineName);
        });
    }
    
    /**
     * Cập nhật hiển thị tab dựa trên filter máy
     */
    function updateTabBasedOnMachineFilter() {
        const machineFilter = document.getElementById('machineFilter');
        if (!machineFilter) {
            return;
        }
        if (!machineFilter.value) return;
        
        const machineValue = machineFilter.value;
        let targetTabId = 'all-tab';
        
        // Lọc các máy thuộc Stage_${STAGE_CONFIG.KEY}
        const MStageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Kiểm tra máy được chọn và chuyển đến tab tương ứng
        for (const machine of MStageMachines) {
            if (machineValue.includes(machine.machine_name)) {
                const machineId = `machine-${machine.machine_name.toLowerCase().replace(/[^a-z0-9]/g, '-')}`;
                targetTabId = `${machineId}-tab`;
                break;
            }
        }
        
        const targetTab = document.getElementById(targetTabId);
        if (targetTab) {
            targetTab.click();
        }
    }
    
    /**
     * Lấy danh sách tất cả máy của stage hiện tại có sẵn
     * @returns {Array} - Mảng các máy của stage hiện tại
     */
    function getAvailableStageMachines() {
        if (!machineStatusData || machineStatusData.length === 0) {
            return [];
        }
        
        return machineStatusData.filter(machine => 
            machine.stage_machine && 
            machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`) &&
            machine.machine_name
        ).map(machine => machine.machine_name);
    }

    /**
     * Lấy số lượng từ stage trước đó cho bất kỳ stage nào
     * @param {object} order - Lệnh sản xuất
     * @param {string} currentStage - Stage hiện tại (mặc định: STAGE_CONFIG.KEY)
     * @returns {number} - Số lượng từ stage trước
     */
    function getInputQuantityFromPreviousStage(order, currentStage = STAGE_CONFIG.KEY) {
        if (!order || !order.workflow_definition) {
            return 0;
        }

        // Sử dụng function getPreviousStageFromWorkflow để lấy stage trước
        const previousStage = getPreviousStageFromWorkflow(order.workflow_definition, currentStage);
        
        if (!previousStage) {
            // Stage hiện tại là stage đầu tiên hoặc không tìm thấy
            // Ưu tiên sheet_count, fallback về quantity
            return order.sheet_count || order.quantity || 0;
        }

        // Sử dụng dữ liệu đã được transform sẵn từ previous_stage_handover_quantity
        if (order.previous_stage_handover_quantity && order.previous_stage_handover_quantity > 0) {
            return order.previous_stage_handover_quantity;
        }
        
        if (order.previous_stage_good_quantity && order.previous_stage_good_quantity > 0) {
            return order.previous_stage_good_quantity;
        }

        // Fallback về cách cũ nếu dữ liệu transform chưa có
        const handoverField = `${previousStage}_handover_quantity`;
        const goodField = `${previousStage}_good_quantity`;
        
        // Lấy số lượng từ stage trước
        const handoverQty = order[handoverField] || 0;
        const goodQty = order[goodField] || 0;
        
        // Ưu tiên handover_quantity, fallback về good_quantity
        return handoverQty > 0 ? handoverQty : goodQty;
    }

    /**
     * Lấy tên máy từ trường assigned_machine cho công đoạn hiện tại
     */
    function getStageMachineFromAssigned(assignedMachine) {
        if (!assignedMachine) return '';
        
        const machines = assignedMachine.split(',').map(m => m.trim());
        
        // Lọc các máy thuộc Stage hiện tại
        const stageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Tìm máy của stage hiện tại trong danh sách máy được gán
        for (const stageMachine of stageMachines) {
            if (machines.some(machine => machine.includes(stageMachine.machine_name))) {
                return stageMachine.machine_name;
            }
        }
        
        return '';
    }
    
    /**
     * Kiểm tra xem assigned_machine có chứa máy của stage hiện tại không
     */
    function hasStageMachine(assignedMachine) {
        if (!assignedMachine) return false;
        
        const machines = assignedMachine.split(',').map(m => m.trim());
        
        // Lọc các máy thuộc Stage hiện tại
        const stageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        );
        
        // Kiểm tra xem có máy của stage hiện tại nào trong danh sách máy được gán
        return stageMachines.some(stageMachine => 
            machines.some(machine => machine.includes(stageMachine.machine_name))
        );
    }
    
    /**
     * Kiểm tra xem stage trước đã hoàn thành và sẵn sàng cho stage hiện tại chưa
     * @param {object} order - Lệnh sản xuất
     * @returns {boolean} - true nếu stage trước đã hoàn thành hoặc không có stage trước
     */
    function isPreviousStageReady(order) {
        if (!order.previous_stage) {
            return true; // Không có stage trước = sẵn sàng
        }
        
        const previousStageStatus = order.previous_stage_status;
        const currentStageStatus = getOrderField(order, 'status');
        
        // Nếu stage trước chưa hoàn thành và stage hiện tại chưa bắt đầu
        if (previousStageStatus && 
            previousStageStatus !== 'completed' && 
            previousStageStatus !== 'handed_over' && 
            currentStageStatus === 'waiting') {
            return false; // Stage trước chưa sẵn sàng
        }
        
        return true; // Stage trước đã sẵn sàng
    }

    /**
     * Tạo một dòng trong bảng cho một lệnh sản xuất
     */
    function createOrderTableRow(order, index) {
        const row = document.createElement('tr');
        row.className = 'order-row';
        row.setAttribute('data-order-id', order.id);
        
        // Tính toán trạng thái và tiến độ
        const status = getOrderField(order, 'status') || 'waiting';
        
        // Lấy máy được gán cho lệnh này
        const orderMachine = getOrderMachine(order);
        
        let isDisabled = false;
        let displayReason = '';
        
        // Kiểm tra stage trước đã sẵn sàng chưa
        const isPreviousReady = isPreviousStageReady(order);
        
        if (!orderMachine) {
            // Lệnh không được gán cho máy nào → bị mờ
            isDisabled = true;
            displayReason = `Lệnh không được gán cho máy ${STAGE_CONFIG.NAME}`;
        } else {
            // Kiểm tra số lượng cần sản xuất
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            if (inputQuantity <= 0) {
                // Không có số lượng từ stage trước → bị mờ
                isDisabled = true;
                const previousStage = order.previous_stage;
                const previousStageName = previousStage ? getStageDisplayName(previousStage) : 'Công đoạn trước';
                displayReason = `Chờ ${previousStageName} cung cấp số lượng`;
            } else {
                // Kiểm tra trạng thái máy được gán
                const machineStatus = checkMachineStatus(orderMachine);
                
                if (!machineStatus.isRunning) {
                    // Máy đang trống → có thể bắt đầu
                    isDisabled = false;
                    displayReason = `Máy ${orderMachine} đang trống`;
                } else {
                    // Máy đang chạy
                    if (machineStatus.runningOrder && machineStatus.runningOrder.current_order_id == order.id) {
                        // Máy đang chạy chính lệnh này → hiển thị bình thường
                        isDisabled = false;
                        displayReason = `Lệnh hiện tại của máy ${orderMachine}`;
                    } else {
                        // Máy đang chạy lệnh khác → bị mờ
                        isDisabled = true;
                        displayReason = `Máy ${orderMachine} đang sản xuất lệnh ${machineStatus.runningOrder ? machineStatus.runningOrder.current_order_code : 'N/A'}`;
                    }
                }
            }
        }
        
        // Thêm class tương ứng với trạng thái
        if (isDisabled) {
            row.classList.add('disabled-order');
        } else {
            // Kiểm tra xem lệnh có đang chạy không
            const orderRunningCheck = isOrderRunning(order);
            if (orderRunningCheck.isRunning) {
                // Lệnh đang chạy
                row.classList.add('running-order');
            }
        }
        const inputQty = getOrderField(order, 'input_quantity') || 0;
        const sheet_count = order.sheet_count || 0; // Sửa: lấy số tờ giấy
        const goodQty = getOrderField(order, 'good_quantity') || 0;
        const ngQty = getOrderField(order, 'ng_quantity') || 0;
        const deployedQty = order.deployed_quantity || 0;
        const progressPercent = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
        
        // Xác định icon và màu sắc theo trạng thái
        let statusIcon = 'bi-clock';
        let statusClass = 'text-warning';
        let statusText = 'Chờ xử lý';
        
        switch (status) {
            case 'in_progress':
                statusIcon = 'bi-play-circle';
                statusClass = 'text-primary';
                statusText = 'Đang xử lý';
                break;
            case 'completed':
                statusIcon = 'bi-check-circle';
                statusClass = 'text-success';
                statusText = 'Hoàn thành';
                break;
            case 'paused':
                statusIcon = 'bi-pause-circle';
                statusClass = 'text-warning';
                statusText = 'Tạm dừng';
                break;
            case 'handed_over':
                statusIcon = 'bi-arrow-right-circle';
                statusClass = 'text-info';
                statusText = 'Đã bàn giao';
                break;
        }
        
        // Tạo HTML cho dòng
        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-light text-dark">${index + 1}</span>
            </td>

            <td>
                <div class="d-flex align-items-center">
                    <i class="bi ${statusIcon} ${statusClass} me-2"></i>
                    <div>
                        <div class="fw-bold ${isDisabled ? 'text-muted' : ''}">${order.production_order}</div>
                        <small class="text-muted">${formatDate(order.deployment_date)} - ${getOrderField(order, 'shift')}</small>
                        <small class="${isDisabled ? 'text-danger' : 'text-success'} d-block">${displayReason}</small>
                    </div>
                </div>
            </td>
            
            <td class="text-center">
                <span class="fw-bold">${order.order_type || ''}</span>
            </td>
            <td>
                <div>
                    <div class="fw-bold">${order.internal_product_code}</div>
                    <small class="text-muted" title="${order.product_name}">${truncateText(order.product_name, 100)}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">${order.paper_type || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.paper_weight || 0} gsm</span>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(deployedQty)}</div>
                <small class="text-muted">pcs</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary">${formatNumber(sheet_count)}</div>
                <small class="text-muted">tờ giấy</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${formatNumber(order.paper_length || 0)}</div>
                <small class="text-muted">chiều dài</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-danger">${formatNumber(order.paper_width || 0)}</div>
                <small class="text-muted">chiều rộng</small>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(order.blank_count || 0)}</div>
                <small class="text-muted">phôi</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-primary'}" 
                         style="width: ${Math.min(progressPercent, 100)}%">
                        ${progressPercent}%
                    </div>
                </div>
                <small class="text-muted">${statusText}</small>
            </td>
            <td class="text-center">
                <small class="text-muted d-block" title="${order.assigned_machine || 'Chưa gán'}">${truncateText(order.assigned_machine || 'Chưa gán', 15)}</small>
            </td>

        `;
        
        // Add data attribute for order ID
        row.setAttribute('data-order-id', order.id);
        
        // Cho phép click nếu lệnh không bị disable
        if (!isDisabled) {
            row.style.cursor = 'pointer';
            row.onclick = (e) => {
                // Ngăn chặn event bubbling để tránh đóng panel
                e.stopPropagation();
                showOrderDetails(order.id);
            };
        } else {
            row.style.cursor = 'not-allowed';
            row.onclick = (e) => {
                e.stopPropagation();
                showNotification(displayReason, 'warning');
            };
        }
        
        return row;
    }


    
    

 
    


    /**
     * Cập nhật thống kê tổng quan
     */
    function updateStatistics() {
        const totalOrders = ordersData.length;
        const totalPlan = ordersData.reduce((sum, order) => sum + (getOrderField(order, 'input_quantity') || 0), 0);
        const totalGood = ordersData.reduce((sum, order) => sum + (getOrderField(order, 'good_quantity') || 0), 0);
        const totalNg = ordersData.reduce((sum, order) => sum + (getOrderField(order, 'ng_quantity') || 0), 0);
        
        // Cập nhật các thẻ thống kê
        updateElementText('totalOrders', totalOrders);
        updateElementText('totalPlan', formatNumber(totalPlan));
        updateElementText('totalGood', formatNumber(totalGood));
        updateElementText('totalNg', formatNumber(totalNg));
    }

    /**
     * =================================================================
     * XỬ LÝ SỰ KIỆN - EVENT HANDLERS
     * =================================================================
     */


    /**
     * Setup event listeners cho wizard form
     */
    function setupWizardEventListeners() {
        // Event listeners cho các input trong wizard
        const wizardGoodQty = document.getElementById('wizardGoodQty');
        const wizardNgQty = document.getElementById('wizardNgQty');
        const wizardHandoverQty = document.getElementById('wizardHandoverQty');
        
        if (wizardGoodQty) {
            wizardGoodQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardNgQty) {
            wizardNgQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardHandoverQty) {
            wizardHandoverQty.addEventListener('input', function() {
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
    }

    /**
     * Làm mới dữ liệu
     */
    async function refreshData() {
        try {
            showLoading('Đang làm mới dữ liệu...');
            await loadOrdersData();
            renderOrdersTable();
            updateStatistics();
            // showNotification('Đã làm mới dữ liệu thành công', 'info');
        } catch (error) {

            showNotification('Lỗi làm mới dữ liệu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }





    /**
     * Cập nhật số lượng bàn giao khi thay đổi số lượng OK
     */
    function updateHandoverQuantity() {
        const goodQty = getElementValue('completeGoodQty') || 0;
        setElementValue('handoverQty', goodQty);
    }
    
    /**
     * Alias cho updateHandoverQuantity (được gọi từ HTML)
     */
    function updateHandoverQty() {
        updateHandoverQuantity();
    }





    /**
     * =================================================================
     * WIZARD FUNCTIONS - CÁC HÀM XỬ LÝ WIZARD FORM
     * =================================================================
     */

    let wizardCurrentStep = 1;
    const wizardTotalSteps = 3;

    /**
     * Reset wizard về bước 1
     */
    function resetWizard() {
        wizardCurrentStep = 1;
        updateWizardStepDisplay();
    }

    /**
     * Cập nhật hiển thị bước wizard
     */
    function updateWizardStepDisplay() {
        // Update step indicators
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < wizardCurrentStep) {
                step.classList.add('completed');
            } else if (stepNum === wizardCurrentStep) {
                step.classList.add('active');
            }
        });
        
        // Update step content
        document.querySelectorAll('.step-content').forEach((content, index) => {
            content.classList.remove('active');
            if (index + 1 === wizardCurrentStep) {
                content.classList.add('active');
            }
        });
        
        // Update buttons
        const prevBtn = document.getElementById('wizardPrevBtn');
        const nextBtn = document.getElementById('wizardNextBtn');
        const finishBtn = document.getElementById('wizardFinishBtn');
        
        prevBtn.style.display = wizardCurrentStep > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = wizardCurrentStep < wizardTotalSteps ? 'inline-block' : 'none';
        finishBtn.style.display = wizardCurrentStep === wizardTotalSteps ? 'inline-block' : 'none';
        
        // Update step indicator
        document.getElementById('wizardCurrentStep').textContent = wizardCurrentStep;
        
        // Update handover quantity in step 1
        if (wizardCurrentStep === 1) {
            updateWizardHandoverQuantity();
        }
        
        // Update confirmation data in step 3
        if (wizardCurrentStep === 3) {
            updateWizardConfirmation();
        }
    }

    /**
     * Chuyển đến bước tiếp theo
     */
    function wizardNextStep() {
        if (wizardCurrentStep < wizardTotalSteps) {
            // Validate current step
            if (!validateWizardCurrentStep()) {
                return;
            }
            
            wizardCurrentStep++;
            updateWizardStepDisplay();
        }
    }

    /**
     * Quay lại bước trước
     */
    function wizardPreviousStep() {
        if (wizardCurrentStep > 1) {
            wizardCurrentStep--;
            updateWizardStepDisplay();
        }
    }

    /**
     * Validate bước hiện tại
     */
    function validateWizardCurrentStep() {
        switch (wizardCurrentStep) {
            case 1:
                const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
                const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
                if (goodQty + ngQty === 0) {
                    showNotification('Tổng số lượng phải lớn hơn 0', 'error');
                    return false;
                }
                break;
            case 2:
                const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
                if (handoverQty <= 0) {
                    showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
                    return false;
                }
                break;
        }
        return true;
    }



    /**
     * Cập nhật số lượng bàn giao trong wizard
     */
    function updateWizardHandoverQuantity() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        setElementValue('wizardHandoverQty', goodQty);
    }

    /**
     * Cập nhật dữ liệu xác nhận trong wizard
     */
    function updateWizardConfirmation() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
        const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
        const total = goodQty + ngQty;
        const progress = total > 0 ? Math.round((goodQty / total) * 100) : 0;
        const machine = getElementValue('wizardMachine');
        const worker = getElementValue('wizardWorker');
        const shift = getElementValue('wizardShift');
        const handoverPerson = getElementValue('wizardHandoverPerson');
        const receiverPerson = getElementValue('wizardReceiverPerson');
        const handoverNotes = getElementValue('wizardHandoverNotes');
        
        // Update confirmation data
        updateElementText('confirmOrderCode', getElementValue('wizardOrderCode'));
        updateElementText('confirmProductCode', getElementValue('wizardProductCode'));
        updateElementText('confirmProductName', getElementValue('wizardProductName'));
        updateElementText('confirmPaperType', getElementValue('wizardPaperType'));
        updateElementText('confirmPaperWeight', getElementValue('wizardPaperWeight'));
        updateElementText('confirmQuantity', getElementValue('wizardQuantity'));
        updateElementText('confirmGoodQty', goodQty.toLocaleString());
        updateElementText('confirmNgQty', ngQty.toLocaleString());
        updateElementText('confirmProgress', progress + '%');
        updateElementText('confirmMachine', machine);
        updateElementText('confirmWorker', worker || 'Chưa nhập');
        updateElementText('confirmShift', shift || 'Ca 1');
        updateElementText('confirmHandoverQty', handoverQty.toLocaleString());
        updateElementText('confirmHandoverPerson', handoverPerson || 'Chưa nhập');
        updateElementText('confirmReceiverPerson', receiverPerson || 'Chưa nhập');
        updateElementText('confirmHandoverNotes', handoverNotes || 'Không có');
    }



    /**
     * =================================================================
     * UTILITY FUNCTIONS - CÁC HÀM TIỆN ÍCH
     * =================================================================
     */

    // Hiển thị loading
    function showLoading(message = 'Đang tải...') {
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.style.display = 'flex';
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = message;
        }
    }

    // Ẩn loading  
    function hideLoading() {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.style.display = 'none';
    }

    // Hiển thị thông báo
    function showNotification(message, type = 'success') {
        // Tạo toast notification đơn giản
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Tự động xóa sau 5 giây
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Format số theo định dạng Việt Nam
    function formatNumber(num) {
        if (!num && num !== 0) return '';
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    // Format ngày
    function formatDate(date, format = 'dd/mm/yyyy') {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        
        return format
            .replace('dd', day)
            .replace('mm', month)
            .replace('yyyy', year);
    }

    // Cập nhật text của element
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) element.textContent = text;
    }

    // Set giá trị cho element
    function setElementValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }

    // Lấy giá trị từ element
    function getElementValue(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return '';
        
        if (element.type === 'checkbox') {
            return element.checked;
        } else {
            return element.value;
        }
    }

    // Cắt ngắn text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Chuyển đổi status thành text
    function getStatusText(status) {
        const statusMap = {
            'waiting': 'Chờ xử lý',
            'in_progress': 'Đang xử lý', 
            'completed': 'Hoàn thành',
            'paused': 'Tạm dừng',
            'handed_over': 'Đã bàn giao'
        };
        return statusMap[status] || 'Không xác định';
    }

    /**
     * =================================================================
     * SIDEBAR TOGGLE - ĐIỀU KHIỂN SIDEBAR
     * =================================================================
     * Đã được chuyển sang sidebar-generator.js
     */

    /**
     * =================================================================
     * DETAILS PANEL - PANEL CHI TIẾT
     * =================================================================
     */

    function showOrderDetails(orderId) {
        // Tìm order trong cả ordersData và originalOrdersData
        let order = ordersData.find(o => o.id == orderId); // Sử dụng == để so sánh loose
        
        if (!order) {
            order = originalOrdersData.find(o => o.id == orderId);
        }
        
        if (!order) {

            
            // Thử tìm bằng production_order nếu orderId có thể là production_order
            const orderByProductionOrder = ordersData.find(o => o.production_order == orderId);
            if (orderByProductionOrder) {
                order = orderByProductionOrder;
            } else {
                const orderByProductionOrderOriginal = originalOrdersData.find(o => o.production_order == orderId);
                if (orderByProductionOrderOriginal) {
                    order = orderByProductionOrderOriginal;
                } else {
                    return;
                }
            }
        }

        // Update current editing order
        currentEditingOrder = order;
        
        // Kiểm tra shift hiện tại để lấy start_time từ bảng production_orders_shift
        checkCurrentShiftStatus();
        
        // Chi tiết log để debug thông tin thời gian

        // Cập nhật mã lệnh trong tiêu đề
        const orderCodeBadge = document.getElementById('detailOrderCode');
        if (orderCodeBadge) {
            orderCodeBadge.textContent = order.production_order || `#${order.id}`;
        }

        // Add logging to debug start time

        // Remove previous selection
        const previousSelected = document.querySelector('.table tbody tr.selected');
        if (previousSelected) {
            previousSelected.classList.remove('selected');
        }

        // Add selection to current row
        const currentRow = document.querySelector(`[data-order-id="${orderId}"]`);
        if (currentRow) {
            currentRow.classList.add('selected');
        }

        // Show details panel
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        
        detailsPanel.classList.add('show');
        contentArea.classList.add('details-open');

        // Generate dynamic HTML content for the sidebar
        detailsPanel.innerHTML = generateSidebarHTML(order);
        
        // Initialize multi-select for workers
        initializeWorkerMultiSelect(order);

        // Active tab "Số lượng" nếu đã có thời gian bắt đầu
        if (getOrderField(order, 'start_time')) {
            setTimeout(() => {
                const quantityTab = document.querySelector('.details-panel .tab-btn[onclick*="quantity"]');
                if (quantityTab) {
                    // Remove active class from all tabs
                    document.querySelectorAll('.details-panel .tab-btn').forEach(btn => btn.classList.remove('active'));
                    document.querySelectorAll('.details-panel .tab-panel').forEach(panel => panel.classList.remove('active'));
                    
                    // Add active class to quantity tab
                    quantityTab.classList.add('active');
                    const quantityPanel = document.getElementById('quantity-panel');
                    if (quantityPanel) {
                        quantityPanel.classList.add('active');
                    }
                }
            }, 100);
        }

        // Bắt đầu timer nếu đã có thời gian bắt đầu và chưa kết thúc
        if (window.currentShiftStartTime && !getOrderField(order, 'end_time')) {
            setTimeout(() => {
                startProductionTimer();
            }, 100);
        } else if (window.currentShiftStartTime && getOrderField(order, 'end_time')) {
            // Nếu đã kết thúc, hiển thị thời gian cố định
            setTimeout(() => {
                const statusTimeElement = document.getElementById('statusTime');
                const runningTimeInfoElement = document.getElementById('runningTimeInfo');
                
                if (statusTimeElement) {
                    const fixedTime = calculateWorkTime(window.currentShiftStartTime, getOrderField(order, 'end_time'));
                    statusTimeElement.textContent = `Thời gian: ${fixedTime}`;
                }
                
                // Thời gian chạy trong tab thông tin đã được hiển thị đúng từ HTML generation
                // Không cần cập nhật vì đã có giá trị cố định từ calculateWorkTime
            }, 100);
        }

        // Thêm event listener để tự động cập nhật số lượng chuyển giao
        setTimeout(() => {
            const goodQtyInput = document.getElementById('goodQty');
            const handoverQtyInput = document.getElementById('handoverQty');
            
            if (goodQtyInput && handoverQtyInput) {
                goodQtyInput.addEventListener('input', function() {
                    const goodQty = parseInt(this.value) || 0;
                    handoverQtyInput.value = goodQty;
                    updateTotalQuantityDisplay(); // Cập nhật validation real-time
                });
            }
            
                    // Thêm event listeners cho validation real-time
        const quantityInputs = ['goodQty', 'ngQty', 'ngStartEndQty', 'returnQty'];
        quantityInputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                input.addEventListener('input', updateTotalQuantityDisplay);
                input.addEventListener('blur', updateTotalQuantityDisplay);
                input.addEventListener('input', updateStatisticsDisplay);
                input.addEventListener('blur', updateStatisticsDisplay);
            }
        });
        
        // Khởi tạo hiển thị tổng số lượng và thống kê
        updateTotalQuantityDisplay();
        updateStatisticsDisplay();
        
        // Tự động đề xuất ca làm việc hiện tại
        const shiftSelect = document.getElementById('shift');
        if (shiftSelect) {
            const currentShift = getCurrentShift();
            shiftSelect.value = currentShift;
        }
        
        // Reset form để nhập dữ liệu mới (không load từ database)
        // resetProductionForm();
        
        // Load số lượng còn lại
        loadRemainingQuantity();
        
        // Kiểm tra trạng thái shift hiện tại
        checkCurrentShiftStatus();
        }, 150);
    }

    /**
     * Tính số lượng cần sản xuất còn lại
     * = Số lượng từ công đoạn trước - (Tổng số lượng bàn giao + NG của các ca đã làm)
     */
    async function getRemainingQuantity(order) {
        try {
            // Lấy số lượng từ công đoạn trước
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            
            // Lấy tổng số lượng bàn giao và NG của các ca đã làm
            const shiftsResponse = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/shifts?stage=${STAGE_CONFIG.KEY}`);
            const shiftsData = await shiftsResponse.json();
            
            let totalHandoverQuantity = 0;
            let totalNgQuantity = 0;
            if (shiftsData.shifts && Array.isArray(shiftsData.shifts)) {
                shiftsData.shifts.forEach(shift => {
                    totalHandoverQuantity += (parseInt(shift.handover_quantity) || 0);
                    totalNgQuantity += (parseInt(shift.ng_quantity) || 0);
                });
            }
            
            // Số lượng còn lại = Input từ công đoạn trước - (Bàn giao + NG của các ca trước)
            const remainingQuantity = Math.max(0, inputQuantity - totalHandoverQuantity - totalNgQuantity);
            console.log('📊 Số lượng còn lại:', {
                inputQuantity,
                totalHandoverQuantity,
                totalNgQuantity,
                remainingQuantity
            });
            
            return remainingQuantity;
        } catch (error) {
            console.error('❌ Lỗi tính số lượng còn lại:', error);
            return getInputQuantityFromPreviousStage(order); // Fallback
        }
    }

    /**
     * Generate dynamic sidebar HTML for the order
     */
    function generateSidebarHTML(order) {
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HOÀN THÀNH';
        
        // Get status info
        let statusBadgeStyle = '';
        let statusText = '';
        
        if (getOrderField(order, 'status') === 'in_progress') {
            statusBadgeStyle = 'background: linear-gradient(135deg, var(--primary-green), #20c997);';
            statusText = 'Đang sản xuất';
        } else if (getOrderField(order, 'status') === 'completed') {
            statusBadgeStyle = 'background: linear-gradient(135deg, var(--primary-blue), #0dcaf0);';
            statusText = 'Hoàn thành';
        } else if (getOrderField(order, 'status') === 'handed_over') {
            statusBadgeStyle = 'background: linear-gradient(135deg, var(--primary-orange), #fd7e14);';
            statusText = 'Đã bàn giao';
        } else {
            statusBadgeStyle = 'background: linear-gradient(135deg, #6c757d, #adb5bd);';
            statusText = 'Chưa bắt đầu';
        }

        // Calculate statistics - không sử dụng dữ liệu từ database
        const totalProduced = 0; // Sẽ được tính từ form nhập liệu
        const inputQuantity = getInputQuantityFromPreviousStage(order);
        const efficiency = 0; // Sẽ được tính từ form nhập liệu
        const ngRate = 0; // Sẽ được tính từ form nhập liệu

        return `
            <div class="sidebar-header">
                <h5><i class="bi bi-clipboard-data me-2"></i>Báo cáo lệnh: <strong>${order.production_order || `#${order.id}`}</strong></h5>
                <button type="button" class="detail-close" onclick="closeDetailsPanel()">
                    <i class="bi bi-x-lg"></i>
                </button>
            </div>

            <div class="sidebar-content">
                <!-- Tab Navigation -->
                <div class="tab-navigation">
                    <button class="tab-btn active" onclick="switchTab('info')">
                        <div class="tab-icon"><i class="bi bi-person-fill"></i></div>
                        <div>Thông tin</div>
                    </button>
                    <button class="tab-btn" onclick="switchTab('quantity')">
                        <div class="tab-icon"><i class="bi bi-calculator-fill"></i></div>
                        <div>Số lượng</div>
                    </button>
      
                    <button class="tab-btn" onclick="switchTab('shifts')">
                        <div class="tab-icon"><i class="bi bi-clock-history"></i></div>
                        <div>Thông tin ca</div>
                    </button>
                    
                    <button class="tab-btn" onclick="switchTab('notes')">
                        <div class="tab-icon"><i class="bi bi-chat-text-fill"></i></div>
                        <div>Ghi chú</div>
                    </button>
                </div>

                <!-- Tab Content -->
                <div class="tab-content">
                    <!-- Info Tab -->
                    <div id="info-panel" class="tab-panel active">
                        <div class="form-group">
                            <div class="multi-select-container">
                                <div class="multi-select-input" id="workerMultiSelect">
                                    <div class="selected-items" id="selectedWorkers"></div>
                                    <input type="text" class="multi-select-search" id="workerSearch" placeholder="Tìm kiếm thợ...">
                                </div>
                                <div class="multi-select-dropdown" id="workerDropdown" style="display: none;">
                                    <div class="dropdown-items" id="workerOptions">
                                        <!-- Options will be populated by JavaScript -->
                                    </div>
                                </div>
                            </div>
                            <label class="form-label">
                                <i class="bi bi-person-badge"></i>
                                Tên thợ phụ trách
                            </label>
                            <input type="hidden" id="worker" value="${getOrderField(order, 'worker_name') || ''}">
                        </div>

                        <div class="form-group">
                            <select class="form-control-custom" id="shift">
                                <option value="">Chọn ca làm việc</option>
                                <option value="Ca 1" ${getOrderField(order, 'shift') === 'Ca 1' ? 'selected' : ''}>Ca 1 (6:00 - 14:00)</option>
                                <option value="Ca 2" ${getOrderField(order, 'shift') === 'Ca 2' ? 'selected' : ''}>Ca 2 (14:00 - 22:00)</option>
                                <option value="Ca 3" ${getOrderField(order, 'shift') === 'Ca 3' ? 'selected' : ''}>Ca 3 (22:00 - 6:00)</option>
                                <option value="Kíp 1" ${getOrderField(order, 'shift') === 'Kíp 1' ? 'selected' : ''}>Kíp 1 (6:00 - 18:00)</option>
                                <option value="Kíp 2" ${getOrderField(order, 'shift') === 'Kíp 2' ? 'selected' : ''}>Kíp 2 (18:00 - 6:00)</option>
                            </select>
                            <label class="form-label">
                                <i class="bi bi-clock"></i>
                                Ca làm việc
                            </label>
                        </div>

                        <div style="display: none;" class="form-group">
                            <select class="form-control-custom" id="machine">
                                <option value="">Chọn máy sản xuất</option>
                                ${getAvailableStageMachines().map(machineName => {
                                    const isSelected = getStageMachineFromAssigned(order.assigned_machine) === machineName;
                                    return `<option value="${machineName}" ${isSelected ? 'selected' : ''}>${machineName}</option>`;
                                }).join('')}
                            </select>
                            <label class="form-label">
                                <i class="bi bi-gear-fill"></i>
                                Máy sản xuất
                            </label>
                        </div>

                        <div class="info-row">
                            <span class="info-label">Thời gian bắt đầu</span>
                            <span class="info-value" id="startTimeInfo">${window.currentShiftStartTime ? formatDateTime(window.currentShiftStartTime) : '--'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Thời gian kết thúc</span>
                            <span class="info-value" id="endTimeInfo">${getOrderField(order, 'end_time') ? formatDateTime(getOrderField(order, 'end_time')) : '--'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Thời gian chạy</span>
                            <span class="info-value" id="runningTimeInfo">${window.currentShiftStartTime ?
                                (getOrderField(order, 'end_time') ? calculateWorkTime(window.currentShiftStartTime, getOrderField(order, 'end_time')) : 'Đang tính...') : '--'}</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Trạng thái máy</span>
                            <span class="info-value">${getOrderField(order, 'status') === 'in_progress' ? 'Hoạt động tốt' : 'Chờ'}</span>
                        </div>
                    </div>

                    <!-- Quantity Tab -->
                    <div id="quantity-panel" class="tab-panel">
                        <div class="quantity-grid mb-3">
                            <div class="quantity-card success">
                                <div class="quantity-label">Số lượng OK</div>
                                <input type="number" class="quantity-input" id="goodQty" value="0">
                            </div>
                            <div class="quantity-card danger">
                                <div class="quantity-label">Số lượng NG</div>
                                <input type="number" class="quantity-input" id="ngQty" value="0">
                            </div>
                        </div>

                        <div class="quantity-grid mb-3">
                            <div class="quantity-card ">
                                <div class="quantity-label">NG đầu/cuối</div>
                                <input type="number" class="quantity-input" id="ngStartEndQty" value="0">
                            </div>
                            <div class="quantity-card ">
                                <div class="quantity-label">Số lượng trả</div>
                                <input type="number" class="quantity-input" id="returnQty" value="0">
                            </div>
                        </div>


                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-arrow-right-circle"></i>
                                Số lượng chuyển giao
                            </label>
                            <input type="number" class="form-control-custom" id="handoverQty" value="0" style="font-size: 1.1rem; font-weight: 600; color: var(--primary-blue);">
                        </div>

                        <div class="info-row" style="background: linear-gradient(135deg, #e3f2fd, #e3f2fd); border-radius: 8px; padding: 12px; margin: 10px 0; ">
                            <span class="info-label" style="font-weight: 600; color: #1976d2;">📥 Số lượng cần sản xuất</span>
                            <span class="info-value" id="remainingQuantityDisplay" style="font-weight: 700; font-size: 1.1rem; color: #1565c0;">Đang tính...</span>
                        </div>
                        <div class="info-row" style="background: linear-gradient(135deg, #fff3cd, #fff3cd); border-radius: 8px; padding: 12px; margin: 10px 0; ">
                            <span class="info-label" style="font-weight: 600; color: #856404;">📊 Tổng số lượng đã nhập</span>
                            <span class="info-value" id="totalQuantityDisplay" style="font-weight: 700; font-size: 1.1rem; color: #856404;">0 / 0</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tổng sản xuất</span>
                            <span class="info-value" id="totalProducedValue">0 sản phẩm</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Hiệu suất</span>
                            <span class="info-value" id="efficiencyValue">0%</span>
                        </div>
                        <div class="info-row">
                            <span class="info-label">Tỷ lệ NG</span>
                            <span class="info-value" id="ngRateValue">0%</span>
                        </div>
                    </div>

                 

                    

                    <!-- Shifts Tab -->
                    <div id="shifts-panel" class="tab-panel">
                
                            <div class="shifts-header">
                                <h6><i class="bi bi-clock-history me-2"></i>Lịch sử ca làm việc</h6>
                                <div class="shifts-loading" id="shiftsLoading" style="display: none;">
                                    <div class="spinner-border spinner-border-sm" role="status">
                                        <span class="visually-hidden">Loading...</span>
                                    </div>
                                    <span class="ms-2">Đang tải...</span>
                                </div>
                            </div>
                            
                            <div class="shifts-list" id="shiftsList">
                                <!-- Shifts will be loaded here -->
                            </div>
                        </div>
                  
                </div>

                <!-- Notes Tab -->
                    <div id="notes-panel" class="tab-panel">
                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-journal-text"></i>
                                Ghi chú sản xuất
                            </label>
                            <div class="note-area">
                                <textarea class="note-textarea" id="note" placeholder="Nhập ghi chú về quá trình sản xuất...">${getOrderField(order, 'note') || ''}</textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-lightbulb"></i>
                                Đề xuất cải tiến
                            </label>
                            <div class="note-area">
                                <textarea class="note-textarea" id="improvement" placeholder="Nhập đề xuất cải tiến...">${order.improvement_suggestions || ''}</textarea>
                            </div>
                        </div>

                        <div class="form-group">
                            <label class="form-label">
                                <i class="bi bi-tag"></i>
                                Tags
                            </label>
                            <input type="text" class="form-control-custom" id="tags" value="${order.tags || ''}" placeholder="Nhập các tag, cách nhau bởi dấu phẩy">
                        </div>
                    </div>

                <!-- Production Controls -->
                <div class="production-controls">
                    <!-- Production Status -->
                    <div class="production-status ${getOrderField(order, 'status') === 'in_progress' ? 'running' : 'stopped'}" id="productionStatus">
                        <div class="status-text">
                            <i class="bi bi-${getOrderField(order, 'status') === 'in_progress' ? 'play-circle-fill text-success' : 'stop-circle-fill text-danger'}"></i>
                            <span id="productionStatusText">${statusText}</span>
                        </div>
                        <div class="status-time" id="statusTime">Thời gian: </div>
                    </div>

                    <!-- Control Buttons -->
                    <div class="control-row">
                        <button class="btn-custom btn-success-custom" id="startBtn" onclick="startProduction()">
                            <i class="bi bi-play-fill"></i>
                            Bắt đầu
                        </button>
         
                        <button class="btn-custom btn-info-custom" id="handoverShiftBtn" onclick="startHandoverConfirmationFlow()" ${getOrderField(order, 'status') === 'not_started' || getOrderField(order, 'status') === 'handed_over' ? 'disabled' : ''} style="${getOrderField(order, 'start_time') && !getOrderField(order, 'end_time') ? 'display: flex;' : 'display: none;'}">
                            <i class="bi bi-clock-history"></i>
                            Bàn giao ca
                        </button>

                          <button class="btn-custom btn-secondary-custom" id="resetBtn" onclick="resetProduction()" style="${getOrderField(order, 'start_time') && getOrderField(order, 'status') === 'in_progress' ? 'display: flex;    max-width: 100px;' : 'display: none;'}">
                            <i class="bi bi-arrow-clockwise"></i>
                            Hủy làm
                        </button>
                    </div>

          
                </div>
            </div>
        `;
    }

    // Helper functions for form manipulation
    function setElementValue(id, value) {
        const element = document.getElementById(id);
        if (element) {
            element.value = value;
        }
    }

    function getElementValue(id) {
        const element = document.getElementById(id);
        if (!element) return '';
        
        // Xử lý đặc biệt cho select elements
        if (element.tagName === 'SELECT') {
            const selectedOption = element.options[element.selectedIndex];
            return selectedOption ? selectedOption.value : '';
        }
        
        // Xử lý cho input, textarea và các element khác
        return element.value || '';
    }

    /**
     * Xác định ca làm việc theo thời gian hiện tại
     */
    function getCurrentShift() {
        const now = new Date();
        const currentHour = now.getHours();
        
        // Kíp 1: từ 6:00 - 18:00 (6:00 đến 17:59)
        if (currentHour >= 6 && currentHour < 18) {
            return 'Kíp 1';
        }
        // Kíp 2: từ 18:00 - 6:00 (18:00 đến 5:59)
        else {
            return 'Kíp 2';
        }
    }

    /**
     * Validate tổng số lượng không vượt quá số lượng đầu vào
     */
    function validateTotalQuantity(order, goodQty, ngQty, ngStartEndQty = 0, returnQty = 0) {
        // Lấy số lượng đầu vào từ stage trước hoặc sheet_count
        const inputQuantity = getInputQuantityFromPreviousStage(order);
        
        // Tính tổng số lượng đã nhập
        const totalEntered = goodQty + ngQty + ngStartEndQty + returnQty;
        
        // Kiểm tra tổng số lượng không vượt quá số lượng đầu vào
        if (totalEntered > inputQuantity) {
            showNotification(`⚠️ Tổng số lượng (${totalEntered}) vượt quá số lượng đầu vào (${inputQuantity})!\n\nChi tiết:\n• OK: ${goodQty}\n• NG: ${ngQty}\n• NG đầu/cuối: ${ngStartEndQty}\n• Trả: ${returnQty}\n• Tổng: ${totalEntered}\n• Đầu vào: ${inputQuantity}`, 'error');
            return false;
        }
        
        return true;
    }

    /**
     * Cập nhật hiển thị tổng số lượng và validation real-time
     */
    function updateTotalQuantityDisplay() {
        if (!currentEditingOrder) return;
        
        const goodQty = parseInt(getElementValue('goodQty')) || 0;
        const ngQty = parseInt(getElementValue('ngQty')) || 0;
        const ngStartEndQty = parseInt(getElementValue('ngStartEndQty')) || 0;
        const returnQty = parseInt(getElementValue('returnQty')) || 0;
        
        const totalEntered = goodQty + ngQty + ngStartEndQty + returnQty;
        
        // Lấy số lượng còn lại từ element hiển thị
        const remainingQuantityDisplay = document.getElementById('remainingQuantityDisplay');
        let remainingQuantity = 0;
        
        if (remainingQuantityDisplay && remainingQuantityDisplay.textContent) {
            const text = remainingQuantityDisplay.textContent;
            const match = text.match(/(\d+)/);
            if (match) {
                remainingQuantity = parseInt(match[1]);
            }
        }
        
        // Cập nhật hiển thị tổng số lượng
        const totalDisplay = document.getElementById('totalQuantityDisplay');
        if (totalDisplay) {
            totalDisplay.textContent = `${totalEntered} / ${remainingQuantity}`;
            
            // Thay đổi màu sắc dựa trên validation
            if (totalEntered > remainingQuantity) {
                totalDisplay.style.color = '#dc3545'; // Đỏ
                totalDisplay.style.fontWeight = 'bold';
            } else if (totalEntered === remainingQuantity) {
                totalDisplay.style.color = '#28a745'; // Xanh lá
                totalDisplay.style.fontWeight = 'bold';
            } else {
                totalDisplay.style.color = '#6c757d'; // Xám
                totalDisplay.style.fontWeight = 'normal';
            }
        }
        
        // Cập nhật trạng thái các input field
        const inputs = ['goodQty', 'ngQty', 'ngStartEndQty', 'returnQty'];
        inputs.forEach(inputId => {
            const input = document.getElementById(inputId);
            if (input) {
                if (totalEntered > remainingQuantity) {
                    input.style.color = '#ff3030';
                    // input.style.backgroundColor = '#fff5f5';
                } else {
                    input.style.color = '';
                    // input.style.backgroundColor = '';
                }
            }
        });
    }

    /**
     * Lấy dữ liệu từ form trong sidebar
     * @returns {object} - Dữ liệu form đã được validate
     */
    function getFormData() {
        const formData = {
            worker: getElementValue('worker') || '',
            shift: getElementValue('shift') || '',
            machine: getElementValue('machine') || '',
            goodQty: parseInt(getElementValue('goodQty')) || 0,
            ngQty: parseInt(getElementValue('ngQty')) || 0,
            ngStartEndQty: parseInt(getElementValue('ngStartEndQty')) || 0,
            returnQty: parseInt(getElementValue('returnQty')) || 0,
            handoverQty: parseInt(getElementValue('handoverQty')) || 0,
            qualityRating: getElementValue('qualityRating') || '',
            qualityCheck: getElementValue('qualityCheck') || '',
            note: getElementValue('note') || '',
            improvement: getElementValue('improvement') || '',
            tags: getElementValue('tags') || ''
        };

        return formData;
    }

    function closeDetailsPanel() {
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        
        detailsPanel.classList.remove('show');
        contentArea.classList.remove('details-open');
        
        // Dừng timer khi đóng panel
        stopProductionTimer();
        
        // Remove selection from table row
        const selectedRow = document.querySelector('.table tbody tr.selected');
        if (selectedRow) {
            selectedRow.classList.remove('selected');
        }
    }




    function getStatusBadgeClass(status) {
        const statusMap = {
            'waiting': 'bg-warning',
            'in_progress': 'bg-primary',
            'completed': 'bg-success',
            'paused': 'bg-secondary',
            'handed_over': 'bg-info'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return 'N/A';
        }
    }

    // Production control functions
    async function startProduction() {

        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
    
            showLoading('Đang bắt đầu ca làm việc...');
            
            // Lấy thông tin từ form trong sidebar
            const formData = getFormData();
            
            // Kiểm tra đã chọn ca làm việc chưa
            if (!formData.shift) {
                showNotification('⚠️ Vui lòng chọn ca làm việc', 'warning');
                return;
            }
            
            // Lấy máy được gán thực tế cho lệnh này
            const assignedMachine = getOrderMachine(order);
            if (!assignedMachine) {
                showNotification(`⚠️ Lệnh này không được gán cho máy ${STAGE_CONFIG.NAME} nào`, 'warning');
                return;
            }
            
            // Validation cơ bản
            if (!formData.worker || !formData.worker.trim()) {
                showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
                return;
            }
            
            // Lấy số ca tiếp theo
            const shiftsResponse = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/shifts?stage=${STAGE_CONFIG.KEY}`);
            const shiftsData = await shiftsResponse.json();
            
            const nextShiftNumber = shiftsData.shifts && shiftsData.shifts.length > 0
                ? Math.max(...shiftsData.shifts.map(s => s.shift_number)) + 1
                : 1;
            
            const now = new Date();
            const shiftDate = now.toISOString().split('T')[0];
            
            const mysqlDateTime = formatDateTimeForMySQL(now);
            
            // Tạo ca làm việc mới với status 'in_progress'
            const createShiftData = {
                production_order_id: order.id,
                production_order: order.production_order,
                stage: STAGE_CONFIG.KEY,
                shift_number: nextShiftNumber,
                shift_name: formData.shift,
                shift_date: shiftDate,
                worker_name: formData.worker,
                machine_name: assignedMachine,
                start_time: mysqlDateTime,
                end_time: null,
                work_duration_minutes: 0,
                good_quantity: 0,
                ng_quantity: 0,
                ng_start_end_quantity: 0,
                return_quantity: 0,
                output_quantity: 0,
                handover_quantity: 0,
                efficiency_percent: 0,
                quality_score: 0,
                handover_person: '',
                receiver_person: '',
                ng_reason: '',
                quality_notes: '',
                is_overtime: 0,
                overtime_hours: 0,
                is_night_shift: 0,
                break_duration_minutes: 0,
                status: 'in_progress',
                notes: formData.note || `Bắt đầu ca làm việc ${formData.shift}`
            };
            
            // Tạo shift mới
            const response = await fetch(`${API_BASE_URL}/data/production_orders_shift`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(createShiftData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
    
                showNotification('✅ Đã bắt đầu ca làm việc thành công!', 'success');
                
                // Lưu ID và thời gian bắt đầu của shift hiện tại để sử dụng khi bàn giao
                window.currentShiftId = result.shift_id;
                window.currentShiftStartTime = mysqlDateTime;

                
                // Cập nhật trạng thái production_orders với stage_status = 'in_progress'
                try {
                    const orderUpdateData = {
                        status: 'in_progress',
                        [`${STAGE_CONFIG.KEY}_status`]: 'in_progress',
                        [`${STAGE_CONFIG.KEY}_worker_name`]: formData.worker,
                        [`${STAGE_CONFIG.KEY}_machine_name`]: assignedMachine,
                        [`${STAGE_CONFIG.KEY}_start_time`]: mysqlDateTime
                    };
                    

                    
                    const updateOrderResponse = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderUpdateData)
                    });
                    
                    if (updateOrderResponse.ok) {
                        // console.log('✅ Production order status updated successfully');
                    } else {
                        const updateError = await updateOrderResponse.json();
                        console.warn('⚠️ Failed to update production order status:', updateError);
                    }
                } catch (updateError) {
                    console.warn('⚠️ Error updating production order status:', updateError);
                    // Không throw error vì đây không phải lỗi nghiêm trọng
                }
                
                // Cập nhật UI để hiển thị thời gian bắt đầu
                const startTimeElement = document.querySelector('.detail-section .alert .row .col-6:first-child span');
                if (startTimeElement) {
                    startTimeElement.textContent = formatDateTime(new Date(mysqlDateTime));
                    startTimeElement.classList.add('text-primary');
                }
                
                // Cập nhật thời gian bắt đầu trong sidebar
                const startTimeInfo = document.getElementById('startTimeInfo');
                if (startTimeInfo) {
                    // Hiển thị thời gian đã được định dạng
                    startTimeInfo.textContent = formatDateTime(mysqlDateTime);

                }
                
                // Hiển thị đồng hồ thời gian
                const timeDisplayContainer = document.querySelector('.detail-section .alert');
                if (timeDisplayContainer) {
                    // Kiểm tra xem đã có phần hiển thị thời gian chạy chưa
                    let timerSection = timeDisplayContainer.querySelector('.text-center');
                    
                    if (!timerSection) {
                        // Tạo phần hiển thị thời gian chạy nếu chưa có
                        const timerHtml = `
                            <hr class="my-2">
                            <div class="text-center">
                                <strong>Thời gian đang chạy:</strong><br>
                                <span class="text-warning" id="productionRunningTime">Đang tính...</span>
                            </div>
                        `;
                        timeDisplayContainer.insertAdjacentHTML('beforeend', timerHtml);
                    }
                    
                    // Bắt đầu timer ngay lập tức
                    startProductionTimer();
                }
                
                // Cập nhật trạng thái nút
                const startBtn = document.getElementById('startBtn');
                const handoverBtn = document.getElementById('handoverShiftBtn');
                const stopAndHandoverBtn = document.getElementById('stopAndHandoverBtn');
                const resetBtn = document.getElementById('resetBtn');
                
                // Ẩn nút bắt đầu, hiển thị các nút khác
                if (startBtn) {
                    startBtn.style.display = 'none';
                    startBtn.disabled = true;
                }
                
                if (handoverBtn) {
                    handoverBtn.style.display = 'flex';
                    handoverBtn.disabled = false;
                }
                
                if (stopAndHandoverBtn) {
                    stopAndHandoverBtn.style.display = 'flex';
                    stopAndHandoverBtn.disabled = false;
                }
                
                if (resetBtn) {
                    resetBtn.style.display = 'flex';
                    resetBtn.disabled = false;
                }
                
                // Refresh dữ liệu từ API
                await refreshData();
                
                // Refresh sidebar content
                showOrderDetails(order.id);
            } else {
                throw new Error(`API error: ${response.status} - ${result.message || result.error || 'Unknown error'}`);
            }
            
        } catch (error) {
            console.error('❌ Lỗi trong startProduction:', error);
            console.error('❌ Error stack:', error.stack);
            showNotification('Lỗi khi bắt đầu sản xuất: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    






 /**
     * Reset lệnh sản xuất về trạng thái chưa bắt đầu
     */
     async function resetProduction() {
        const order = currentEditingOrder;
        
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        // Hiển thị dialog xác nhận
        const confirmed = confirm('⚠️ Bạn có chắc chắn muốn reset lệnh sản xuất này về trạng thái chưa bắt đầu?\n\nĐiều này sẽ:\n• Xóa thời gian bắt đầu và kết thúc\n• Reset trạng thái về "chưa bắt đầu"\n• Xóa dữ liệu sản xuất (số lượng, ghi chú, v.v.)\n\nHành động này không thể hoàn tác!');
        
        if (!confirmed) {
            return;
        }
        
        try {
            showLoading('Đang reset lệnh sản xuất...');
            
            // Chuẩn bị dữ liệu reset
            const resetData = {
                stage: STAGE_CONFIG.KEY,
                reset_to_not_started: true
            };
            
            // Gửi request đến API để reset
            const response = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/reset_production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(resetData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Dừng timer nếu đang chạy
                stopProductionTimer();
                
                showNotification('✅ Đã reset lệnh sản xuất thành công!', 'success');
                
                // Cập nhật dữ liệu local
                if (currentEditingOrder) {
                    setOrderField(currentEditingOrder, 'status', 'waiting');
                    setOrderField(currentEditingOrder, 'start_time', null);
                    setOrderField(currentEditingOrder, 'end_time', null);
                    setOrderField(currentEditingOrder, 'worker', '');
                    setOrderField(currentEditingOrder, 'shift', '');
                    setOrderField(currentEditingOrder, 'good_quantity', 0);
                    setOrderField(currentEditingOrder, 'ng_quantity', 0);
                    setOrderField(currentEditingOrder, 'handover_quantity', 0);
                    setOrderField(currentEditingOrder, 'note', '');
                }
                
                await refreshData();
                
                // Refresh sidebar content
                showOrderDetails(order.id);
                
            } else {
                throw new Error(`API error: ${response.status} - ${result.message || result.error || 'Unknown error'}`);
            }
            
        } catch (error) {
            console.error('Reset production error:', error);
            
            // Fallback: Nếu API không hỗ trợ reset, thực hiện reset local
            if (error.message.includes('404') || error.message.includes('not found')) {
                showNotification('⚠️ API reset không khả dụng, thực hiện reset local...', 'warning');
                
                // Reset local data
                if (currentEditingOrder) {
                    setOrderField(currentEditingOrder, 'status', 'waiting');
                    setOrderField(currentEditingOrder, 'start_time', null);
                    setOrderField(currentEditingOrder, 'end_time', null);
                    setOrderField(currentEditingOrder, 'worker', '');
                    setOrderField(currentEditingOrder, 'shift', '');
                    setOrderField(currentEditingOrder, 'good_quantity', 0);
                    setOrderField(currentEditingOrder, 'ng_quantity', 0);
                    setOrderField(currentEditingOrder, 'handover_quantity', 0);
                    setOrderField(currentEditingOrder, 'note', '');
                }
                
                // Dừng timer
                stopProductionTimer();
                
                // Refresh UI
                await refreshData();
                showOrderDetails(order.id);
                
                showNotification('✅ Đã reset lệnh sản xuất (local)!', 'success');
            } else {
                showNotification('Lỗi khi reset lệnh sản xuất: ' + error.message, 'error');
            }
        } finally {
            hideLoading();
        }
    }



    // Utility functions for time display
    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
    
    try {
        // Xóa Z để JS không coi là UTC
        const localDateString = dateString.replace('Z', '');
        const date = new Date(localDateString);

        return date.toLocaleString('vi-VN', {
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit',
            day: '2-digit',
            month: '2-digit',
            year: 'numeric'
        });
    } catch (error) {
        console.error('Error formatting date:', error);
        return 'Error';
    }
    }
    
 
    
    function formatDateTimeForInput(dateString) {
        if (!dateString) return '';
        
        try {
            const date = new Date(dateString);
            
            // Kiểm tra date có hợp lệ không
            if (isNaN(date.getTime())) {
                console.error('Invalid date in formatDateTimeForInput:', dateString);
                return '';
            }
            
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            const hours = String(date.getHours()).padStart(2, '0');
            const minutes = String(date.getMinutes()).padStart(2, '0');
            return `${year}-${month}-${day}T${hours}:${minutes}`;
        } catch (error) {
            console.error('Error in formatDateTimeForInput:', error);
            return '';
        }
    }
    
    function calculateWorkTime(startTime, endTime) {
        if (!startTime || !endTime) return 'N/A';
        
        try {
            const start = new Date(startTime);
            const end = new Date(endTime);
            
            // Kiểm tra nếu date không hợp lệ
            if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                console.error('Invalid date in calculateWorkTime:', { startTime, endTime });
                return 'Invalid date';
            }
            
            const diffMs = end - start;
            
            // Xử lý trường hợp thời gian âm
            if (diffMs < 0) {
                console.warn('Negative time difference in calculateWorkTime:', { startTime, endTime, diffMs });
                return '00:00:00';
            }

            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
        } catch (error) {
            console.error('Error calculating work time:', error);
            return 'Error';
        }
    }

    // Format datetime cho MySQL (YYYY-MM-DD HH:mm:ss)
    function formatDateTimeForMySQL(date) {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        const seconds = String(date.getSeconds()).padStart(2, '0');
        return `${year}-${month}-${day} ${hours}:${minutes}:${seconds}`;
    }

    // Biến để lưu trữ ID của timer
    let productionTimerId = null;

    /**
     * =================================================================
     * TAB SWITCHING FUNCTIONS - HÀM CHUYỂN ĐỔI TAB
     * =================================================================
     */

    /**
     * Switch between tabs in the sidebar
     */
    function switchTab(tabName) {

        
        // Remove active class from all tabs and panels in sidebar only
        document.querySelectorAll('.details-panel .tab-btn').forEach(btn => btn.classList.remove('active'));
        document.querySelectorAll('.details-panel .tab-panel').forEach(panel => panel.classList.remove('active'));
        
        // Add active class to clicked tab and corresponding panel
        const clickedTab = event.target.closest('.tab-btn');
        if (clickedTab) {
            clickedTab.classList.add('active');
        }
        
        const targetPanel = document.getElementById(tabName + '-panel');
        if (targetPanel) {
            targetPanel.classList.add('active');
    
        } else {
            console.error('❌ Panel not found:', tabName + '-panel');
        }
        
        // Load shifts data if switching to shifts tab
        if (tabName === 'shifts' && currentEditingOrder) {
            loadShiftsData(currentEditingOrder.id);
        }
    }

    /**
     * Load shifts data for an order
     */
    async function loadShiftsData(orderId) {
        const shiftsList = document.getElementById('shiftsList');
        const shiftsLoading = document.getElementById('shiftsLoading');
        
        if (!shiftsList || !shiftsLoading) {
            console.error('Shifts elements not found');
            return;
        }
        

        
        try {
            // Show loading
            shiftsLoading.style.display = 'flex';
            shiftsList.innerHTML = '';
            
            const apiUrl = `${API_BASE_URL}/data/production_orders/${orderId}/shifts?stage=${STAGE_CONFIG.KEY}`;

            
            // Fetch shifts data
            const response = await fetch(apiUrl);

            
            const data = await response.json();
                        if (response.ok) {
                
                renderShiftsList(data.shifts);
            } else {
                console.error('❌ API error:', response.status, data);
                throw new Error(data.error || 'Failed to load shifts data');
            }
        } catch (error) {
            console.error('💥 Error loading shifts data:', error);
            console.error('💥 Error stack:', error.stack);
            shiftsList.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-exclamation-triangle"></i>
                    <h5>Không thể tải dữ liệu ca làm việc</h5>
                    <p>${error.message}</p>
                </div>
            `;
        } finally {
            shiftsLoading.style.display = 'none';
        }
    }
    
    /**
     * Render shifts list
     */
    function renderShiftsList(shifts) {
        const shiftsList = document.getElementById('shiftsList');
        
        if (!shiftsList) {
            console.error('❌ Shifts list element not found!');
            return;
        }
        
        if (!shifts || shifts.length === 0) {
            shiftsList.innerHTML = `
                <div class="empty-state">
                    <i class="bi bi-clock-history"></i>
                    <h5>Chưa có ca làm việc nào</h5>
                    <p>Ca làm việc sẽ được tạo khi bắt đầu sản xuất</p>
                </div>
            `;
            return;
        }

        // Tính toán thống kê
        const completedShifts = shifts.filter(s => s.status === 'completed').length;
        const inProgressShifts = shifts.filter(s => s.status === 'in_progress').length;
        const pendingShifts = shifts.filter(s => s.status === 'pending').length;
        const totalQuantity = shifts.reduce((sum, s) => sum + (parseInt(s.handover_quantity) || 0), 0);

        // Tạo HTML cho thống kê
        const statsHtml = `
            <div class="shifts-stats">
                <div class="stat-card">
                    <div class="stat-number">${completedShifts}</div>
                    <div class="stat-label">Đã hoàn thành</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${inProgressShifts}</div>
                    <div class="stat-label">Đang chạy</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${pendingShifts}</div>
                    <div class="stat-label">Chờ bắt đầu</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number">${totalQuantity.toLocaleString()}</div>
                    <div class="stat-label">Tổng sản lượng</div>
                </div>
            </div>
        `;
        
        const shiftsHtml = shifts.map(shift => {
            const statusClass = getShiftStatusClass(shift.status);
            const statusText = getShiftStatusText(shift.status);
            const startTime = shift.start_time ? formatDateTime(shift.start_time) : '--';
            const endTime = shift.end_time ? formatDateTime(shift.end_time) : '--';
            const workDuration = shift.work_duration_minutes ? `${shift.work_duration_minutes} phút` : '--';
            const efficiency = shift.efficiency_percent && !isNaN(shift.efficiency_percent) ? 
                `${parseFloat(shift.efficiency_percent).toFixed(1)}%` : '--';
            
            // Tính toán progress cho ca đang chạy
            let progressHtml = '';
            if (shift.status === 'in_progress' && shift.start_time) {
                const start = new Date(shift.start_time);
                const now = new Date();
                const totalDuration = 8 * 60; // 8 giờ = 480 phút
                const elapsed = Math.floor((now - start) / (1000 * 60));
                const progress = Math.min(100, Math.max(0, (elapsed / totalDuration) * 100));
                const remaining = Math.max(0, totalDuration - elapsed);
                const remainingHours = Math.floor(remaining / 60);
                const remainingMinutes = remaining % 60;
                
                progressHtml = `
                    <div class="shift-progress">
                        <div class="progress-bar">
                            <div class="progress-fill" style="width: ${progress}%"></div>
                        </div>
                        <div class="progress-text">${progress.toFixed(0)}% hoàn thành - Còn ${remainingHours} giờ ${remainingMinutes} phút</div>
                    </div>
                `;
            }
            
            return `
                <div class="shift-item">
                    <div class="shift-header">
                        <div class="shift-title">
                            <i class="bi bi-clock"></i>
                            ${shift.shift_name || `Ca ${shift.shift_number}`}
                        </div>
                        <span class="shift-status ${statusClass}">${statusText}</span>
                    </div>
                    
                    <div class="shift-details">
                        <div class="shift-detail">
                            <div class="shift-detail-label">Thợ phụ trách</div>
                            <div class="shift-detail-value">${shift.worker_name || '--'}</div>
                        </div>
                        <div class="shift-detail">
                            <div class="shift-detail-label">Máy sản xuất</div>
                            <div class="shift-detail-value">${shift.machine_name || '--'}</div>
                        </div>
                        <div class="shift-detail">
                            <div class="shift-detail-label">Số lượng OK</div>
                            <div class="shift-detail-value">${shift.handover_quantity || 0}</div>
                        </div>
                        <div class="shift-detail">
                            <div class="shift-detail-label">Số lượng NG</div>
                            <div class="shift-detail-value">${(parseInt(shift.ng_quantity) || 0) + (parseInt(shift.ng_start_end_quantity) || 0)}</div>
                        </div>
                        <div class="shift-detail">
                            <div class="shift-detail-label">Hiệu suất</div>
                            <div class="shift-detail-value">${efficiency}</div>
                        </div>
                        <div class="shift-detail">
                            <div class="shift-detail-label">Thời gian làm việc</div>
                            <div class="shift-detail-value">${workDuration}</div>
                        </div>
                    </div>

                    ${progressHtml}
                    
                    <div class="shift-times">
                        <span><i class="bi bi-play-circle"></i>Bắt đầu: ${startTime}</span>
                        <span><i class="bi bi-stop-circle"></i>Kết thúc: ${endTime}</span>
                    </div>

                    <div class="shift-actions">
                        <a href="#" class="btn-action btn-view" onclick="viewShiftDetails('${shift.id}')">
                            <i class="bi bi-eye"></i>Xem chi tiết
                        </a>
                        ${shift.status === 'in_progress' ? `
                            <a href="#" class="btn-action btn-edit" onclick="editShift('${shift.id}')">
                                <i class="bi bi-pencil"></i>Chỉnh sửa
                            </a>
                        ` : ''}
                    </div>
                </div>
            `;
        }).join('');
        
        shiftsList.innerHTML = statsHtml + shiftsHtml;
    }
    

    
    /**
     * Get shift status class for CSS
     */
    function getShiftStatusClass(status) {
        switch (status) {
            case 'completed': return 'completed';
            case 'in_progress': return 'in_progress';
            case 'waiting': return 'waiting';
            case 'paused': return 'paused';
            case 'handed_over': return 'handed_over';
            default: return 'waiting';
        }
    }
    
    /**
     * Get shift status text
     */
    function getShiftStatusText(status) {
        switch (status) {
            case 'completed': return 'Hoàn thành';
            case 'in_progress': return 'Đang làm';
            case 'waiting': return 'Chờ';
            case 'paused': return 'Tạm dừng';
            case 'handed_over': return 'Đã bàn giao';
            default: return 'Chờ';
        }
    }

    /**
     * View shift details
     */
    function viewShiftDetails(shiftId) {
        console.log('🔍 Viewing shift details for:', shiftId);
        // TODO: Implement shift details view
        showNotification('Tính năng xem chi tiết ca làm việc đang được phát triển', 'info');
    }

    /**
     * Edit shift
     */
    function editShift(shiftId) {
        console.log('✏️ Editing shift:', shiftId);
        // TODO: Implement shift editing
        showNotification('Tính năng chỉnh sửa ca làm việc đang được phát triển', 'info');
    }

    /**
     * Bàn giao ca làm việc
     */
    async function handoverShift() {
        const order = currentEditingOrder;
        
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        // Kiểm tra có shift đang chạy không
        if (!window.currentShiftId) {
            showNotification('⚠️ Không có ca làm việc nào đang chạy. Vui lòng bắt đầu ca trước khi bàn giao.', 'warning');
            return;
        }
        
        // Lấy thông tin từ form trong sidebar
        const formData = getFormData();
        const goodQuantity = formData.goodQty;
        const ngQuantity = formData.ngQty;
        const ngStartEndQuantity = formData.ngStartEndQty;
        const returnQuantity = formData.returnQty;
        const handoverQuantity = formData.handoverQty;
        const workerName = formData.worker;
        const shift = formData.shift || getCurrentShift();
        const notes = formData.note;
        
        // Lấy máy được gán thực tế cho lệnh này
        const assignedMachine = getOrderMachine(order);
        if (!assignedMachine) {
            showNotification(`⚠️ Lệnh này không được gán cho máy ${STAGE_CONFIG.NAME} nào`, 'warning');
            return;
        }
        
        // Validation cơ bản
        if (!workerName || !workerName.trim()) {
            showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
            return;
        }
        
        if (goodQuantity <= 0) {
            showNotification('⚠️ Vui lòng nhập số lượng sản xuất (OK hoặc NG)', 'warning');
            return;
        }
        
        if (handoverQuantity > goodQuantity) {
            showNotification('Số lượng chuyển giao không thể lớn hơn số lượng OK', 'error');
            return;
        }
        
        // Validate tổng số lượng không vượt quá số lượng đầu vào
        if (!validateTotalQuantity(order, goodQuantity, ngQuantity, ngStartEndQuantity, returnQuantity)) {
            return;
        }
        
        // Hiển thị dialog xác nhận (bỏ qua nếu đã xác nhận qua webhook)
        if (!window.__skip_handover_prompt) {
            const confirmed = confirm(`📋 Xác nhận bàn giao ca làm việc?\n\n` +
                `Lệnh sản xuất: ${order.production_order}\n` +
                `Thợ phụ trách: ${workerName}\n` +
                `Ca làm việc: ${shift}\n\n` +
                `Số lượng:\n` +
                `• OK: ${goodQuantity}\n` +
                `• NG: ${ngQuantity}\n` +
                `• NG đầu/cuối: ${ngStartEndQuantity}\n` +
                `• Trả: ${returnQuantity}\n` +
                `• Bàn giao: ${handoverQuantity}\n\n` +
                `Thông tin này sẽ được lưu vào lịch sử ca làm việc.`);
            if (!confirmed) {
                return;
            }
        }
        
        try {
            showLoading('Đang bàn giao ca làm việc...');
            
            const now = new Date();
            const outputQuantity = goodQuantity + ngQuantity + ngStartEndQuantity + returnQuantity;
            const efficiencyPercent = outputQuantity > 0 ? (goodQuantity / outputQuantity) * 100 : 0;
            
            const mysqlDateTime = formatDateTimeForMySQL(now);
            

            
            // Tính thời gian làm việc (work_duration_minutes)
            let workDurationMinutes = 0;
            if (window.currentShiftStartTime) {
                const startTime = new Date(window.currentShiftStartTime);
                const endTime = new Date(mysqlDateTime);
                workDurationMinutes = Math.round((endTime - startTime) / (1000 * 60));
            }
            
            // Cập nhật shift hiện tại với thông tin bàn giao
            const updateData = {
                end_time: mysqlDateTime,
                work_duration_minutes: workDurationMinutes,
                good_quantity: goodQuantity,
                ng_quantity: ngQuantity,
                ng_start_end_quantity: ngStartEndQuantity,
                return_quantity: returnQuantity,
                output_quantity: outputQuantity,
                handover_quantity: handoverQuantity,
                efficiency_percent: efficiencyPercent,
                handover_person: workerName,
                machine_name: assignedMachine,
                status: 'completed',
                notes: notes
            };
            
        
            const updateResponse = await fetch(`${API_BASE_URL}/data/production_orders_shift/${window.currentShiftId}`, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(updateData)
            });
            
            const updateResult = await updateResponse.json();
            
            if (updateResponse.ok) {
                
                // Kiểm tra logic status: nếu tổng số lượng nhập bằng số lượng còn sản xuất còn lại thì status=handed_over
                try {
                    // Log thông tin order trước khi xử lý
                    console.log('🔍 [handoverShift] Thông tin order trước khi xử lý:', {
                        orderId: order.id,
                        orderCode: order.production_order,
                        nextStage: order.next_stage,
                        currentStageStatus: order[`${STAGE_CONFIG.KEY}_status`],
                        allStageFields: Object.keys(order).filter(key => key.includes('_status'))
                    });
                    
                    const inputQuantity = getInputQuantityFromPreviousStage(order);
                    const remainingQuantity = await getRemainingQuantity(order);
              
                    
                    // Nếu số lượng còn lại sau ca này = 0, thì status = 'handed_over'
                    const newStatus = remainingQuantity <= 0 ? 'handed_over' : 'waiting';
                    
                    // Xác định công đoạn tiếp theo
                    const nextStage = order.next_stage;
                    
                    const orderUpdateData = {
                        status: remainingQuantity <= 0 ? 'Hoàn thành' : 'Đang sản xuất',
                        [`${STAGE_CONFIG.KEY}_status`]: newStatus
                    };
                    
                    // Log thông tin trước khi cập nhật
                    console.log('🔍 [handoverShift] Thông tin trước khi cập nhật:', {
                        orderId: order.id,
                        orderCode: order.production_order,
                        nextStage: nextStage,
                        handoverQuantity: handoverQuantity,
                        handoverQty: handoverQty,
                        newStatus: newStatus,
                        remainingQuantity: remainingQuantity,
                        currentStage: STAGE_CONFIG.KEY
                    });
                    
                    // Nếu có công đoạn tiếp theo và có số lượng bàn giao, cập nhật trạng thái công đoạn tiếp theo thành 'waiting'
                    if (nextStage && handoverQuantity > 0) {
                        orderUpdateData[`${nextStage}_status`] = 'waiting';
                        console.log(`🔄 [handoverShift] Cập nhật trạng thái công đoạn tiếp theo ${nextStage} thành 'waiting'`);
                    } else {
                        console.log(`⚠️ [handoverShift] Không cập nhật trạng thái công đoạn tiếp theo:`, {
                            hasNextStage: !!nextStage,
                            hasHandoverQty: handoverQuantity > 0,
                            nextStage: nextStage,
                            handoverQuantity: handoverQuantity
                        });
                    }
                    
                    console.log('📤 [handoverShift] Dữ liệu gửi lên API:', orderUpdateData);
                    
                    const updateOrderResponse = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify(orderUpdateData)
                    });
                    
                    if (updateOrderResponse.ok) {
                        const updateResult = await updateOrderResponse.json();
                        console.log(`✅ [handoverShift] Production order status updated successfully:`, {
                            mainStatus: orderUpdateData.status,
                            stageStatus: newStatus,
                            nextStage: nextStage ? nextStage + ' -> waiting' : 'N/A',
                            apiResponse: updateResult,
                            updatedFields: updateResult.updated_fields || []
                        });
                        
                        // Kiểm tra xem có cập nhật trạng thái công đoạn tiếp theo không
                        if (nextStage && updateResult.updated_fields) {
                            const nextStageField = `${nextStage}_status`;
                            const hasNextStageUpdate = updateResult.updated_fields.includes(nextStageField);
                            console.log(`🔍 [handoverShift] Kiểm tra cập nhật trạng thái công đoạn tiếp theo:`, {
                                nextStageField: nextStageField,
                                hasNextStageUpdate: hasNextStageUpdate,
                                allUpdatedFields: updateResult.updated_fields
                            });
                        }
                    } else {
                        const updateError = await updateOrderResponse.json();
                        console.warn('⚠️ [handoverShift] Failed to update production order status after handover:', updateError);
                    }
                } catch (updateError) {
                    console.warn('⚠️ Error updating production order status after handover:', updateError);
                    // Không throw error vì đây không phải lỗi nghiêm trọng
                }
                
                showNotification('✅ Đã bàn giao ca làm việc thành công!', 'success');
            } else {
                console.error('❌ Update shift failed:', updateResult);
                throw new Error(`Cập nhật ca: ${updateResult.error || 'Unknown error'}`);
            }
            
            // Reset cờ xác nhận qua webhook (nếu có)
            window.__skip_handover_prompt = false;

            // Reset form số lượng
            setElementValue('goodQty', '0');
            setElementValue('ngQty', '0');
            setElementValue('ngStartEndQty', '0');
            setElementValue('returnQty', '0');
            setElementValue('handoverQty', '0');
            
            // Enable nút "Bắt đầu", disable nút "Bàn giao ca"
            const startBtn = document.querySelector('button[onclick="startProduction()"]');
            const handoverBtn = document.querySelector('button[onclick="handoverShift()"]');
            if (startBtn) startBtn.disabled = false;
            if (handoverBtn) handoverBtn.disabled = true;
            
            // Dừng timer
            stopProductionTimer();
            
            // Cập nhật dữ liệu local
            await refreshData();
            
            // Refresh sidebar content
            showOrderDetails(order.id);
            
            // Chuyển sang tab "Thông tin ca" để xem kết quả
            setTimeout(() => {
                const shiftsTab = document.querySelector('.details-panel .tab-btn[onclick*="shifts"]');
                if (shiftsTab) {
                    shiftsTab.click();
                }
            }, 500);
            
                        } catch (error) {
                    console.error('💥 Error in handoverShift:', error);
                    console.error('💥 Error stack:', error.stack);
                    console.error('💥 Error message:', error.message);
                    showNotification('Lỗi khi bàn giao ca làm việc: ' + error.message, 'error');
                } finally {
            hideLoading();
        }
    }

    // BẮT ĐẦU LUỒNG XÁC NHẬN TRƯỚC KHI BÀN GIAO
    async function startHandoverConfirmationFlow() {
        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        const formData = getFormData();
        const assignedMachine = getOrderMachine(order);
        if (!assignedMachine) {
            showNotification(`⚠️ Lệnh này không được gán cho máy ${STAGE_CONFIG.NAME} nào`, 'warning');
            return;
        }
        if (!formData.worker || !formData.worker.trim()) {
            showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
            return;
        }
        if (!formData.shift) {
            showNotification('⚠️ Vui lòng chọn ca làm việc', 'warning');
            return;
        }
        if ((formData.goodQty || 0) <= 0) {
            showNotification('⚠️ Vui lòng nhập số lượng sản xuất (OK > 0)', 'warning');
            return;
        }
        if (formData.handoverQty > formData.goodQty) {
            showNotification('Số lượng chuyển giao không thể lớn hơn số lượng OK', 'error');
            return;
        }

        // Hiển thị popup chờ xác nhận
        openConfirmWaitModal({
            orderCode: order.production_order,
            worker: formData.worker,
            shift: formData.shift,
            goodQty: formData.goodQty,
            ngQty: formData.ngQty,
            ngStartEndQty: formData.ngStartEndQty,
            returnQty: formData.returnQty,
            handoverQty: formData.handoverQty
        });

        // Gửi yêu cầu xác nhận qua webhook (lưu vào DB production_confirm)
        try {
            const info = {
                type: 'handover_request',
                stage: STAGE_CONFIG.KEY,
                order_code: order.production_order,
                machine_name: assignedMachine,
                shift_name: formData.shift,
                worker_name: formData.worker,
                quantities: {
                    good: formData.goodQty,
                    ng: formData.ngQty,
                    ng_start_end: formData.ngStartEndQty,
                    return: formData.returnQty,
                    handover: formData.handoverQty
                },
                requested_at: new Date().toISOString()
            };
            const payload = {
                production_order_id: order.id,
                info_confirm_json: JSON.stringify(info)
            };
            const res = await fetch(`${WEBHOOK_BASE_URL}/confirmations`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(payload)
            });
            const data = await res.json();
            if (!res.ok) {
                throw new Error(data.message || data.error || 'Tạo yêu cầu xác nhận thất bại');
            }
            // Bắt đầu polling trạng thái (dựa trên production_order_id, không cần id)
            pollConfirmationStatusForOrder(order.id, 120, 3000);
        } catch (e) {
            closeConfirmWaitModal();
            showNotification('Lỗi gửi yêu cầu xác nhận: ' + e.message, 'error');
        }
    }

    function openConfirmWaitModal(info) {
        const modal = document.getElementById('confirmWaitModal');
        if (!modal) return;
        const body = modal.querySelector('#confirmWaitBody');
        if (body) {
            body.innerHTML = `
                <div class="mb-2"><strong>Lệnh:</strong> ${info.orderCode}</div>
                <div class="mb-2"><strong>Thợ:</strong> ${info.worker}</div>
                <div class="mb-2"><strong>Ca:</strong> ${info.shift}</div>
                <div class="mb-2"><strong>Số lượng:</strong>
                    OK: ${formatNumber(info.goodQty)}; NG: ${formatNumber(info.ngQty)}; NG đầu/cuối: ${formatNumber(info.ngStartEndQty)}; Trả: ${formatNumber(info.returnQty)}; Bàn giao: ${formatNumber(info.handoverQty)}
                </div>
                <div id="confirmStatusBox" class="alert alert-info d-flex align-items-center" role="alert">
                    <i class="bi bi-hourglass-split me-2"></i>
                    <div><span id="confirmStatusText">Đang chờ quản lý xác nhận...</span></div>
                </div>
                <div class="d-flex gap-2">
                    <button id="proceedHandoverBtn" class="btn btn-primary btn-sm" style="display:none;" onclick="proceedAfterApproved()">
                        <i class="bi bi-check2-circle me-1"></i>Tiến hành bàn giao
                    </button>
                    <button class="btn btn-outline-secondary btn-sm" onclick="closeConfirmWaitModal()">Đóng</button>
                </div>
            `;
        }
        modal.style.display = 'flex';
        try { document.body.style.overflow = 'hidden'; } catch (e) {}
    }

    function closeConfirmWaitModal() {
        const modal = document.getElementById('confirmWaitModal');
        if (modal) modal.style.display = 'none';
        try { document.body.style.overflow = ''; } catch (e) {}
    }

    async function pollConfirmationStatus(id, maxAttempts = 120, intervalMs = 3000, cb) {
        let attempts = 0;
        const timer = setInterval(async () => {
            attempts++;
            try {
                // DB-oriented status endpoint
                const res = await fetch(`${WEBHOOK_BASE_URL}/get_status_confirmations?id=${encodeURIComponent(id)}`);
                const data = await res.json();
                if (res.ok && data) {
                    const status = data.status || data[0]?.status;
                    if (status) updateConfirmWaitModalStatus(status);
                    if (status === 'approved' || status === 'rejected') clearInterval(timer);
                }
            } catch (e) {
                // ignore transient errors
            }
            if (attempts >= maxAttempts) {
                clearInterval(timer);
                closeConfirmWaitModal();
                showNotification('Hết thời gian chờ xác nhận. Vui lòng thử lại.', 'warning');
            }
        }, intervalMs);
    }

    // Poll theo production_order_id, không cần truyền id
    async function pollConfirmationStatusForOrder(orderId, maxAttempts = 120, intervalMs = 3000) {
        let attempts = 0;
        const timer = setInterval(async () => {
            attempts++;
            try {
                const res = await fetch(`${WEBHOOK_BASE_URL}/get_status_confirmations`);
                const data = await res.json();
                if (res.ok && data) {
                    let row = null;
                    if (Array.isArray(data)) {
                        // Tìm theo production_order_id
                        const candidates = data.filter(r => String(r.production_order_id) === String(orderId));
                        if (candidates.length > 0) {
                            // Lấy bản ghi mới nhất theo updated_at/created_at nếu có
                            candidates.sort((a,b) => new Date(b.updated_at||b.created_at||0) - new Date(a.updated_at||a.created_at||0));
                            row = candidates[0];
                        }
                    } else if (data.production_order_id && String(data.production_order_id) === String(orderId)) {
                        row = data;
                    }

                    if (row && row.status) {
                        updateConfirmWaitModalStatus(row.status);
                        if (row.status === 'approved' || row.status === 'rejected') {
                            clearInterval(timer);
                        }
                    }
                }
            } catch (e) {
                // ignore
            }
            if (attempts >= maxAttempts) {
                clearInterval(timer);
                closeConfirmWaitModal();
                showNotification('Hết thời gian chờ xác nhận. Vui lòng thử lại.', 'warning');
            }
        }, intervalMs);
    }

    function updateConfirmWaitModalStatus(status) {
        const box = document.getElementById('confirmStatusBox');
        const text = document.getElementById('confirmStatusText');
        const proceedBtn = document.getElementById('proceedHandoverBtn');
        if (!box || !text) return;
        if (status === 'approved') {
            box.className = 'alert alert-success d-flex align-items-center';
            text.textContent = 'Đã được phê duyệt. Bạn có thể tiến hành bàn giao.';
            if (proceedBtn) proceedBtn.style.display = 'inline-block';
        } else if (status === 'rejected') {
            box.className = 'alert alert-danger d-flex align-items-center';
            text.textContent = 'Yêu cầu bị từ chối.';
            if (proceedBtn) proceedBtn.style.display = 'none';
        } else {
            box.className = 'alert alert-info d-flex align-items-center';
            text.textContent = 'Đang chờ quản lý xác nhận...';
            if (proceedBtn) proceedBtn.style.display = 'none';
        }
    }

    async function proceedAfterApproved() {
        // Chỉ chạy khi đã approved
        window.__skip_handover_prompt = true;
        await handoverShift();
        closeConfirmWaitModal();
    }

    /**
     * Reset form fields in the sidebar
     */
    function resetForm() {
        // Reset all input fields
        document.querySelectorAll('#detailsPanel input, #detailsPanel select, #detailsPanel textarea').forEach(field => {
            if (field.type === 'checkbox') {
                field.checked = false;
            } else {
                field.value = '';
            }
        });
        
        // Reset quantity inputs to 0
        document.querySelectorAll('.quantity-input').forEach(input => {
            input.value = '0';
        });
        
        showNotification('Đã reset form thành công!', 'success');
    }


    
    // Hàm tính thời gian đang chạy (từ thời điểm bắt đầu đến hiện tại)
    function calculateRunningTime(startTime, endTime) {

        
        try {
            // Parse thời gian bắt đầu
            const start = new Date(startTime);
            // Sử dụng thời gian hiện tại và chuyển về múi giờ local
            const end = endTime ? new Date(endTime) : new Date();
            
            // Thêm 7 giờ vào end time để chuyển về múi giờ Việt Nam
            const endLocal = new Date(end.getTime() + (7 * 60 * 60 * 1000));
          
            
            // Kiểm tra nếu date không hợp lệ
            if (isNaN(start.getTime()) || isNaN(endLocal.getTime())) {
                console.error('❌ Invalid date in calculateRunningTime:', { startTime, endTime });
                return 'Invalid date';
            }
            
            const diffMs = endLocal.getTime() - start.getTime();
            
            const hours = Math.floor(diffMs / (1000 * 60 * 60));
            const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
            const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
            
            const result = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
            
            return result;
        } catch (error) {
            return 'Error';
        }
    }
    
    // Hàm cập nhật thời gian chạy trong giao diện
    function updateRunningTimer() {
        // Tìm element timer trong sidebar mới
        const statusTimeElement = document.getElementById('statusTime');
        const runningTimeInfoElement = document.getElementById('runningTimeInfo');
        const endTimeInfoElement = document.getElementById('endTimeInfo');
        // Fallback cho element cũ nếu còn tồn tại
        const timerElement = document.getElementById('productionRunningTime');
        
        if (window.currentShiftStartTime) {
            // Tính thời gian chạy từ thời điểm bắt đầu đến hiện tại (hoặc thời điểm kết thúc nếu có)
            const endTime = getOrderField(currentEditingOrder, 'end_time');
            const time = calculateRunningTime(window.currentShiftStartTime, endTime);
            
  
            
            // Cập nhật timer trong sidebar mới (production status)
            if (statusTimeElement) {
                statusTimeElement.textContent = `Thời gian: ${time}`;
            }
            
            // Cập nhật thời gian chạy trong tab thông tin
            if (runningTimeInfoElement) {
                // Luôn cập nhật, không quan tâm có end_time hay không
                runningTimeInfoElement.textContent = time;
            }
            
            // Cập nhật thời gian kết thúc nếu đã kết thúc
            if (endTimeInfoElement && getOrderField(currentEditingOrder, 'end_time')) {
                endTimeInfoElement.textContent = formatDateTime(getOrderField(currentEditingOrder, 'end_time'));
            }
            
            // Cập nhật timer cũ nếu còn tồn tại (fallback)
            if (timerElement) {
                timerElement.textContent = time;
            }
        } else {
            console.warn('⚠️ Không có thời gian bắt đầu (window.currentShiftStartTime)');
            
            // Nếu chưa bắt đầu hoặc không có thời gian
            if (statusTimeElement) {
                statusTimeElement.textContent = 'Thời gian: 00:00:00';
            }
            if (runningTimeInfoElement) {
                runningTimeInfoElement.textContent = '--';
            }
            if (endTimeInfoElement) {
                endTimeInfoElement.textContent = '--';
            }
        }
    }
    
    // Hàm bắt đầu timer
    function startProductionTimer() {
        // Xóa timer cũ nếu có
        stopProductionTimer();
        
        // Log order information for debugging
        if (currentEditingOrder) {
            
        }
        
        // Bắt đầu timer mới, cập nhật mỗi giây
        updateRunningTimer();
        productionTimerId = setInterval(updateRunningTimer, 1000);

    }
    
    // Hàm dừng timer
    function stopProductionTimer() {
        if (productionTimerId) {
            clearInterval(productionTimerId);
            productionTimerId = null;
        }
    }

    // Export functions for global access
    window.refreshData = refreshData;
    window.showReportTab = showReportTab;

    

    window.updateHandoverQuantity = updateHandoverQuantity;
    
    // Filter functions
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
    
    // Wizard functions
    window.wizardNextStep = wizardNextStep;
    window.wizardPreviousStep = wizardPreviousStep;

    window.updateWizardHandoverQuantity = updateWizardHandoverQuantity;
    
    // Details panel functions
    window.showOrderDetails = showOrderDetails;
    window.closeDetailsPanel = closeDetailsPanel;

    window.startProduction = startProduction;
    // window.endProduction = endProduction;

    // Tab switching functions
    window.switchTab = switchTab;
    window.resetForm = resetForm;
    // window.pauseProduction = pauseProduction;

    




    /**
     * =================================================================
     * REPORT FUNCTIONS - HÀM XỬ LÝ BÁO CÁO
     * =================================================================
     */

    /**
     * Hiển thị tab báo cáo
     */
    function showReportTab() {
        
        // Chuyển sang tab báo cáo
        const reportTab = document.getElementById('report-tab');
        
        if (reportTab) {
            reportTab.click();
        } else {
            console.error('Report tab not found!');
        }
        
        // Load dữ liệu báo cáo
        loadReportData();
    }

    /**
     * Load dữ liệu báo cáo - các lệnh đã bàn giao
     */
    async function loadReportData() {
      
        
        try {
            showLoading('Đang tải dữ liệu báo cáo...');
            
                    // Lọc các lệnh đã hoàn thành (số lượng cần sản xuất = 0) và đã được bàn giao từ công đoạn trước
        const handedOverOrders = ordersData.filter(order => {
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            
            // Tính tổng số lượng bàn giao và input
            const previousStageHandover = order.previous_stage_handover_quantity || 0;
            const currentStageHandover = getOrderField(order, 'handover_quantity') || 0;
            const currentStageInput = getOrderField(order, 'input_quantity') || 0;
            
  
            return inputQuantity <= 0 && previousStageHandover > 0;
        });  
        
            
            // Render bảng báo cáo
            renderReportTable(handedOverOrders);
            
            // Cập nhật số lượng
            updateReportCount(handedOverOrders.length);
            
        } catch (error) {
            console.error('Error in loadReportData:', error);
            showNotification('Lỗi khi tải dữ liệu báo cáo: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Render bảng báo cáo
     */
    function renderReportTable(orders) {
        const tableBody = document.getElementById('reportTableBody');
        if (!tableBody) {
            console.error('reportTableBody not found!');
            return;
        }
        
        // Xóa dữ liệu cũ
        tableBody.innerHTML = '';
        
        // Kiểm tra có dữ liệu không
        if (orders.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        <i class="bi bi-file-earmark-text fs-1 mb-2 d-block"></i>
                        Chưa có lệnh nào được bàn giao
                    </td>
                </tr>
            `;
            return;
        }

        // Sắp xếp theo thời gian bàn giao (mới nhất lên đầu)
        const sortedOrders = [...orders].sort((a, b) => {
            const aTime = getOrderField(a, 'handover_date') ? new Date(getOrderField(a, 'handover_date')).getTime() : 0;
            const bTime = getOrderField(b, 'handover_date') ? new Date(getOrderField(b, 'handover_date')).getTime() : 0;
            return bTime - aTime;
        });

        // Render từng dòng
        sortedOrders.forEach((order, index) => {
            const row = createReportTableRow(order, index);
            tableBody.appendChild(row);
        });
    }

    /**
     * Tạo dòng báo cáo
     */
    function createReportTableRow(order, index) {
        const row = document.createElement('tr');
        row.className = 'order-row';
        row.setAttribute('data-order-id', order.id);
        
        // Tính toán tiến độ
        const inputQty = getOrderField(order, 'input_quantity') || 0;
        const sheet_count = order.sheet_count || 0;
        const goodQty = getOrderField(order, 'good_quantity') || 0;
        const ngQty = getOrderField(order, 'ng_quantity') || 0;
        const deployedQty = order.deployed_quantity || 0;
        const progressPercent = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
        
        // Lấy thông tin bàn giao
        const handoverDate = getOrderField(order, 'handover_date') ? formatDateTime(getOrderField(order, 'handover_date')) : 'N/A';
        const handoverQuantity = getOrderField(order, 'handover_quantity') || 0;
        
        // Xác định icon và màu sắc cho trạng thái đã bàn giao
        const statusIcon = 'bi-arrow-right-circle';
        const statusClass = 'text-info';
        const statusText = 'Đã bàn giao';
        
        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-light text-dark">${index + 1}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="bi ${statusIcon} ${statusClass} me-2"></i>
                    <div>
                        <div class="fw-bold">${order.production_order}</div>
                        <small class="text-muted">${formatDate(order.deployment_date)} - ${getOrderField(order, 'shift')}</small>
                        <small class="text-info d-block">${statusText}</small>
                    </div>
                </div>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.order_type || ''}</span>
            </td>
            <td>
                <div>
                    <div class="fw-bold">${order.internal_product_code}</div>
                    <small class="text-muted" title="${order.product_name}">${truncateText(order.product_name, 100)}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">${order.paper_type || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.paper_weight || 0} gsm</span>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(deployedQty)}</div>
                <small class="text-muted">pcs</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary">${formatNumber(sheet_count)}</div>
                <small class="text-muted">tờ giấy</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${formatNumber(order.paper_length || 0)}</div>
                <small class="text-muted">KT</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-danger">${formatNumber(order.paper_width || 0)}</div>
                <small class="text-muted">chiều rộng</small>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(order.blank_count || 0)}</div>
                <small class="text-muted">phôi</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar bg-success" style="width: ${Math.min(progressPercent, 100)}%">
                        ${progressPercent}%
                    </div>
                </div>
                <small class="text-muted">${statusText}</small>
            </td>
            <td class="text-center">
                <small class="text-muted d-block" title="${order.assigned_machine || 'N/A'}">${truncateText(order.assigned_machine || 'N/A', 15)}</small>
            </td>
        `;
        
        // Thêm click event để xem chi tiết
        row.style.cursor = 'pointer';
        row.addEventListener('click', () => {
            showOrderDetails(order.id);
        });
        
        return row;
    }

    /**
     * Cập nhật số lượng báo cáo
     */
    function updateReportCount(count) {
        const reportCountElement = document.getElementById('report-count');
        if (reportCountElement) {
            reportCountElement.textContent = count;
        } else {
            console.error('report-count element not found!');
        }
    }

    /**
     * =================================================================
     * FILTER FUNCTIONS - HÀM LỌC DỮ LIỆU
     * =================================================================
     */

    // Biến lưu trữ dữ liệu gốc và dữ liệu đã lọc
    let originalOrdersData = [];
    let filteredOrdersData = [];

    /**
     * Áp dụng các bộ lọc
     */
    function applyFilters() {
        const fromDateFilter = document.getElementById('fromDateFilter')?.value || '';
        const toDateFilter = document.getElementById('toDateFilter')?.value || '';
        const searchInput = document.getElementById('searchInput')?.value?.toLowerCase() || '';

        // Lọc dữ liệu
        let filteredCount = 0;
        filteredOrdersData = originalOrdersData.filter(order => {
            // Lọc theo khoảng ngày sản xuất
            if (fromDateFilter && toDateFilter) {
                const orderDate = order.deployment_date || order.created_at;
                if (!orderDate || orderDate < fromDateFilter || orderDate > toDateFilter) {
                    return false;
                }
            } else if (fromDateFilter) {
                const orderDate = order.deployment_date || order.created_at;
                if (!orderDate || orderDate < fromDateFilter) {
                    return false;
                }
            } else if (toDateFilter) {
                const orderDate = order.deployment_date || order.created_at;
                if (!orderDate || orderDate > toDateFilter) {
                    return false;
                }
            }



            // Lọc theo tìm kiếm
            if (searchInput) {
                const searchFields = [
                    order.order_type,
                    order.production_order,
                    order.internal_product_code,
                    order.paper_type,
                    order.assigned_machine,
                    getOrderField(order, 'worker_name')
                ].map(field => (field || '').toLowerCase());

                const hasMatch = searchFields.some(field => field.includes(searchInput));
                if (!hasMatch) {
                    return false;
                }
            }

            // ✅ KIỂM TRA STAGE TRƯỚC ĐÃ HOÀN THÀNH HAY CHƯA (TẠM THỜI DISABLE)
            /*
            if (!isPreviousStageReady(order)) {
                console.log(`Order ${order.id} filtered out by previous stage not ready:`, {
                    previous_stage: order.previous_stage,
                    previous_stage_status: order.previous_stage_status,
                    current_status: getOrderField(order, 'status')
                });
                return false; // Ẩn lệnh này vì stage trước chưa xong
            }
            */

            filteredCount++;
            return true;
        });



        // Cập nhật dữ liệu hiển thị
        ordersData = filteredOrdersData;
        
        // Render lại bảng
        renderOrdersTable();
        updateStatistics();
        
        // Hiển thị thông báo
        if (filteredOrdersData.length === 0) {
            showNotification('Không tìm thấy dữ liệu phù hợp với bộ lọc', 'warning');
        } else {
            showNotification(`Đã lọc: ${filteredOrdersData.length} lệnh sản xuất`, 'info');
        }
    }

    /**
     * Xóa tất cả bộ lọc
     */
    function clearFilters() {
        const fromDateFilter = document.getElementById('fromDateFilter');
        const toDateFilter = document.getElementById('toDateFilter');
        const searchInput = document.getElementById('searchInput');
        
        if (fromDateFilter) fromDateFilter.value = '';
        if (toDateFilter) toDateFilter.value = '';
        if (searchInput) searchInput.value = '';

        // Xóa cache filter ngày khi clear
        localStorage.removeItem(DATE_FILTER_CACHE_KEY);

        // Khôi phục dữ liệu gốc
        ordersData = [...originalOrdersData];
        
        // Chuyển về tab "Tất cả" khi xóa filter
        const allTab = document.getElementById('all-tab');
        if (allTab) {
            allTab.click();
        }
        
        // Render lại bảng
        renderOrdersTable();
        updateStatistics();
        
        showNotification('Đã xóa tất cả bộ lọc', 'info');
    }

    /**
     * Tự động lọc khi nhập tìm kiếm (debounce)
     */
    let searchTimeout;
    function setupSearchDebounce() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300); // Delay 300ms
            });
        }
    }

    /**
     * Tự động lọc khi thay đổi bộ lọc
     */
    function setupFilterChangeListeners() {
        // Chỉ setup listener cho các element thực sự tồn tại
        const fromDateFilter = document.getElementById('fromDateFilter');
        const toDateFilter = document.getElementById('toDateFilter');

        if (fromDateFilter) {
            fromDateFilter.addEventListener('change', applyFilters);
        }
        if (toDateFilter) {
            toDateFilter.addEventListener('change', applyFilters);
        }
    }

    /**
     * Cập nhật danh sách máy từ dữ liệu thực tế
     */
    function updateMachineFilterOptions() {
        const machineFilter = document.getElementById('machineFilter');
        if (!machineFilter) {
            return;
        }

        // Lọc các máy thuộc Stage_${STAGE_CONFIG.KEY} từ dữ liệu máy
        const MStageMachines = machineStatusData.filter(machine => 
            machine.stage_machine && machine.stage_machine.includes(`Stage_${STAGE_CONFIG.KEY}`)
        ).map(machine => machine.machine_name);

        // Xóa options cũ (giữ lại option "Tất cả")
        machineFilter.innerHTML = '<option value="">Tất cả</option>';

        // Thêm options mới
        MStageMachines.sort().forEach(machine => {
            const option = document.createElement('option');
            option.value = machine;
            option.textContent = machine;
            machineFilter.appendChild(option);
        });
    }


    /**
     * Tính số lượng cần sản xuất còn lại
     * = Số lượng từ công đoạn trước - (Tổng số lượng bàn giao + NG của các ca đã làm)
     */
    async function getRemainingQuantity(order) {
        try {
            // Lấy số lượng từ công đoạn trước
            const inputQuantity = getInputQuantityFromPreviousStage(order);
            
            // Lấy tổng số lượng bàn giao của các ca đã làm
            const shiftsResponse = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/shifts?stage=${STAGE_CONFIG.KEY}`);
            const shiftsData = await shiftsResponse.json();
            
            let totalHandoverQuantity = 0;
            let totalNgQuantity = 0;
            if (shiftsData.shifts && Array.isArray(shiftsData.shifts)) {
                shiftsData.shifts.forEach(shift => {
                    totalHandoverQuantity += (parseInt(shift.handover_quantity) || 0);
                    totalNgQuantity += (parseInt(shift.ng_quantity) || 0);
                });
            }
            
            const remainingQuantity = Math.max(0, inputQuantity - totalHandoverQuantity - totalNgQuantity);
            
            return remainingQuantity;
        } catch (error) {
            console.error('❌ Lỗi tính số lượng còn lại:', error);
            return getInputQuantityFromPreviousStage(order); // Fallback
        }
    }

    /**
     * Load và hiển thị số lượng còn lại
     */
    async function loadRemainingQuantity() {
        if (!currentEditingOrder) return;
        
        try {
            const remainingQuantity = await getRemainingQuantity(currentEditingOrder);
            
            // Cập nhật hiển thị số lượng còn lại
            const remainingQuantityDisplay = document.getElementById('remainingQuantityDisplay');
            if (remainingQuantityDisplay) {
                remainingQuantityDisplay.textContent = `${remainingQuantity} tờ giấy`;
            }
            
            // Cập nhật hiển thị tổng số lượng đã nhập
            const totalQuantityDisplay = document.getElementById('totalQuantityDisplay');
            if (totalQuantityDisplay) {
                const currentTotal = parseInt(getElementValue('goodQty') || 0) + 
                                   parseInt(getElementValue('ngQty') || 0) + 
                                   parseInt(getElementValue('ngStartEndQty') || 0) + 
                                   parseInt(getElementValue('returnQty') || 0);
                totalQuantityDisplay.textContent = `${currentTotal} / ${remainingQuantity}`;
            }
            
        } catch (error) {
            console.error('❌ Lỗi load số lượng còn lại:', error);
        }
    }

    /**
     * Cập nhật hiển thị thống kê real-time
     */
    function updateStatisticsDisplay() {
        const goodQty = parseInt(getElementValue('goodQty')) || 0;
        const ngQty = parseInt(getElementValue('ngQty')) || 0;
        const ngStartEndQty = parseInt(getElementValue('ngStartEndQty')) || 0;
        const returnQty = parseInt(getElementValue('returnQty')) || 0;
        
        const totalProduced = goodQty + ngQty + ngStartEndQty + returnQty;
        const inputQuantity = getInputQuantityFromPreviousStage(currentEditingOrder);
        const efficiency = inputQuantity > 0 ? Math.round((totalProduced / inputQuantity) * 100) : 0;
        const ngRate = totalProduced > 0 ? Math.round(((ngQty + ngStartEndQty) / totalProduced) * 100) : 0;
        
        // Cập nhật hiển thị thống kê
        const totalProducedElement = document.getElementById('totalProducedValue');
        const efficiencyElement = document.getElementById('efficiencyValue');
        const ngRateElement = document.getElementById('ngRateValue');
        
        if (totalProducedElement) {
            totalProducedElement.textContent = `${totalProduced} sản phẩm`;
        }
        if (efficiencyElement) {
            efficiencyElement.textContent = `${efficiency}%`;
        }
        if (ngRateElement) {
            ngRateElement.textContent = `${ngRate}%`;
        }
        
        // Cập nhật hiển thị tổng số lượng đã nhập
        updateTotalQuantityDisplay();
    }

    /**
     * Load và hiển thị số lượng còn lại
     */
    async function loadRemainingQuantity() {
        if (!currentEditingOrder) return;
        
        try {
            const remainingQuantity = await getRemainingQuantity(currentEditingOrder);
            
            // Cập nhật hiển thị số lượng còn lại
            const remainingQuantityDisplay = document.getElementById('remainingQuantityDisplay');
            if (remainingQuantityDisplay) {
                remainingQuantityDisplay.textContent = `${remainingQuantity} tờ giấy`;
            }
            
            // Cập nhật hiển thị tổng số lượng đã nhập
            const totalQuantityDisplay = document.getElementById('totalQuantityDisplay');
            if (totalQuantityDisplay) {
                const currentTotal = parseInt(getElementValue('goodQty') || 0) + 
                                   parseInt(getElementValue('ngQty') || 0) + 
                                   parseInt(getElementValue('ngStartEndQty') || 0) + 
                                   parseInt(getElementValue('returnQty') || 0);
                totalQuantityDisplay.textContent = `${currentTotal} / ${remainingQuantity}`;
            }
            
        } catch (error) {
            console.error('❌ Lỗi load số lượng còn lại:', error);
        }
    }

    /**
     * Kiểm tra shift hiện tại và cập nhật trạng thái nút
     */
    async function checkCurrentShiftStatus() {
        if (!currentEditingOrder) return;
        
        try {
            const shiftsResponse = await fetch(`${API_BASE_URL}/data/production_orders/${currentEditingOrder.id}/shifts?stage=${STAGE_CONFIG.KEY}`);
            const shiftsData = await shiftsResponse.json();
            
            // Tìm shift đang chạy (status = 'in_progress')
            const currentShift = shiftsData.shifts?.find(shift => shift.status === 'in_progress');
            
            // Cập nhật trạng thái nút
            const startBtn = document.getElementById('startBtn');
            const handoverBtn = document.getElementById('handoverShiftBtn');
            const stopAndHandoverBtn = document.getElementById('stopAndHandoverBtn');
            const handoverBtn2 = document.getElementById('handoverBtn');
            const resetBtn = document.getElementById('resetBtn');
            
            if (currentShift) {
                // Có shift đang chạy
        
                
                // Cập nhật UI dựa trên trạng thái ca kíp
                if (startBtn) {
                    startBtn.style.display = 'none';
                    startBtn.disabled = true;
                }
                
                if (handoverBtn) {
                    handoverBtn.style.display = 'flex';
                    handoverBtn.disabled = false;
                }
                
                if (stopAndHandoverBtn) {
                    stopAndHandoverBtn.style.display = 'flex';
                    stopAndHandoverBtn.disabled = false;
                }
                
                if (resetBtn) {
                    resetBtn.style.display = 'flex';
                    resetBtn.disabled = false;
                }
                
                // Lưu ID và thời gian bắt đầu của shift hiện tại
                window.currentShiftId = currentShift.id;
                window.currentShiftStartTime = currentShift.start_time;
                
                // Cập nhật hiển thị thời gian bắt đầu trong sidebar
                const startTimeInfo = document.getElementById('startTimeInfo');
                if (startTimeInfo) {
                    // Hiển thị thời gian đã được định dạng
                    startTimeInfo.textContent = formatDateTime(currentShift.start_time);
    
                }
                
                // Bắt đầu timer nếu chưa có
                if (!productionTimerId) {
                    startProductionTimer();
                }
                

            } else {
                // Không có shift đang chạy

                
                // Kiểm tra trạng thái lệnh để quyết định hiển thị nút bắt đầu
                const orderStatus = getOrderField(currentEditingOrder, 'status');
                
                if (startBtn) {
                    if (orderStatus === 'completed' || orderStatus === 'handed_over') {
                        // Nếu lệnh đã hoàn thành hoặc đã bàn giao, ẩn nút bắt đầu
                        startBtn.style.display = 'none';
                        startBtn.disabled = true;
        
                    } else {
                        // Nếu lệnh chưa hoàn thành, hiển thị nút bắt đầu
                        startBtn.style.display = 'flex';
                        startBtn.disabled = false;
        
                    }
                }
                
                if (handoverBtn) {
                    handoverBtn.style.display = 'none';
                    handoverBtn.disabled = true;
                }
                
                if (stopAndHandoverBtn) {
                    stopAndHandoverBtn.style.display = 'none';
                    stopAndHandoverBtn.disabled = true;
                }
                
                if (resetBtn) {
                    resetBtn.style.display = 'none';
                    resetBtn.disabled = true;
                }
                
                // Dừng timer
                stopProductionTimer();
                
    
            }
            
        } catch (error) {
            console.error('❌ Lỗi kiểm tra trạng thái shift:', error);
        }
    }

    /**
     * Load và hiển thị số lượng còn lại
     */
    async function loadRemainingQuantity() {
        if (!currentEditingOrder) return;
        
        try {
            const remainingQuantity = await getRemainingQuantity(currentEditingOrder);
            
            // Cập nhật hiển thị số lượng còn lại
            const remainingQuantityDisplay = document.getElementById('remainingQuantityDisplay');
            if (remainingQuantityDisplay) {
                remainingQuantityDisplay.textContent = `${remainingQuantity} tờ giấy`;
            }
            
            // Cập nhật hiển thị tổng số lượng đã nhập
            const totalQuantityDisplay = document.getElementById('totalQuantityDisplay');
            if (totalQuantityDisplay) {
                const currentTotal = parseInt(getElementValue('goodQty') || 0) + 
                                   parseInt(getElementValue('ngQty') || 0) + 
                                   parseInt(getElementValue('ngStartEndQty') || 0) + 
                                   parseInt(getElementValue('returnQty') || 0);
                totalQuantityDisplay.textContent = `${currentTotal} / ${remainingQuantity}`;
            }
            
        } catch (error) {
            console.error('❌ Lỗi load số lượng còn lại:', error);
        }
    }
  </script>
  
  <!-- User Info Update Script -->
  <script>
    // Update user info when page loads
    document.addEventListener('DOMContentLoaded', function() {
      setTimeout(checkAuthAndUpdateUser, 100);
    });
    

    
    function checkAuthAndUpdateUser() {
      if (typeof auth === 'undefined') {
        setTimeout(checkAuthAndUpdateUser, 100);
        return;
      }
      
      if (!auth.isLoggedIn()) {
        showLoginPopup({
          onLoginSuccess: function(userData) {
            updateUserInfo();
            refreshData();
          },
          onLoginError: function(error) {
            console.error('Login failed:', error);
          }
        });
        return;
      }
      
      updateUserInfo();
    }
    
    function updateUserInfo() {
      const userNameElement = document.getElementById('userName');
      
      if (!userNameElement) {
        setTimeout(updateUserInfo, 100);
        return;
      }
      
      if (typeof auth === 'undefined') {
        setTimeout(updateUserInfo, 100);
        return;
      }
      
      const user = auth.getUser();
      
      if (user) {
        userNameElement.textContent = user.full_name;
      } else {
        userNameElement.textContent = 'Chưa đăng nhập';
      }
    }
    

    
    // Multi-Select Worker Functions
    function initializeWorkerMultiSelect(order) {
        const selectedWorkers = document.getElementById('selectedWorkers');
        const workerSearch = document.getElementById('workerSearch');
        const workerDropdown = document.getElementById('workerDropdown');
        const workerOptions = document.getElementById('workerOptions');
        
        // Lấy danh sách user từ API
        let availableWorkers = [];
        
        async function loadWorkersFromAPI() {
            try {
                const response = await fetch(`${API_BASE_URL}/data/user`);
                
                if (response.ok) {
                    const users = await response.json();
           
                    
                    // Kiểm tra format của response
                    if (Array.isArray(users)) {
                        availableWorkers = users.map(user => {
                            // Format: "Mã nhân viên - Tên nhân viên"
                            const name = `${user.ma_nhan_vien} - ${user.ten_nhan_vien}`;
                            return name;
                        }).filter(name => name && name.trim());
                    } else if (users.data && Array.isArray(users.data)) {
                        availableWorkers = users.data.map(user => `${user.ma_nhan_vien} - ${user.ten_nhan_vien}`).filter(name => name);
                    } else {
                        console.error('Unexpected API response format:', users);
                        availableWorkers = [];
                    }
                    
                    // Sau khi load workers, đề xuất user đăng nhập hiện tại
                    suggestCurrentUser();
                    
                    // Nếu dropdown đang mở, cập nhật lại options
                    if (workerDropdown.style.display === 'block') {
                        renderDropdownOptions(workerSearch.value);
                    }
                } else {
                    console.error('Failed to load workers from API, status:', response.status);
                    availableWorkers = [];
                }
            } catch (error) {
                console.error('Error loading workers:', error);
                availableWorkers = [];
            }
        }
        
        // Đề xuất user đăng nhập hiện tại
        function suggestCurrentUser() {
            
            if (typeof auth !== 'undefined') {
                const currentUser = auth.getUser();
                // console.log('👤 Current user:', currentUser);
                
                if (currentUser && currentUser.full_name) {

                    
                    // Tìm user trong danh sách available workers
                    const userWorkerName = availableWorkers.find(worker => 
                        worker.includes(currentUser.full_name) || 
                        worker.includes(currentUser.ma_nhan_vien)
                    );
                    
                    
                    if (userWorkerName && selectedWorkerList.length === 0) {
                        selectedWorkerList = [userWorkerName];
                        renderSelectedWorkers();
                        updateWorkerInput();
                
                    } else if (selectedWorkerList.length > 0) {
                    } else {
                    }
                } else {
                }
            } else {
            }
        }
        
        let selectedWorkerList = [];
        
        // Không load dữ liệu từ database, chỉ để trống để nhập mới
        
        // Render selected workers
        function renderSelectedWorkers() {
            selectedWorkers.innerHTML = '';
            selectedWorkerList.forEach(worker => {
                const tag = document.createElement('div');
                tag.className = 'selected-tag';
                tag.innerHTML = `
                    ${worker}
                    <button class="remove-btn" onclick="event.stopPropagation(); event.preventDefault(); removeWorker('${worker}')">×</button>
                `;
                selectedWorkers.appendChild(tag);
            });
        }
        
        // Render dropdown options
        function renderDropdownOptions(filter = '') {
            
            
            workerOptions.innerHTML = '';
            const filteredWorkers = availableWorkers.filter(worker => 
                worker.toLowerCase().includes(filter.toLowerCase()) &&
                !selectedWorkerList.includes(worker)
            );
            
            
            filteredWorkers.forEach(worker => {
                const item = document.createElement('div');
                item.className = 'dropdown-item';
                item.textContent = worker;
                item.onclick = (e) => {
                    e.stopPropagation();
                    e.preventDefault();
                    addWorker(worker);
                };
                workerOptions.appendChild(item);
            });
            
        }
        
        // Add worker
        window.addWorker = function(worker) {
            if (!selectedWorkerList.includes(worker)) {
                selectedWorkerList.push(worker);
                renderSelectedWorkers();
                renderDropdownOptions(workerSearch.value);
                updateWorkerInput();
            }
            // Không đóng dropdown ngay, để user có thể chọn thêm
            workerSearch.focus();
        };
        
        // Remove worker
        window.removeWorker = function(worker) {
            selectedWorkerList = selectedWorkerList.filter(w => w !== worker);
            renderSelectedWorkers();
            renderDropdownOptions(workerSearch.value);
            updateWorkerInput();
            // Focus lại vào search input sau khi xóa
            workerSearch.focus();
        };
        
        // Update hidden input for form submission
        function updateWorkerInput() {
            const workerInput = document.getElementById('worker');
            if (workerInput) {
                workerInput.value = selectedWorkerList.join(', ');
            }
        }
        
        // Event listeners
        workerSearch.addEventListener('focus', () => {
            workerDropdown.style.display = 'block';
            renderDropdownOptions();
        });
        
        // Ngăn chặn event propagation cho toàn bộ multi-select container
        const multiSelectContainer = document.querySelector('.multi-select-container');
        if (multiSelectContainer) {
            multiSelectContainer.addEventListener('click', (e) => {
                e.stopPropagation();
            });
        }
        
        workerSearch.addEventListener('input', (e) => {
            renderDropdownOptions(e.target.value);
        });
        
        // Ngăn chặn event propagation cho dropdown
        workerDropdown.addEventListener('click', (e) => {
            e.stopPropagation();
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', (e) => {
            // Chỉ đóng dropdown nếu click outside multi-select và không phải click vào dropdown item
            if (!e.target.closest('.multi-select-container') && !e.target.closest('.dropdown-item')) {
                workerDropdown.style.display = 'none';
            }
        });
        
        // Initialize
        loadWorkersFromAPI().then(() => {
            renderSelectedWorkers();
            updateWorkerInput();
        });
    }
    
    // handleLogout đã được định nghĩa ở trên
  </script>

  <!-- Details Panel - Will be generated dynamically -->
  <div class="details-panel" id="detailsPanel">
    <!-- Content will be generated by showOrderDetails() function -->
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Đang tải dữ liệu từ API...</div>
    </div>
  </div>

  <!-- Confirm Wait Modal (simple custom modal to avoid extra deps) -->
  <div id="confirmWaitModal" style="display:none; position: fixed; inset: 0; background: rgba(0,0,0,0.5); z-index: 10000; align-items: center; justify-content: center;">
    <div style="background:#fff; border-radius:12px; width: min(560px, 92vw); padding:18px; box-shadow: 0 20px 40px rgba(0,0,0,.35); transform: translateZ(0);">
      <div class="d-flex align-items-center mb-2">
        <i class="bi bi-shield-check text-primary me-2"></i>
        <h5 class="mb-0">Chờ xác nhận bàn giao</h5>
        <button class="btn btn-sm btn-outline-secondary ms-auto" onclick="closeConfirmWaitModal()">Đóng</button>
      </div>
      <div id="confirmWaitBody" class="small"></div>
      <div class="mt-3 text-muted" style="font-size: 12px;">
        Vui lòng giữ nguyên màn hình này cho đến khi được phê duyệt hoặc từ chối.
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
