<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Qu·∫£n l√Ω ti·∫øn ƒë·ªô - Carton Manager</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .progress-board {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
      gap: 20px;
      margin-top: 20px;
    }
    
    .stage-column {
      background: white;
      border-radius: 8px;
      border: 1px solid var(--border);
      min-height: 400px;
    }
    
    .stage-header {
      padding: 16px;
      background: var(--light);
      border-bottom: 1px solid var(--border);
      border-radius: 8px 8px 0 0;
    }
    
    .stage-header h3 {
      margin: 0;
      color: var(--primary);
      font-size: 16px;
      font-weight: 600;
    }
    
    .stage-header .count {
      background: var(--primary);
      color: white;
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 12px;
      margin-left: 8px;
    }
    
    .stage-content {
      padding: 16px;
      min-height: 300px;
    }
    
    .stage-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 16px;
      font-size: 14px;
    }
    
    .stage-table th,
    .stage-table td {
      border: 1px solid var(--border);
      padding: 8px 12px;
      text-align: left;
    }
    
    .stage-table th {
      background: var(--light);
      font-weight: 600;
      color: var(--dark);
    }
    
    .stage-table tr:nth-child(even) {
      background: #fafafa;
    }
    
    .stage-table tr:hover {
      background: #f0f9ff;
    }
    
    .quantity-input {
      width: 80px;
      padding: 4px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      text-align: center;
    }
    
    .quantity-display {
      font-weight: 600;
      color: var(--primary);
    }
    
    .stage-summary {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 16px;
      padding: 12px;
      background: var(--light);
      border-radius: 6px;
      font-size: 14px;
    }
    
    .summary-item {
      text-align: center;
    }
    
    .summary-value {
      font-size: 18px;
      font-weight: 700;
      color: var(--primary);
    }
    
    .summary-label {
      font-size: 12px;
      color: var(--gray);
      margin-top: 4px;
    }
    
    .order-card {
      background: white;
      border: 1px solid var(--border);
      border-radius: 6px;
      padding: 12px;
      margin-bottom: 12px;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    
    .order-card:hover {
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
      transform: translateY(-2px);
    }
    
    .order-card .order-id {
      font-weight: 600;
      color: var(--primary);
      font-size: 14px;
    }
    
    .order-card .order-name {
      color: var(--dark);
      margin: 4px 0;
    }
    
    .order-card .order-qty {
      color: var(--gray);
      font-size: 12px;
    }
    
    .order-card .order-time {
      color: var(--gray);
      font-size: 11px;
      margin-top: 8px;
    }
    
    .order-card .actions {
      margin-top: 8px;
      display: flex;
      gap: 8px;
    }
    
    .empty-stage {
      text-align: center;
      color: var(--gray);
      padding: 40px 20px;
      font-style: italic;
    }
    
    .stage-actions {
      margin-top: 16px;
      padding-top: 16px;
      border-top: 1px solid var(--border);
    }
    
    .status-badge {
      padding: 2px 8px;
      border-radius: 12px;
      font-size: 11px;
      font-weight: 500;
    }
    
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-doing { background: #dbeafe; color: #1e40af; }
    .status-done { background: #dcfce7; color: #166534; }
    .status-error { background: #fee2e2; color: #991b1b; }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="logo">
      <img src="images/logo.svg" alt="Logo" style="height:32px;margin-right:10px;"> Carton Manager
    </div>
    <nav>
      <ul>
        <li><a href="dashboard.html">Dashboard</a></li>
        <li><a href="orders.html">L·ªánh s·∫£n xu·∫•t</a></li>
        <li><a href="progress.html" class="active">Ti·∫øn ƒë·ªô</a></li>
        <li><a href="materials.html">V·∫≠t t∆∞</a></li>
        <li><a href="workflow.html">C√¥ng ƒëo·∫°n</a></li>
        <li><a href="reports.html">B√°o c√°o</a></li>
      </ul>
    </nav>
    <div style="padding:16px 24px 0 24px; font-size:13px; color:#cbd5e1;">¬© 2025 Carton Manager</div>
  </div>
  
  <div class="main">
    <header style="display:flex;justify-content:space-between;align-items:center;margin-bottom:24px;">
      <div>
        <h1>Qu·∫£n l√Ω ti·∫øn ƒë·ªô s·∫£n xu·∫•t</h1>
        <p style="color:var(--gray);margin:0;">Theo d√µi l·ªánh s·∫£n xu·∫•t theo t·ª´ng c√¥ng ƒëo·∫°n</p>
      </div>
      <div>
        <button class="btn btn-primary" onclick="refreshProgress()">üîÑ L√†m m·ªõi</button>
        <a href="orders.html" class="btn btn-secondary">üìã L·ªánh s·∫£n xu·∫•t</a>
      </div>
    </header>
    
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2>B·∫£ng ti·∫øn ƒë·ªô theo c√¥ng ƒëo·∫°n</h2>
        <div style="display:flex;gap:8px;align-items:center;">
          <span style="font-size:12px;color:var(--gray);">Ch√∫ th√≠ch:</span>
          <span class="status-badge status-pending">Ch∆∞a l√†m</span>
          <span class="status-badge status-doing">ƒêang l√†m</span>
          <span class="status-badge status-done">Ho√†n th√†nh</span>
          <span class="status-badge status-error">L·ªói</span>
        </div>
      </div>
      
      <div class="progress-board" id="progressBoard">
        <!-- C√°c c·ªôt c√¥ng ƒëo·∫°n s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    let workflow = [];
    let orders = [];
    let progressData = {};
    let inventoryData = {};
    
    // Kh·ªüi t·∫°o d·ªØ li·ªáu
    function initData() {
      workflow = App.load('workflow', [
        {name:'X·∫¢', desc:'X·∫£ gi·∫•y cu·ªôn'},
        {name:'X√âN', desc:'X√©n gi·∫•y'},
        {name:'IN OFFSET', desc:'In offset'},
        {name:'B·ªíI', desc:'B·ªìi gi·∫•y'},
        {name:'B·∫æ', desc:'B·∫ø h·ªôp'},
        {name:'D√ÅN M√ÅY', desc:'D√°n h·ªôp'},
        {name:'KHO TH√ÄNH PH·∫®M', desc:'L∆∞u kho'}
      ]);
      
      orders = App.load('orders', []);
      if (!orders || orders.length === 0) {
        orders = [
          {id:'LSX001', name:'H·ªôp carton A4', qty:1000, start:'2025-07-25', end:'2025-07-30', status:'done'},
          {id:'LSX002', name:'H·ªôp carton B5', qty:500, start:'2025-07-24', end:'2025-07-29', status:'inprogress'},
          {id:'LSX003', name:'H·ªôp carton C3', qty:2000, start:'2025-07-26', end:'2025-08-02', status:'inprogress'},
          {id:'LSX004', name:'H·ªôp carton D2', qty:800, start:'2025-07-27', end:'2025-08-05', status:'error'}
        ];
        App.save('orders', orders);
      }
      
      // L·∫•y ti·∫øn ƒë·ªô c·ªßa t·∫•t c·∫£ l·ªánh
      orders.forEach(order => {
        progressData[order.id] = App.load('progress_' + order.id, workflow.map((w,i)=>({
          step: i+1,
          name: w.name,
          status: 'pending',
          start: '',
          end: '',
          user: '',
          note: ''
        })));
      });
      
      // L·∫•y d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn
      inventoryData = App.load('inventory_data', {});
    }
    
    // X√°c ƒë·ªãnh l·ªánh ƒëang ·ªü c√¥ng ƒëo·∫°n n√†o
    function getCurrentStage(orderId) {
      const progress = progressData[orderId];
      if (!progress) return -1;
      
      // T√¨m c√¥ng ƒëo·∫°n cu·ªëi c√πng c√≥ tr·∫°ng th√°i 'done'
      for (let i = progress.length - 1; i >= 0; i--) {
        if (progress[i].status === 'done') {
          return i;
        }
      }
      
      // N·∫øu ch∆∞a c√≥ c√¥ng ƒëo·∫°n n√†o ho√†n th√†nh, tr·∫£ v·ªÅ c√¥ng ƒëo·∫°n ƒë·∫ßu ti√™n
      return 0;
    }
    
    // L·∫•y danh s√°ch l·ªánh ·ªü m·ªôt c√¥ng ƒëo·∫°n c·ª• th·ªÉ
    function getOrdersInStage(stageIndex) {
      return orders.filter(order => {
        const currentStage = getCurrentStage(order.id);
        return currentStage === stageIndex;
      });
    }
    
    // L·∫•y d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn cho m·ªôt l·ªánh ·ªü m·ªôt c√¥ng ƒëo·∫°n
    function getStageInventory(orderId, stageIndex) {
      const key = `${orderId}_${stageIndex}`;
      return inventoryData[key] || { in: 0, out: 0 };
    }
    
    // C·∫≠p nh·∫≠t d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn
    window.updateInventory = function(orderId, stageIndex, type, value) {
      const key = `${orderId}_${stageIndex}`;
      if (!inventoryData[key]) {
        inventoryData[key] = { in: 0, out: 0 };
      }
      
      inventoryData[key][type] = parseInt(value) || 0;
      App.save('inventory_data', inventoryData);
      
      // Ghi nh·∫≠t k√Ω
      const stageName = workflow[stageIndex].name;
      const action = type === 'in' ? 'Nh·∫≠p' : 'Xu·∫•t';
      addLog(orderId, `${action} h√†ng`, `${action} ${value} s·∫£n ph·∫©m ·ªü c√¥ng ƒëo·∫°n ${stageName}`);
      
      // L√†m m·ªõi b·∫£ng
      renderProgressBoard();
    };
    
    // Hi·ªÉn th·ªã b·∫£ng ti·∫øn ƒë·ªô
    function renderProgressBoard() {
      const board = document.getElementById('progressBoard');
      let html = '';
      
      workflow.forEach((stage, stageIndex) => {
        const ordersInStage = getOrdersInStage(stageIndex);
        
        html += `
          <div class="stage-column">
            <div class="stage-header">
              <h3>${stage.name} <span class="count">${ordersInStage.length}</span></h3>
              <div style="font-size:12px;color:var(--gray);margin-top:4px;">${stage.desc}</div>
            </div>
            <div class="stage-content">
        `;
        
        if (ordersInStage.length === 0) {
          html += '<div class="empty-stage">Ch∆∞a c√≥ l·ªánh n√†o</div>';
        } else {
          // B·∫£ng chi ti·∫øt c√¥ng ƒëo·∫°n
          html += `
            <table class="stage-table">
              <thead>
                <tr>
                  <th>M√£ l·ªánh</th>
                  <th>S·∫£n ph·∫©m</th>
                  <th>S·ªë l∆∞·ª£ng g·ªëc</th>
                  <th>ƒê√£ nh·∫≠p</th>
                  <th>ƒê√£ xu·∫•t</th>
                  <th>T·ªìn kho</th>
                  <th>Tr·∫°ng th√°i</th>
                  <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                  <th>Thao t√°c</th>
                </tr>
              </thead>
              <tbody>
          `;
          
          let totalOriginal = 0;
          let totalIn = 0;
          let totalOut = 0;
          let totalStock = 0;
          
          ordersInStage.forEach(order => {
            const progress = progressData[order.id];
            const currentProgress = progress[stageIndex];
            
            // L·∫•y d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn cho l·ªánh n√†y ·ªü c√¥ng ƒëo·∫°n n√†y
            const stageInventory = getStageInventory(order.id, stageIndex);
            
            totalOriginal += order.qty;
            totalIn += stageInventory.in || 0;
            totalOut += stageInventory.out || 0;
            totalStock += (stageInventory.in || 0) - (stageInventory.out || 0);
            
            html += `
              <tr>
                <td><strong>${order.id}</strong></td>
                <td>${order.name}</td>
                <td class="quantity-display">${order.qty}</td>
                <td>
                  <input type="number" class="quantity-input" value="${stageInventory.in || 0}" 
                         onchange="updateInventory('${order.id}', ${stageIndex}, 'in', this.value)">
                </td>
                <td>
                  <input type="number" class="quantity-input" value="${stageInventory.out || 0}" 
                         onchange="updateInventory('${order.id}', ${stageIndex}, 'out', this.value)">
                </td>
                <td class="quantity-display">${(stageInventory.in || 0) - (stageInventory.out || 0)}</td>
                <td>
                  <span class="status-badge status-${currentProgress.status}">
                    ${getStatusLabel(currentProgress.status)}
                  </span>
                </td>
                <td>${currentProgress.user || '-'}</td>
                <td>
                  <button class="btn btn-primary btn-sm" onclick="updateProgress('${order.id}', ${stageIndex})">
                    C·∫≠p nh·∫≠t
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="openOrderDetail('${order.id}')">
                    Chi ti·∫øt
                  </button>
                  ${stageIndex < workflow.length - 1 ? `
                    <button class="btn btn-success btn-sm" onclick="moveToNextStage('${order.id}', ${stageIndex})">
                      Xu·∫•t
                    </button>
                  ` : ''}
                </td>
              </tr>
            `;
          });
          
          html += `
              </tbody>
            </table>
            
            <div class="stage-summary">
              <div class="summary-item">
                <div class="summary-value">${totalOriginal}</div>
                <div class="summary-label">T·ªïng g·ªëc</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${totalIn}</div>
                <div class="summary-label">T·ªïng nh·∫≠p</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${totalOut}</div>
                <div class="summary-label">T·ªïng xu·∫•t</div>
              </div>
              <div class="summary-item">
                <div class="summary-value">${totalStock}</div>
                <div class="summary-label">T·ªïng t·ªìn</div>
              </div>
            </div>
          `;
        }
        
        html += `
            </div>
          </div>
        `;
      });
      
      board.innerHTML = html;
    }
    
    // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
    window.updateProgress = function(orderId, stageIndex) {
      const progress = progressData[orderId];
      const currentProgress = progress[stageIndex];
      
      const form = document.createElement('div');
      form.innerHTML = `
        <div style="position:fixed;top:0;left:0;right:0;bottom:0;background:rgba(0,0,0,0.5);display:flex;align-items:center;justify-content:center;z-index:1000;">
          <div style="background:white;padding:24px;border-radius:8px;max-width:500px;width:90%;">
            <h3>C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô - ${workflow[stageIndex].name}</h3>
            <form id="updateProgressForm">
              <div class="form-group">
                <label>Tr·∫°ng th√°i</label>
                <select name="status" required>
                  <option value="pending" ${currentProgress.status==='pending'?'selected':''}>Ch∆∞a l√†m</option>
                  <option value="doing" ${currentProgress.status==='doing'?'selected':''}>ƒêang l√†m</option>
                  <option value="done" ${currentProgress.status==='done'?'selected':''}>Ho√†n th√†nh</option>
                  <option value="error" ${currentProgress.status==='error'?'selected':''}>L·ªói</option>
                </select>
              </div>
              <div class="form-group">
                <label>Th·ªùi gian b·∫Øt ƒë·∫ßu</label>
                <input type="datetime-local" name="start" value="${currentProgress.start ? toInputDateTime(currentProgress.start) : ''}">
              </div>
              <div class="form-group">
                <label>Th·ªùi gian k·∫øt th√∫c</label>
                <input type="datetime-local" name="end" value="${currentProgress.end ? toInputDateTime(currentProgress.end) : ''}">
              </div>
              <div class="form-group">
                <label>Ng∆∞·ªùi th·ª±c hi·ªán</label>
                <input type="text" name="user" value="${currentProgress.user || ''}" placeholder="T√™n ng∆∞·ªùi th·ª±c hi·ªán">
              </div>
              <div class="form-group">
                <label>Ghi ch√∫</label>
                <textarea name="note" rows="3" placeholder="Ghi ch√∫...">${currentProgress.note || ''}</textarea>
              </div>
              <div class="form-actions">
                <button type="submit" class="btn btn-primary">L∆∞u</button>
                <button type="button" class="btn btn-secondary" onclick="this.closest('div[style*=\"position:fixed\"]').remove()">H·ªßy</button>
              </div>
            </form>
          </div>
        </div>
      `;
      
      document.body.appendChild(form);
      
      document.getElementById('updateProgressForm').onsubmit = function(e) {
        e.preventDefault();
        const f = new FormData(e.target);
        
        progress[stageIndex] = {
          ...progress[stageIndex],
          status: f.get('status'),
          start: f.get('start'),
          end: f.get('end'),
          user: f.get('user'),
          note: f.get('note')
        };
        
        App.save('progress_' + orderId, progress);
        progressData[orderId] = progress;
        
        // Ghi nh·∫≠t k√Ω
        addLog(orderId, 'C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô', `C·∫≠p nh·∫≠t c√¥ng ƒëo·∫°n ${workflow[stageIndex].name}`, f.get('user'));
        
        form.remove();
        renderProgressBoard();
      };
    };
    
    // Chuy·ªÉn sang c√¥ng ƒëo·∫°n ti·∫øp theo
    window.moveToNextStage = function(orderId, currentStageIndex) {
      if (currentStageIndex >= workflow.length - 1) {
        alert('ƒê√£ ·ªü c√¥ng ƒëo·∫°n cu·ªëi c√πng!');
        return;
      }
      
      const progress = progressData[orderId];
      const currentProgress = progress[currentStageIndex];
      
      if (currentProgress.status !== 'done') {
        alert('Ph·∫£i ho√†n th√†nh c√¥ng ƒëo·∫°n hi·ªán t·∫°i tr∆∞·ªõc khi chuy·ªÉn sang c√¥ng ƒëo·∫°n ti·∫øp theo!');
        return;
      }
      
      // L·∫•y s·ªë l∆∞·ª£ng t·ªìn kho hi·ªán t·∫°i
      const currentInventory = getStageInventory(orderId, currentStageIndex);
      const stockQuantity = (currentInventory.in || 0) - (currentInventory.out || 0);
      
      if (stockQuantity <= 0) {
        alert('Kh√¥ng c√≥ h√†ng t·ªìn kho ƒë·ªÉ chuy·ªÉn sang c√¥ng ƒëo·∫°n ti·∫øp theo!');
        return;
      }
      
      // T·ª± ƒë·ªông xu·∫•t h√†ng t·ª´ c√¥ng ƒëo·∫°n hi·ªán t·∫°i
      const newOutValue = (currentInventory.out || 0) + stockQuantity;
      updateInventory(orderId, currentStageIndex, 'out', newOutValue);
      
      // T·ª± ƒë·ªông nh·∫≠p h√†ng v√†o c√¥ng ƒëo·∫°n ti·∫øp theo
      const nextStageIndex = currentStageIndex + 1;
      const nextInventory = getStageInventory(orderId, nextStageIndex);
      const newInValue = (nextInventory.in || 0) + stockQuantity;
      updateInventory(orderId, nextStageIndex, 'in', newInValue);
      
      // T·ª± ƒë·ªông b·∫Øt ƒë·∫ßu c√¥ng ƒëo·∫°n ti·∫øp theo
      progress[nextStageIndex] = {
        ...progress[nextStageIndex],
        status: 'doing',
        start: new Date().toISOString().slice(0, 16),
        user: currentProgress.user || '',
        note: `T·ª± ƒë·ªông chuy·ªÉn ${stockQuantity} s·∫£n ph·∫©m t·ª´ c√¥ng ƒëo·∫°n tr∆∞·ªõc`
      };
      
      App.save('progress_' + orderId, progress);
      progressData[orderId] = progress;
      
      // Ghi nh·∫≠t k√Ω
      addLog(orderId, 'Chuy·ªÉn c√¥ng ƒëo·∫°n', `Chuy·ªÉn ${stockQuantity} s·∫£n ph·∫©m t·ª´ ${workflow[currentStageIndex].name} sang ${workflow[nextStageIndex].name}`, currentProgress.user);
      
      renderProgressBoard();
    };
    
    // M·ªü chi ti·∫øt l·ªánh
    window.openOrderDetail = function(orderId) {
      window.open(`order-detail.html?id=${orderId}`, '_blank');
    };
    
    // L√†m m·ªõi d·ªØ li·ªáu
    window.refreshProgress = function() {
      initData();
      renderProgressBoard();
    };
    
    // C√°c h√†m ti·ªán √≠ch
    function getStatusLabel(status) {
      switch(status) {
        case 'done': return 'Ho√†n th√†nh';
        case 'doing': return 'ƒêang l√†m';
        case 'error': return 'L·ªói';
        default: return 'Ch∆∞a l√†m';
      }
    }
    
    function formatDate(dateStr) {
      return App.formatDate(dateStr);
    }
    
    function toInputDateTime(str) {
      if(!str) return '';
      const d = new Date(str);
      return d.toISOString().slice(0,16);
    }
    
    function addLog(orderId, action, details, user = '') {
      let logs = App.load('logs_' + orderId, []);
      logs.unshift({
        action: action,
        details: details,
        user: user,
        timestamp: new Date().toISOString()
      });
      
      if(logs.length > 100) {
        logs = logs.slice(0, 100);
      }
      
      App.save('logs_' + orderId, logs);
    }
    
    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', function() {
      initData();
      renderProgressBoard();
    });
  </script>
</body>
</html> 