<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test B√†n Giao X·∫¢ ‚Üí X√âN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .order-card { border: 1px solid #ddd; margin: 10px 0; padding: 15px; border-radius: 8px; }
        .completed { background-color: #e8f5e8; }
        .pending { background-color: #fff8e1; }
        .stage-badge { padding: 4px 8px; border-radius: 4px; font-size: 0.85em; }
        .stage-xa { background-color: #e3f2fd; color: #1976d2; }
        .stage-xen { background-color: #f3e5f5; color: #7b1fa2; }
        .quantity-info { display: flex; gap: 15px; margin: 10px 0; }
        .quantity-item { text-align: center; }
        .quantity-number { font-size: 1.2em; font-weight: bold; }
        .quantity-label { font-size: 0.9em; color: #666; }
    </style>
</head>
<body>
    <div class="container-fluid">
        <h1><i class="bi bi-arrow-right-circle"></i> Test B√†n Giao: X·∫¢ ‚Üí X√âN</h1>
        
        <div class="row">
            <!-- C·ªôt tr√°i: Danh s√°ch l·ªánh X·∫¢ -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-primary text-white">
                        <h5><i class="bi bi-scissors"></i> C√¥ng ƒëo·∫°n X·∫¢</h5>
                        <small>Danh s√°ch l·ªánh ƒëang ch·ªù x·ª≠ l√Ω</small>
                    </div>
                    <div class="card-body" id="xaOrders">
                        <div class="text-center">
                            <div class="spinner-border" role="status">
                                <span class="visually-hidden">ƒêang t·∫£i...</span>
                            </div>
                            <p>ƒêang t·∫£i d·ªØ li·ªáu...</p>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- C·ªôt ph·∫£i: L·ªãch s·ª≠ b√†n giao -->
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header bg-success text-white">
                        <h5><i class="bi bi-check-circle"></i> L·ªãch s·ª≠ b√†n giao</h5>
                        <small>C√°c l·ªánh ƒë√£ ƒë∆∞·ª£c b√†n giao sang X√âN</small>
                    </div>
                    <div class="card-body" id="handoverHistory">
                        <p class="text-muted">Ch∆∞a c√≥ l·ªánh n√†o ƒë∆∞·ª£c b√†n giao h√¥m nay</p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Th·ªëng k√™ -->
        <div class="row mt-4">
            <div class="col-md-12">
                <div class="card">
                    <div class="card-header">
                        <h6><i class="bi bi-graph-up"></i> Th·ªëng k√™ h√¥m nay</h6>
                    </div>
                    <div class="card-body">
                        <div class="row text-center">
                            <div class="col-md-3">
                                <div class="quantity-item">
                                    <div class="quantity-number text-primary" id="totalOrders">0</div>
                                    <div class="quantity-label">T·ªïng l·ªánh</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quantity-item">
                                    <div class="quantity-number text-warning" id="pendingOrders">0</div>
                                    <div class="quantity-label">Ch·ªù x·ª≠ l√Ω</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quantity-item">
                                    <div class="quantity-number text-success" id="completedOrders">0</div>
                                    <div class="quantity-label">ƒê√£ ho√†n th√†nh</div>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="quantity-item">
                                    <div class="quantity-number text-info" id="handedOverOrders">0</div>
                                    <div class="quantity-label">ƒê√£ b√†n giao</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal B√†n giao -->
    <div class="modal fade" id="handoverModal" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header bg-warning">
                    <h5 class="modal-title"><i class="bi bi-arrow-right"></i> B√†n giao t·ª´ X·∫¢ sang X√âN</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>L·ªánh s·∫£n xu·∫•t:</strong> <span id="modalOrderCode"></span><br>
                        <strong>S·∫£n ph·∫©m:</strong> <span id="modalProductName"></span><br>
                        <strong>S·ªë l∆∞·ª£ng ho√†n th√†nh:</strong> <span id="modalCompletedQty"></span>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">S·ªë l∆∞·ª£ng b√†n giao:</label>
                        <input type="number" class="form-control" id="handoverQuantity" min="1">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ng∆∞·ªùi b√†n giao:</label>
                        <input type="text" class="form-control" id="handoverPerson" placeholder="T√™n ng∆∞·ªùi b√†n giao">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ng∆∞·ªùi nh·∫≠n (X√âN):</label>
                        <input type="text" class="form-control" id="receiverPerson" placeholder="T√™n ng∆∞·ªùi nh·∫≠n">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫:</label>
                        <textarea class="form-control" id="handoverNotes" rows="2" placeholder="Ghi ch√∫ v·ªÅ ch·∫•t l∆∞·ª£ng, l∆∞u √Ω ƒë·∫∑c bi·ªát..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-warning" onclick="executeHandover()">
                        <i class="bi bi-check"></i> X√°c nh·∫≠n b√†n giao
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal Ho√†n th√†nh v√† B√†n giao -->
    <div class="modal fade" id="completeHandoverModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header bg-success text-white">
                    <h5 class="modal-title"><i class="bi bi-check-all"></i> Ho√†n th√†nh X·∫¢ v√† B√†n giao sang X√âN</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <strong>L·ªánh s·∫£n xu·∫•t:</strong> <span id="completeModalOrderCode"></span><br>
                        <strong>S·∫£n ph·∫©m:</strong> <span id="completeModalProductName"></span><br>
                        <strong>S·ªë l∆∞·ª£ng ƒë·∫ßu v√†o:</strong> <span id="completeModalInputQty"></span>
                    </div>
                    <hr>
                    
                    <h6>üìä K·∫øt qu·∫£ c√¥ng ƒëo·∫°n X·∫¢:</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">S·ªë l∆∞·ª£ng ƒë·∫°t (OK):</label>
                            <input type="number" class="form-control" id="completeGoodQty" min="0" oninput="updateHandoverQty()">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">S·ªë l∆∞·ª£ng l·ªói (NG):</label>
                            <input type="number" class="form-control" id="completeNgQty" min="0">
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">Th·ª£ th·ª±c hi·ªán:</label>
                            <input type="text" class="form-control" id="completeWorker" placeholder="T√™n th·ª£">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">M√°y s·ª≠ d·ª•ng:</label>
                            <select class="form-control" id="completeMachine">
                                <option value="X·∫£ 1">X·∫£ 1</option>
                                <option value="X·∫£ 2">X·∫£ 2</option>
                                <option value="X·∫£ 3">X·∫£ 3</option>
                            </select>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫ X·∫¢:</label>
                        <textarea class="form-control" id="completeNotes" rows="2"></textarea>
                    </div>
                    
                    <hr>
                    <h6>üîÑ B√†n giao sang X√âN:</h6>
                    <div class="row mb-3">
                        <div class="col-md-6">
                            <label class="form-label">S·ªë l∆∞·ª£ng b√†n giao:</label>
                            <input type="number" class="form-control" id="completeHandoverQty" min="0">
                        </div>
                        <div class="col-md-6">
                            <label class="form-label">Ng∆∞·ªùi nh·∫≠n (X√âN):</label>
                            <input type="text" class="form-control" id="completeReceiverPerson" placeholder="T√™n ng∆∞·ªùi nh·∫≠n">
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Ghi ch√∫ b√†n giao:</label>
                        <textarea class="form-control" id="completeHandoverNotes" rows="2" placeholder="Ghi ch√∫ v·ªÅ ch·∫•t l∆∞·ª£ng, y√™u c·∫ßu ƒë·∫∑c bi·ªát..."></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
                    <button type="button" class="btn btn-success" onclick="executeCompleteAndHandover()">
                        <i class="bi bi-check-all"></i> Ho√†n th√†nh v√† B√†n giao
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="simple-production-api.js"></script>
    
    <script>
        let ordersData = [];
        let handoverHistory = [];
        let currentOrder = null;

        // Kh·ªüi t·∫°o trang
        document.addEventListener('DOMContentLoaded', function() {
            loadData();
        });

        // Load d·ªØ li·ªáu
        async function loadData() {
            try {
                // Load orders t·ª´ c√¥ng ƒëo·∫°n X·∫¢
                ordersData = await window.SimpleAPI.getOrdersByStage('xa');
                
                // Render giao di·ªán
                renderXaOrders();
                updateStatistics();
                
                console.log('Data loaded successfully:', ordersData.length, 'orders');
                
            } catch (error) {
                console.error('Error loading data:', error);
                window.SimpleAPI.showNotification('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            }
        }

        // Render danh s√°ch l·ªánh X·∫¢
        function renderXaOrders() {
            const container = document.getElementById('xaOrders');
            
            if (ordersData.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªánh n√†o ƒëang ch·ªù x·ª≠ l√Ω</p>';
                return;
            }
            
            container.innerHTML = ordersData.map(order => {
                const status = order.xa_status || 'waiting';
                const isCompleted = status === 'completed';
                const goodQty = order.xa_good_quantity || 0;
                const inputQty = order.xa_input_quantity || 0;
                const progress = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
                
                return `
                    <div class="order-card ${isCompleted ? 'completed' : 'pending'}">
                        <div class="d-flex justify-content-between align-items-start">
                            <div class="flex-grow-1">
                                <h6 class="mb-1">
                                    <strong>${order.production_order || order.order_code}</strong>
                                    <span class="stage-badge stage-xa">X·∫¢</span>
                                </h6>
                                <p class="mb-2 text-truncate">${order.product_name}</p>
                                <small class="text-muted">Kh√°ch h√†ng: ${order.customer_name}</small>
                                
                                <div class="quantity-info">
                                    <div class="quantity-item">
                                        <div class="quantity-number">${window.SimpleAPI.formatNumber(inputQty)}</div>
                                        <div class="quantity-label">K·∫ø ho·∫°ch</div>
                                    </div>
                                    <div class="quantity-item">
                                        <div class="quantity-number text-success">${window.SimpleAPI.formatNumber(goodQty)}</div>
                                        <div class="quantity-label">ƒê√£ ho√†n th√†nh</div>
                                    </div>
                                    <div class="quantity-item">
                                        <div class="quantity-number text-danger">${window.SimpleAPI.formatNumber(order.xa_ng_quantity || 0)}</div>
                                        <div class="quantity-label">NG</div>
                                    </div>
                                </div>
                                
                                ${goodQty > 0 ? `
                                    <div class="progress mb-2" style="height: 6px;">
                                        <div class="progress-bar bg-success" style="width: ${progress}%"></div>
                                    </div>
                                    <small class="text-muted">Ti·∫øn ƒë·ªô: ${progress}%</small>
                                ` : ''}
                            </div>
                            
                            <div class="text-end">
                                ${isCompleted && goodQty > 0 ? `
                                    <button class="btn btn-warning btn-sm mb-1" onclick="showHandoverModal(${order.id})">
                                        <i class="bi bi-arrow-right"></i> B√†n giao
                                    </button>
                                ` : `
                                    <button class="btn btn-success btn-sm mb-1" onclick="showCompleteHandoverModal(${order.id})">
                                        <i class="bi bi-check-all"></i> Ho√†n th√†nh & B√†n giao
                                    </button>
                                `}
                                <br>
                                <small class="text-muted">${getStatusText(status)}</small>
                            </div>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Hi·ªÉn th·ªã modal b√†n giao ƒë∆°n gi·∫£n
        function showHandoverModal(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            currentOrder = order;
            
            document.getElementById('modalOrderCode').textContent = order.production_order || order.order_code;
            document.getElementById('modalProductName').textContent = order.product_name;
            document.getElementById('modalCompletedQty').textContent = window.SimpleAPI.formatNumber(order.xa_good_quantity);
            document.getElementById('handoverQuantity').value = order.xa_good_quantity;
            document.getElementById('handoverPerson').value = order.xa_worker_name || '';
            
            const modal = new bootstrap.Modal(document.getElementById('handoverModal'));
            modal.show();
        }

        // Hi·ªÉn th·ªã modal ho√†n th√†nh v√† b√†n giao
        function showCompleteHandoverModal(orderId) {
            const order = ordersData.find(o => o.id === orderId);
            if (!order) return;
            
            currentOrder = order;
            
            document.getElementById('completeModalOrderCode').textContent = order.production_order || order.order_code;
            document.getElementById('completeModalProductName').textContent = order.product_name;
            document.getElementById('completeModalInputQty').textContent = window.SimpleAPI.formatNumber(order.xa_input_quantity);
            document.getElementById('completeGoodQty').value = order.xa_good_quantity || 0;
            document.getElementById('completeNgQty').value = order.xa_ng_quantity || 0;
            document.getElementById('completeWorker').value = order.xa_worker_name || '';
            document.getElementById('completeMachine').value = order.xa_machine_name || 'X·∫£ 1';
            document.getElementById('completeNotes').value = order.xa_note || '';
            document.getElementById('completeHandoverQty').value = order.xa_good_quantity || 0;
            
            const modal = new bootstrap.Modal(document.getElementById('completeHandoverModal'));
            modal.show();
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√†n giao khi thay ƒë·ªïi s·ªë l∆∞·ª£ng OK
        function updateHandoverQty() {
            const goodQty = parseInt(document.getElementById('completeGoodQty').value) || 0;
            document.getElementById('completeHandoverQty').value = goodQty;
        }

        // Th·ª±c hi·ªán b√†n giao ƒë∆°n gi·∫£n
        async function executeHandover() {
            if (!currentOrder) return;
            
            const handoverQuantity = parseInt(document.getElementById('handoverQuantity').value);
            const handoverPerson = document.getElementById('handoverPerson').value;
            const receiverPerson = document.getElementById('receiverPerson').value;
            const notes = document.getElementById('handoverNotes').value;
            
            if (!handoverQuantity || handoverQuantity <= 0) {
                window.SimpleAPI.showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
                return;
            }
            
            try {
                window.SimpleAPI.showLoading();
                
                const result = await window.SimpleAPI.handoverXaToXen(
                    currentOrder.id,
                    handoverQuantity,
                    handoverPerson,
                    receiverPerson,
                    notes
                );
                
                // Th√™m v√†o l·ªãch s·ª≠
                handoverHistory.push({
                    order: currentOrder,
                    quantity: handoverQuantity,
                    time: new Date(),
                    person: handoverPerson,
                    receiver: receiverPerson
                });
                
                // ƒê√≥ng modal v√† refresh
                bootstrap.Modal.getInstance(document.getElementById('handoverModal')).hide();
                await loadData();
                
            } catch (error) {
                console.error('Error executing handover:', error);
                window.SimpleAPI.showNotification('L·ªói b√†n giao: ' + error.message, 'error');
            } finally {
                window.SimpleAPI.hideLoading();
            }
        }

        // Th·ª±c hi·ªán ho√†n th√†nh v√† b√†n giao
        async function executeCompleteAndHandover() {
            if (!currentOrder) return;
            
            const goodQty = parseInt(document.getElementById('completeGoodQty').value) || 0;
            const ngQty = parseInt(document.getElementById('completeNgQty').value) || 0;
            const worker = document.getElementById('completeWorker').value;
            const machine = document.getElementById('completeMachine').value;
            const notes = document.getElementById('completeNotes').value;
            const handoverQty = parseInt(document.getElementById('completeHandoverQty').value) || 0;
            const receiverPerson = document.getElementById('completeReceiverPerson').value;
            const handoverNotes = document.getElementById('completeHandoverNotes').value;
            
            if (goodQty + ngQty === 0) {
                window.SimpleAPI.showNotification('T·ªïng s·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0', 'error');
                return;
            }
            
            if (handoverQty <= 0) {
                window.SimpleAPI.showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
                return;
            }
            
            try {
                window.SimpleAPI.showLoading();
                
                const result = await window.SimpleAPI.completeXaAndHandoverToXen(currentOrder.id, {
                    outputQuantity: goodQty + ngQty,
                    goodQuantity: goodQty,
                    ngQuantity: ngQty,
                    workerName: worker,
                    notes: notes,
                    handoverQuantity: handoverQty,
                    handoverPerson: worker,
                    receiverPerson: receiverPerson,
                    handoverNotes: handoverNotes
                });
                
                // Th√™m v√†o l·ªãch s·ª≠
                handoverHistory.push({
                    order: currentOrder,
                    quantity: handoverQty,
                    time: new Date(),
                    person: worker,
                    receiver: receiverPerson,
                    completed: true
                });
                
                // ƒê√≥ng modal v√† refresh
                bootstrap.Modal.getInstance(document.getElementById('completeHandoverModal')).hide();
                await loadData();
                
            } catch (error) {
                console.error('Error executing complete and handover:', error);
                window.SimpleAPI.showNotification('L·ªói ho√†n th√†nh v√† b√†n giao: ' + error.message, 'error');
            } finally {
                window.SimpleAPI.hideLoading();
            }
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStatistics() {
            const total = ordersData.length;
            const pending = ordersData.filter(o => (o.xa_status || 'waiting') === 'waiting').length;
            const completed = ordersData.filter(o => (o.xa_status || 'waiting') === 'completed').length;
            const handedOver = handoverHistory.length;
            
            document.getElementById('totalOrders').textContent = total;
            document.getElementById('pendingOrders').textContent = pending;
            document.getElementById('completedOrders').textContent = completed;
            document.getElementById('handedOverOrders').textContent = handedOver;
        }

        // Utility functions
        function getStatusText(status) {
            const statusMap = {
                'waiting': 'Ch·ªù x·ª≠ l√Ω',
                'in_progress': 'ƒêang x·ª≠ l√Ω',
                'completed': 'Ho√†n th√†nh',
                'paused': 'T·∫°m d·ª´ng'
            };
            return statusMap[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
        }
        
        // L√†m m·ªõi d·ªØ li·ªáu
        window.refreshData = loadData;
    </script>
</body>
</html>
