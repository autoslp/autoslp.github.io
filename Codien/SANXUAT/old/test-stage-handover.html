<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test B√†n Giao T·ª± ƒê·ªông - Stage Handover</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stage-card {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            background: #f8f9fa;
        }
        .stage-active {
            background: #e3f2fd;
            border-color: #2196f3;
        }
        .stage-completed {
            background: #e8f5e8;
            border-color: #4caf50;
        }
        .stage-waiting {
            background: #fff3e0;
            border-color: #ff9800;
        }
        .quantity-input {
            width: 100px;
            display: inline-block;
        }
        .flow-arrow {
            text-align: center;
            font-size: 24px;
            color: #2196f3;
            margin: 10px 0;
        }
        .log-container {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">üîÑ Test B√†n Giao T·ª± ƒê·ªông Gi·ªØa C√°c C√¥ng ƒêo·∫°n</h1>
        
        <!-- Ch·ªçn ƒë∆°n h√†ng -->
        <div class="row mb-4">
            <div class="col-md-6">
                <label for="order-select">Ch·ªçn ƒë∆°n h√†ng:</label>
                <select id="order-select" class="form-select" onchange="loadOrderStages()">
                    <option value="">-- Ch·ªçn ƒë∆°n h√†ng --</option>
                </select>
            </div>
            <div class="col-md-6">
                <label>&nbsp;</label><br>
                <button onclick="loadOrders()" class="btn btn-info">T·∫£i danh s√°ch ƒë∆°n h√†ng</button>
                <button onclick="createTestOrder()" class="btn btn-success">T·∫°o ƒë∆°n h√†ng test</button>
            </div>
        </div>

        <!-- Th√¥ng tin ƒë∆°n h√†ng hi·ªán t·∫°i -->
        <div id="order-info" class="alert alert-info" style="display: none;">
            <h5>üìã Th√¥ng tin ƒë∆°n h√†ng</h5>
            <div id="order-details"></div>
        </div>

        <!-- Flow c√°c c√¥ng ƒëo·∫°n -->
        <div id="stages-flow" style="display: none;">
            <h3>üè≠ Workflow s·∫£n xu·∫•t (17 c√¥ng ƒëo·∫°n)</h3>
            <div id="stages-container"></div>
        </div>

        <!-- Form b√†n giao nhanh -->
        <div id="quick-handover-form" class="mt-4" style="display: none;">
            <div class="card">
                <div class="card-header">
                    <h5>‚ö° B√†n giao nhanh</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-3">
                            <input type="text" id="handover-person" class="form-control" placeholder="Ng∆∞·ªùi b√†n giao">
                        </div>
                        <div class="col-md-3">
                            <input type="text" id="receiver-person" class="form-control" placeholder="Ng∆∞·ªùi nh·∫≠n">
                        </div>
                        <div class="col-md-4">
                            <input type="text" id="handover-notes" class="form-control" placeholder="Ghi ch√∫ b√†n giao">
                        </div>
                        <div class="col-md-2">
                            <button onclick="performQuickHandover()" class="btn btn-primary w-100">B√†n giao nhanh</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- L·ªãch s·ª≠ b√†n giao -->
        <div id="handover-history" class="mt-4" style="display: none;">
            <h3>üìú L·ªãch s·ª≠ b√†n giao</h3>
            <div id="history-table"></div>
        </div>

        <!-- Console log -->
        <div class="mt-4">
            <h5>üìü Console Log</h5>
            <div id="log-console" class="log-container"></div>
            <button onclick="clearLog()" class="btn btn-secondary btn-sm mt-2">X√≥a log</button>
        </div>
    </div>

    <script src="stage-handover-api.js"></script>
    <script>
        // Kh·ªüi t·∫°o API v·ªõi base URL
        const api = new StageHandoverAPI('/api');
        
        let currentOrderId = null;
        let currentStages = {};
        
        // Stages mapping
        const stageNames = {
            'xa': 'X·∫¢',
            'xen': 'X√âN', 
            'in_offset': 'IN OFFSET',
            'xen_toa': 'X√âN TOA',
            'kcs_in': 'KCS IN',
            'kcs_sau_in': 'KCS SAU IN',
            'lang': 'L√ÅNG',
            'in_luoi': 'IN L∆Ø·ªöI',
            'boi': 'B·ªíI',
            'be': 'B·∫æ',
            'boc_le': 'B√ìC L·∫∫',
            'dan_3m': 'D√ÅN 3M-NILON',
            'dan_may': 'D√ÅN M√ÅY',
            'hoan_thien': 'HO√ÄN THI·ªÜN',
            'ghim': 'GHIM',
            'gap': 'G·∫§P',
            'nhap_kho': 'NH·∫¨P KHO'
        };

        // Utility functions
        function log(message, type = 'info') {
            const console = document.getElementById('log-console');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#0f0';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function clearLog() {
            document.getElementById('log-console').innerHTML = '';
        }

        // Load danh s√°ch ƒë∆°n h√†ng
        async function loadOrders() {
            try {
                log('üîÑ ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...');
                const response = await fetch('/api/production_orders');
                const data = await response.json();
                
                const select = document.getElementById('order-select');
                select.innerHTML = '<option value="">-- Ch·ªçn ƒë∆°n h√†ng --</option>';
                
                data.orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.production_order} - ${order.product_name}`;
                    select.appendChild(option);
                });
                
                log(`‚úÖ ƒê√£ t·∫£i ${data.orders.length} ƒë∆°n h√†ng`, 'success');
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i ƒë∆°n h√†ng: ${error.message}`, 'error');
            }
        }

        // T·∫°o ƒë∆°n h√†ng test
        async function createTestOrder() {
            try {
                log('üîÑ ƒêang t·∫°o ƒë∆°n h√†ng test...');
                
                const testOrder = {
                    production_order: `TEST-${Date.now()}`,
                    po_number: `PO-${Date.now()}`,
                    internal_product_code: `TEST-CODE-${Date.now()}`,
                    customer_code: 'TEST001',
                    customer_name: 'Kh√°ch h√†ng Test',
                    product_name: 'S·∫£n ph·∫©m Test B√†n Giao',
                    order_quantity: 1000,
                    required_quantity: 1000,
                    deployed_quantity: 1200,
                    current_stage: 'xa',
                    current_stage_index: 0,
                    xa_input_quantity: 1200,
                    xa_status: 'in_progress'
                };

                const response = await fetch('/api/production_orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testOrder)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ ƒê√£ t·∫°o ƒë∆°n h√†ng test ID: ${result.id}`, 'success');
                    loadOrders(); // Reload danh s√°ch
                } else {
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng test');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói t·∫°o ƒë∆°n h√†ng test: ${error.message}`, 'error');
            }
        }

        // Load th√¥ng tin stages c·ªßa ƒë∆°n h√†ng
        async function loadOrderStages() {
            const orderId = document.getElementById('order-select').value;
            if (!orderId) {
                document.getElementById('order-info').style.display = 'none';
                document.getElementById('stages-flow').style.display = 'none';
                document.getElementById('quick-handover-form').style.display = 'none';
                document.getElementById('handover-history').style.display = 'none';
                return;
            }

            currentOrderId = orderId;
            
            try {
                log(`üîÑ ƒêang t·∫£i chi ti·∫øt ƒë∆°n h√†ng ${orderId}...`);
                
                // Load stage details
                const stageData = await api.getStageDetails(orderId);
                currentStages = stageData.stages;
                
                // Load handover history
                const historyData = await api.getHandoverHistory(orderId);
                
                // Display order info
                displayOrderInfo(stageData);
                
                // Display stages flow
                displayStagesFlow(stageData);
                
                // Display handover history
                displayHandoverHistory(historyData.handover_history);
                
                // Show quick handover form
                document.getElementById('quick-handover-form').style.display = 'block';
                
                log(`‚úÖ ƒê√£ t·∫£i chi ti·∫øt ƒë∆°n h√†ng ${stageData.production_order}`, 'success');
                
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i chi ti·∫øt ƒë∆°n h√†ng: ${error.message}`, 'error');
            }
        }

        // Hi·ªÉn th·ªã th√¥ng tin ƒë∆°n h√†ng
        function displayOrderInfo(data) {
            const orderDetails = document.getElementById('order-details');
            orderDetails.innerHTML = `
                <strong>L·ªánh SX:</strong> ${data.production_order} |
                <strong>C√¥ng ƒëo·∫°n hi·ªán t·∫°i:</strong> ${stageNames[data.current_stage]} (${data.current_stage}) |
                <strong>Ch·ªâ s·ªë:</strong> ${data.current_stage_index}/16
            `;
            document.getElementById('order-info').style.display = 'block';
        }

        // Hi·ªÉn th·ªã flow c√°c c√¥ng ƒëo·∫°n
        function displayStagesFlow(data) {
            const container = document.getElementById('stages-container');
            container.innerHTML = '';
            
            const stages = Object.keys(stageNames);
            
            stages.forEach((stage, index) => {
                const stageData = data.stages[stage];
                const isActive = data.current_stage === stage;
                const isCompleted = stageData.status === 'completed';
                const isWaiting = stageData.status === 'waiting';
                
                let cardClass = 'stage-card';
                if (isActive) cardClass += ' stage-active';
                else if (isCompleted) cardClass += ' stage-completed';
                else if (isWaiting) cardClass += ' stage-waiting';
                
                const statusIcon = isCompleted ? '‚úÖ' : isActive ? 'üîÑ' : '‚è≥';
                
                container.innerHTML += `
                    <div class="${cardClass}">
                        <div class="row align-items-center">
                            <div class="col-md-2">
                                <strong>${statusIcon} ${stageNames[stage]}</strong>
                                <br><small>(${stage})</small>
                            </div>
                            <div class="col-md-2">
                                <label>Input:</label>
                                <input type="number" 
                                       class="form-control quantity-input" 
                                       value="${stageData.input_quantity}"
                                       onchange="updateStageQuantity('${stage}', 'input', this.value)"
                                       ${isCompleted ? 'readonly' : ''}>
                            </div>
                            <div class="col-md-2">
                                <label>Output:</label>
                                <input type="number" 
                                       class="form-control quantity-input" 
                                       value="${stageData.output_quantity}"
                                       onchange="updateStageQuantity('${stage}', 'output', this.value)"
                                       ${!isActive ? 'readonly' : ''}>
                            </div>
                            <div class="col-md-2">
                                <label>ƒê·∫°t:</label>
                                <input type="number" 
                                       class="form-control quantity-input" 
                                       value="${stageData.good_quantity}"
                                       onchange="updateStageQuantity('${stage}', 'good', this.value)"
                                       ${!isActive ? 'readonly' : ''}>
                            </div>
                            <div class="col-md-2">
                                <label>NG:</label>
                                <input type="number" 
                                       class="form-control quantity-input" 
                                       value="${stageData.ng_quantity}"
                                       onchange="updateStageQuantity('${stage}', 'ng', this.value)"
                                       ${!isActive ? 'readonly' : ''}>
                            </div>
                            <div class="col-md-2">
                                ${isActive ? `<button onclick="completeStage('${stage}')" class="btn btn-success btn-sm">Ho√†n th√†nh</button>` : ''}
                            </div>
                        </div>
                        <div class="row mt-2">
                            <div class="col-md-6">
                                <small><strong>Th·ªùi gian:</strong> ${stageData.start_time || 'Ch∆∞a b·∫Øt ƒë·∫ßu'} - ${stageData.end_time || 'Ch∆∞a k·∫øt th√∫c'}</small>
                            </div>
                            <div class="col-md-6">
                                <small><strong>Th·ª£:</strong> ${stageData.worker_name || 'Ch∆∞a ph√¢n c√¥ng'}</small>
                            </div>
                        </div>
                    </div>
                    ${index < stages.length - 1 ? '<div class="flow-arrow">‚¨áÔ∏è</div>' : ''}
                `;
            });
            
            document.getElementById('stages-flow').style.display = 'block';
        }

        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng stage
        async function updateStageQuantity(stage, type, value) {
            if (!currentOrderId) return;
            
            try {
                const updateData = {};
                updateData[`${stage}_${type}_quantity`] = parseInt(value) || 0;
                
                const response = await fetch(`/api/production_orders/${currentOrderId}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(updateData)
                });
                
                if (response.ok) {
                    log(`‚úÖ C·∫≠p nh·∫≠t ${stage}_${type}_quantity = ${value}`, 'success');
                    currentStages[stage][`${type}_quantity`] = parseInt(value) || 0;
                } else {
                    throw new Error('Kh√¥ng th·ªÉ c·∫≠p nh·∫≠t');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói c·∫≠p nh·∫≠t ${stage}_${type}_quantity: ${error.message}`, 'error');
            }
        }

        // Ho√†n th√†nh stage v√† b√†n giao
        async function completeStage(stage) {
            if (!currentOrderId) return;
            
            const stageData = currentStages[stage];
            const outputQty = stageData.output_quantity || 0;
            const goodQty = stageData.good_quantity || 0;
            const ngQty = stageData.ng_quantity || 0;
            
            if (outputQty <= 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng output > 0');
                return;
            }
            
            try {
                const handoverPerson = document.getElementById('handover-person').value.trim();
                const receiverPerson = document.getElementById('receiver-person').value.trim();
                const notes = document.getElementById('handover-notes').value.trim();
                
                log(`üîÑ ƒêang ho√†n th√†nh ${stage} v√† b√†n giao...`);
                
                await api.completeAndHandover(
                    currentOrderId, 
                    stage, 
                    outputQty, 
                    goodQty, 
                    ngQty, 
                    stageData.worker_name || 'Th·ª£ test',
                    handoverPerson || 'Ng∆∞·ªùi b√†n giao test',
                    receiverPerson || 'Ng∆∞·ªùi nh·∫≠n test',
                    notes || 'B√†n giao t·ª± ƒë·ªông'
                );
                
                log(`‚úÖ Ho√†n th√†nh ${stage} th√†nh c√¥ng!`, 'success');
                
                // Reload stages
                loadOrderStages();
                
            } catch (error) {
                log(`‚ùå L·ªói ho√†n th√†nh ${stage}: ${error.message}`, 'error');
            }
        }

        // B√†n giao nhanh tr·ª±c ti·∫øp v√†o c·ªôt input_quantity
        async function performQuickHandover() {
            if (!currentOrderId) {
                alert('Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
                return;
            }
            
            try {
                const stageData = await api.getStageDetails(currentOrderId);
                const currentStage = stageData.current_stage;
                
                const handoverPerson = document.getElementById('handover-person').value.trim();
                const receiverPerson = document.getElementById('receiver-person').value.trim();
                const notes = document.getElementById('handover-notes').value.trim();
                
                log(`üîÑ ƒêang th·ª±c hi·ªán b√†n giao nhanh t·ª´ ${currentStage}...`);
                
                const nextStage = api.getNextStage(currentStage);
                if (!nextStage) {
                    alert('ƒê√¢y l√† c√¥ng ƒëo·∫°n cu·ªëi c√πng');
                    return;
                }
                
                // L·∫•y output quantity c·ªßa stage hi·ªán t·∫°i
                const currentStageData = stageData.stages[currentStage];
                const outputQuantity = currentStageData.output_quantity;
                
                if (outputQuantity <= 0) {
                    alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng output cho stage hi·ªán t·∫°i tr∆∞·ªõc');
                    return;
                }
                
                // S·ª≠ d·ª•ng API m·ªõi - b√†n giao tr·ª±c ti·∫øp v√†o c·ªôt input
                await api.handoverToNextStage(
                    currentOrderId,
                    currentStage,
                    outputQuantity,
                    handoverPerson || 'Ng∆∞·ªùi b√†n giao test',
                    receiverPerson || 'Ng∆∞·ªùi nh·∫≠n test',
                    notes || 'B√†n giao nhanh tr·ª±c ti·∫øp'
                );
                
                log(`‚úÖ B√†n giao nhanh th√†nh c√¥ng: ${currentStage} ‚Üí ${nextStage}!`, 'success');
                log(`üìù ƒê√£ ghi ${outputQuantity} v√†o c·ªôt ${nextStage}_input_quantity`, 'success');
                
                // Reload stages
                loadOrderStages();
                
            } catch (error) {
                log(`‚ùå L·ªói b√†n giao nhanh: ${error.message}`, 'error');
            }
        }

        // Hi·ªÉn th·ªã l·ªãch s·ª≠ b√†n giao
        function displayHandoverHistory(history) {
            const container = document.getElementById('history-table');
            
            if (history.length === 0) {
                container.innerHTML = '<p class="text-muted">Ch∆∞a c√≥ l·ªãch s·ª≠ b√†n giao</p>';
            } else {
                let tableHTML = `
                    <table class="table table-striped table-sm">
                        <thead>
                            <tr>
                                <th>Th·ªùi gian</th>
                                <th>T·ª´</th>
                                <th>ƒê·∫øn</th>
                                <th>SL b√†n giao</th>
                                <th>SL nh·∫≠n</th>
                                <th>Ch√™nh l·ªách</th>
                                <th>Ng∆∞·ªùi b√†n giao</th>
                                <th>Ng∆∞·ªùi nh·∫≠n</th>
                                <th>Ghi ch√∫</th>
                            </tr>
                        </thead>
                        <tbody>
                `;
                
                history.forEach(h => {
                    const diffClass = h.quantity_difference === 0 ? 'text-success' : 'text-danger';
                    tableHTML += `
                        <tr>
                            <td>${new Date(h.handover_date).toLocaleString()}</td>
                            <td><span class="badge bg-primary">${stageNames[h.from_stage]}</span></td>
                            <td><span class="badge bg-success">${stageNames[h.to_stage]}</span></td>
                            <td>${h.quantity_handover}</td>
                            <td>${h.quantity_received}</td>
                            <td class="${diffClass}">${h.quantity_difference > 0 ? '+' : ''}${h.quantity_difference}</td>
                            <td>${h.handover_person}</td>
                            <td>${h.receiver_person}</td>
                            <td>${h.notes}</td>
                        </tr>
                    `;
                });
                
                tableHTML += '</tbody></table>';
                container.innerHTML = tableHTML;
            }
            
            document.getElementById('handover-history').style.display = 'block';
        }

        // Load danh s√°ch ƒë∆°n h√†ng khi trang load
        window.onload = function() {
            log('üöÄ Kh·ªüi t·∫°o Test B√†n Giao T·ª± ƒê·ªông');
            loadOrders();
        };
    </script>
</body>
</html>
