<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test H·ªá th·ªëng M√°y ƒê∆°n gi·∫£n</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.7.2/font/bootstrap-icons.css" rel="stylesheet">
    <style>
        .machine-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .machine-available {
            background-color: #d4edda;
            border-color: #c3e6cb;
        }
        .machine-busy {
            background-color: #f8d7da;
            border-color: #f5c6cb;
        }
        .order-item {
            border: 1px solid #ddd;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 10px;
        }
        .order-running {
            background-color: #fff3cd;
            border-color: #ffeaa7;
        }
        .order-completed {
            background-color: #d1ecf1;
            border-color: #bee5eb;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center mb-4">üß™ Test H·ªá th·ªëng M√°y ƒê∆°n gi·∫£n</h1>
        
        <!-- Th√¥ng b√°o -->
        <div id="notification" class="alert" style="display: none;"></div>
        
        <!-- B·∫£ng ƒëi·ªÅu khi·ªÉn -->
        <div class="row mb-4">
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üéõÔ∏è ƒêi·ªÅu khi·ªÉn</h5>
                    </div>
                    <div class="card-body">
                        <button class="btn btn-primary" onclick="loadMachineStatus()">
                            <i class="bi bi-arrow-clockwise"></i> Refresh Tr·∫°ng th√°i M√°y
                        </button>
                        <button class="btn btn-success" onclick="loadAvailableMachines()">
                            <i class="bi bi-list-check"></i> Xem M√°y R·∫£nh
                        </button>
                        <button class="btn btn-info" onclick="loadOrders()">
                            <i class="bi bi-list-ul"></i> Xem L·ªánh S·∫£n xu·∫•t
                        </button>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="card">
                    <div class="card-header">
                        <h5>üìä Th·ªëng k√™</h5>
                    </div>
                    <div class="card-body">
                        <div id="stats">
                            <p>M√°y r·∫£nh: <span id="available-count">-</span></p>
                            <p>M√°y b·∫≠n: <span id="busy-count">-</span></p>
                            <p>L·ªánh ƒëang ch·∫°y: <span id="running-count">-</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Tr·∫°ng th√°i m√°y -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üè≠ Tr·∫°ng th√°i M√°y</h5>
                    </div>
                    <div class="card-body">
                        <div id="machine-status"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- L·ªánh s·∫£n xu·∫•t -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üìã L·ªánh S·∫£n xu·∫•t</h5>
                    </div>
                    <div class="card-body">
                        <div id="orders-list"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Test Actions -->
        <div class="row mb-4">
            <div class="col-12">
                <div class="card">
                    <div class="card-header">
                        <h5>üß™ Test Actions</h5>
                    </div>
                    <div class="card-body">
                        <div class="row">
                            <div class="col-md-6">
                                <h6>B·∫Øt ƒë·∫ßu l·ªánh:</h6>
                                <div class="mb-3">
                                    <label class="form-label">M√°y:</label>
                                    <select id="test-machine" class="form-select">
                                        <option value="">Ch·ªçn m√°y...</option>
                                    </select>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">L·ªánh:</label>
                                    <select id="test-order" class="form-select">
                                        <option value="">Ch·ªçn l·ªánh...</option>
                                    </select>
                                </div>
                                <button class="btn btn-success" onclick="testStartOrder()">
                                    <i class="bi bi-play-circle"></i> B·∫Øt ƒë·∫ßu
                                </button>
                            </div>
                            <div class="col-md-6">
                                <h6>K·∫øt th√∫c l·ªánh:</h6>
                                <div class="mb-3">
                                    <label class="form-label">M√°y ƒëang ch·∫°y:</label>
                                    <select id="test-busy-machine" class="form-select">
                                        <option value="">Ch·ªçn m√°y...</option>
                                    </select>
                                </div>
                                <button class="btn btn-danger" onclick="testEndOrder()">
                                    <i class="bi bi-stop-circle"></i> K·∫øt th√∫c
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="api-config.js"></script>
    <script src="simple-machine-ui.js"></script>
    <script>
        // Kh·ªüi t·∫°o
        document.addEventListener('DOMContentLoaded', function() {
            initializeSimpleMachine();
            loadMachineStatus();
            loadOrders();
        });

        // Hi·ªÉn th·ªã th√¥ng b√°o
        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            notification.className = `alert alert-${type}`;
            notification.textContent = message;
            notification.style.display = 'block';
            
            setTimeout(() => {
                notification.style.display = 'none';
            }, 3000);
        }

        // Load tr·∫°ng th√°i m√°y
        async function loadMachineStatus() {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.MACHINE_STATUS));
                const data = await response.json();
                
                if (response.ok) {
                    displayMachineStatus(data.machines);
                    updateStats(data.machines);
                } else {
                    showNotification(`‚ùå ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error loading machine status:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server', 'danger');
            }
        }

        // Hi·ªÉn th·ªã tr·∫°ng th√°i m√°y
        function displayMachineStatus(machines) {
            const container = document.getElementById('machine-status');
            
            if (machines.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ m√°y n√†o</p>';
                return;
            }

            const html = machines.map(machine => `
                <div class="machine-item ${machine.status === 'available' ? 'machine-available' : 'machine-busy'}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${machine.machine_name}</h6>
                            <small class="text-muted">ID: ${machine.machine_id}</small>
                            <br>
                            <span class="badge ${machine.status === 'available' ? 'bg-success' : 'bg-warning'}">
                                ${machine.status === 'available' ? 'R·∫£nh' : 'B·∫≠n'}
                            </span>
                        </div>
                        <div class="text-end">
                            ${machine.current_order_code ? `
                                <small class="text-muted">ƒêang ch·∫°y:</small><br>
                                <strong>${machine.current_order_code}</strong>
                            ` : '<small class="text-muted">Kh√¥ng c√≥ l·ªánh</small>'}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // C·∫≠p nh·∫≠t th·ªëng k√™
        function updateStats(machines) {
            const availableCount = machines.filter(m => m.status === 'available').length;
            const busyCount = machines.filter(m => m.status === 'busy').length;
            const runningCount = machines.filter(m => m.current_order_id !== null).length;
            
            document.getElementById('available-count').textContent = availableCount;
            document.getElementById('busy-count').textContent = busyCount;
            document.getElementById('running-count').textContent = runningCount;
        }

        // Load m√°y r·∫£nh
        async function loadAvailableMachines() {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.AVAILABLE_MACHINES));
                const data = await response.json();
                
                if (response.ok) {
                    showNotification(`‚úÖ C√≥ ${data.available_machines.length} m√°y r·∫£nh`, 'success');
                    updateMachineSelect(data.available_machines);
                } else {
                    showNotification(`‚ùå ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error loading available machines:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server', 'danger');
            }
        }

        // C·∫≠p nh·∫≠t dropdown m√°y
        function updateMachineSelect(machines) {
            const select = document.getElementById('test-machine');
            select.innerHTML = '<option value="">Ch·ªçn m√°y...</option>';
            
            machines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.machine_id;
                option.textContent = `${machine.machine_name} (${machine.machine_id})`;
                select.appendChild(option);
            });
        }

        // Load l·ªánh s·∫£n xu·∫•t
        async function loadOrders() {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.PRODUCTION_ORDERS));
                const data = await response.json();
                
                if (response.ok) {
                    displayOrders(data);
                    updateOrderSelect(data);
                } else {
                    showNotification(`‚ùå ${data.error}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error loading orders:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server', 'danger');
            }
        }

        // Hi·ªÉn th·ªã l·ªánh s·∫£n xu·∫•t
        function displayOrders(orders) {
            const container = document.getElementById('orders-list');
            
            if (orders.length === 0) {
                container.innerHTML = '<p class="text-muted">Kh√¥ng c√≥ l·ªánh s·∫£n xu·∫•t</p>';
                return;
            }

            const html = orders.slice(0, 10).map(order => `
                <div class="order-item ${order.xa_status === 'in_progress' ? 'order-running' : order.xa_status === 'completed' ? 'order-completed' : ''}">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6 class="mb-1">${order.production_order}</h6>
                            <small class="text-muted">ID: ${order.id}</small>
                            <br>
                            <span class="badge ${order.xa_status === 'completed' ? 'bg-success' : order.xa_status === 'in_progress' ? 'bg-warning' : 'bg-secondary'}">
                                ${order.xa_status || 'Ch∆∞a b·∫Øt ƒë·∫ßu'}
                            </span>
                        </div>
                        <div class="text-end">
                            ${order.xa_machine_id ? `
                                <small class="text-muted">M√°y:</small><br>
                                <strong>${order.xa_machine_id}</strong>
                            ` : '<small class="text-muted">Ch∆∞a g√°n m√°y</small>'}
                        </div>
                    </div>
                </div>
            `).join('');
            
            container.innerHTML = html;
        }

        // C·∫≠p nh·∫≠t dropdown l·ªánh
        function updateOrderSelect(orders) {
            const select = document.getElementById('test-order');
            select.innerHTML = '<option value="">Ch·ªçn l·ªánh...</option>';
            
            orders.filter(order => !order.xa_status || order.xa_status !== 'completed').forEach(order => {
                const option = document.createElement('option');
                option.value = order.id;
                option.textContent = `${order.production_order} (ID: ${order.id})`;
                select.appendChild(option);
            });
        }

        // Test b·∫Øt ƒë·∫ßu l·ªánh
        async function testStartOrder() {
            const machineId = document.getElementById('test-machine').value;
            const orderId = document.getElementById('test-order').value;
            
            if (!machineId || !orderId) {
                showNotification('‚ùå Vui l√≤ng ch·ªçn m√°y v√† l·ªánh', 'warning');
                return;
            }

            const order = await getOrderById(orderId);
            if (!order) {
                showNotification('‚ùå Kh√¥ng t√¨m th·∫•y l·ªánh', 'danger');
                return;
            }

                         try {
                 const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.START_ORDER_ON_MACHINE), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        machine_id: machineId,
                        order_id: orderId,
                        order_code: order.production_order
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    loadMachineStatus();
                    loadOrders();
                } else {
                    showNotification(`‚ùå ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error starting order:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server', 'danger');
            }
        }

        // Test k·∫øt th√∫c l·ªánh
        async function testEndOrder() {
            const machineId = document.getElementById('test-busy-machine').value;
            
            if (!machineId) {
                showNotification('‚ùå Vui l√≤ng ch·ªçn m√°y', 'warning');
                return;
            }

            // L·∫•y th√¥ng tin m√°y ƒë·ªÉ bi·∫øt order_id
            const machineStatus = await getMachineStatus();
            const machine = machineStatus.find(m => m.machine_id === machineId);
            
            if (!machine || !machine.current_order_id) {
                showNotification('‚ùå M√°y kh√¥ng ƒëang ch·∫°y l·ªánh n√†o', 'warning');
                return;
            }

                         try {
                 const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.END_ORDER_ON_MACHINE), {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        machine_id: machineId,
                        order_id: machine.current_order_id
                    })
                });

                const result = await response.json();

                if (response.ok) {
                    showNotification(`‚úÖ ${result.message}`, 'success');
                    loadMachineStatus();
                    loadOrders();
                } else {
                    showNotification(`‚ùå ${result.error}`, 'danger');
                }
            } catch (error) {
                console.error('‚ùå Error ending order:', error);
                showNotification('‚ùå L·ªói k·∫øt n·ªëi server', 'danger');
            }
        }

        // Helper functions
        async function getOrderById(orderId) {
            try {
                const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.PRODUCTION_ORDER_BY_ID) + `/${orderId}`);
                const data = await response.json();
                return response.ok ? data : null;
            } catch (error) {
                console.error('‚ùå Error getting order:', error);
                return null;
            }
        }

                 async function getMachineStatus() {
             try {
                 const response = await fetch(API_CONFIG.getUrl(API_CONFIG.ENDPOINTS.MACHINE_STATUS));
                const data = await response.json();
                return response.ok ? data.machines : [];
            } catch (error) {
                console.error('‚ùå Error getting machine status:', error);
                return [];
            }
        }

        // C·∫≠p nh·∫≠t dropdown m√°y b·∫≠n
        async function updateBusyMachineSelect() {
            const machineStatus = await getMachineStatus();
            const busyMachines = machineStatus.filter(m => m.status === 'busy');
            
            const select = document.getElementById('test-busy-machine');
            select.innerHTML = '<option value="">Ch·ªçn m√°y...</option>';
            
            busyMachines.forEach(machine => {
                const option = document.createElement('option');
                option.value = machine.machine_id;
                option.textContent = `${machine.machine_name} - ${machine.current_order_code}`;
                select.appendChild(option);
            });
        }

        // Auto refresh
        setInterval(() => {
            loadMachineStatus();
            updateBusyMachineSelect();
        }, 5000);
    </script>
</body>
</html> 