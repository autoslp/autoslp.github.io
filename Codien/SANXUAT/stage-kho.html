<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>KHO TH√ÄNH PH·∫®M - Qu·∫£n l√Ω s·∫£n xu·∫•t</title>
  <link rel="stylesheet" href="styles/main.css">
  <style>
    .stage-header {
      background: linear-gradient(135deg, #ffecd2 0%, #fcb69f 100%);
      color: white;
      padding: 24px;
      border-radius: 12px;
      margin-bottom: 24px;
    }
    
    .stage-stats {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
      gap: 16px;
      margin-bottom: 24px;
    }
    
    .stat-card {
      background: white;
      padding: 20px;
      border-radius: 8px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
      text-align: center;
    }
    
    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: var(--primary);
      margin-bottom: 8px;
    }
    
    .stat-label {
      color: var(--gray);
      font-size: 14px;
    }
    
    .orders-table {
      width: 100%;
      border-collapse: collapse;
      background: white;
      border-radius: 8px;
      overflow: hidden;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
    
    .orders-table th,
    .orders-table td {
      padding: 12px 16px;
      text-align: left;
      border-bottom: 1px solid var(--border);
    }
    
    .orders-table th {
      background: var(--light);
      font-weight: 600;
      color: var(--dark);
    }
    
    .orders-table tr:hover {
      background: #f8fafc;
    }
    
    .quantity-input {
      width: 80px;
      padding: 6px 8px;
      border: 1px solid var(--border);
      border-radius: 4px;
      text-align: center;
      font-size: 14px;
    }
    
    .quantity-display {
      font-weight: 600;
      color: var(--primary);
    }
    
    .status-badge {
      padding: 4px 8px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 500;
    }
    
    .status-pending { background: #fef3c7; color: #92400e; }
    .status-doing { background: #dbeafe; color: #1e40af; }
    .status-done { background: #d1fae5; color: #065f46; }
    .status-error { background: #fee2e2; color: #991b1b; }
    
    .action-buttons {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }
    
    .btn-sm {
      padding: 4px 8px;
      font-size: 12px;
    }
    
    .empty-state {
      text-align: center;
      padding: 48px 24px;
      color: var(--gray);
    }
    
    .empty-state h3 {
      margin-bottom: 8px;
      color: var(--dark);
    }
  </style>
</head>
<body>
  <div class="sidebar">
    <div class="sidebar-header">
      <img src="images/logo.svg" alt="Logo" style="height:32px;">
      <h3>Carton Manager</h3>
    </div>
    <nav>
      <ul>
        <li><a href="dashboard.html">üìä Dashboard</a></li>
        <li><a href="orders.html">üìã L·ªánh s·∫£n xu·∫•t</a></li>
        <li><a href="progress.html">‚ö° Qu·∫£n l√Ω ti·∫øn ƒë·ªô</a></li>
        <li><a href="materials.html">üì¶ V·∫≠t t∆∞</a></li>
        <li><a href="workflow.html">üîÑ C√¥ng ƒëo·∫°n</a></li>
        <li><a href="reports.html">üìà B√°o c√°o</a></li>
        <li><a href="stage-xa.html">üéØ C√¥ng ƒëo·∫°n X·∫¢</a></li>
        <li><a href="stage-xen.html">‚úÇÔ∏è C√¥ng ƒëo·∫°n X√âN</a></li>
        <li><a href="stage-in.html">üñ®Ô∏è C√¥ng ƒëo·∫°n IN</a></li>
        <li><a href="stage-boi.html">üìÑ C√¥ng ƒëo·∫°n B·ªíI</a></li>
        <li><a href="stage-be.html">üî™ C√¥ng ƒëo·∫°n B·∫æ</a></li>
        <li><a href="stage-dan.html">üîó C√¥ng ƒëo·∫°n D√ÅN</a></li>
        <li class="active"><a href="stage-kho.html">üè≠ KHO TH√ÄNH PH·∫®M</a></li>
      </ul>
    </nav>
    <div style="padding:16px 24px 0 24px; font-size:13px; color:#cbd5e1;">¬© 2025 Carton Manager</div>
  </div>
  
  <div class="main">
    <div class="stage-header">
      <h1>üè≠ KHO TH√ÄNH PH·∫®M</h1>
      <p>L∆∞u kho th√†nh ph·∫©m - Qu·∫£n l√Ω xu·∫•t nh·∫≠p t·ªìn chi ti·∫øt</p>
    </div>
    
    <div class="stage-stats" id="stageStats">
      <!-- Th·ªëng k√™ s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
    </div>
    
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;">
        <h2>Danh s√°ch l·ªánh s·∫£n xu·∫•t</h2>
        <div>
          <button class="btn btn-primary" onclick="refreshData()">üîÑ L√†m m·ªõi</button>
          <a href="progress.html" class="btn btn-secondary">‚Üê Quay l·∫°i</a>
        </div>
      </div>
      
      <div id="ordersTable">
        <!-- B·∫£ng s·∫Ω ƒë∆∞·ª£c t·∫°o ƒë·ªông -->
      </div>
    </div>
  </div>

  <script src="js/app.js"></script>
  <script>
    let workflow = [];
    let orders = [];
    let progressData = {};
    let inventoryData = {};
    const STAGE_INDEX = 6; // KHO TH√ÄNH PH·∫®M l√† c√¥ng ƒëo·∫°n cu·ªëi
    const STAGE_NAME = 'KHO TH√ÄNH PH·∫®M';
    
    // Kh·ªüi t·∫°o d·ªØ li·ªáu
    function initData() {
      workflow = App.load('workflow', [
        {name:'X·∫¢', desc:'X·∫£ gi·∫•y cu·ªôn'},
        {name:'X√âN', desc:'X√©n gi·∫•y'},
        {name:'IN OFFSET', desc:'In offset'},
        {name:'B·ªíI', desc:'B·ªìi gi·∫•y'},
        {name:'B·∫æ', desc:'B·∫ø h·ªôp'},
        {name:'D√ÅN M√ÅY', desc:'D√°n h·ªôp'},
        {name:'KHO TH√ÄNH PH·∫®M', desc:'L∆∞u kho'}
      ]);
      
      orders = App.load('orders', []);
      if (!orders || orders.length === 0) {
        orders = [
          {id:'LSX001', name:'H·ªôp carton A4', qty:1000, start:'2025-07-25', end:'2025-07-30', status:'done'},
          {id:'LSX002', name:'H·ªôp carton B5', qty:500, start:'2025-07-24', end:'2025-07-29', status:'inprogress'},
          {id:'LSX003', name:'H·ªôp carton C3', qty:2000, start:'2025-07-26', end:'2025-08-02', status:'inprogress'},
          {id:'LSX004', name:'H·ªôp carton D2', qty:800, start:'2025-07-27', end:'2025-08-05', status:'error'}
        ];
        App.save('orders', orders);
      }
      
      // L·∫•y ti·∫øn ƒë·ªô c·ªßa t·∫•t c·∫£ l·ªánh
      orders.forEach(order => {
        progressData[order.id] = App.load('progress_' + order.id, workflow.map((w,i)=>({
          step: i+1,
          name: w.name,
          status: 'pending',
          start: '',
          end: '',
          user: '',
          note: ''
        })));
      });
      
      // L·∫•y d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn
      inventoryData = App.load('inventory_data', {});
    }
    
    // L·∫•y d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn cho m·ªôt l·ªánh ·ªü c√¥ng ƒëo·∫°n n√†y
    function getStageInventory(orderId) {
      const key = `${orderId}_${STAGE_INDEX}`;
      return inventoryData[key] || { in: 0, out: 0 };
    }
    
    // X√°c ƒë·ªãnh l·ªánh ƒëang ·ªü c√¥ng ƒëo·∫°n n√†o
    function getCurrentStage(orderId) {
      const progress = progressData[orderId];
      if (!progress) return -1;
      
      // T√¨m c√¥ng ƒëo·∫°n cu·ªëi c√πng c√≥ tr·∫°ng th√°i 'done'
      for (let i = progress.length - 1; i >= 0; i--) {
        if (progress[i].status === 'done') {
          return i;
        }
      }
      
      // N·∫øu ch∆∞a c√≥ c√¥ng ƒëo·∫°n n√†o ho√†n th√†nh, tr·∫£ v·ªÅ c√¥ng ƒëo·∫°n ƒë·∫ßu ti√™n
      return 0;
    }
    
    // L·∫•y danh s√°ch l·ªánh ·ªü kho th√†nh ph·∫©m
    function getOrdersInStage() {
      return orders.filter(order => {
        const currentStage = getCurrentStage(order.id);
        return currentStage === STAGE_INDEX;
      });
    }
    
    // C·∫≠p nh·∫≠t d·ªØ li·ªáu xu·∫•t nh·∫≠p t·ªìn
    window.updateInventory = function(orderId, type, value) {
      const key = `${orderId}_${STAGE_INDEX}`;
      if (!inventoryData[key]) {
        inventoryData[key] = { in: 0, out: 0 };
      }
      
      inventoryData[key][type] = parseInt(value) || 0;
      App.save('inventory_data', inventoryData);
      
      // Ghi nh·∫≠t k√Ω
      const action = type === 'in' ? 'Nh·∫≠p' : 'Xu·∫•t';
      addLog(orderId, `${action} h√†ng`, `${action} ${value} s·∫£n ph·∫©m ·ªü ${STAGE_NAME}`);
      
      // L√†m m·ªõi d·ªØ li·ªáu
      renderData();
    };
    
    // C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô
    window.updateProgress = function(orderId) {
      const progress = progressData[orderId];
      const currentProgress = progress[STAGE_INDEX];
      
      const status = prompt('Tr·∫°ng th√°i (pending/doing/done/error):', currentProgress.status);
      if (!status) return;
      
      const user = prompt('Ng∆∞·ªùi th·ª±c hi·ªán:', currentProgress.user);
      const note = prompt('Ghi ch√∫:', currentProgress.note);
      
      progress[STAGE_INDEX] = {
        ...currentProgress,
        status: status,
        user: user || '',
        note: note || '',
        start: status === 'doing' && !currentProgress.start ? new Date().toISOString().slice(0, 16) : currentProgress.start,
        end: status === 'done' ? new Date().toISOString().slice(0, 16) : currentProgress.end
      };
      
      App.save('progress_' + orderId, progress);
      progressData[orderId] = progress;
      
      // Ghi nh·∫≠t k√Ω
      addLog(orderId, 'C·∫≠p nh·∫≠t ti·∫øn ƒë·ªô', `C·∫≠p nh·∫≠t tr·∫°ng th√°i ${STAGE_NAME} th√†nh ${status}`, user);
      
      renderData();
    };
    
    // Ghi nh·∫≠t k√Ω
    function addLog(orderId, action, details, user = 'H·ªá th·ªëng') {
      const logs = App.load('logs_' + orderId, []);
      logs.unshift({
        time: new Date().toISOString(),
        action: action,
        details: details,
        user: user
      });
      
      // Gi·ªØ t·ªëi ƒëa 100 nh·∫≠t k√Ω
      if (logs.length > 100) {
        logs.splice(100);
      }
      
      App.save('logs_' + orderId, logs);
    }
    
    // Hi·ªÉn th·ªã d·ªØ li·ªáu
    function renderData() {
      const ordersInStage = getOrdersInStage();
      
      // T√≠nh th·ªëng k√™
      let totalOriginal = 0;
      let totalIn = 0;
      let totalOut = 0;
      let totalStock = 0;
      let totalOrders = ordersInStage.length;
      
      ordersInStage.forEach(order => {
        const stageInventory = getStageInventory(order.id);
        totalOriginal += order.qty;
        totalIn += stageInventory.in || 0;
        totalOut += stageInventory.out || 0;
        totalStock += (stageInventory.in || 0) - (stageInventory.out || 0);
      });
      
      // Hi·ªÉn th·ªã th·ªëng k√™
      document.getElementById('stageStats').innerHTML = `
        <div class="stat-card">
          <div class="stat-value">${totalOrders}</div>
          <div class="stat-label">T·ªïng l·ªánh</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalOriginal}</div>
          <div class="stat-label">T·ªïng g·ªëc</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalIn}</div>
          <div class="stat-label">T·ªïng nh·∫≠p</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalOut}</div>
          <div class="stat-label">T·ªïng xu·∫•t</div>
        </div>
        <div class="stat-card">
          <div class="stat-value">${totalStock}</div>
          <div class="stat-label">T·ªïng t·ªìn</div>
        </div>
      `;
      
      // Hi·ªÉn th·ªã b·∫£ng
      if (ordersInStage.length === 0) {
        document.getElementById('ordersTable').innerHTML = `
          <div class="empty-state">
            <h3>Ch∆∞a c√≥ l·ªánh n√†o ·ªü ${STAGE_NAME}</h3>
            <p>L·ªánh s·∫Ω xu·∫•t hi·ªán ·ªü ƒë√¢y khi ƒë∆∞·ª£c chuy·ªÉn ƒë·∫øn c√¥ng ƒëo·∫°n n√†y</p>
          </div>
        `;
      } else {
        let tableHTML = `
          <table class="orders-table">
            <thead>
              <tr>
                <th>M√£ l·ªánh</th>
                <th>S·∫£n ph·∫©m</th>
                <th>S·ªë l∆∞·ª£ng g·ªëc</th>
                <th>ƒê√£ nh·∫≠p</th>
                <th>ƒê√£ xu·∫•t</th>
                <th>T·ªìn kho</th>
                <th>Tr·∫°ng th√°i</th>
                <th>Ng∆∞·ªùi th·ª±c hi·ªán</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody>
        `;
        
        ordersInStage.forEach(order => {
          const progress = progressData[order.id];
          const currentProgress = progress[STAGE_INDEX];
          const stageInventory = getStageInventory(order.id);
          
          tableHTML += `
            <tr>
              <td><strong>${order.id}</strong></td>
              <td>${order.name}</td>
              <td class="quantity-display">${order.qty}</td>
              <td>
                <input type="number" class="quantity-input" value="${stageInventory.in || 0}" 
                       onchange="updateInventory('${order.id}', 'in', this.value)">
              </td>
              <td>
                <input type="number" class="quantity-input" value="${stageInventory.out || 0}" 
                       onchange="updateInventory('${order.id}', 'out', this.value)">
              </td>
              <td class="quantity-display">${(stageInventory.in || 0) - (stageInventory.out || 0)}</td>
              <td>
                <span class="status-badge status-${currentProgress.status}">
                  ${getStatusLabel(currentProgress.status)}
                </span>
              </td>
              <td>${currentProgress.user || '-'}</td>
              <td>
                <div class="action-buttons">
                  <button class="btn btn-primary btn-sm" onclick="updateProgress('${order.id}')">
                    C·∫≠p nh·∫≠t
                  </button>
                  <button class="btn btn-secondary btn-sm" onclick="openOrderDetail('${order.id}')">
                    Chi ti·∫øt
                  </button>
                </div>
              </td>
            </tr>
          `;
        });
        
        tableHTML += `
            </tbody>
          </table>
        `;
        
        document.getElementById('ordersTable').innerHTML = tableHTML;
      }
    }
    
    // M·ªü chi ti·∫øt l·ªánh
    window.openOrderDetail = function(orderId) {
      window.open(`order-detail.html?id=${orderId}`, '_blank');
    };
    
    // L√†m m·ªõi d·ªØ li·ªáu
    window.refreshData = function() {
      initData();
      renderData();
    };
    
    // L·∫•y nh√£n tr·∫°ng th√°i
    function getStatusLabel(status) {
      const labels = {
        'pending': 'Ch∆∞a l√†m',
        'doing': 'ƒêang l√†m',
        'done': 'Ho√†n th√†nh',
        'error': 'L·ªói'
      };
      return labels[status] || status;
    }
    
    // Kh·ªüi t·∫°o
    document.addEventListener('DOMContentLoaded', function() {
      initData();
      renderData();
    });
  </script>
</body>
</html> 