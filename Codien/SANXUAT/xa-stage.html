<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công đoạn XẢ - Carton Manager</title>
  <!-- Bootstrap Icons -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <!-- Universal Stage CSS -->
  <link rel="stylesheet" href="universal-stage.css">
  <!-- Sidebar Generator -->
  <script src="sidebar-generator.js"></script>
  <style>

  
    /* Đảm bảo modal hiển thị đúng và ở giữa màn hình */
    .modal {
      z-index: 1050 !important;
    }
    
    .modal-backdrop {
      z-index: 1040 !important;
    }
    
    .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1.75rem auto;
    }
    
    .modal-content {
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    
    /* Đảm bảo các tab hiển thị đúng */
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom-color: transparent;
    }
    
    /* Cải thiện hiển thị của form */
    .form-control, .form-select {
      /* margin-bottom: 0.5rem; */
      border-radius: 6px;
    }
    
    /* Tạo khoảng cách rõ ràng giữa các phần của form */
    .form-label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    /* Làm nổi bật thông tin quan trọng */
    .alert {
      border-radius: 6px;
    }
    
    /* Đảm bảo modal không bị tràn màn hình trên thiết bị di động */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 0.5rem;
        max-width: 95%;
      }
      
      .modal-dialog-centered {
        min-height: calc(100% - 1rem);
      }
    }
    
    /* Fix cho nút đóng trên modal header */
    .modal-header .btn-close {
      padding: 0.5rem;
      margin: -0.5rem -0.5rem -0.5rem auto;
    }
    
    /* Hiệu ứng hover cho các nút */
    .btn {
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
    }
    
    /* Animation styles cho notification */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

    /* Enhanced form styling for sidebar */
    .section-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 1rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #e9ecef;
    }

    /* Style cho các lệnh bị disable */
    .disabled-order {
        opacity: 0.1;
        background-color: #f8f9fa !important;
    }

    .disabled-order:hover {
        background-color: #f8f9fa !important;
    }

    .disabled-order td {
        color: #6c757d !important;
    }

    .disabled-order .progress-bar {
        background-color: #6c757d !important;
    }

    /* Style cho lệnh đang chạy - highlight màu xanh */
    .running-order {
        background-color: #d1ecf1 !important;
        border-left: 4px solid #17a2b8 !important;
    }

    .running-order:hover {
        background-color: #bee5eb !important;
    }

    .running-order td {
        color: #0c5460 !important;
        font-weight: 500;
    }

    /* Đảm bảo tương thích với table-striped của Bootstrap */
    .table.table-striped tbody tr.running-order {
        background-color: #d1ecf1 !important;
    }

    .table.table-striped tbody tr.running-order:nth-child(odd) {
        background-color: #d1ecf1 !important;
    }

    .table.table-striped tbody tr.running-order:nth-child(even) {
        background-color: #d1ecf1 !important;
    }

    .table.table-striped tbody tr.running-order:hover {
        background-color: #bee5eb !important;
    }

    .table.table-striped tbody tr.running-order:nth-child(odd):hover {
        background-color: #bee5eb !important;
    }

    .table.table-striped tbody tr.running-order:nth-child(even):hover {
        background-color: #bee5eb !important;
    }

    .section-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 20px;
        font-size: 0.75rem;
        font-weight: bold;
    }



    .form-group {
        margin-bottom: 0.5rem;
    }

    .form-group:last-child {
        margin-bottom: 0;
    }

    .detail-label {
        min-width: 180px;
        margin-bottom: 0;
    }
    

    
    /* Table styles */
    .table {
        table-layout: fixed;
        width: 100%;
    }
    
    

    
    /* Active row highlight */
    .table-active {
        background-color: #e3f2fd !important;
        border-left: 4px solid #2196f3;
    }
    

    
    /* Hover effect for rows */
    .order-row:hover {
        background-color: #f8f9fa;
        cursor: pointer;
    }
    

    
    /* Card styles for statistics */
    .card.border-0 {
        transition: transform 0.2s ease;
    }
    
    .card.border-0:hover {
        transform: translateY(-2px);
    }

    .form-control-lg, .form-select-lg {
        border-radius: 8px;
        border: 2px solid #e9ecef;
        transition: all 0.3s ease;
    }

    .form-control-lg:focus, .form-select-lg:focus {
        border-color: #0d6efd;
        box-shadow: 0 0 0 0.2rem rgba(13, 110, 253, 0.25);
    }

    .input-group-lg .form-control {
        border-radius: 8px 0 0 8px;
    }

    .input-group-lg .input-group-text {
        border-radius: 0 8px 8px 0;
    }

    .alert {
        border-radius: 8px;
        border-left: 4px solid;
    }

    .btn-lg {
        border-radius: 8px;
        font-weight: 600;
        padding: 0.75rem 1.5rem;
    }



    /* Wizard Form Styles */
    .wizard-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      margin: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .wizard-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }
    
    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }
    
    .step.active:not(:last-child)::after {
      background: #6f42c1;
    }
    
    .step.completed:not(:last-child)::after {
      background: #28a745;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }
    
    .step.active .step-circle {
      background: #6f42c1;
      color: white;
      box-shadow: 0 0 0 4px rgba(111, 66, 193, 0.2);
    }
    
    .step.completed .step-circle {
      background: #28a745;
      color: white;
    }
    
    .step-label {
      margin-top: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
    }
    
    .wizard-content {
      padding: 30px;
      min-height: 400px;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #6f42c1;
      box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    
    /* .btn-primary {
      background: linear-gradient(45deg, #6f42c1, #5a2d91);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    } */
    
    .btn-success {
      background: linear-gradient(45deg, #28a745, #1e7e34);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #545b62);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    }
    
    .info-card {
      background: linear-gradient(45deg, #17a2b8, #138496);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .progress-card {
      background: linear-gradient(45deg, #fd7e14, #e55a00);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .wizard-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 15px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .step-indicator {
      font-size: 0.9rem;
      color: #6c757d;
    }

    /* Cập nhật chỉ phần details-header để cố định khi cuộn */
    .details-header {
        position: sticky;
        top: 0;
        z-index: 1050;
        /* background: #f8f9fa; */
        padding: 15px;
        border-bottom: 1px solid #dee2e6;
        box-shadow: 0 2px 5px rgba(0,0,0,0.05);

        background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
    }

    /* Tab Styles */
    .nav-tabs {
        border-bottom: 2px solid #dee2e6;
    }
    
    .nav-tabs .nav-link {
        border: none;
        border-bottom: 3px solid transparent;
        color: #6c757d;
        font-weight: 500;
        padding: 0.75rem 1.5rem;
        transition: all 0.3s ease;
    }
    
    .nav-tabs .nav-link:hover {
        border-color: transparent;
        color: #495057;
        background-color: #f8f9fa;
    }
    
    .nav-tabs .nav-link.active {
        border-bottom-color: #0d6efd;
        color: #0d6efd;
        background-color: transparent;
        font-weight: 600;
    }
    
    .nav-tabs .nav-link .badge {
        font-size: 0.75rem;
        padding: 0.25rem 0.5rem;
    }
    
    /* Tab content animation */
    .tab-pane {
        transition: opacity 0.3s ease;
    }
    
    .tab-pane.fade {
        opacity: 0;
    }
    
    .tab-pane.fade.show {
        opacity: 1;
    }
    
    /* Machine-specific tab colors */
    #xa1-tab.active {
        border-bottom-color: #dc3545;
        color: #dc3545;
    }
    
    #xa2-tab.active {
        border-bottom-color: #fd7e14;
        color: #fd7e14;
    }
    
    #xa3-tab.active {
        border-bottom-color: #6f42c1;
        color: #6f42c1;
    }
    
    #all-tab.active {
        border-bottom-color: #6c757d;
        color: #6c757d;
    }

  </style>
</head>
<body data-stage="xa">
  
  <!-- Sidebar will be generated by JavaScript -->

  <!-- Main Content -->
  <div class="main-content sidebar-collapsed" id="mainContent">
    <div class="content-area">
    <div class="container-fluid p-4">
      
      <!-- Stage Header -->
      <div class="stage-header">
        <h1>
          <i class="bi bi-bullseye me-2 text-primary"></i>
          Công đoạn XẢ
        </h1>
        <p class="mb-0">Xả giấy cuộn - Quản lý chi tiết sản xuất</p>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4" id="stageStats">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Tổng lệnh</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalPlan">0</div>
            <div class="stat-label">SL Kế hoạch</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalGood">0</div>
            <div class="stat-label">SL Đạt</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalNg">0</div>
            <div class="stat-label">SL NG</div>
          </div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Danh sách lệnh sản xuất - Công đoạn Xả</h5>
          <div class="d-flex align-items-center">

            
 
            
            <!-- Main Actions -->
            <button class="btn btn-primary me-2" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
            </button>
            <button class="btn btn-info me-2" onclick="refreshMachineStatus()" title="Làm mới trạng thái máy">
              <i class="bi bi-gear me-1"></i>Trạng thái máy
            </button>
            <button class="btn btn-warning me-2" onclick="debugMachineStatus()" title="Debug trạng thái máy">
              <i class="bi bi-bug me-1"></i>Debug
            </button>
            <button class="btn btn-success" onclick="showNewOrderForm()">
              <i class="bi bi-plus-lg me-1"></i>Thêm mới
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filters -->
          <div class="card mb-3">
            <div class="card-header bg-light">
              <div class="d-flex justify-content-between align-items-center">
                <h6 class="mb-0">
                  <i class="bi bi-funnel me-2"></i>Bộ lọc dữ liệu
                </h6>
                <button class="btn btn-outline-secondary btn-sm" onclick="clearFilters()" title="Xóa tất cả bộ lọc">
                  <i class="bi bi-x-circle me-1"></i>Xóa bộ lọc
                </button>
              </div>
            </div>
            <div class="card-body">
              <div class="row g-3">
                <div class="col-md-3">
                  <label class="form-label fw-bold">
                    <i class="bi bi-calendar me-1"></i>Ngày sản xuất:
                  </label>
                  <input type="date" class="form-control" id="dateFilter">
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-bold">
                    <i class="bi bi-clock me-1"></i>Ca:
                  </label>
                  <select class="form-select" id="shiftFilter">
                    <option value="">Tất cả</option>
                    <option value="Ca 1">Ca 1</option>
                    <option value="Ca 2">Ca 2</option>
                    <option value="Ca 3">Ca 3</option>
                  </select>
                </div>
                <div class="col-md-2">
                  <label class="form-label fw-bold">
                    <i class="bi bi-gear me-1"></i>Máy:
                  </label>
                  <select class="form-select" id="machineFilter">
                    <option value="">Tất cả</option>
                    <option value="Xả 1">Xả 1</option>
                    <option value="Xả 2">Xả 2</option>
                    <option value="Xả 3">Xả 3</option>
                  </select>
                </div>
                <div class="col-md-5">
                  <label class="form-label fw-bold">
                    <i class="bi bi-search me-1"></i>Tìm kiếm:
                  </label>
                  <div class="input-group">
                    <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã lệnh, sản phẩm, máy, thợ...">
                    <button class="btn btn-primary" type="button" onclick="applyFilters()">
                      <i class="bi bi-search"></i>
                    </button>
                  </div>
                  <!-- <small class="text-muted">Tự động tìm kiếm khi nhập (300ms delay)</small> -->
                </div>
              </div>
            </div>
          </div>
          
          <!-- Tabs Navigation -->
          <ul class="nav nav-tabs mb-3" id="machineTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="xa1-tab" data-bs-toggle="tab" data-bs-target="#xa1-content" type="button" role="tab" aria-controls="xa1-content" aria-selected="true">
                <i class="bi bi-gear me-1"></i>Xả 1
                <span class="badge bg-primary ms-1" id="xa1-count">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="xa2-tab" data-bs-toggle="tab" data-bs-target="#xa2-content" type="button" role="tab" aria-controls="xa2-content" aria-selected="false">
                <i class="bi bi-gear me-1"></i>Xả 2
                <span class="badge bg-primary ms-1" id="xa2-count">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="xa3-tab" data-bs-toggle="tab" data-bs-target="#xa3-content" type="button" role="tab" aria-controls="xa3-content" aria-selected="false">
                <i class="bi bi-gear me-1"></i>Xả 3
                <span class="badge bg-primary ms-1" id="xa3-count">0</span>
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="all-tab" data-bs-toggle="tab" data-bs-target="#all-content" type="button" role="tab" aria-controls="all-content" aria-selected="false">
                <i class="bi bi-list-ul me-1"></i>Tất cả
                <span class="badge bg-secondary ms-1" id="all-count">0</span>
              </button>
            </li>
          </ul>
          
          <!-- Tab Content -->
          <div class="tab-content" id="machineTabContent">
            <!-- Xả 1 Tab -->
            <div class="tab-pane fade " id="xa1-content" role="tabpanel" aria-labelledby="xa1-tab">
              <div class="table-container">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                      <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                      <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                      <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                      <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                      <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                      <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                    </tr>
                  </thead>
                  <tbody id="xa1TableBody">
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Xả 2 Tab -->
            <div class="tab-pane fade" id="xa2-content" role="tabpanel" aria-labelledby="xa2-tab">
              <div class="table-container">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                      <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                      <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                      <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                      <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                      <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                      <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                    </tr>
                  </thead>
                  <tbody id="xa2TableBody">
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- Xả 3 Tab -->
            <div class="tab-pane fade" id="xa3-content" role="tabpanel" aria-labelledby="xa3-tab">
              <div class="table-container">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                      <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                      <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                      <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                      <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                      <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                      <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                    </tr>
                  </thead>
                  <tbody id="xa3TableBody">
                  </tbody>
                </table>
              </div>
            </div>
            
            <!-- All Tab -->
            <div class="tab-pane fade show active" id="all-content" role="tabpanel" aria-labelledby="all-tab">
              <div class="table-container">
                <table class="table table-striped table-hover">
                  <thead>
                    <tr>
                      <th style="width: 40px!important; min-width: 40px!important;" class="text-center">#</th>
                      <th style="width: 150px!important; min-width: 120px!important;" class="text-center">Lệnh SX</th>
                      <th style="width: 70px!important; min-width: 50px!important;" class="text-center">Loại LSX</th>
                      <th style="width: 260px!important; min-width: 150px!important;" class="text-center">Sản phẩm</th>
                      <th style="width: 130px!important; min-width: 130px!important;" class="text-center">Loại giấy</th>
                      <th style="width: 90px!important; min-width: 90px!important;" class="text-center">Định lượng</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Kế hoạch</th>
                      <th style="width: 150px!important; min-width: 150px!important;" class="text-center">Triển khai</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">KT xả</th>
                      <th style="width: 100px!important; min-width: 100px!important;" class="text-center">Số phôi</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Tiến độ</th>
                      <th style="width: 120px!important; min-width: 120px!important;" class="text-center">Máy/Thợ</th>
                    </tr>
                  </thead>
                  <tbody id="allTableBody">
                  </tbody>
                </table>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Order Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm lệnh sản xuất mới - Công đoạn Xả</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="orderForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã lệnh sản xuất *</label>
                <input type="text" class="form-control" id="orderCode" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã sản phẩm *</label>
                <input type="text" class="form-control" id="productCode" required>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Tên sản phẩm *</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Loại giấy *</label>
                <select class="form-select" id="paperType" required>
                  <option value="">Chọn loại giấy</option>
                  <option value="BC">BC</option>
                  <option value="CC">CC</option>
                  <option value="WF">WF</option>
                  <option value="OF">OF</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Định lượng (gsm) *</label>
                <input type="number" class="form-control" id="paperWeight" required min="100" max="1000">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Khổ tờ</label>
                <input type="text" class="form-control" id="sheetSize" placeholder="VD: 1020x720mm">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Số lượng kế hoạch *</label>
                <input type="number" class="form-control" id="planQty" required min="1">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Ca sản xuất</label>
                <select class="form-select" id="shift">
                  <option value="Ca 1">Ca 1</option>
                  <option value="Ca 2">Ca 2</option>
                  <option value="Ca 3">Ca 3</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Máy xả</label>
                <select class="form-select" id="machine">
                  <option value="Xả 1">Xả 1</option>
                  <option value="Xả 2">Xả 2</option>
                  <option value="Xả 3">Xả 3</option>
                </select>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Ghi chú</label>
                <textarea class="form-control" id="orderNote" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="saveOrder()">Lưu</button>
        </div>
      </div>
    </div>
  </div>



  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * =================================================================
     * XẢ STAGE MANAGEMENT - QUẢN LÝ CÔNG ĐOẠN XẢ
     * =================================================================
     * Chức năng chính:
     * 1. Hiển thị danh sách lệnh sản xuất ở công đoạn XẢ
     * 2. Hoàn thành công đoạn XẢ (cập nhật số lượng OK, NG)
     * 3. Bàn giao sang công đoạn tiếp theo theo workflow_definition
     */

    // === CẤU HÌNH API & WEBHOOK ===
    const API_BASE_URL = 'https://autoslp.duckdns.org/api';
    const WEBHOOK_BASE_URL = 'https://autoslp.duckdns.org:5678/webhook';



    // === CẤU HÌNH CÔNG ĐOẠN ===
    const STAGE_CONFIG = {
        KEY: 'xa',           // Tên key trong database
        NAME: 'XẢ',          // Tên hiển thị
        NEXT_STAGE: null     // Sẽ được xác định từ workflow_definition
    };

    // === BIẾN GLOBAL ===
    let ordersData = [];        // Dữ liệu lệnh sản xuất
    let currentEditingOrder = null;  // Đơn hàng đang chỉnh sửa
    let machineStatusData = []; // Dữ liệu trạng thái máy

    /**
     * =================================================================
     * MACHINE STATUS FUNCTIONS - HÀM QUẢN LÝ TRẠNG THÁI MÁY
     * =================================================================
     */

    /**
     * Tải dữ liệu trạng thái máy từ API
     */
    async function loadMachineStatus() {
        try {
            const response = await fetch(`${API_BASE_URL}/data/production_machines`);
            if (response.ok) {
                machineStatusData = await response.json();
            } else {
                console.error('Lỗi khi tải dữ liệu máy:', response.status);
                machineStatusData = [];
            }
        } catch (error) {
            console.error('Lỗi khi tải dữ liệu máy:', error);
            machineStatusData = [];
        }
    }

    /**
     * Kiểm tra xem máy có đang sản xuất lệnh nào không
     * @param {string} machineName - Tên máy
     * @returns {object|null} - Thông tin lệnh đang sản xuất hoặc null
     */
    function getMachineCurrentOrder(machineName) {
        if (!machineStatusData || machineStatusData.length === 0) {
            return null;
        }
        
        const machine = machineStatusData.find(m => m.machine_name === machineName);
        return machine && machine.current_order_id ? machine : null;
    }

    /**
     * Kiểm tra xem máy cụ thể có đang chạy lệnh không
     * @param {string} machineName - Tên máy cần kiểm tra
     * @returns {object} - { isRunning: boolean, runningOrder: object|null }
     */
    function checkMachineStatus(machineName) {
        const machine = machineStatusData.find(m => m.machine_name === machineName);
        
        if (!machine) {
            return { isRunning: false, runningOrder: null };
        }
        
        const isRunning = !!(machine.current_order_id && machine.current_order_id !== null);
        
        return {
            isRunning: isRunning,
            runningOrder: isRunning ? machine : null
        };
    }

    /**
     * Kiểm tra xem lệnh có thuộc máy nào không
     * @param {object} order - Lệnh sản xuất
     * @returns {string|null} - Tên máy hoặc null
     */
    function getOrderMachine(order) {
        const assignedMachine = order.assigned_machine || '';
        
        // Tìm máy Xả trong danh sách máy được gán
        if (assignedMachine.includes('Xả 1')) {
            return 'Xả 1';
        } else if (assignedMachine.includes('Xả 2')) {
            return 'Xả 2';
        } else if (assignedMachine.includes('Xả 3')) {
            return 'Xả 3';
        }
        
        return null;
    }

    /**
     * Kiểm tra xem lệnh có đang chạy không
     * @param {object} order - Lệnh sản xuất
     * @returns {object} - { isRunning: boolean, reason: string }
     */
    function isOrderRunning(order) {
        // Kiểm tra xem có máy nào đang sản xuất lệnh này không
        const machineWithThisOrder = machineStatusData.find(machine => 
            machine.current_order_id == order.id
        );

        // Nếu lệnh này đang được sản xuất bởi một máy nào đó
        if (machineWithThisOrder) {
            return { isRunning: true, reason: `Lệnh hiện tại của máy ${machineWithThisOrder.machine_name}` };
        }

        // Nếu không có máy nào đang sản xuất lệnh này
        return { isRunning: false, reason: 'Lệnh không đang được sản xuất' };
    }



    /**
     * =================================================================
     * ENHANCED API FUNCTIONS - API CẢI TIẾN
     * =================================================================
     */

    /**
     * Fetch với timeout và retry
     */
    async function fetchWithTimeout(url, options = {}, timeout = 10000) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    /**
     * Fetch với retry logic
     */
    async function fetchWithRetry(url, options = {}, maxRetries = 3) {
        let lastError;
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                const timeout = attempt === 1 ? 10000 : 3000;
                const response = await fetchWithTimeout(url, options, timeout);
                
                if (response.ok) {
                    return response;
                }
                
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                lastError = error;
                
                if (attempt < maxRetries) {
                    const delay = Math.min(1000 * attempt, 2000);
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        throw lastError;
    }


    /**
     * Tải dữ liệu lệnh sản xuất từ API
     */
    async function loadOrdersData() {
        const timingKey = 'loadOrdersData';

        
        try {
            // Load dữ liệu máy trước
            await loadMachineStatus();
    
            
            // Tối ưu: Thêm pagination để load nhanh hơn
            const pageSize = 500; // Load 500 records mỗi lần
            let allData = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
                const url = `${API_BASE_URL}/data/production_orders/optimized?stage=xa&page=${page}&limit=${pageSize}&days_back=300`;
                
                // Tối ưu: Giảm timeout và retry cho load nhanh hơn
                const fastOptions = {
                    timeout: 5000, // Giảm timeout xuống 5s
                    maxRetries: 2   // Giảm retry xuống 2 lần
                };
                
                // Gọi API với timeout ngắn hơn
                const response = await fetchWithRetry(url, {}, fastOptions.maxRetries);
                const apiData = await response.json();
                
                // Kiểm tra dữ liệu raw từ API
        
                if (apiData.length > 0) {
                    // Log các mẫu để kiểm tra xa_start_time
                    apiData.slice(0, 3).forEach((record, idx) => {
                        // Sample data logging removed
                    });
                    
                    // Đếm số bản ghi có xa_start_time
                    const recordsWithStartTime = apiData.filter(r => r.xa_start_time).length;
                }
                
                if (!Array.isArray(apiData) || apiData.length === 0) {
                    hasMore = false;
                    break;
                }
                
                allData = allData.concat(apiData);
                
                // Nếu ít hơn pageSize, đã hết dữ liệu
                if (apiData.length < pageSize) {
                    hasMore = false;
                }
                
                page++;
                
                // Giới hạn tối đa 3 pages để tránh load quá nhiều
                if (page > 3) {
                    hasMore = false;
                }
            }
            

            
            ordersData = transformApiData(allData);
            
            // Kiểm tra dữ liệu sau khi transform
            if (ordersData.length > 0) {
                // Log các mẫu để kiểm tra xa_start_time
                ordersData.slice(0, 3).forEach((record, idx) => {
                    // Sample transformed data logging removed
                });
                
                // Đếm số bản ghi có xa_start_time
                const recordsWithStartTime = ordersData.filter(r => r.xa_start_time).length;
            }
            
            // Lưu dữ liệu gốc cho filtering
            originalOrdersData = [...ordersData];
            filteredOrdersData = [...ordersData];
            
            // Log sample data để debug
            if (ordersData.length > 0) {
                // Sample orders data logging removed
            }
            

            
        } catch (error) {
            ordersData = [];
            showNotification('Không thể tải dữ liệu: ' + error.message, 'error');
        }
    }

    /**
     * Transform API data
     */
    function transformApiData(apiData) {
        if (!Array.isArray(apiData)) {
            return [];
        }

        const transformedData = [];
        
        for (let i = 0; i < apiData.length; i++) {
            transformedData[i] = transformOrder(apiData[i]);
        }
        
        return transformedData;
    }



    /**
     * Transform một order
     */
    function transformOrder(order) {
        let workflowDef = order.workflow_definition;
        
        // Log dữ liệu thô từ API để debug
        
        if (order.xa_start_time) {
            // API Data logging removed
        }
        
        const nextStage = getNextStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY);
        
        // Tạo đối tượng kết quả
        const transformedOrder = {
            id: order.id || order.order_id || order.production_order_id,
            production_order: order.order_code || order.production_order,
            order_type: order.order_type || '', // Thêm trường loại LSX
            product_name: order.product_name,
            internal_product_code: order.internal_product_code,
            customer_name: order.customer_name,
            total_quantity: order.quantity || order.total_quantity,
            deployed_quantity: order.deployed_quantity || 0, // Thêm deployed_quantity
            sheet_count: order.sheet_count || 0, // Thêm sheet_count
            xa_input_quantity: order.quantity || order.total_quantity || 0,
            xa_output_quantity: order.xa_output_quantity || 0,
            xa_good_quantity: order.xa_good_quantity || 0,
            xa_ng_quantity: order.xa_ng_quantity || 0,
            xa_status: order.xa_status || order.status || 'waiting',
            xa_machine_name: order.xa_machine_name || '',
            xa_worker_name: order.xa_worker_name || '',
            xa_note: order.xa_note || order.notes || '',
            xa_start_time: order.xa_start_time || null,
            xa_end_time: order.xa_end_time || null,
            paper_type: order.paper_type || '',
            paper_weight: order.paper_weight || 0,
            paper_length: order.paper_length  || 0,
            paper_width: order.paper_width  || 0,
            blank_count: order.blank_count|| 0, // Số phôi
            production_shift: order.shift || order.production_shift || '',
            delivery_date: order.delivery_date,
            deployment_date: order.deployment_date || order.created_at,
            assigned_machine: order.assigned_machine || '', // Thêm trường assigned_machine
            workflow_definition: workflowDef,
            next_stage: nextStage,
            created_at: order.created_at,
            updated_at: order.updated_at
        };
        
        // Log dữ liệu sau khi transform để debug
        if (transformedOrder.xa_start_time) {
            // Transformed data logging removed
        }
        
        return transformedOrder;
    }

    /**
     * =================================================================
     * WORKFLOW FUNCTIONS - HÀM XỬ LÝ WORKFLOW
     * =================================================================
     */

    /**
     * Lấy stage tiếp theo từ workflow definition
     * @param {string} workflowDef - Workflow definition (VD: "xa,xen,in" hoặc "xa,in_offset")
     * @param {string} currentStage - Stage hiện tại
     * @returns {string|null} Stage tiếp theo hoặc null nếu là stage cuối
     */
    function getNextStageFromWorkflow(workflowDef, currentStage) {
        if (!workflowDef) {
            return null;
        }
        
        const stages = workflowDef.split(',').map(s => s.trim());
        const currentIndex = stages.indexOf(currentStage);
        
        if (currentIndex === -1 || currentIndex >= stages.length - 1) {
            return null; // Không tìm thấy hoặc đã là stage cuối
        }
        
        const nextStage = stages[currentIndex + 1];
        return nextStage;
    }

    /**
     * Lấy tên hiển thị của stage
     * @param {string} stageKey - Key của stage
     * @returns {string} Tên hiển thị
     */
    function getStageDisplayName(stageKey) {
        const stageNames = {
            'xa': 'XẢ',
            'xen': 'XÉN', 
            'in_offset': 'IN OFFSET',
            'boi': 'BỒI',
            'be': 'BẾ',
            'dan': 'DÁN',
            'kho': 'KHO'
        };
        
        return stageNames[stageKey] || stageKey.toUpperCase();
    }

    /**
     * Lấy màu sắc theo stage
     * @param {string} stageKey - Key của stage
     * @returns {string} CSS class màu sắc
     */
    function getStageColor(stageKey) {
        const stageColors = {
            'xa': 'primary',
            'xen': 'success',
            'in_offset': 'purple',
            'boi': 'warning',
            'be': 'danger',
            'dan': 'dark',
            'kho': 'secondary'
        };
        
        return stageColors[stageKey] || 'secondary';
    }

    /**
     * =================================================================
     * WEBHOOK FUNCTIONS - HÀM GỬI DỮ LIỆU QUA WEBHOOK
     * =================================================================
     */

    /**
     * Gửi dữ liệu qua webhook n8n
     * @param {string} action - Loại hành động
     * @param {Object} data - Dữ liệu gửi đi
     * @returns {Promise<Object>} Kết quả gửi webhook
     */
    async function sendWebhook(action, data) {
        try {
            const payload = {
                action: action,
                timestamp: new Date().toISOString(),
                source: 'xa_stage_frontend',
                data: data
            };

            const response = await fetch(`${WEBHOOK_BASE_URL}/production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }

            const result = await response.json();
            
            return {
                success: true,
                message: 'Dữ liệu đã được gửi qua webhook thành công',
                webhook_response: result
            };

        } catch (error) {

            
            // Fallback: Lưu vào localStorage để retry sau
            saveToLocalStorage(action, data);
            
            return {
                success: true,
                message: 'Đã lưu dữ liệu local (sẽ đồng bộ khi có kết nối)',
                local_only: true
            };
        }
    }

    /**
     * Lưu dữ liệu vào localStorage để retry sau
     */
    function saveToLocalStorage(action, data) {
        try {
            const key = 'pending_webhooks_xa';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            
            existing.push({
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(key, JSON.stringify(existing));
        } catch (error) {

        }
    }

    /**
     * Đồng bộ dữ liệu đã lưu trong localStorage
     */
    async function syncPendingData() {
        try {
            const key = 'pending_webhooks_xa';
            const pending = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (pending.length === 0) return;
            
            for (const item of pending) {
                await sendWebhook(item.action, item.data);
            }
            
            // Xóa dữ liệu đã sync
            localStorage.removeItem(key);
            showNotification('Đã đồng bộ dữ liệu thành công', 'success');
            
        } catch (error) {

        }
    }

    /**
     * =================================================================
     * KHỞI TẠO TRANG - PAGE INITIALIZATION
     * =================================================================
     */
    
    // Khởi tạo khi trang được load
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    /**
     * Khởi tạo trang - load dữ liệu và setup UI
     */
    async function initializePage() {


        
        try {
            showLoading('Đang tải dữ liệu...');
            
            // Tải dữ liệu từ API
            await loadOrdersData();
            
            // Render giao diện
                        renderOrdersTable();
            updateStatistics();
            
            // Khởi tạo filters
            setupFilterChangeListeners();
            setupSearchDebounce();
            updateMachineFilterOptions();
            
            // Khởi tạo tabs
            initializeTabs();
            
            // Log tổng thời gian
            // logTotalLoadTime();
            
            // showNotification('Đã tải dữ liệu thành công', 'success');
            
        } catch (error) {
            showNotification('Lỗi tải dữ liệu: ' + error.message, 'error');
            
   
            
            renderOrdersTable();
            updateStatistics();
        } finally {
            hideLoading();
        }
    }

    

    /**
     * Render bảng danh sách lệnh sản xuất với tab structure
     */
    function renderOrdersTable() {
        // Kiểm tra có dữ liệu không
        if (ordersData.length === 0) {
            // Hiển thị thông báo trống cho tất cả các tab
            const emptyMessage = `
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Không có lệnh sản xuất nào cho công đoạn ${STAGE_CONFIG.NAME}
                    </td>
                </tr>
            `;
            
            document.getElementById('xa1TableBody').innerHTML = emptyMessage;
            document.getElementById('xa2TableBody').innerHTML = emptyMessage;
            document.getElementById('xa3TableBody').innerHTML = emptyMessage;
            document.getElementById('allTableBody').innerHTML = emptyMessage;
            
            // Cập nhật số lượng cho các tab
            updateTabCounts({ xa1: 0, xa2: 0, xa3: 0, all: 0 });
            return;
        }
        
        // Phân loại dữ liệu theo máy từ trường assigned_machine
        const xa1Orders = ordersData.filter(order => {
            const assignedMachine = order.assigned_machine || '';
            return assignedMachine.includes('Xả 1');
        });
        const xa2Orders = ordersData.filter(order => {
            const assignedMachine = order.assigned_machine || '';
            return assignedMachine.includes('Xả 2');
        });
        const xa3Orders = ordersData.filter(order => {
            const assignedMachine = order.assigned_machine || '';
            return assignedMachine.includes('Xả 3');
        });
        const unassignedOrders = ordersData.filter(order => {
            const assignedMachine = order.assigned_machine || '';
            return !assignedMachine.includes('Xả 1') && !assignedMachine.includes('Xả 2') && !assignedMachine.includes('Xả 3');
        });
        
        // Render từng tab
        renderTabTable('xa1TableBody', xa1Orders);
        renderTabTable('xa2TableBody', xa2Orders);
        renderTabTable('xa3TableBody', xa3Orders);
        renderTabTable('allTableBody', ordersData);
        
        // Cập nhật số lượng cho các tab
        updateTabCounts({
            xa1: xa1Orders.length,
            xa2: xa2Orders.length,
            xa3: xa3Orders.length,
            all: ordersData.length
        });
        

    }
    

    
    /**
     * Render bảng cho một tab cụ thể
     */
    function renderTabTable(tableBodyId, orders) {
        const tableBody = document.getElementById(tableBodyId);
        if (!tableBody) {

            return;
        }
        
        // Xóa dữ liệu cũ
        tableBody.innerHTML = '';
        
        // Kiểm tra có dữ liệu không
        if (orders.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="13" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Không có lệnh sản xuất nào
                    </td>
                </tr>
            `;
            return;
        }




        
        const fragment = document.createDocumentFragment();
        
        orders.forEach((order, index) => {
            const row = createOrderTableRow(order, index);
            fragment.appendChild(row);
        });
        
        tableBody.appendChild(fragment);
    }
    
    /**
     * Cập nhật số lượng hiển thị trên các tab
     */
    function updateTabCounts(counts) {
        document.getElementById('xa1-count').textContent = counts.xa1;
        document.getElementById('xa2-count').textContent = counts.xa2;
        document.getElementById('xa3-count').textContent = counts.xa3;
        document.getElementById('all-count').textContent = counts.all;
    }
    
    /**
     * Khởi tạo tab functionality
     */
    function initializeTabs() {
        // Thêm event listeners cho các tab
        const tabs = document.querySelectorAll('#machineTabs .nav-link');
        tabs.forEach(tab => {
            tab.addEventListener('click', function(e) {
                // Cập nhật active state
                tabs.forEach(t => t.classList.remove('active'));
                this.classList.add('active');
                
                // Hiển thị tab content tương ứng
                const targetId = this.getAttribute('data-bs-target');
                const targetContent = document.querySelector(targetId);
                
                if (targetContent) {
                    document.querySelectorAll('.tab-pane').forEach(pane => {
                        pane.classList.remove('show', 'active');
                    });
                    targetContent.classList.add('show', 'active');
                }
                
                // Cập nhật URL hash để bookmark
                window.location.hash = targetId.replace('#', '');
            });
        });
        
        // Khôi phục tab từ URL hash nếu có
        const hash = window.location.hash;
        if (hash) {
            const targetTab = document.querySelector(`[data-bs-target="${hash}"]`);
            if (targetTab) {
                targetTab.click();
            }
        }
    }
    
    /**
     * Lọc dữ liệu theo tab hiện tại
     */
    function filterDataByCurrentTab() {
        const activeTab = document.querySelector('#machineTabs .nav-link.active');
        if (!activeTab) return ordersData;
        
        const tabId = activeTab.id;
        
        switch (tabId) {
            case 'xa1-tab':
                return ordersData.filter(order => {
                    const assignedMachine = order.assigned_machine || '';
                    return assignedMachine.includes('Xả 1');
                });
            case 'xa2-tab':
                return ordersData.filter(order => {
                    const assignedMachine = order.assigned_machine || '';
                    return assignedMachine.includes('Xả 2');
                });
            case 'xa3-tab':
                return ordersData.filter(order => {
                    const assignedMachine = order.assigned_machine || '';
                    return assignedMachine.includes('Xả 3');
                });
            case 'all-tab':
            default:
                return ordersData;
        }
    }
    
    /**
     * Cập nhật hiển thị tab dựa trên filter máy
     */
    function updateTabBasedOnMachineFilter() {
        const machineFilter = document.getElementById('machineFilter');
        if (!machineFilter || !machineFilter.value) return;
        
        const machineValue = machineFilter.value;
        let targetTabId = 'all-tab';
        
        // Kiểm tra máy được chọn và chuyển đến tab tương ứng
        if (machineValue.includes('Xả 1')) {
            targetTabId = 'xa1-tab';
        } else if (machineValue.includes('Xả 2')) {
            targetTabId = 'xa2-tab';
        } else if (machineValue.includes('Xả 3')) {
            targetTabId = 'xa3-tab';
        }
        
        const targetTab = document.getElementById(targetTabId);
        if (targetTab) {
            targetTab.click();
        }
    }
    
    /**
     * Lấy tên máy Xả từ trường assigned_machine
     */
    function getXaMachineFromAssigned(assignedMachine) {
        if (!assignedMachine) return '';
        
        const machines = assignedMachine.split(',').map(m => m.trim());
        const xaMachine = machines.find(machine => 
            machine.includes('Xả 1') || machine.includes('Xả 2') || machine.includes('Xả 3')
        );
        
        return xaMachine || '';
    }
    
    /**
     * Kiểm tra xem assigned_machine có chứa máy Xả nào không
     */
    function hasXaMachine(assignedMachine) {
        if (!assignedMachine) return false;
        
        const machines = assignedMachine.split(',').map(m => m.trim());
        return machines.some(machine => 
            machine.includes('Xả 1') || machine.includes('Xả 2') || machine.includes('Xả 3')
        );
    }

    /**
     * Tạo một dòng trong bảng cho một lệnh sản xuất
     */
    function createOrderTableRow(order, index) {
        const row = document.createElement('tr');
        row.className = 'order-row';
        row.setAttribute('data-order-id', order.id);
        
        // Tính toán trạng thái và tiến độ
        const status = order.xa_status || 'waiting';
        
        // Lấy máy Xả được gán cho lệnh này
        const orderMachine = getOrderMachine(order);
        
        let isDisabled = false;
        let displayReason = '';
        
        if (!orderMachine) {
            // Lệnh không được gán cho máy Xả nào → bị mờ
            isDisabled = true;
            displayReason = 'Lệnh không được gán cho máy Xả';
        } else {
            // Kiểm tra trạng thái máy Xả được gán
            const machineStatus = checkMachineStatus(orderMachine);
            
            if (!machineStatus.isRunning) {
                // Máy Xả đang trống → có thể bắt đầu
                isDisabled = false;
                displayReason = `Máy ${orderMachine} đang trống`;
            } else {
                // Máy Xả đang chạy
                if (machineStatus.runningOrder.current_order_id == order.id) {
                    // Máy đang chạy chính lệnh này → hiển thị bình thường
                    isDisabled = false;
                    displayReason = `Lệnh hiện tại của máy ${orderMachine}`;
                } else {
                    // Máy đang chạy lệnh khác → bị mờ
                    isDisabled = true;
                    displayReason = `Máy ${orderMachine} đang sản xuất lệnh ${machineStatus.runningOrder.current_order_code}`;
                }
            }
        }
        
        // Thêm class tương ứng với trạng thái
        if (isDisabled) {
            row.classList.add('disabled-order');
        } else {
            // Kiểm tra xem lệnh có đang chạy không
            const orderRunningCheck = isOrderRunning(order);
            if (orderRunningCheck.isRunning) {
                // Lệnh đang chạy
                row.classList.add('running-order');
            }
        }
        const inputQty = order.xa_input_quantity || 0;
        const sheet_count = order.sheet_count || 0; // Sửa: lấy số tờ giấy
        const goodQty = order.xa_good_quantity || 0;
        const ngQty = order.xa_ng_quantity || 0;
        const deployedQty = order.deployed_quantity || 0;
        const progressPercent = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
        
        // Xác định icon và màu sắc theo trạng thái
        let statusIcon = 'bi-clock';
        let statusClass = 'text-warning';
        let statusText = 'Chờ xử lý';
        
        switch (status) {
            case 'in_progress':
                statusIcon = 'bi-play-circle';
                statusClass = 'text-primary';
                statusText = 'Đang xử lý';
                break;
            case 'completed':
                statusIcon = 'bi-check-circle';
                statusClass = 'text-success';
                statusText = 'Hoàn thành';
                break;
            case 'paused':
                statusIcon = 'bi-pause-circle';
                statusClass = 'text-warning';
                statusText = 'Tạm dừng';
                break;
        }
        
        // Tạo HTML cho dòng
        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-light text-dark">${index + 1}</span>
            </td>

            <td>
                <div class="d-flex align-items-center">
                    <i class="bi ${statusIcon} ${statusClass} me-2"></i>
                    <div>
                        <div class="fw-bold ${isDisabled ? 'text-muted' : ''}">${order.production_order}</div>
                        <small class="text-muted">${formatDate(order.deployment_date)} - ${order.production_shift}</small>
                        <small class="${isDisabled ? 'text-danger' : 'text-success'} d-block">${displayReason}</small>
                    </div>
                </div>
            </td>
            
            <td class="text-center">
                <span class="fw-bold">${order.order_type || ''}</span>
            </td>
            <td>
                <div>
                    <div class="fw-bold">${order.internal_product_code}</div>
                    <small class="text-muted" title="${order.product_name}">${truncateText(order.product_name, 100)}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">${order.paper_type || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.paper_weight || 0} gsm</span>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(deployedQty)}</div>
                <small class="text-muted">pcs</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary">${formatNumber(sheet_count)}</div>
                <small class="text-muted">tờ giấy</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${formatNumber(order.paper_length || 0)}</div>
                <small class="text-muted">chiều dài</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-danger">${formatNumber(order.paper_width || 0)}</div>
                <small class="text-muted">chiều rộng</small>
            </td>
            <td class="text-center">
                <div class="fw-bold">${formatNumber(order.blank_count || 0)}</div>
                <small class="text-muted">phôi</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-primary'}" 
                         style="width: ${Math.min(progressPercent, 100)}%">
                        ${progressPercent}%
                    </div>
                </div>
                <small class="text-muted">${statusText}</small>
            </td>
            <td class="text-center">
                <small class="text-muted d-block">${order.assigned_machine || 'Chưa gán'}</small>
                <small class="text-muted">${order.xa_worker_name || 'Chưa gán'}</small>
            </td>

        `;
        
        // Add data attribute for order ID
        row.setAttribute('data-order-id', order.id);
        
        // Cho phép click nếu lệnh không bị disable
        if (!isDisabled) {
            row.style.cursor = 'pointer';
            row.onclick = (e) => {
                // Ngăn chặn event bubbling để tránh đóng panel
                e.stopPropagation();
                showOrderDetails(order.id);
            };
        } else {
            row.style.cursor = 'not-allowed';
            row.onclick = (e) => {
                e.stopPropagation();
                showNotification(displayReason, 'warning');
            };
        }
        
        return row;
    }


    
    

 
    


    /**
     * Cập nhật thống kê tổng quan
     */
    function updateStatistics() {
        const totalOrders = ordersData.length;
        const totalPlan = ordersData.reduce((sum, order) => sum + (order.xa_input_quantity || 0), 0);
        const totalGood = ordersData.reduce((sum, order) => sum + (order.xa_good_quantity || 0), 0);
        const totalNg = ordersData.reduce((sum, order) => sum + (order.xa_ng_quantity || 0), 0);
        
        // Cập nhật các thẻ thống kê
        updateElementText('totalOrders', totalOrders);
        updateElementText('totalPlan', formatNumber(totalPlan));
        updateElementText('totalGood', formatNumber(totalGood));
        updateElementText('totalNg', formatNumber(totalNg));
    }

    /**
     * =================================================================
     * XỬ LÝ SỰ KIỆN - EVENT HANDLERS
     * =================================================================
     */


    /**
     * Setup event listeners cho wizard form
     */
    function setupWizardEventListeners() {
        // Event listeners cho các input trong wizard
        const wizardGoodQty = document.getElementById('wizardGoodQty');
        const wizardNgQty = document.getElementById('wizardNgQty');
        const wizardHandoverQty = document.getElementById('wizardHandoverQty');
        
        if (wizardGoodQty) {
            wizardGoodQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardNgQty) {
            wizardNgQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardHandoverQty) {
            wizardHandoverQty.addEventListener('input', function() {
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
    }

    /**
     * Làm mới dữ liệu
     */
    async function refreshData() {
        try {
            showLoading('Đang làm mới dữ liệu...');
            await loadOrdersData();
            renderOrdersTable();
            updateStatistics();
            showNotification('Đã làm mới dữ liệu thành công', 'info');
        } catch (error) {

            showNotification('Lỗi làm mới dữ liệu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Refresh dữ liệu máy và render lại bảng
     */
    async function refreshMachineStatus() {
        try {
            await loadMachineStatus();
            renderOrdersTable();
        } catch (error) {
            console.error('Lỗi khi refresh dữ liệu máy:', error);
        }
    }

    /**
     * Debug function để kiểm tra trạng thái máy và lệnh
     */
    function debugMachineStatus() {
        console.log('=== DEBUG MACHINE STATUS ===');
        console.log('Machine Status Data:', machineStatusData);
        console.log('Orders Data:', ordersData);
        
        console.log('=== DEBUG MACHINE STATUS ===');
        
        // Hiển thị trạng thái từng máy
        ['Xả 1', 'Xả 2', 'Xả 3'].forEach(machineName => {
            const machineStatus = checkMachineStatus(machineName);
            console.log(`${machineName}: ${machineStatus.isRunning ? 'RUNNING' : 'IDLE'} - ${machineStatus.runningOrder ? `Order: ${machineStatus.runningOrder.current_order_code}` : 'No order'}`);
        });
        
        ordersData.forEach((order, index) => {
            const orderMachine = getOrderMachine(order);
            const machineStatus = orderMachine ? checkMachineStatus(orderMachine) : null;
            
            let isDisabled = false;
            let reason = '';
            
            if (!orderMachine) {
                isDisabled = true;
                reason = 'Không được gán máy Xả';
            } else if (machineStatus && machineStatus.isRunning && machineStatus.runningOrder.current_order_id != order.id) {
                isDisabled = true;
                reason = `Máy ${orderMachine} đang chạy lệnh khác`;
            } else if (machineStatus && !machineStatus.isRunning) {
                isDisabled = false;
                reason = `Máy ${orderMachine} đang trống`;
            } else if (machineStatus && machineStatus.isRunning && machineStatus.runningOrder.current_order_id == order.id) {
                isDisabled = false;
                reason = `Đang chạy trên máy ${orderMachine}`;
            }
            
            console.log(`Order ${index + 1}: ${order.production_order} - Assigned Machine: ${order.assigned_machine || 'N/A'} - Xả Machine: ${orderMachine || 'N/A'} - Is Disabled: ${isDisabled} - Reason: ${reason}`);
        });
    }

    /**
     * Xử lý bàn giao đơn lẻ từ XẢ sang XÉN
     */
    async function executeHandoverOnly() {
        if (!currentEditingOrder) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            const handoverData = {
                handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
                handoverPerson: getElementValue('handoverPerson'),
                receiverPerson: getElementValue('receiverPerson'),
                handoverNotes: getElementValue('handoverNotes'),
                confirmHandover: getElementValue('confirmHandover')
            };
            
            // Validate
            if (handoverData.handoverQuantity <= 0) {
                showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
                return;
            }
            
            if (!handoverData.confirmHandover) {
                showNotification('Bạn phải xác nhận đã bàn giao đủ số lượng và chất lượng', 'warning');
                return;
            }
            
            showLoading('Đang bàn giao...');
            
            // Lấy thông tin stage tiếp theo từ workflow
            const nextStage = currentEditingOrder.next_stage;
            if (!nextStage) {
                showNotification('Không xác định được công đoạn tiếp theo', 'error');
                return;
            }
            
            // Chuẩn bị dữ liệu bàn giao
            const handoverWebhookData = {
                order_id: currentEditingOrder.id,
                from_stage: STAGE_CONFIG.KEY,
                to_stage: nextStage,
                quantity: handoverData.handoverQuantity,
                handover_person: handoverData.handoverPerson,
                receiver_person: handoverData.receiverPerson,
                notes: handoverData.handoverNotes,
                handover_date: new Date().toISOString()
            };
            
            // Gửi qua webhook
            const result = await sendWebhook(`handover_${STAGE_CONFIG.KEY}_to_${nextStage}`, handoverWebhookData);
            
            if (result.success) {
                showNotification(`Đã bàn giao ${handoverData.handoverQuantity} sản phẩm cho công đoạn ${getStageDisplayName(nextStage)}`, 'success');
            }
            
            // Refresh dữ liệu và đóng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {

            showNotification('Lỗi bàn giao: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Cập nhật số lượng bàn giao khi thay đổi số lượng OK
     */
    function updateHandoverQuantity() {
        const goodQty = getElementValue('completeGoodQty') || 0;
        setElementValue('handoverQty', goodQty);
    }
    
    /**
     * Alias cho updateHandoverQuantity (được gọi từ HTML)
     */
    function updateHandoverQty() {
        updateHandoverQuantity();
    }

    /**
     * Xử lý hoàn thành công đoạn
     */
    async function completeOrder() {
        if (!currentEditingOrder) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            // Lấy dữ liệu từ form
            const completionData = getCompletionDataFromForm();
            
            // Validate dữ liệu
            if (!validateCompletionData(completionData)) {
                return;
            }
            
            showLoading('Đang xử lý...');
            
            // Luôn thực hiện cả hoàn thành và bàn giao (vì đã gộp chung thành 1 form)
            await handleCompleteAndHandover(completionData);
            
            // Refresh dữ liệu và đóng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {

            showNotification('Lỗi: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Lấy dữ liệu từ form hoàn thành
     */
    function getCompletionDataFromForm() {
        return {
            // Dữ liệu hoàn thành
            goodQuantity: parseInt(getElementValue('completeGoodQty')) || 0,
            ngQuantity: parseInt(getElementValue('completeNgQty')) || 0,
            ngStartEndQuantity: parseInt(getElementValue('completeNgStartEndQty')) || 0,
            returnQuantity: parseInt(getElementValue('completeReturnQty')) || 0,
            machine: getElementValue('completeMachine'),
            shift: getElementValue('completeShift'),
            workerName: getElementValue('completeWorker'),
            notes: getElementValue('completeNote'),
            
            // Dữ liệu bàn giao
            handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
            handoverDate: getElementValue('handoverDate'),
            handoverPerson: getElementValue('handoverPerson'),
            receiverPerson: getElementValue('receiverPerson'),
            handoverNotes: getElementValue('handoverNotes'),
            confirmHandover: getElementValue('confirmHandover')
        };
    }

    /**
     * Validate dữ liệu hoàn thành
     */
    function validateCompletionData(data) {
        // Validate dữ liệu hoàn thành cơ bản
        if (data.goodQuantity + data.ngQuantity === 0) {
            showNotification('Tổng số lượng phải lớn hơn 0', 'error');
            return false;
        }
        
        // Validate dữ liệu bàn giao (luôn kiểm tra vì đã gộp chung form)
        if (data.handoverQuantity <= 0) {
            showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
            return false;
        }
        
        if (!data.confirmHandover) {
            showNotification('Bạn phải xác nhận đã bàn giao đủ số lượng và chất lượng', 'warning');
            return false;
        }
        
        // Kiểm tra số lượng bàn giao không vượt quá số lượng OK
        if (data.handoverQuantity > data.goodQuantity) {
            showNotification('Số lượng bàn giao không thể lớn hơn số lượng OK', 'error');
            return false;
        }
        
        return true;
    }

    /**
     * Xử lý hoàn thành và bàn giao từ XẢ sang stage tiếp theo
     */
    async function handleCompleteAndHandover(data) {
        try {
            const nextStage = currentEditingOrder.next_stage;
            
            if (!nextStage) {
                // Nếu không có stage tiếp theo, chỉ hoàn thành
                return await handleCompleteStageOnly(data);
            }
            
            const completeHandoverData = {
                order_id: currentEditingOrder.id,
                action_type: 'complete_and_handover',
                from_stage: 'xa',
                to_stage: nextStage,
                workflow_definition: currentEditingOrder.workflow_definition,
                
                // Thông tin hoàn thành
                completion: {
                    output_quantity: data.goodQuantity + data.ngQuantity,
                    good_quantity: data.goodQuantity,
                    ng_quantity: data.ngQuantity,
                    worker_name: data.workerName,
                    machine_name: data.machine,
                    shift: data.shift,
                    notes: data.notes
                },
                
                // Thông tin bàn giao
                handover: {
                    handover_quantity: data.handoverQuantity,
                    handover_person: data.handoverPerson,
                    receiver_person: data.receiverPerson,
                    handover_date: data.handoverDate,
                    handover_notes: data.handoverNotes
                },
                
                completed_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook(`complete_xa_and_handover_to_${nextStage}`, completeHandoverData);
            
            if (result.success) {
                const nextStageName = getStageDisplayName(nextStage);
                showNotification(
                    `✅ Đã hoàn thành công đoạn XẢ và bàn giao ${formatNumber(data.handoverQuantity)} sản phẩm cho công đoạn ${nextStageName} thành công!`,
                    'success'
                );
            }
            
        } catch (error) {

            showNotification('Lỗi khi hoàn thành và bàn giao: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * Xử lý chỉ hoàn thành công đoạn
     */
    async function handleCompleteStageOnly(data) {
        try {
            const updateData = {
                order_id: currentEditingOrder.id,
                stage: STAGE_CONFIG.KEY,
                output_quantity: data.goodQuantity + data.ngQuantity,
                good_quantity: data.goodQuantity,
                ng_quantity: data.ngQuantity,
                worker_name: data.workerName,
                machine_name: data.machine,
                shift: data.shift,
                notes: data.notes,
                updated_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook('update_stage_output', updateData);
            
            if (result.success) {
                showNotification(
                    `✅ Đã cập nhật hoàn thành công đoạn XẢ: ${formatNumber(data.goodQuantity + data.ngQuantity)} sản phẩm`,
                    'success'
                );
            }
            
        } catch (error) {

            showNotification('Lỗi khi hoàn thành công đoạn: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * =================================================================
     * WIZARD FUNCTIONS - CÁC HÀM XỬ LÝ WIZARD FORM
     * =================================================================
     */

    let wizardCurrentStep = 1;
    const wizardTotalSteps = 3;

    /**
     * Reset wizard về bước 1
     */
    function resetWizard() {
        wizardCurrentStep = 1;
        updateWizardStepDisplay();
    }

    /**
     * Cập nhật hiển thị bước wizard
     */
    function updateWizardStepDisplay() {
        // Update step indicators
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < wizardCurrentStep) {
                step.classList.add('completed');
            } else if (stepNum === wizardCurrentStep) {
                step.classList.add('active');
            }
        });
        
        // Update step content
        document.querySelectorAll('.step-content').forEach((content, index) => {
            content.classList.remove('active');
            if (index + 1 === wizardCurrentStep) {
                content.classList.add('active');
            }
        });
        
        // Update buttons
        const prevBtn = document.getElementById('wizardPrevBtn');
        const nextBtn = document.getElementById('wizardNextBtn');
        const finishBtn = document.getElementById('wizardFinishBtn');
        
        prevBtn.style.display = wizardCurrentStep > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = wizardCurrentStep < wizardTotalSteps ? 'inline-block' : 'none';
        finishBtn.style.display = wizardCurrentStep === wizardTotalSteps ? 'inline-block' : 'none';
        
        // Update step indicator
        document.getElementById('wizardCurrentStep').textContent = wizardCurrentStep;
        
        // Update handover quantity in step 1
        if (wizardCurrentStep === 1) {
            updateWizardHandoverQuantity();
        }
        
        // Update confirmation data in step 3
        if (wizardCurrentStep === 3) {
            updateWizardConfirmation();
        }
    }

    /**
     * Chuyển đến bước tiếp theo
     */
    function wizardNextStep() {
        if (wizardCurrentStep < wizardTotalSteps) {
            // Validate current step
            if (!validateWizardCurrentStep()) {
                return;
            }
            
            wizardCurrentStep++;
            updateWizardStepDisplay();
        }
    }

    /**
     * Quay lại bước trước
     */
    function wizardPreviousStep() {
        if (wizardCurrentStep > 1) {
            wizardCurrentStep--;
            updateWizardStepDisplay();
        }
    }

    /**
     * Validate bước hiện tại
     */
    function validateWizardCurrentStep() {
        switch (wizardCurrentStep) {
            case 1:
                const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
                const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
                if (goodQty + ngQty === 0) {
                    showNotification('Tổng số lượng phải lớn hơn 0', 'error');
                    return false;
                }
                break;
            case 2:
                const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
                if (handoverQty <= 0) {
                    showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
                    return false;
                }
                break;
        }
        return true;
    }



    /**
     * Cập nhật số lượng bàn giao trong wizard
     */
    function updateWizardHandoverQuantity() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        setElementValue('wizardHandoverQty', goodQty);
    }

    /**
     * Cập nhật dữ liệu xác nhận trong wizard
     */
    function updateWizardConfirmation() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
        const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
        const total = goodQty + ngQty;
        const progress = total > 0 ? Math.round((goodQty / total) * 100) : 0;
        const machine = getElementValue('wizardMachine');
        const worker = getElementValue('wizardWorker');
        const shift = getElementValue('wizardShift');
        const handoverPerson = getElementValue('wizardHandoverPerson');
        const receiverPerson = getElementValue('wizardReceiverPerson');
        const handoverNotes = getElementValue('wizardHandoverNotes');
        
        // Update confirmation data
        updateElementText('confirmOrderCode', getElementValue('wizardOrderCode'));
        updateElementText('confirmProductCode', getElementValue('wizardProductCode'));
        updateElementText('confirmProductName', getElementValue('wizardProductName'));
        updateElementText('confirmPaperType', getElementValue('wizardPaperType'));
        updateElementText('confirmPaperWeight', getElementValue('wizardPaperWeight'));
        updateElementText('confirmQuantity', getElementValue('wizardQuantity'));
        updateElementText('confirmGoodQty', goodQty.toLocaleString());
        updateElementText('confirmNgQty', ngQty.toLocaleString());
        updateElementText('confirmProgress', progress + '%');
        updateElementText('confirmMachine', machine);
        updateElementText('confirmWorker', worker || 'Chưa nhập');
        updateElementText('confirmShift', shift || 'Ca 1');
        updateElementText('confirmHandoverQty', handoverQty.toLocaleString());
        updateElementText('confirmHandoverPerson', handoverPerson || 'Chưa nhập');
        updateElementText('confirmReceiverPerson', receiverPerson || 'Chưa nhập');
        updateElementText('confirmHandoverNotes', handoverNotes || 'Không có');
    }

    /**
     * Hoàn thành wizard
     */
    async function wizardFinish() {
        if (!document.getElementById('wizardConfirmHandover').checked) {
            showNotification('Vui lòng xác nhận đã bàn giao đủ số lượng và chất lượng!', 'error');
            return;
        }
        
        try {
            // Lấy dữ liệu từ wizard form
            const completionData = getWizardCompletionData();
            
            // Validate dữ liệu
            if (!validateWizardCompletionData(completionData)) {
                return;
            }
            
            showLoading('Đang xử lý...');
            
            // Xử lý hoàn thành và bàn giao
            await handleCompleteAndHandover(completionData);
            
            // Refresh dữ liệu và đóng sidebar
            await refreshData();
            
            // Close the sidebar
            closeDetailsPanel();
            
            showNotification('🎉 Hoàn thành! Dữ liệu đã được lưu thành công.', 'success');
            
        } catch (error) {

            showNotification('Lỗi: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Lấy dữ liệu từ wizard form
     */
    function getWizardCompletionData() {
        return {
            // Dữ liệu hoàn thành
            goodQuantity: parseInt(getElementValue('wizardGoodQty')) || 0,
            ngQuantity: parseInt(getElementValue('wizardNgQty')) || 0,
            ngStartEndQuantity: parseInt(getElementValue('wizardNgStartEndQty')) || 0,
            returnQuantity: parseInt(getElementValue('wizardReturnQty')) || 0,
            machine: getElementValue('wizardMachine'),
            shift: getElementValue('wizardShift'),
            workerName: getElementValue('wizardWorker'),
            notes: getElementValue('wizardNote'),
            
            // Dữ liệu bàn giao
            handoverQuantity: parseInt(getElementValue('wizardHandoverQty')) || 0,
            handoverDate: getElementValue('wizardHandoverDate'),
            handoverPerson: getElementValue('wizardHandoverPerson'),
            receiverPerson: getElementValue('wizardReceiverPerson'),
            handoverNotes: getElementValue('wizardHandoverNotes'),
            confirmHandover: getElementValue('wizardConfirmHandover')
        };
    }

    /**
     * Validate dữ liệu hoàn thành từ wizard
     */
    function validateWizardCompletionData(data) {
        // Validate dữ liệu hoàn thành cơ bản
        if (data.goodQuantity + data.ngQuantity === 0) {
            showNotification('Tổng số lượng phải lớn hơn 0', 'error');
            return false;
        }
        
        // Validate dữ liệu bàn giao
        if (data.handoverQuantity <= 0) {
            showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
            return false;
        }
        
        if (!data.confirmHandover) {
            showNotification('Bạn phải xác nhận đã bàn giao đủ số lượng và chất lượng', 'warning');
            return false;
        }
        
        // Kiểm tra số lượng bàn giao không vượt quá số lượng OK
        if (data.handoverQuantity > data.goodQuantity) {
            showNotification('Số lượng bàn giao không thể lớn hơn số lượng OK', 'error');
            return false;
        }
        
        return true;
    }

    /**
     * =================================================================
     * UTILITY FUNCTIONS - CÁC HÀM TIỆN ÍCH
     * =================================================================
     */

    // Hiển thị loading
    function showLoading(message = 'Đang tải...') {
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.style.display = 'flex';
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = message;
        }
    }

    // Ẩn loading  
    function hideLoading() {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.style.display = 'none';
    }

    // Hiển thị thông báo
    function showNotification(message, type = 'success') {
        // Tạo toast notification đơn giản
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Tự động xóa sau 5 giây
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Format số theo định dạng Việt Nam
    function formatNumber(num) {
        if (!num && num !== 0) return '';
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    // Format ngày
    function formatDate(date, format = 'dd/mm/yyyy') {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        
        return format
            .replace('dd', day)
            .replace('mm', month)
            .replace('yyyy', year);
    }

    // Cập nhật text của element
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) element.textContent = text;
    }

    // Set giá trị cho element
    function setElementValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }

    // Lấy giá trị từ element
    function getElementValue(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return '';
        
        if (element.type === 'checkbox') {
            return element.checked;
        } else {
            return element.value;
        }
    }

    // Cắt ngắn text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Chuyển đổi status thành text
    function getStatusText(status) {
        const statusMap = {
            'waiting': 'Chờ xử lý',
            'in_progress': 'Đang xử lý', 
            'completed': 'Hoàn thành',
            'paused': 'Tạm dừng'
        };
        return statusMap[status] || 'Không xác định';
    }

    /**
     * =================================================================
     * SIDEBAR TOGGLE - ĐIỀU KHIỂN SIDEBAR
     * =================================================================
     * Đã được chuyển sang sidebar-generator.js
     */

    /**
     * =================================================================
     * DETAILS PANEL - PANEL CHI TIẾT
     * =================================================================
     */

    function showOrderDetails(orderId) {
        // Tìm order trong cả ordersData và originalOrdersData
        let order = ordersData.find(o => o.id == orderId); // Sử dụng == để so sánh loose
        
        if (!order) {
            order = originalOrdersData.find(o => o.id == orderId);
        }
        
        if (!order) {

            
            // Thử tìm bằng production_order nếu orderId có thể là production_order
            const orderByProductionOrder = ordersData.find(o => o.production_order == orderId);
            if (orderByProductionOrder) {
                order = orderByProductionOrder;
            } else {
                const orderByProductionOrderOriginal = originalOrdersData.find(o => o.production_order == orderId);
                if (orderByProductionOrderOriginal) {
                    order = orderByProductionOrderOriginal;
                } else {
                    return;
                }
            }
        }

        // Update current editing order
        currentEditingOrder = order;
        
        // Chi tiết log để debug thông tin thời gian

        // Cập nhật mã lệnh trong tiêu đề
        const orderCodeBadge = document.getElementById('detailOrderCode');
        if (orderCodeBadge) {
            orderCodeBadge.textContent = order.production_order || `#${order.id}`;
        }

        // Add logging to debug start time

        // Remove previous selection
        const previousSelected = document.querySelector('.table tbody tr.selected');
        if (previousSelected) {
            previousSelected.classList.remove('selected');
        }

        // Add selection to current row
        const currentRow = document.querySelector(`[data-order-id="${orderId}"]`);
        if (currentRow) {
            currentRow.classList.add('selected');
        }

        // Show details panel
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        const detailsContent = document.getElementById('detailsContent');
        
        detailsPanel.classList.add('show');
        contentArea.classList.add('details-open');

        // Populate details content with handover form
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HOÀN THÀNH';
        
        detailsContent.innerHTML = `
            <!-- Action Buttons -->
            <div class="detail-section mb-4">
                <div class="row g-2">
                    <div class="col-6">
                        <button class="btn btn-primary btn-lg w-100" onclick="startProduction()" ${order.xa_status === 'completed' ? 'disabled' : ''}>
                            <i class="bi bi-play-circle me-2"></i>Bắt đầu
                        </button>
                    </div>
                    <div class="col-6">
                        <button class="btn btn-danger btn-lg w-100" onclick="endProduction()" ${order.xa_status === 'not_started' ? 'disabled' : ''}>
                            <i class="bi bi-stop-circle me-2"></i>Kết thúc
                        </button>
                    </div>
                </div>
            </div>

            <!-- Production Time Display -->
            <div class="detail-section mb-3">
                <h6><i class="bi bi-clock me-2"></i>Thời gian sản xuất</h6>
                <div style="border-top: 6px solid #495057!important;border-left: unset!important;" class="alert alert-light">
                    <div class="row">
                        <div style="text-align: center;" class="col-6">
                            <strong>Bắt đầu:</strong><br>
                            <span class="text-primary">${order.xa_start_time ? formatDateTime(order.xa_start_time) : 'Chưa bắt đầu'}</span>
                        
                        </div>
                        <div style="text-align: center;" class="col-6">
                            <strong>Kết thúc:</strong><br>
                            <span class="text-primary">${order.xa_end_time ? formatDateTime(order.xa_end_time) : 'Chưa kết thúc'}</span>
                        </div>
                    </div>
                    ${order.xa_start_time ? `
                        <hr class="my-2">
                        <div class="text-center">
                            <strong>Thời gian ${order.xa_end_time ? 'làm việc' : 'đang chạy'}:</strong><br>
                            <h1 class="${order.xa_end_time ? 'text-success' : 'text-warning'}" id="productionRunningTime">
                                ${order.xa_end_time ? calculateWorkTime(order.xa_start_time, order.xa_end_time) : 'Đang tính...'}
                            </h1>
                        </div>
                    ` : ''}
                </div>
            </div>

    
            <!-- Input Information Alert -->
                <!-- <div class="alert alert-info mb-3">
                <h6><i class="bi bi-info-circle me-2"></i>Thông tin đầu vào</h6>
                <div>
                    <strong>Số lượng cần triển khai:</strong> <span class="text-primary">${formatNumber(order.sheet_count) || 0}</span>
                 tờ</div>
            </div> -->



            <!-- Production Results Form -->
            <div class="detail-section">
                <h6><i class="bi bi-clipboard-check me-2"></i>Kết quả sản xuất</h6>
                
                <div class="form-card">
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label fw-bold text-success mb-0">
                                <i class="bi bi-check-circle me-1"></i>Số lượng đạt (OK) <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="goodQty" value="${order.xa_good_quantity || 0}" min="0">
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label fw-bold text-danger mb-0">
                                <i class="bi bi-x-circle me-1"></i>Số lượng NG <span class="text-danger">*</span>
                            </label>
                            <input type="number" class="form-control" id="ngQty" value="${order.xa_ng_quantity || 0}" min="0">
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label fw-bold mb-0">
                                <i class="bi bi-exclamation-triangle me-1"></i>NG Đầu/Cuối
                            </label>
                            <input type="number" class="form-control" id="ngStartEndQty" value="0" min="0">
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label fw-bold  mb-0">
                                <i class="bi bi-arrow-return-left me-1"></i>Hàng trả
                            </label>
                            <input type="number" class="form-control" id="returnQty" value="0" min="0">
                        </div>

                    </div>
                    

                </div>
            </div>

            <!-- Assigned Machine Information -->
            <div class="detail-section">
                <h6><i class="bi bi-gear-wide-connected me-2"></i>Thông tin máy được gán</h6>
                <div class="alert alert-info">
                    <div class="d-flex align-items-center">
                        <i class="bi bi-info-circle me-2"></i>
                        <div>
                            <strong>Máy được gán:</strong> ${order.assigned_machine || 'Chưa gán máy'}
                            ${order.assigned_machine ? `<br><small class="text-muted">Máy Xả: ${getXaMachineFromAssigned(order.assigned_machine) || 'Không có máy Xả'}</small>` : ''}
                        </div>
                    </div>
                </div>
            </div>

            <!-- Production Information Form -->
            <div class="detail-section">
                <h6><i class="bi bi-person-gear me-2"></i>Thông tin sản xuất</h6>
                
                <div class="form-card">
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label mb-0">
                                <i class="bi bi-gear me-1"></i>Máy sản xuất
                            </label>
                            <select class="form-select" id="machine">
                                <option value="Xả 1" ${getXaMachineFromAssigned(order.assigned_machine) === 'Xả 1' ? 'selected' : ''}>Xả 1</option>
                                <option value="Xả 2" ${getXaMachineFromAssigned(order.assigned_machine) === 'Xả 2' ? 'selected' : ''}>Xả 2</option>
                                <option value="Xả 3" ${getXaMachineFromAssigned(order.assigned_machine) === 'Xả 3' ? 'selected' : ''}>Xả 3</option>
                            </select>
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label mb-0">
                                <i class="bi bi-clock me-1"></i>Ca sản xuất
                            </label>
                            <select class="form-select" id="shift">
                                <option value="Ca 1" ${order.production_shift === 'Ca 1' ? 'selected' : ''}>Ca 1 (6:00-14:00)</option>
                                <option value="Ca 2" ${order.production_shift === 'Ca 2' ? 'selected' : ''}>Ca 2 (14:00-22:00)</option>
                                <option value="Ca 3" ${order.production_shift === 'Ca 3' ? 'selected' : ''}>Ca 3 (22:00-6:00)</option>
                            </select>
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <div class="d-flex align-items-center justify-content-between">
                            <label class="detail-label mb-0">
                                <i class="bi bi-person me-1"></i>Thợ phụ trách
                            </label>
                            <input type="text" class="form-control" id="worker" placeholder="Nhập tên thợ..." value="${order.xa_worker_name || ''}">
                        </div>

                    </div>
                    
                    <div class="form-group">
                        <label class="detail-label">
                            <i class="bi bi-chat-text me-1"></i>Ghi chú sản xuất
                        </label>
                        <textarea class="form-control" id="note" rows="2" placeholder="Ghi chú về quá trình sản xuất, vấn đề kỹ thuật, chất lượng...">${order.xa_note || ''}</textarea>

                    </div>
                </div>
            </div>



            <!-- Handover Form -->
            <div class="detail-section">
                <h6><i class="bi bi-arrow-right-circle me-2"></i>Chuyển giao công đoạn</h6>
                
                ${nextStage ? `
                    <div class="alert alert-warning border-warning">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-exclamation-triangle-fill me-3 fs-4 text-warning"></i>
                            <div>
                                <h6 class="mb-1 fw-bold">Công đoạn tiếp theo: <span class="text-primary">${nextStageName}</span></h6>
                                <p class="mb-0 small">Sản phẩm OK sẽ được chuyển sang công đoạn tiếp theo để tiếp tục xử lý</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="form-card">
                        <div class="form-group">
                            <div class="d-flex align-items-center justify-content-between">
                                <label class="detail-label fw-bold text-warning mb-0">
                                    <i class="bi bi-box-arrow-right me-1"></i>Số lượng chuyển giao <span class="text-danger">*</span>
                                </label>
                                <input type="number" class="form-control" id="handoverQty" value="${order.xa_good_quantity || 0}" min="0" max="${order.xa_good_quantity || 0}">
                            </div>

                        </div>

                        <div class="d-grid gap-2 mt-4">
                            <button class="btn btn-success btn-lg" onclick="sendXaHandoverWebhook()">
                                <i class="bi bi-check-circle me-2"></i>Cập nhật & Chuyển giao
                            </button>
                        </div>
                    </div>
                ` : `
                    <div class="alert alert-info border-info">
                        <div class="d-flex align-items-center">
                            <i class="bi bi-flag-checkered me-3 fs-4 text-info"></i>
                            <div>
                                <h6 class="mb-1 fw-bold">Đây là công đoạn cuối cùng</h6>
                                <p class="mb-0 small">Không có công đoạn tiếp theo để chuyển giao</p>
                            </div>
                        </div>
                    </div>
                `}
            </div>
        `;
        
        // Bắt đầu timer nếu đã có thời gian bắt đầu
        if (order.xa_start_time) {
            // Đợi một chút để đảm bảo DOM đã được render
            setTimeout(() => {
                const timerElement = document.getElementById('productionRunningTime');
                
                if (order.xa_end_time) {
                    // Nếu đã có thời gian kết thúc, chỉ hiển thị thời gian cố định
                    if (timerElement) {
                        const fixedTime = calculateWorkTime(order.xa_start_time, order.xa_end_time);
                        timerElement.textContent = fixedTime;
                    }
                } else {
                    // Nếu chưa có thời gian kết thúc, bắt đầu timer chạy
                    startProductionTimer();
                }
            }, 100);
        } else {
            stopProductionTimer();
        }
    }

    function closeDetailsPanel() {
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        
        detailsPanel.classList.remove('show');
        contentArea.classList.remove('details-open');
        
        // Dừng timer khi đóng panel
        stopProductionTimer();
        
        // Remove selection from table row
        const selectedRow = document.querySelector('.table tbody tr.selected');
        if (selectedRow) {
            selectedRow.classList.remove('selected');
        }
    }



    async function executeHandover() {
        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            // Lấy dữ liệu kết quả sản xuất từ sidebar
            const productionData = {
                goodQuantity: parseInt(getElementValue('goodQty')) || 0,
                ngQuantity: parseInt(getElementValue('ngQty')) || 0,
                ngStartEndQuantity: parseInt(getElementValue('ngStartEndQty')) || 0,
                returnQuantity: parseInt(getElementValue('returnQty')) || 0,
                machine: getElementValue('machine') || '',
                shift: getElementValue('shift') || '',
                workerName: getElementValue('worker') || '',
                notes: getElementValue('note') || ''
            };
            
            // Log để debug
            
            // Validation cơ bản
            if (!productionData.workerName.trim()) {
                showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
                return;
            }
            

            
            // Lấy dữ liệu chuyển giao
            const handoverData = {
                handoverQuantity: parseInt(getElementValue('handoverQty')) || 0
            };
            
            // Validate kết quả sản xuất
            if (productionData.goodQuantity + productionData.ngQuantity === 0) {
                showNotification('Tổng số lượng phải lớn hơn 0', 'error');
                return;
            }
            
            // Validate chuyển giao
            if (handoverData.handoverQuantity <= 0) {
                showNotification('Số lượng chuyển giao phải lớn hơn 0', 'error');
                return;
            }
            
            if (handoverData.handoverQuantity > productionData.goodQuantity) {
                showNotification('Số lượng chuyển giao không thể lớn hơn số lượng OK', 'error');
                return;
            }
            
            showLoading('Đang cập nhật và chuyển giao...');
            
            // Lấy thông tin stage tiếp theo từ workflow
            const nextStage = order.next_stage;
            if (!nextStage) {
                showNotification('Không xác định được công đoạn tiếp theo', 'error');
                return;
            }
            
            // Chuẩn bị dữ liệu gửi lên API
            const completeData = {
                stage: 'xa',
                output_quantity: productionData.goodQuantity + productionData.ngQuantity,
                good_quantity: productionData.goodQuantity,
                ng_quantity: productionData.ngQuantity,
                worker_name: productionData.workerName,
                machine_name: productionData.machine,
                shift: productionData.shift,
                notes: productionData.notes,
                handover_quantity: handoverData.handoverQuantity,
                next_stage: nextStage
            };
            

            
            // Gửi request đến API complete_production
            const response = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/complete_production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(completeData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                const nextStageName = getStageDisplayName(nextStage);
                showNotification(
                    `✅ Đã cập nhật kết quả sản xuất và chuyển giao ${formatNumber(handoverData.handoverQuantity)} sản phẩm cho công đoạn ${nextStageName} thành công!`,
                    'success'
                );
                
                // Refresh dữ liệu và đóng sidebar
                await refreshData();
                closeDetailsPanel();
            } else {
                throw new Error(`API error: ${response.status} - ${result.message || result.error || 'Unknown error'}`);
            }
            
        } catch (error) {

            showNotification('Lỗi khi cập nhật và chuyển giao: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    function getStatusBadgeClass(status) {
        const statusMap = {
            'waiting': 'bg-warning',
            'in_progress': 'bg-primary',
            'completed': 'bg-success',
            'paused': 'bg-secondary'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return 'N/A';
        }
    }

    // Production control functions
    async function startProduction() {
        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            showLoading('Đang bắt đầu sản xuất...');
            
            // Lấy thông tin từ form trong sidebar
            const worker = getElementValue('worker') || '';
            const shift = getElementValue('shift') || '';
            const notes = getElementValue('note') || '';
            
            // Lấy máy được gán thực tế cho lệnh này
            const assignedMachine = getOrderMachine(order);
            if (!assignedMachine) {
                showNotification('⚠️ Lệnh này không được gán cho máy Xả nào', 'warning');
                return;
            }
            
            // Hiển thị thông báo xác nhận máy sẽ được sử dụng
            showNotification(`ℹ️ Sẽ bắt đầu sản xuất trên máy: ${assignedMachine}`, 'info');
            
            // Validation cơ bản
            if (!worker.trim()) {
                showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
                return;
            }
            
            // Chuẩn bị dữ liệu gửi lên API
            const startData = {
                stage: 'xa',
                production_order: order.production_order,
                worker_name: worker,
                machine_name: assignedMachine, // Sử dụng máy được gán thực tế
                shift: shift,
                notes: notes || 'Bắt đầu sản xuất từ giao diện XẢ'
            };
            
            // Gửi request đến API start_production
            const response = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/start_production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(startData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                showNotification('✅ Đã bắt đầu sản xuất thành công!', 'success');
                
                // Nếu API trả về thông tin thời gian bắt đầu, cập nhật vào đối tượng hiện tại
                if (result.start_time || result.xa_start_time) {
                    currentEditingOrder.xa_start_time = result.start_time || result.xa_start_time;
                } else {
                    // Nếu API không trả về thời gian bắt đầu, dùng thời gian hiện tại
                    currentEditingOrder.xa_start_time = new Date().toISOString();
                }
                
                // Cập nhật UI ngay lập tức để hiển thị thời gian bắt đầu
                const startTimeElement = document.querySelector('.detail-section .alert .row .col-6:first-child span');
                if (startTimeElement) {
                    startTimeElement.textContent = formatDateTime(currentEditingOrder.xa_start_time);
                    startTimeElement.classList.add('text-primary');
                }
                
                // Hiển thị đồng hồ thời gian
                const timeDisplayContainer = document.querySelector('.detail-section .alert');
                if (timeDisplayContainer) {
                    // Kiểm tra xem đã có phần hiển thị thời gian chạy chưa
                    let timerSection = timeDisplayContainer.querySelector('.text-center');
                    
                    if (!timerSection) {
                        // Tạo phần hiển thị thời gian chạy nếu chưa có
                        const timerHtml = `
                            <hr class="my-2">
                            <div class="text-center">
                                <strong>Thời gian đang chạy:</strong><br>
                                <span class="text-warning" id="productionRunningTime">Đang tính...</span>
                            </div>
                        `;
                        timeDisplayContainer.insertAdjacentHTML('beforeend', timerHtml);
                    }
                    
                    // Bắt đầu timer ngay lập tức
                    startProductionTimer();
                }
                
                // Refresh dữ liệu từ API
                await refreshData();
                
                // Refresh dữ liệu máy và render lại bảng
                await refreshMachineStatus();
                
                // Refresh sidebar content
                showOrderDetails(order.id);
            } else {
                throw new Error(`API error: ${response.status} - ${result.message || result.error || 'Unknown error'}`);
            }
            
        } catch (error) {

            showNotification('Lỗi khi bắt đầu sản xuất: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }
    
    async function endProduction() {
        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            showLoading('Đang kết thúc sản xuất...');
            
            // Lấy thông tin từ form trong sidebar
            const goodQty = parseInt(getElementValue('goodQty')) || 0;
            const ngQty = parseInt(getElementValue('ngQty')) || 0;
            const handoverQty = parseInt(getElementValue('handoverQty')) || 0;
            const worker = getElementValue('worker') || '';
            const shift = getElementValue('shift') || '';
            const notes = getElementValue('note') || '';
            
            // Lấy máy được gán thực tế cho lệnh này
            const assignedMachine = getOrderMachine(order);
            if (!assignedMachine) {
                showNotification('⚠️ Lệnh này không được gán cho máy Xả nào', 'warning');
                return;
            }
            
            // Validation cơ bản
            if (!worker.trim()) {
                showNotification('⚠️ Vui lòng nhập tên thợ phụ trách trong phần "Thông tin sản xuất"', 'warning');
                return;
            }
            
            if (goodQty <= 0 && ngQty <= 0) {
                showNotification('⚠️ Vui lòng nhập số lượng sản xuất (OK hoặc NG)', 'warning');
                return;
            }
            
            // Hiển thị thông báo xác nhận máy sẽ được sử dụng
            showNotification(`ℹ️ Sẽ kết thúc sản xuất trên máy: ${assignedMachine}`, 'info');
            
            // Chuẩn bị dữ liệu gửi lên API
            const endData = {
                stage: 'xa',
                production_order: order.production_order,
                worker_name: worker,
                machine_name: assignedMachine, // Sử dụng máy được gán thực tế
                shift: shift,
                notes: notes || 'Kết thúc sản xuất từ giao diện XẢ',
                good_quantity: goodQty,
                ng_quantity: ngQty,
                handover_quantity: handoverQty
            };
            
            // Gửi request đến API end_production
            const response = await fetch(`${API_BASE_URL}/data/production_orders/${order.id}/end_production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(endData)
            });
            
            const result = await response.json();
            
            if (response.ok) {
                // Dừng timer khi kết thúc sản xuất
                stopProductionTimer();
                
                showNotification('✅ Đã kết thúc sản xuất thành công!', 'success');
                
                // Cập nhật dữ liệu local nếu cần
                if (result.end_time) {
                    currentEditingOrder.xa_end_time = result.end_time;
                }
                
                await refreshData();
                
                // Refresh dữ liệu máy và render lại bảng
                await refreshMachineStatus();
                
                // Refresh sidebar content
                showOrderDetails(order.id);
            } else {
                throw new Error(`API error: ${response.status} - ${result.message || result.error || 'Unknown error'}`);
            }
            
        } catch (error) {
            showNotification('Lỗi khi kết thúc sản xuất: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    // Utility functions for time display
    function formatDateTime(dateString) {
        if (!dateString) return 'N/A';
        const date = new Date(dateString);
        return date.toLocaleString('vi-VN', {
            year: 'numeric',
            month: '2-digit',
            day: '2-digit',
            hour: '2-digit',
            minute: '2-digit',
            second: '2-digit'
        });
    }
    

    

    
    function formatDateTimeForInput(dateString) {
        if (!dateString) return '';
        const date = new Date(dateString);
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        const hours = String(date.getHours()).padStart(2, '0');
        const minutes = String(date.getMinutes()).padStart(2, '0');
        return `${year}-${month}-${day}T${hours}:${minutes}`;
    }
    
    function calculateWorkTime(startTime, endTime) {
        if (!startTime || !endTime) return 'N/A';
        
        const start = new Date(startTime);
        const end = new Date(endTime);
        const diffMs = end - start;
        
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }

    // Biến để lưu trữ ID của timer
    let productionTimerId = null;
    
    // Hàm tính thời gian đang chạy (từ thời điểm bắt đầu đến hiện tại)
    function calculateRunningTime(startTime, endTime) {
        if (!startTime) return 'N/A';
        
        const start = new Date(startTime);
        const end = endTime ? new Date(endTime) : new Date();
        const diffMs = end - start;
        
        const hours = Math.floor(diffMs / (1000 * 60 * 60));
        const minutes = Math.floor((diffMs % (1000 * 60 * 60)) / (1000 * 60));
        const seconds = Math.floor((diffMs % (1000 * 60)) / 1000);
        
        return `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
    }
    
    // Hàm cập nhật thời gian chạy trong giao diện
    function updateRunningTimer() {
        const timerElement = document.getElementById('productionRunningTime');
        
        if (timerElement && currentEditingOrder && currentEditingOrder.xa_start_time) {
            const time = calculateRunningTime(currentEditingOrder.xa_start_time, currentEditingOrder.xa_end_time);
            timerElement.textContent = time;
        } else {
            // Timer update logging removed
        }
    }
    
    // Hàm bắt đầu timer
    function startProductionTimer() {
        // Xóa timer cũ nếu có
        stopProductionTimer();
        
        // Log order information for debugging
        if (currentEditingOrder) {
            // Current order timing info logging removed
        }
        
        // Bắt đầu timer mới, cập nhật mỗi giây
        updateRunningTimer();
        productionTimerId = setInterval(updateRunningTimer, 1000);
    }
    
    // Hàm dừng timer
    function stopProductionTimer() {
        if (productionTimerId) {
            clearInterval(productionTimerId);
            productionTimerId = null;
        }
    }

    // Export functions for global access
    window.refreshData = refreshData;

    
    window.executeHandoverOnly = executeHandoverOnly;
    window.completeOrder = completeOrder;
    window.updateHandoverQuantity = updateHandoverQuantity;
    
    // Filter functions
    window.applyFilters = applyFilters;
    window.clearFilters = clearFilters;
    
    // Wizard functions
    window.wizardNextStep = wizardNextStep;
    window.wizardPreviousStep = wizardPreviousStep;
    window.wizardFinish = wizardFinish;
    window.updateWizardHandoverQuantity = updateWizardHandoverQuantity;
    
    // Details panel functions
    window.showOrderDetails = showOrderDetails;
    window.closeDetailsPanel = closeDetailsPanel;
    window.executeHandover = executeHandover;
    window.startProduction = startProduction;
    window.endProduction = endProduction;

    





    // Add click outside listener to close details panel
    document.addEventListener('click', function(e) {
        const detailsPanel = document.getElementById('detailsPanel');
        
        // Kiểm tra xem click có phải vào table row không
        const clickedRow = e.target.closest('tr.order-row');
        if (clickedRow) {
            // Nếu click vào table row, không đóng panel
            return;
        }
        
        // Kiểm tra xem click có phải vào tab content không
        const clickedTabContent = e.target.closest('.tab-content');
        if (clickedTabContent) {
            // Nếu click vào tab content, không đóng panel
            return;
        }
        
        // Kiểm tra xem click có phải vào tab navigation không
        const clickedTabNav = e.target.closest('#machineTabs');
        if (clickedTabNav) {
            // Nếu click vào tab navigation, không đóng panel
            return;
        }
        
        // Kiểm tra xem click có phải vào table container không
        const tableContainer = document.querySelector('.table-container');
        const tabContent = document.querySelector('.tab-content');
        
        // Debug: Log click events (chỉ khi cần thiết)
        // console.log('Click detected:', e.target);
        // console.log('Details panel open:', detailsPanel.classList.contains('show'));
        // console.log('Clicked inside details panel:', detailsPanel.contains(e.target));
        // console.log('Clicked inside table container:', tableContainer && tableContainer.contains(e.target));
        // console.log('Clicked inside tab content:', tabContent && tabContent.contains(e.target));
        
        // If details panel is open and click is outside table and details panel
        if (detailsPanel.classList.contains('show') && 
            !detailsPanel.contains(e.target) && 
            !(tableContainer && tableContainer.contains(e.target)) &&
            !(tabContent && tabContent.contains(e.target))) {
    
            closeDetailsPanel();
        }
    });

    /**
     * =================================================================
     * FILTER FUNCTIONS - HÀM LỌC DỮ LIỆU
     * =================================================================
     */

    // Biến lưu trữ dữ liệu gốc và dữ liệu đã lọc
    let originalOrdersData = [];
    let filteredOrdersData = [];

    /**
     * Áp dụng các bộ lọc
     */
    function applyFilters() {
        const dateFilter = document.getElementById('dateFilter').value;
        const shiftFilter = document.getElementById('shiftFilter').value;
        const machineFilter = document.getElementById('machineFilter').value;
        const searchInput = document.getElementById('searchInput').value.toLowerCase();



        // Lọc dữ liệu
        filteredOrdersData = originalOrdersData.filter(order => {
            // Lọc theo ngày sản xuất
            if (dateFilter) {
                const orderDate = order.xa_production_date;
                if (!orderDate || orderDate !== dateFilter) {
                    return false;
                }
            }

            // Lọc theo ca
            if (shiftFilter) {
                const orderShift = order.xa_shift;
                if (!orderShift || orderShift !== shiftFilter) {
                    return false;
                }
            }

            // Lọc theo máy
            if (machineFilter) {
                const assignedMachine = order.assigned_machine || '';
                if (!assignedMachine.includes(machineFilter)) {
                    return false;
                }
            }

            // Lọc theo tìm kiếm
            if (searchInput) {
                const searchFields = [
                    order.order_type,
                    order.production_order,
                    order.internal_product_code,
                    order.paper_type,
                    order.assigned_machine,
                    order.xa_worker_name
                ].map(field => (field || '').toLowerCase());

                const hasMatch = searchFields.some(field => field.includes(searchInput));
                if (!hasMatch) {
                    return false;
                }
            }

            return true;
        });



        // Cập nhật dữ liệu hiển thị
        ordersData = filteredOrdersData;
        
        // Render lại bảng
        renderOrdersTable();
        updateStatistics();
        
        // Hiển thị thông báo
        if (filteredOrdersData.length === 0) {
            showNotification('Không tìm thấy dữ liệu phù hợp với bộ lọc', 'warning');
        } else {
            showNotification(`Đã lọc: ${filteredOrdersData.length} lệnh sản xuất`, 'info');
        }
    }

    /**
     * Xóa tất cả bộ lọc
     */
    function clearFilters() {
        document.getElementById('dateFilter').value = '';
        document.getElementById('shiftFilter').value = '';
        document.getElementById('machineFilter').value = '';
        document.getElementById('searchInput').value = '';

        // Khôi phục dữ liệu gốc
        ordersData = [...originalOrdersData];
        
        // Chuyển về tab "Tất cả" khi xóa filter
        const allTab = document.getElementById('all-tab');
        if (allTab) {
            allTab.click();
        }
        
        // Render lại bảng
        renderOrdersTable();
        updateStatistics();
        
        showNotification('Đã xóa tất cả bộ lọc', 'info');
    }

    /**
     * Tự động lọc khi nhập tìm kiếm (debounce)
     */
    let searchTimeout;
    function setupSearchDebounce() {
        const searchInput = document.getElementById('searchInput');
        if (searchInput) {
            searchInput.addEventListener('input', function() {
                clearTimeout(searchTimeout);
                searchTimeout = setTimeout(() => {
                    applyFilters();
                }, 300); // Delay 300ms
            });
        }
    }

    /**
     * Tự động lọc khi thay đổi bộ lọc
     */
    function setupFilterChangeListeners() {
        const dateFilter = document.getElementById('dateFilter');
        const shiftFilter = document.getElementById('shiftFilter');
        const machineFilter = document.getElementById('machineFilter');

        if (dateFilter) {
            dateFilter.addEventListener('change', applyFilters);
        }
        if (shiftFilter) {
            shiftFilter.addEventListener('change', applyFilters);
        }
        if (machineFilter) {
            machineFilter.addEventListener('change', function() {
                applyFilters();
                // Tự động chuyển tab khi chọn máy cụ thể
                updateTabBasedOnMachineFilter();
            });
        }
    }

    /**
     * Cập nhật danh sách máy từ dữ liệu thực tế
     */
    function updateMachineFilterOptions() {
        const machineFilter = document.getElementById('machineFilter');
        if (!machineFilter) return;

        // Lấy danh sách máy từ trường assigned_machine
        const allMachines = [];
        originalOrdersData.forEach(order => {
            const assignedMachine = order.assigned_machine || '';
            if (assignedMachine.trim() !== '') {
                // Tách các máy bằng dấu phẩy và thêm vào danh sách
                const machines = assignedMachine.split(',').map(m => m.trim());
                allMachines.push(...machines);
            }
        });

        // Lọc ra các máy Xả và loại bỏ trùng lặp
        const xaMachines = [...new Set(allMachines.filter(machine => 
            machine.includes('Xả') && (machine.includes('Xả 1') || machine.includes('Xả 2') || machine.includes('Xả 3'))
        ))];

        // Xóa options cũ (giữ lại option "Tất cả")
        machineFilter.innerHTML = '<option value="">Tất cả</option>';

        // Thêm options mới
        xaMachines.sort().forEach(machine => {
            const option = document.createElement('option');
            option.value = machine;
            option.textContent = machine;
            machineFilter.appendChild(option);
        });


    }

    // Thêm hàm mới để gửi dữ liệu chuyển giao qua webhook n8n
    async function sendXaHandoverWebhook() {
        const order = currentEditingOrder;
        if (!order) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            // Lấy dữ liệu đầu vào
            const goodQuantity = parseInt(getElementValue('goodQty')) || 0;
            const ngQuantity = parseInt(getElementValue('ngQty')) || 0;
            const handoverQuantity = parseInt(getElementValue('handoverQty')) || 0;
            
            // Validation cơ bản
            if (goodQuantity + ngQuantity <= 0) {
                showNotification('Tổng số lượng phải lớn hơn 0', 'error');
                return;
            }
            
            if (handoverQuantity <= 0) {
                showNotification('Số lượng chuyển giao phải lớn hơn 0', 'error');
                return;
            }
            
            if (handoverQuantity > goodQuantity) {
                showNotification('Số lượng chuyển giao không thể lớn hơn số lượng OK', 'error');
                return;
            }
            
            const nextStage = order.next_stage;
            if (!nextStage) {
                showNotification('Không xác định được công đoạn tiếp theo', 'error');
                return;
            }
            
            // Hiển thị loading
            showLoading('Đang gửi dữ liệu qua webhook n8n...');
            
            // Tạo dữ liệu webhook
            const webhookData = {
                order_id: order.id,
                production_order: order.production_order,
                stage: 'xa',
                next_stage: nextStage,
                workflow_definition: order.workflow_definition,
                good_quantity: goodQuantity,
                ng_quantity: ngQuantity,
                handover_quantity: handoverQuantity,
                timestamp: new Date().toISOString()
            };
            

            
            // Gửi webhook
            const response = await fetch(`${WEBHOOK_BASE_URL}/production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    action: 'xa_handover',
                    data: webhookData,
                    source: 'xa_stage_frontend',
                    timestamp: new Date().toISOString()
                })
            });
            
            if (!response.ok) {
                throw new Error(`Webhook failed with status: ${response.status}`);
            }
            
            const result = await response.json();
            
            // Thông báo thành công
            const nextStageName = getStageDisplayName(nextStage);
            showNotification(`✅ Đã chuyển giao ${formatNumber(handoverQuantity)} sản phẩm sang công đoạn ${nextStageName}!`, 'success');
            
            // Refresh dữ liệu
            await refreshData();
            
            // Đóng sidebar
            closeDetailsPanel();
            
        } catch (error) {

            showNotification('Lỗi khi gửi dữ liệu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

  </script>
  

  
  <!-- Details Panel -->
  <div class="details-panel" id="detailsPanel">
    <div class="details-header">
      <h5 class="mb-0">
        <i class="bi bi-info-circle me-2"></i>
        Báo cáo lệnh: <span id="detailOrderCode"></span>
      </h5>
      <button type="button" class="detail-close" onclick="closeDetailsPanel()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="details-content" id="detailsContent">
      <!-- Details will be loaded here -->
    </div>
  </div>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Đang tải dữ liệu từ API...</div>
    </div>
  </div>
</body>
</html>
