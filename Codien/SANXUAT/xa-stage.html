<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công đoạn XẢ - Carton Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">    <link rel="stylesheet" href="universal-stage.css">
  <style>
    /* Đảm bảo modal hiển thị đúng và ở giữa màn hình */
    .modal {
      z-index: 1050 !important;
    }
    
    .modal-backdrop {
      z-index: 1040 !important;
    }
    
    .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1.75rem auto;
    }
    
    .modal-content {
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    
    /* Đảm bảo các tab hiển thị đúng */
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom-color: transparent;
    }
    
    /* Cải thiện hiển thị của form */
    .form-control, .form-select {
      margin-bottom: 0.5rem;
      border-radius: 6px;
    }
    
    /* Tạo khoảng cách rõ ràng giữa các phần của form */
    .form-label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    /* Làm nổi bật thông tin quan trọng */
    .alert {
      border-radius: 6px;
    }
    
    /* Đảm bảo modal không bị tràn màn hình trên thiết bị di động */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 0.5rem;
        max-width: 95%;
      }
      
      .modal-dialog-centered {
        min-height: calc(100% - 1rem);
      }
    }
    
    /* Fix cho nút đóng trên modal header */
    .modal-header .btn-close {
      padding: 0.5rem;
      margin: -0.5rem -0.5rem -0.5rem auto;
    }
    
    /* Hiệu ứng hover cho các nút */
    .btn {
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
    }
    
    /* Animation styles cho notification */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

  </style>
</head>
<body data-stage="xa">
  
  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="bg-primary text-white rounded d-flex align-items-center justify-content-center" style="width:32px;height:32px;">
            <i class="bi bi-box"></i>
          </div>
          <h5 class="mb-0 text-primary">Carton Manager</h5>
        </div>
        <button class="btn btn-primary sidebar-toggle" onclick="toggleSidebar()" id="toggleBtn" title="Thu nhỏ/Mở rộng">
          <span id="toggleIcon"><i class="bi bi-chevron-right"></i></span>
        </button>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-link">
          <i class="bi bi-house"></i>
          <span class="nav-text">Trang chủ</span>
        </a>
        <a href="production-orders.html" class="nav-link">
          <i class="bi bi-clipboard-data"></i>
          <span class="nav-text">Lệnh sản xuất</span>
        </a>
        <a href="progress.html" class="nav-link">
          <i class="bi bi-lightning"></i>
          <span class="nav-text">Quản lý tiến độ</span>
        </a>
        <a href="materials.html" class="nav-link">
          <i class="bi bi-box-seam"></i>
          <span class="nav-text">Vật tư</span>
        </a>
        <a href="workflow.html" class="nav-link">
          <i class="bi bi-arrow-repeat"></i>
          <span class="nav-text">Công đoạn</span>
        </a>
        <a href="reports.html" class="nav-link">
          <i class="bi bi-graph-up"></i>
          <span class="nav-text">Báo cáo</span>
        </a>
        <a href="xa-stage.html" class="nav-link active">
          <i class="bi bi-bullseye"></i>
          <span class="nav-text">Công đoạn XẢ</span>
        </a>
        <a href="xen-stage.html" class="nav-link">
          <i class="bi bi-scissors"></i>
          <span class="nav-text">Công đoạn XÉN</span>
        </a>
        <a href="in-stage.html" class="nav-link">
          <i class="bi bi-printer"></i>
          <span class="nav-text">Công đoạn IN</span>
        </a>
        <a href="boi-stage.html" class="nav-link">
          <i class="bi bi-file-text"></i>
          <span class="nav-text">Công đoạn BỒI</span>
        </a>
        <a href="be-stage.html" class="nav-link">
          <i class="bi bi-knife"></i>
          <span class="nav-text">Công đoạn BẾ</span>
        </a>
        <a href="dan-stage.html" class="nav-link">
          <i class="bi bi-link"></i>
          <span class="nav-text">Công đoạn DÁN</span>
        </a>
        <a href="kho-stage.html" class="nav-link">
          <i class="bi bi-building"></i>
          <span class="nav-text">KHO THÀNH PHẨM</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        © 2025 Carton Manager
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content sidebar-collapsed" id="mainContent">
    <div class="container-fluid p-4">
      
      <!-- Stage Header -->
      <div class="stage-header">
        <h1>
          <i class="bi bi-bullseye me-2 text-primary"></i>
          Công đoạn XẢ
        </h1>
        <p class="mb-0">Xả giấy cuộn - Quản lý chi tiết sản xuất</p>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4" id="stageStats">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Tổng lệnh</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalPlan">0</div>
            <div class="stat-label">SL Kế hoạch</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalGood">0</div>
            <div class="stat-label">SL Đạt</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalNg">0</div>
            <div class="stat-label">SL NG</div>
          </div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Danh sách lệnh sản xuất - Công đoạn Xả</h5>
          <div>
            <button class="btn btn-primary me-2" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
            </button>
            <button class="btn btn-success" onclick="showNewOrderForm()">
              <i class="bi bi-plus-lg me-1"></i>Thêm mới
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Ngày sản xuất:</label>
              <input type="date" class="form-control" id="dateFilter">
            </div>
            <div class="col-md-2">
              <label class="form-label">Ca:</label>
              <select class="form-select" id="shiftFilter">
                <option value="">Tất cả</option>
                <option value="Ca 1">Ca 1</option>
                <option value="Ca 2">Ca 2</option>
                <option value="Ca 3">Ca 3</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Máy:</label>
              <select class="form-select" id="machineFilter">
                <option value="">Tất cả</option>
                <option value="Xả 1">Xả 1</option>
                <option value="Xả 2">Xả 2</option>
                <option value="Xả 3">Xả 3</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Tìm kiếm:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã lệnh, sản phẩm...">
                <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Table -->
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th width="50">#</th>
                  <th width="150">Lệnh SX</th>
                  <th width="200">Sản phẩm</th>
                  <th width="80">Loại giấy</th>
                  <th width="80">Định lượng</th>
                  <th width="100">KH</th>
                  <th width="100">Đầu vào</th>
                  <th width="100">OK</th>
                  <th width="100">NG</th>
                  <th width="120">Tiến độ</th>
                  <th width="120">Máy/Thợ</th>
                  <th width="150">Thao tác</th>
                </tr>
              </thead>
              <tbody id="stageTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Order Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Thêm lệnh sản xuất mới - Công đoạn Xả</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="orderForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã lệnh sản xuất *</label>
                <input type="text" class="form-control" id="orderCode" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Mã sản phẩm *</label>
                <input type="text" class="form-control" id="productCode" required>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Tên sản phẩm *</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Loại giấy *</label>
                <select class="form-select" id="paperType" required>
                  <option value="">Chọn loại giấy</option>
                  <option value="BC">BC</option>
                  <option value="CC">CC</option>
                  <option value="WF">WF</option>
                  <option value="OF">OF</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Định lượng (gsm) *</label>
                <input type="number" class="form-control" id="paperWeight" required min="100" max="1000">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Khổ tờ</label>
                <input type="text" class="form-control" id="sheetSize" placeholder="VD: 1020x720mm">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Số lượng kế hoạch *</label>
                <input type="number" class="form-control" id="planQty" required min="1">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Ca sản xuất</label>
                <select class="form-select" id="shift">
                  <option value="Ca 1">Ca 1</option>
                  <option value="Ca 2">Ca 2</option>
                  <option value="Ca 3">Ca 3</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Máy xả</label>
                <select class="form-select" id="machine">
                  <option value="Xả 1">Xả 1</option>
                  <option value="Xả 2">Xả 2</option>
                  <option value="Xả 3">Xả 3</option>
                </select>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Ghi chú</label>
                <textarea class="form-control" id="orderNote" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-primary" onclick="saveOrder()">Lưu</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal hoàn thành công đoạn -->
  <div class="modal fade" id="completeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <h5 class="modal-title">
            <i class="bi bi-check-circle me-2"></i>
            Hoàn thành công đoạn XẢ
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="completeStageForm">
            <input type="hidden" id="completeOrderId">
            
            <!-- Order Info -->
            <div class="row mb-3">
              <div class="col-md-6">
                <strong>Mã lệnh:</strong> <span id="completeOrderCode"></span>
              </div>
              <div class="col-md-6">
                <strong>Sản phẩm:</strong> <span id="completeProductName"></span>
              </div>
            </div>
            
            <!-- Current Stage Info -->
            <div class="alert alert-info">
              <h6><i class="bi bi-info-circle me-2"></i>Thông tin đầu vào:</h6>
              <div class="row">
                <div class="col-md-4">
                  <strong>Số lượng kế hoạch:</strong> <span id="completeQuantity" class="text-primary">0</span>
                </div>
                <div class="col-md-4">
                  <strong>Loại giấy:</strong> <span id="completePaperType"></span>
                </div>
                <div class="col-md-4">
                  <strong>Định lượng:</strong> <span id="completePaperWeight"></span>
                </div>
              </div>
            </div>
            
            <!-- Section 1: Production Results -->
            <div class="border rounded p-3 mb-4 bg-light">
              <h6 class="text-primary mb-3">
                <i class="bi bi-gear me-2"></i>1. Kết quả sản xuất
              </h6>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Số lượng đạt (OK) *</label>
                  <input type="number" class="form-control" id="completeGoodQty" required min="0" onchange="updateHandoverQty()">
                  <div class="form-text">Số lượng tờ giấy đạt chất lượng</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Số lượng NG *</label>
                  <input type="number" class="form-control" id="completeNgQty" required min="0">
                  <div class="form-text">Số lượng tờ giấy không đạt chất lượng</div>
                </div>
              </div>
              
              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">NG Đầu/Cuối</label>
                  <input type="number" class="form-control" id="completeNgStartEndQty" min="0">
                  <div class="form-text">Số lượng NG do setup máy</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Hàng trả</label>
                  <input type="number" class="form-control" id="completeReturnQty" min="0">
                  <div class="form-text">Số lượng hàng trả lại</div>
                </div>
              </div>
            </div>
            
            <!-- Section 2: Production Information -->
            <div class="border rounded p-3 mb-4 bg-light">
              <h6 class="text-primary mb-3">
                <i class="bi bi-person-gear me-2"></i>2. Thông tin sản xuất
              </h6>
              
              <div class="row">
                <div class="col-md-4 mb-3">
                  <label class="form-label">Máy sản xuất</label>
                  <select class="form-select" id="completeMachine">
                    <option value="Xả 1">Xả 1</option>
                    <option value="Xả 2">Xả 2</option>
                    <option value="Xả 3">Xả 3</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Ca sản xuất</label>
                  <select class="form-select" id="completeShift">
                    <option value="Ca 1">Ca 1 (6:00-14:00)</option>
                    <option value="Ca 2">Ca 2 (14:00-22:00)</option>
                    <option value="Ca 3">Ca 3 (22:00-6:00)</option>
                  </select>
                </div>
                <div class="col-md-4 mb-3">
                  <label class="form-label">Thợ phụ trách</label>
                  <input type="text" class="form-control" id="completeWorker">
                </div>
              </div>
              
              <div class="mb-3">
                <label class="form-label">Ghi chú sản xuất</label>
                <textarea class="form-control" id="completeNote" rows="2" placeholder="Ghi chú về quá trình sản xuất..."></textarea>
              </div>
            </div>
            
            <!-- Section 3: Handover Information -->
            <div class="border rounded p-3 mb-3 bg-success bg-opacity-10">
              <h6 class="text-success mb-3">
                <i class="bi bi-arrow-right-circle me-2"></i>3. Bàn giao công đoạn tiếp theo
              </h6>
              
              <!-- Next Stage Info Alert -->
              <div class="alert alert-warning mb-3">
                <h6><i class="bi bi-arrow-right me-2"></i>Công đoạn tiếp theo:</h6>
                <p class="mb-1" id="nextStageInfo">Sau khi hoàn thành, sản phẩm OK sẽ được chuyển sang công đoạn tiếp theo</p>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Số lượng bàn giao: <span class="text-danger">*</span></label>
                  <input type="number" class="form-control" id="handoverQty" min="0" readonly>
                  <div class="form-text">Tự động = Số lượng OK (có thể chỉnh sửa nếu cần)</div>
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Ngày bàn giao:</label>
                  <input type="date" class="form-control" id="handoverDate">
                </div>
              </div>

              <div class="row">
                <div class="col-md-6 mb-3">
                  <label class="form-label">Người bàn giao:</label>
                  <input type="text" class="form-control" id="handoverPerson" placeholder="Nhập tên người bàn giao">
                </div>
                <div class="col-md-6 mb-3">
                  <label class="form-label">Người nhận:</label>
                  <input type="text" class="form-control" id="receiverPerson" placeholder="Nhập tên người nhận">
                </div>
              </div>

              <div class="mb-3">
                <label class="form-label">Ghi chú bàn giao:</label>
                <textarea class="form-control" id="handoverNotes" rows="2" placeholder="Ghi chú về bàn giao sản phẩm..."></textarea>
              </div>

              <div class="alert alert-secondary">
                <div class="form-check">
                  <input class="form-check-input" type="checkbox" id="confirmHandover">
                  <label class="form-check-label" for="confirmHandover">
                    Tôi xác nhận đã bàn giao đủ số lượng và chất lượng cho công đoạn tiếp theo
                  </label>
                </div>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-success" onclick="completeOrder()">
            <i class="bi bi-check-lg me-1"></i>Hoàn thành & Bàn giao
          </button>
        </div>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * =================================================================
     * XẢ STAGE MANAGEMENT - QUẢN LÝ CÔNG ĐOẠN XẢ
     * =================================================================
     * Chức năng chính:
     * 1. Hiển thị danh sách lệnh sản xuất ở công đoạn XẢ
     * 2. Hoàn thành công đoạn XẢ (cập nhật số lượng OK, NG)
     * 3. Bàn giao sang công đoạn tiếp theo theo workflow_definition
     */

    // === CẤU HÌNH API & WEBHOOK ===
    const API_BASE_URL = 'https://autoslp.duckdns.org/api';
    const WEBHOOK_BASE_URL = 'https://autoslp.duckdns.org:5678/webhook';

    // === CẤU HÌNH CÔNG ĐOẠN ===
    const STAGE_CONFIG = {
        KEY: 'xa',           // Tên key trong database
        NAME: 'XẢ',          // Tên hiển thị
        NEXT_STAGE: null     // Sẽ được xác định từ workflow_definition
    };

    // === BIẾN GLOBAL ===
    let ordersData = [];        // Dữ liệu lệnh sản xuất
    let currentEditingOrder = null;  // Đơn hàng đang chỉnh sửa

    /**
     * =================================================================
     * WORKFLOW FUNCTIONS - HÀM XỬ LÝ WORKFLOW
     * =================================================================
     */

    /**
     * Lấy stage tiếp theo từ workflow definition
     * @param {string} workflowDef - Workflow definition (VD: "xa,xen,in" hoặc "xa,in_offset")
     * @param {string} currentStage - Stage hiện tại
     * @returns {string|null} Stage tiếp theo hoặc null nếu là stage cuối
     */
    function getNextStageFromWorkflow(workflowDef, currentStage) {
        console.log(`[WORKFLOW DEBUG] Processing workflow: "${workflowDef}", current stage: "${currentStage}"`);
        
        if (!workflowDef) {
            console.log(`[WORKFLOW DEBUG] No workflow definition found, returning null`);
            return null;
        }
        
        const stages = workflowDef.split(',').map(s => s.trim());
        console.log(`[WORKFLOW DEBUG] Parsed stages:`, stages);
        
        const currentIndex = stages.indexOf(currentStage);
        console.log(`[WORKFLOW DEBUG] Current stage "${currentStage}" found at index: ${currentIndex}`);
        
        if (currentIndex === -1 || currentIndex >= stages.length - 1) {
            console.log(`[WORKFLOW DEBUG] Stage not found or is last stage, returning null`);
            return null; // Không tìm thấy hoặc đã là stage cuối
        }
        
        const nextStage = stages[currentIndex + 1];
        console.log(`[WORKFLOW DEBUG] Next stage determined: "${nextStage}"`);
        return nextStage;
    }

    /**
     * Lấy tên hiển thị của stage
     * @param {string} stageKey - Key của stage
     * @returns {string} Tên hiển thị
     */
    function getStageDisplayName(stageKey) {
        const stageNames = {
            'xa': 'XẢ',
            'xen': 'XÉN', 
            'in_offset': 'IN OFFSET',
            'boi': 'BỒI',
            'be': 'BẾ',
            'dan': 'DÁN',
            'kho': 'KHO'
        };
        
        return stageNames[stageKey] || stageKey.toUpperCase();
    }

    /**
     * Lấy màu sắc theo stage
     * @param {string} stageKey - Key của stage
     * @returns {string} CSS class màu sắc
     */
    function getStageColor(stageKey) {
        const stageColors = {
            'xa': 'primary',
            'xen': 'success',
            'in_offset': 'purple',
            'boi': 'warning',
            'be': 'danger',
            'dan': 'dark',
            'kho': 'secondary'
        };
        
        return stageColors[stageKey] || 'secondary';
    }

    /**
     * =================================================================
     * WEBHOOK FUNCTIONS - HÀM GỬI DỮ LIỆU QUA WEBHOOK
     * =================================================================
     */

    /**
     * Gửi dữ liệu qua webhook n8n
     * @param {string} action - Loại hành động
     * @param {Object} data - Dữ liệu gửi đi
     * @returns {Promise<Object>} Kết quả gửi webhook
     */
    async function sendWebhook(action, data) {
        try {
            const payload = {
                action: action,
                timestamp: new Date().toISOString(),
                source: 'xa_stage_frontend',
                data: data
            };

            console.log(`Sending webhook for action: ${action}`, payload);

            const response = await fetch(`${WEBHOOK_BASE_URL}/production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }

            const result = await response.json();
            console.log('Webhook response:', result);
            
            return {
                success: true,
                message: 'Dữ liệu đã được gửi qua webhook thành công',
                webhook_response: result
            };

        } catch (error) {
            console.error('Error sending webhook:', error);
            
            // Fallback: Lưu vào localStorage để retry sau
            saveToLocalStorage(action, data);
            
            return {
                success: true,
                message: 'Đã lưu dữ liệu local (sẽ đồng bộ khi có kết nối)',
                local_only: true
            };
        }
    }

    /**
     * Lưu dữ liệu vào localStorage để retry sau
     */
    function saveToLocalStorage(action, data) {
        try {
            const key = 'pending_webhooks_xa';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            
            existing.push({
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(key, JSON.stringify(existing));
            console.log('Data saved to localStorage for later sync');
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }

    /**
     * Đồng bộ dữ liệu đã lưu trong localStorage
     */
    async function syncPendingData() {
        try {
            const key = 'pending_webhooks_xa';
            const pending = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (pending.length === 0) return;
            
            console.log(`Syncing ${pending.length} pending webhooks...`);
            
            for (const item of pending) {
                await sendWebhook(item.action, item.data);
            }
            
            // Xóa dữ liệu đã sync
            localStorage.removeItem(key);
            showNotification('Đã đồng bộ dữ liệu thành công', 'success');
            
        } catch (error) {
            console.error('Error syncing pending data:', error);
        }
    }

    /**
     * =================================================================
     * KHỞI TẠO TRANG - PAGE INITIALIZATION
     * =================================================================
     */
    
    // Khởi tạo khi trang được load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== XẢ STAGE PAGE LOADED ===');
        initializePage();
    });

    /**
     * Khởi tạo trang - load dữ liệu và setup UI
     */
    async function initializePage() {
        try {
            showLoading('Đang tải dữ liệu...');
            
            // Đồng bộ dữ liệu pending trước
            await syncPendingData();
            
            // Tải dữ liệu từ API
            await loadOrdersData();
            
            // Render giao diện
            renderOrdersTable();
            updateStatistics();
            
            // Setup các event listeners
            setupEventListeners();
            
            showNotification('Đã tải dữ liệu thành công', 'success');
            
        } catch (error) {
            console.error('Error initializing page:', error);
            showNotification('Lỗi tải dữ liệu: ' + error.message, 'error');
            
            // Fallback: sử dụng dữ liệu mẫu
            loadSampleData();
            renderOrdersTable();
            updateStatistics();
        } finally {
            hideLoading();
        }
    }

    /**
     * =================================================================
     * QUẢN LÝ DỮ LIỆU - DATA MANAGEMENT
     * =================================================================
     */

    /**
     * Tải dữ liệu lệnh sản xuất từ API
     */
    async function loadOrdersData() {
        try {
            console.log('Loading orders data for stage:', STAGE_CONFIG.KEY);
            
            // Gọi API để lấy danh sách lệnh sản xuất từ bảng production_orders
            const response = await fetch(`${API_BASE_URL}/data/production_orders`);
            
            if (!response.ok) {
                throw new Error(`API response: ${response.status}`);
            }
            
            const apiData = await response.json();
            console.log('API data received:', apiData);
            
            // Log tất cả workflow_definition values từ API (detailed)
            if (Array.isArray(apiData)) {
                console.log('=== WORKFLOW_DEFINITION VALUES FROM API (DETAILED) ===');
                apiData.forEach((order, index) => {
                    console.log(`Order ${index + 1}:`);
                    console.log(`  - ID: ${order.id}`);
                    console.log(`  - Order Code: ${order.production_order || order.order_code || 'No Code'}`);
                    console.log(`  - workflow_definition: ${order.workflow_definition === null ? 'NULL' : `"${order.workflow_definition}"`}`);
                    console.log(`  - work_stage: ${order.work_stage || 'No work_stage'}`);
                    console.log(`  - All workflow fields:`, {
                        workflow_definition: order.workflow_definition,
                        work_stage: order.work_stage,
                        current_stage: order.current_stage
                    });
                    console.log(`  ---`);
                });
                console.log('=== END DETAILED WORKFLOW_DEFINITION LOG ===');
                
                // Count null vs non-null values
                const nullCount = apiData.filter(order => order.workflow_definition === null).length;
                const nonNullCount = apiData.filter(order => order.workflow_definition !== null).length;
                console.log(`[DATA ANALYSIS] workflow_definition NULL count: ${nullCount}, Non-NULL count: ${nonNullCount}`);
            }
            
            // Chuyển đổi dữ liệu API từ bảng production_orders thành format internal
            ordersData = Array.isArray(apiData) ? apiData.map(order => {
                let workflowDef = order.workflow_definition;
                
                // TEMPORARY FALLBACK: Nếu workflow_definition là null, tạo workflow test dựa trên work_stage hoặc ID
                if (workflowDef === null || workflowDef === undefined || workflowDef === '') {
                    console.log(`[FALLBACK] Order ${order.id} has null workflow_definition, creating test workflow...`);
                    
                    // Tạo workflow test dựa trên ID để demo
                    if (order.id % 3 === 0) {
                        workflowDef = "xa,in_offset,boi,kho"; // Test với in_offset
                        console.log(`[FALLBACK] Generated workflow for order ${order.id}: "${workflowDef}"`);
                    } else if (order.id % 3 === 1) {
                        workflowDef = "xa,xen,be,dan,kho"; // Test với xen
                        console.log(`[FALLBACK] Generated workflow for order ${order.id}: "${workflowDef}"`);
                    } else {
                        workflowDef = "xa,boi,kho"; // Test workflow ngắn
                        console.log(`[FALLBACK] Generated workflow for order ${order.id}: "${workflowDef}"`);
                    }
                }
                
                const nextStage = getNextStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY);
                
                // Log kết quả xử lý workflow với chi tiết hơn
                console.log(`[DATA PROCESSING] Order ${order.id} (${order.order_code || order.production_order || 'No Code'}):`);
                console.log(`[DATA PROCESSING] - Raw workflow_definition from API: ${order.workflow_definition === null ? 'NULL' : `"${order.workflow_definition}"`}`);
                console.log(`[DATA PROCESSING] - Final workflowDef used: "${workflowDef}"`);
                console.log(`[DATA PROCESSING] - Current stage: "${STAGE_CONFIG.KEY}"`);
                console.log(`[DATA PROCESSING] - Calculated next_stage: "${nextStage}"`);
                console.log(`[DATA PROCESSING] - Next stage display name: "${nextStage ? getStageDisplayName(nextStage) : 'None'}"`);
                console.log(`[DATA PROCESSING] ---`);
                
                return {
                    id: order.id,
                    production_order: order.order_code || order.production_order,
                    product_name: order.product_name,
                    internal_product_code: order.internal_product_code,
                    customer_name: order.customer_name,
                    total_quantity: order.quantity || order.total_quantity,
                    xa_input_quantity: order.quantity || order.total_quantity || 0,
                    xa_output_quantity: order.xa_output_quantity || 0,
                    xa_good_quantity: order.xa_good_quantity || 0,
                    xa_ng_quantity: order.xa_ng_quantity || 0,
                    xa_status: order.xa_status || order.status || 'waiting',
                    xa_machine_name: order.xa_machine_name || '',
                    xa_worker_name: order.xa_worker_name || '',
                    xa_note: order.xa_note || order.notes || '',
                    paper_type: order.paper_type || '',
                    paper_weight: order.paper_weight || 0,
                    production_shift: order.shift || order.production_shift || '',
                    delivery_date: order.delivery_date,
                    deployment_date: order.deployment_date || order.created_at,
                    workflow_definition: workflowDef, // Sử dụng workflow đã xử lý (có thể là fallback)
                    next_stage: nextStage,
                    created_at: order.created_at,
                    updated_at: order.updated_at
                };
            }) : [];
            
            console.log(`[DATA PROCESSING] Total orders processed: ${ordersData.length}`);
            console.log(`[DATA PROCESSING] Orders with next_stage defined:`, ordersData.filter(o => o.next_stage).length);
            
            // Thông báo về vấn đề workflow_definition
            const nullWorkflowCount = apiData.filter(order => order.workflow_definition === null).length;
            if (nullWorkflowCount > 0) {
                console.warn(`[WARNING] ${nullWorkflowCount}/${apiData.length} orders have NULL workflow_definition in database!`);
                console.warn(`[WARNING] Using fallback test workflows. Please check database and update workflow_definition column.`);
                showNotification(`⚠️ Cảnh báo: ${nullWorkflowCount} lệnh chưa có workflow_definition trong database. Đang sử dụng workflow test.`, 'warning');
            }
            
        } catch (error) {
            console.error('API error:', error.message);
            ordersData = []; // Khởi tạo mảng rỗng
            showNotification('Không thể tải dữ liệu: ' + error.message, 'warning');
        }
    }

    /**
     * =================================================================
     * HIỂN THỊ DỮ LIỆU - DATA RENDERING
     * =================================================================
     */

    /**
     * Render bảng danh sách lệnh sản xuất
     */
    function renderOrdersTable() {
        console.log('Rendering orders table...');
        
        const tableBody = document.getElementById('stageTableBody');
        if (!tableBody) {
            console.error('Table body element not found');
            return;
        }
        
        // Xóa dữ liệu cũ
        tableBody.innerHTML = '';
        
        // Kiểm tra có dữ liệu không
        if (ordersData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="12" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Không có lệnh sản xuất nào cho công đoạn ${STAGE_CONFIG.NAME}
                    </td>
                </tr>
            `;
            return;
        }
        
        // Render từng dòng dữ liệu
        ordersData.forEach((order, index) => {
            const row = createOrderTableRow(order, index);
            tableBody.appendChild(row);
        });
        
        console.log('Table rendered with', ordersData.length, 'orders');
    }

    /**
     * Tạo một dòng trong bảng cho một lệnh sản xuất
     */
    function createOrderTableRow(order, index) {
        const row = document.createElement('tr');
        row.className = 'order-row';
        row.setAttribute('data-order-id', order.id);
        
        // Tính toán trạng thái và tiến độ
        const status = order.xa_status || 'waiting';
        const inputQty = order.xa_input_quantity || 0;
        const goodQty = order.xa_good_quantity || 0;
        const ngQty = order.xa_ng_quantity || 0;
        const progressPercent = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
        
        // Xác định icon và màu sắc theo trạng thái
        let statusIcon = 'bi-clock';
        let statusClass = 'text-warning';
        let statusText = 'Chờ xử lý';
        
        switch (status) {
            case 'in_progress':
                statusIcon = 'bi-play-circle';
                statusClass = 'text-primary';
                statusText = 'Đang xử lý';
                break;
            case 'completed':
                statusIcon = 'bi-check-circle';
                statusClass = 'text-success';
                statusText = 'Hoàn thành';
                break;
            case 'paused':
                statusIcon = 'bi-pause-circle';
                statusClass = 'text-warning';
                statusText = 'Tạm dừng';
                break;
        }
        
        // Tạo HTML cho dòng
        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-light text-dark">${index + 1}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="bi ${statusIcon} ${statusClass} me-2"></i>
                    <div>
                        <div class="fw-bold">${order.production_order}</div>
                        <small class="text-muted">${formatDate(order.deployment_date)} - ${order.production_shift}</small>
                    </div>
                </div>
            </td>
            <td>
                <div>
                    <div class="fw-bold">${order.internal_product_code}</div>
                    <small class="text-muted" title="${order.product_name}">${truncateText(order.product_name, 30)}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">${order.paper_type || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.paper_weight || 0} gsm</span>
            </td>
            <td class="text-center">
                <div class="fw-bold text-info">${formatNumber(inputQty)}</div>
                <small class="text-muted">kế hoạch</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary">${formatNumber(inputQty)}</div>
                <small class="text-muted">đầu vào</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${formatNumber(goodQty)}</div>
                <small class="text-muted">OK</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-danger">${formatNumber(ngQty)}</div>
                <small class="text-muted">NG</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-primary'}" 
                         style="width: ${Math.min(progressPercent, 100)}%">
                        ${progressPercent}%
                    </div>
                </div>
                <small class="text-muted">${statusText}</small>
            </td>
            <td class="text-center">
                <small class="text-muted d-block">${order.xa_machine_name || 'Chưa gán'}</small>
                <small class="text-muted">${order.xa_worker_name || 'Chưa gán'}</small>
            </td>
            <td class="text-center">
                ${createActionButtons(order)}
            </td>
        `;
        
        return row;
    }

    /**
     * Tạo các nút thao tác cho từng dòng
     */
    function createActionButtons(order) {
        const status = order.xa_status || 'waiting';
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HOÀN THÀNH';
        
        console.log(`[BUTTONS DEBUG] Creating action buttons for Order ${order.id}:`);
        console.log(`[BUTTONS DEBUG] - Status: "${status}"`);
        console.log(`[BUTTONS DEBUG] - Workflow: "${order.workflow_definition}"`);
        console.log(`[BUTTONS DEBUG] - Next Stage: "${nextStage}"`);
        console.log(`[BUTTONS DEBUG] - Next Stage Name: "${nextStageName}"`);
        
        let buttons = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-info rounded-pill px-3 me-1" 
                        onclick="viewOrderDetails(${order.id})" 
                        title="Xem chi tiết">
                    <i class="bi bi-eye me-1"></i>Chi tiết
                </button>
        `;
        
        // Nút Hoàn thành - chỉ hiện khi chưa hoàn thành
        if (status !== 'completed') {
            console.log(`[BUTTONS DEBUG] - Adding "Hoàn thành" button (status is not completed)`);
            buttons += `
                <button class="btn btn-success rounded-pill px-3" 
                        onclick="showCompleteModal(${order.id})" 
                        title="Hoàn thành công đoạn">
                    <i class="bi bi-check-lg me-1"></i>Hoàn thành
                </button>
            `;
        } else if (nextStage) {
            // Nút Bàn giao - chỉ hiện khi đã hoàn thành và có stage tiếp theo
            console.log(`[BUTTONS DEBUG] - Adding "Bàn giao ${nextStageName}" button (status completed, has next stage)`);
            buttons += `
                <button class="btn btn-primary rounded-pill px-3" 
                        onclick="showHandoverModal(${order.id})" 
                        title="Bàn giao cho công đoạn ${nextStageName}">
                    <i class="bi bi-arrow-right-circle me-1"></i>Bàn giao ${nextStageName}
                </button>
            `;
        } else {
            // Đã hoàn thành và không có stage tiếp theo
            console.log(`[BUTTONS DEBUG] - Adding "Hoàn thành workflow" badge (status completed, no next stage)`);
            buttons += `
                <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>Hoàn thành workflow
                </span>
            `;
        }
        
        buttons += `</div>`;
        console.log(`[BUTTONS DEBUG] - Final buttons HTML generated for Order ${order.id}`);
        return buttons;
    }

    /**
     * Cập nhật thống kê tổng quan
     */
    function updateStatistics() {
        const totalOrders = ordersData.length;
        const totalPlan = ordersData.reduce((sum, order) => sum + (order.xa_input_quantity || 0), 0);
        const totalGood = ordersData.reduce((sum, order) => sum + (order.xa_good_quantity || 0), 0);
        const totalNg = ordersData.reduce((sum, order) => sum + (order.xa_ng_quantity || 0), 0);
        
        // Cập nhật các thẻ thống kê
        updateElementText('totalOrders', totalOrders);
        updateElementText('totalPlan', formatNumber(totalPlan));
        updateElementText('totalGood', formatNumber(totalGood));
        updateElementText('totalNg', formatNumber(totalNg));
        
        console.log('Statistics updated:', { totalOrders, totalPlan, totalGood, totalNg });
    }

    /**
     * =================================================================
     * XỬ LÝ SỰ KIỆN - EVENT HANDLERS
     * =================================================================
     */

    /**
     * Setup các event listeners
     */
    function setupEventListeners() {
        // Nút làm mới dữ liệu
        const refreshBtn = document.querySelector('[onclick="refreshData()"]');
        if (refreshBtn) {
            refreshBtn.onclick = refreshData;
        }
        
        // Nút thêm mới (tạm thời disable)
        const addBtn = document.querySelector('[onclick="showNewOrderForm()"]');
        if (addBtn) {
            addBtn.onclick = () => showNotification('Chức năng thêm mới đang phát triển', 'info');
        }
        
        console.log('Event listeners setup completed');
    }

    /**
     * Làm mới dữ liệu
     */
    async function refreshData() {
        try {
            showLoading('Đang làm mới dữ liệu...');
            await loadOrdersData();
            renderOrdersTable();
            updateStatistics();
            showNotification('Đã làm mới dữ liệu thành công', 'info');
        } catch (error) {
            console.error('Error refreshing data:', error);
            showNotification('Lỗi làm mới dữ liệu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xem chi tiết lệnh sản xuất
     */
    function viewOrderDetails(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        // Tạo nội dung chi tiết
        const details = `
Mã lệnh: ${order.production_order}
Sản phẩm: ${order.product_name}
Mã nội bộ: ${order.internal_product_code}
Khách hàng: ${order.customer_name}
Loại giấy: ${order.paper_type} - ${order.paper_weight} gsm
Số lượng kế hoạch: ${formatNumber(order.xa_input_quantity)}
Số lượng đạt: ${formatNumber(order.xa_good_quantity)}
Số lượng NG: ${formatNumber(order.xa_ng_quantity)}
Máy sản xuất: ${order.xa_machine_name || 'Chưa gán'}
Thợ phụ trách: ${order.xa_worker_name || 'Chưa gán'}
Trạng thái: ${getStatusText(order.xa_status)}
Ghi chú: ${order.xa_note || 'Không có'}
        `.trim();
        
        alert('CHI TIẾT LỆNH SẢN XUẤT\n\n' + details);
    }

    /**
     * Hiển thị modal hoàn thành công đoạn
     */
    function showCompleteModal(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        currentEditingOrder = order;
        
        // Cập nhật thông tin về stage tiếp theo
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HOÀN THÀNH WORKFLOW';
        
        console.log(`[MODAL DEBUG] ===== SHOW COMPLETE MODAL =====`);
        console.log(`[MODAL DEBUG] Order ID: ${order.id}`);
        console.log(`[MODAL DEBUG] Order Code: ${order.production_order}`);
        console.log(`[MODAL DEBUG] Workflow Definition: "${order.workflow_definition}"`);
        console.log(`[MODAL DEBUG] Current Stage: "${STAGE_CONFIG.KEY}"`);
        console.log(`[MODAL DEBUG] Next Stage: "${nextStage}"`);
        console.log(`[MODAL DEBUG] Next Stage Display Name: "${nextStageName}"`);
        console.log(`[MODAL DEBUG] ===================================`);
        
        // Cập nhật thông tin về công đoạn tiếp theo
        const nextStageInfo = document.getElementById('nextStageInfo');
        if (nextStageInfo) {
            if (nextStage) {
                const newText = `Sau khi hoàn thành, sản phẩm OK sẽ được chuyển sang công đoạn <strong>${nextStageName}</strong>`;
                console.log(`[MODAL DEBUG] Updating next stage info to: "${newText}"`);
                nextStageInfo.innerHTML = newText;
            } else {
                const newText = `Đây là công đoạn cuối cùng trong workflow. Sản phẩm sẽ được hoàn thành.`;
                console.log(`[MODAL DEBUG] Updating next stage info to: "${newText}"`);
                nextStageInfo.innerHTML = newText;
            }
        }
        
        // Cập nhật text trong checkbox xác nhận
        const confirmLabel = document.querySelector('label[for="confirmHandover"]');
        if (confirmLabel && nextStage) {
            const newConfirmText = `Tôi xác nhận đã bàn giao đủ số lượng và chất lượng cho công đoạn ${nextStageName}`;
            console.log(`[MODAL DEBUG] Updating confirm checkbox text to: "${newConfirmText}"`);
            confirmLabel.textContent = newConfirmText;
        }
        
        // Populate thông tin cơ bản
        updateElementText('completeOrderCode', order.production_order);
        updateElementText('completeProductName', order.product_name);
        updateElementText('completeQuantity', formatNumber(order.xa_input_quantity));
        updateElementText('completePaperType', order.paper_type || 'Chưa xác định');
        updateElementText('completePaperWeight', (order.paper_weight || 0) + ' gsm');
        
        // Populate form values - Phần hoàn thành
        setElementValue('completeGoodQty', order.xa_good_quantity || 0);
        setElementValue('completeNgQty', order.xa_ng_quantity || 0);
        setElementValue('completeNgStartEndQty', 0);
        setElementValue('completeReturnQty', 0);
        setElementValue('completeMachine', order.xa_machine_name || 'Xả 1');
        setElementValue('completeShift', order.production_shift || 'Ca 1');
        setElementValue('completeWorker', order.xa_worker_name || '');
        setElementValue('completeNote', order.xa_note || '');
        
        // Populate form values - Phần bàn giao
        setElementValue('handoverDate', formatDate(new Date()));
        setElementValue('handoverPerson', '');
        setElementValue('receiverPerson', '');
        setElementValue('handoverNotes', '');
        setElementValue('confirmHandover', false);
        
        // Cập nhật số lượng bàn giao (tự động = số lượng OK)
        updateHandoverQuantity();
        
        // Làm cho số lượng bàn giao có thể chỉnh sửa được
        const handoverQtyInput = document.getElementById('handoverQty');
        if (handoverQtyInput) {
            handoverQtyInput.removeAttribute('readonly');
        }
        
        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));
        modal.show();
    }

    /**
     * Hiển thị modal bàn giao đơn lẻ (cho các đơn đã hoàn thành)
     */
    function showHandoverModal(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        currentEditingOrder = order;
        
        // Lấy thông tin stage tiếp theo
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HOÀN THÀNH';
        
        console.log(`[HANDOVER DEBUG] ===== SHOW HANDOVER MODAL =====`);
        console.log(`[HANDOVER DEBUG] Order ID: ${order.id}`);
        console.log(`[HANDOVER DEBUG] Order Code: ${order.production_order}`);
        console.log(`[HANDOVER DEBUG] Workflow Definition: "${order.workflow_definition}"`);
        console.log(`[HANDOVER DEBUG] Current Stage: "${STAGE_CONFIG.KEY}"`);
        console.log(`[HANDOVER DEBUG] Next Stage: "${nextStage}"`);
        console.log(`[HANDOVER DEBUG] Next Stage Display Name: "${nextStageName}"`);
        console.log(`[HANDOVER DEBUG] ====================================`);
        
        if (!nextStage) {
            console.log(`[HANDOVER DEBUG] No next stage found, showing info message`);
            showNotification('Đây là công đoạn cuối cùng trong workflow', 'info');
            return;
        }
        
        // Cập nhật thông tin về stage tiếp theo
        const handoverAlert = document.querySelector('#handover-tab-pane .alert-warning p');
        if (handoverAlert) {
            handoverAlert.innerHTML = `Sau khi hoàn thành, sản phẩm OK sẽ được chuyển sang công đoạn <strong>${nextStageName}</strong>`;
        }
        
        // Cập nhật label cho tab bàn giao
        const handoverTabLabel = document.getElementById('handover-tab');
        if (handoverTabLabel) {
            handoverTabLabel.innerHTML = `<i class="bi bi-arrow-right-circle me-1"></i>Bàn giao công đoạn ${nextStageName}`;
        }
        
        // Cập nhật text trong checkbox xác nhận
        const confirmLabel = document.querySelector('label[for="confirmHandover"]');
        if (confirmLabel) {
            confirmLabel.textContent = `Tôi xác nhận đã bàn giao đủ số lượng và chất lượng cho công đoạn ${nextStageName}`;
        }
        
        // Populate thông tin bàn giao
        updateElementText('handoverOrderCode', order.production_order);
        updateElementText('handoverProductName', order.product_name);
        setElementValue('handoverQty', order.xa_good_quantity || 0);
        setElementValue('handoverDate', formatDate(new Date()));
        setElementValue('handoverPerson', order.xa_worker_name || '');
        setElementValue('receiverPerson', '');
        setElementValue('handoverNotes', '');
        setElementValue('confirmHandover', false);
        
        // Chuyển sang tab bàn giao
        const handoverTab = document.getElementById('handover-tab');
        if (handoverTab) handoverTab.click();
        
        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));
        modal.show();
    }

    /**
     * Xử lý bàn giao đơn lẻ từ XẢ sang XÉN
     */
    async function executeHandoverOnly() {
        if (!currentEditingOrder) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            const handoverData = {
                handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
                handoverPerson: getElementValue('handoverPerson'),
                receiverPerson: getElementValue('receiverPerson'),
                handoverNotes: getElementValue('handoverNotes'),
                confirmHandover: getElementValue('confirmHandover')
            };
            
            // Validate
            if (handoverData.handoverQuantity <= 0) {
                showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
                return;
            }
            
            if (!handoverData.confirmHandover) {
                showNotification('Bạn phải xác nhận đã bàn giao đủ số lượng và chất lượng', 'warning');
                return;
            }
            
            showLoading('Đang bàn giao...');
            
            // Lấy thông tin stage tiếp theo từ workflow
            const nextStage = currentEditingOrder.next_stage;
            if (!nextStage) {
                showNotification('Không xác định được công đoạn tiếp theo', 'error');
                return;
            }
            
            // Chuẩn bị dữ liệu bàn giao
            const handoverWebhookData = {
                order_id: currentEditingOrder.id,
                from_stage: STAGE_CONFIG.KEY,
                to_stage: nextStage,
                quantity: handoverData.handoverQuantity,
                handover_person: handoverData.handoverPerson,
                receiver_person: handoverData.receiverPerson,
                notes: handoverData.handoverNotes,
                handover_date: new Date().toISOString()
            };
            
            // Gửi qua webhook
            const result = await sendWebhook(`handover_${STAGE_CONFIG.KEY}_to_${nextStage}`, handoverWebhookData);
            
            if (result.success) {
                showNotification(`Đã bàn giao ${handoverData.handoverQuantity} sản phẩm cho công đoạn ${getStageDisplayName(nextStage)}`, 'success');
            }
            
            // Refresh dữ liệu và đóng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error executing handover only:', error);
            showNotification('Lỗi bàn giao: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Cập nhật số lượng bàn giao khi thay đổi số lượng OK
     */
    function updateHandoverQuantity() {
        const goodQty = getElementValue('completeGoodQty') || 0;
        setElementValue('handoverQty', goodQty);
    }
    
    /**
     * Alias cho updateHandoverQuantity (được gọi từ HTML)
     */
    function updateHandoverQty() {
        updateHandoverQuantity();
    }

    /**
     * Xử lý hoàn thành công đoạn
     */
    async function completeOrder() {
        if (!currentEditingOrder) {
            showNotification('Lỗi: Không xác định được lệnh sản xuất', 'error');
            return;
        }
        
        try {
            // Lấy dữ liệu từ form
            const completionData = getCompletionDataFromForm();
            
            // Validate dữ liệu
            if (!validateCompletionData(completionData)) {
                return;
            }
            
            showLoading('Đang xử lý...');
            
            // Luôn thực hiện cả hoàn thành và bàn giao (vì đã gộp chung thành 1 form)
            await handleCompleteAndHandover(completionData);
            
            // Refresh dữ liệu và đóng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error completing order:', error);
            showNotification('Lỗi: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Lấy dữ liệu từ form hoàn thành
     */
    function getCompletionDataFromForm() {
        return {
            // Dữ liệu hoàn thành
            goodQuantity: parseInt(getElementValue('completeGoodQty')) || 0,
            ngQuantity: parseInt(getElementValue('completeNgQty')) || 0,
            ngStartEndQuantity: parseInt(getElementValue('completeNgStartEndQty')) || 0,
            returnQuantity: parseInt(getElementValue('completeReturnQty')) || 0,
            machine: getElementValue('completeMachine'),
            shift: getElementValue('completeShift'),
            workerName: getElementValue('completeWorker'),
            notes: getElementValue('completeNote'),
            
            // Dữ liệu bàn giao
            handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
            handoverDate: getElementValue('handoverDate'),
            handoverPerson: getElementValue('handoverPerson'),
            receiverPerson: getElementValue('receiverPerson'),
            handoverNotes: getElementValue('handoverNotes'),
            confirmHandover: getElementValue('confirmHandover')
        };
    }

    /**
     * Validate dữ liệu hoàn thành
     */
    function validateCompletionData(data) {
        // Validate dữ liệu hoàn thành cơ bản
        if (data.goodQuantity + data.ngQuantity === 0) {
            showNotification('Tổng số lượng phải lớn hơn 0', 'error');
            return false;
        }
        
        // Validate dữ liệu bàn giao (luôn kiểm tra vì đã gộp chung form)
        if (data.handoverQuantity <= 0) {
            showNotification('Số lượng bàn giao phải lớn hơn 0', 'error');
            return false;
        }
        
        if (!data.confirmHandover) {
            showNotification('Bạn phải xác nhận đã bàn giao đủ số lượng và chất lượng', 'warning');
            return false;
        }
        
        // Kiểm tra số lượng bàn giao không vượt quá số lượng OK
        if (data.handoverQuantity > data.goodQuantity) {
            showNotification('Số lượng bàn giao không thể lớn hơn số lượng OK', 'error');
            return false;
        }
        
        return true;
    }

    /**
     * Xử lý hoàn thành và bàn giao từ XẢ sang stage tiếp theo
     */
    async function handleCompleteAndHandover(data) {
        try {
            const nextStage = currentEditingOrder.next_stage;
            
            if (!nextStage) {
                // Nếu không có stage tiếp theo, chỉ hoàn thành
                return await handleCompleteStageOnly(data);
            }
            
            const completeHandoverData = {
                order_id: currentEditingOrder.id,
                action_type: 'complete_and_handover',
                from_stage: 'xa',
                to_stage: nextStage,
                workflow_definition: currentEditingOrder.workflow_definition,
                
                // Thông tin hoàn thành
                completion: {
                    output_quantity: data.goodQuantity + data.ngQuantity,
                    good_quantity: data.goodQuantity,
                    ng_quantity: data.ngQuantity,
                    worker_name: data.workerName,
                    machine_name: data.machine,
                    shift: data.shift,
                    notes: data.notes
                },
                
                // Thông tin bàn giao
                handover: {
                    handover_quantity: data.handoverQuantity,
                    handover_person: data.handoverPerson,
                    receiver_person: data.receiverPerson,
                    handover_date: data.handoverDate,
                    handover_notes: data.handoverNotes
                },
                
                completed_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook(`complete_xa_and_handover_to_${nextStage}`, completeHandoverData);
            
            if (result.success) {
                const nextStageName = getStageDisplayName(nextStage);
                showNotification(
                    `✅ Đã hoàn thành công đoạn XẢ và bàn giao ${formatNumber(data.handoverQuantity)} sản phẩm cho công đoạn ${nextStageName} thành công!`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error complete and handover:', error);
            showNotification('Lỗi khi hoàn thành và bàn giao: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * Xử lý chỉ hoàn thành công đoạn
     */
    async function handleCompleteStageOnly(data) {
        try {
            const updateData = {
                order_id: currentEditingOrder.id,
                stage: STAGE_CONFIG.KEY,
                output_quantity: data.goodQuantity + data.ngQuantity,
                good_quantity: data.goodQuantity,
                ng_quantity: data.ngQuantity,
                worker_name: data.workerName,
                machine_name: data.machine,
                shift: data.shift,
                notes: data.notes,
                updated_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook('update_stage_output', updateData);
            
            if (result.success) {
                showNotification(
                    `✅ Đã cập nhật hoàn thành công đoạn XẢ: ${formatNumber(data.goodQuantity + data.ngQuantity)} sản phẩm`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error completing stage:', error);
            showNotification('Lỗi khi hoàn thành công đoạn: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * =================================================================
     * UTILITY FUNCTIONS - CÁC HÀM TIỆN ÍCH
     * =================================================================
     */

    // Hiển thị loading
    function showLoading(message = 'Đang tải...') {
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.style.display = 'flex';
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = message;
        }
    }

    // Ẩn loading  
    function hideLoading() {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.style.display = 'none';
    }

    // Hiển thị thông báo
    function showNotification(message, type = 'success') {
        // Tạo toast notification đơn giản
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // Tự động xóa sau 5 giây
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Format số theo định dạng Việt Nam
    function formatNumber(num) {
        if (!num && num !== 0) return '';
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    // Format ngày
    function formatDate(date, format = 'dd/mm/yyyy') {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        
        return format
            .replace('dd', day)
            .replace('mm', month)
            .replace('yyyy', year);
    }

    // Cập nhật text của element
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) element.textContent = text;
    }

    // Set giá trị cho element
    function setElementValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }

    // Lấy giá trị từ element
    function getElementValue(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return '';
        
        if (element.type === 'checkbox') {
            return element.checked;
        } else {
            return element.value;
        }
    }

    // Cắt ngắn text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Chuyển đổi status thành text
    function getStatusText(status) {
        const statusMap = {
            'waiting': 'Chờ xử lý',
            'in_progress': 'Đang xử lý', 
            'completed': 'Hoàn thành',
            'paused': 'Tạm dừng'
        };
        return statusMap[status] || 'Không xác định';
    }

    /**
     * =================================================================
     * SIDEBAR TOGGLE - ĐIỀU KHIỂN SIDEBAR
     * =================================================================
     */

    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleIcon = document.getElementById('toggleIcon');
        
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            toggleIcon.innerHTML = '<i class="bi bi-chevron-left"></i>';
        } else {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            toggleIcon.innerHTML = '<i class="bi bi-chevron-right"></i>';
        }
    }

    // Export functions for global access
    window.refreshData = refreshData;
    window.viewOrderDetails = viewOrderDetails;
    window.showCompleteModal = showCompleteModal;
    window.showHandoverModal = showHandoverModal;
    window.executeHandoverOnly = executeHandoverOnly;
    window.completeOrder = completeOrder;
    window.updateHandoverQuantity = updateHandoverQuantity;
    window.toggleSidebar = toggleSidebar;

    console.log('XA Stage JavaScript initialized successfully');
  </script>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Đang tải dữ liệu từ API...</div>
    </div>
  </div>
</body>
</html>
