<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>C√¥ng ƒëo·∫°n X·∫¢ - Carton Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">   
   <link rel="stylesheet" href="universal-stage.css">
   <script src="sidebar-generator.js"></script>
  <style>
    /* ƒê·∫£m b·∫£o modal hi·ªÉn th·ªã ƒë√∫ng v√† ·ªü gi·ªØa m√†n h√¨nh */
    .modal {
      z-index: 1050 !important;
    }
    
    .modal-backdrop {
      z-index: 1040 !important;
    }
    
    .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1.75rem auto;
    }
    
    .modal-content {
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    
    /* ƒê·∫£m b·∫£o c√°c tab hi·ªÉn th·ªã ƒë√∫ng */
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom-color: transparent;
    }
    
    /* C·∫£i thi·ªán hi·ªÉn th·ªã c·ªßa form */
    .form-control, .form-select {
      margin-bottom: 0.5rem;
      border-radius: 6px;
    }
    
    /* T·∫°o kho·∫£ng c√°ch r√µ r√†ng gi·ªØa c√°c ph·∫ßn c·ªßa form */
    .form-label {   
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    /* L√†m n·ªïi b·∫≠t th√¥ng tin quan tr·ªçng */
    .alert {
      border-radius: 6px;
    }
    
    /* ƒê·∫£m b·∫£o modal kh√¥ng b·ªã tr√†n m√†n h√¨nh tr√™n thi·∫øt b·ªã di ƒë·ªông */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 0.5rem;
        max-width: 95%;
      }
      
      .modal-dialog-centered {
        min-height: calc(100% - 1rem);
      }
    }
    
    /* Fix cho n√∫t ƒë√≥ng tr√™n modal header */
    .modal-header .btn-close {
      padding: 0.5rem;
      margin: -0.5rem -0.5rem -0.5rem auto;
    }
    
    /* Hi·ªáu ·ª©ng hover cho c√°c n√∫t */
    .btn {
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
    }
    
    /* Animation styles cho notification */
    @keyframes fadeIn {
      from { opacity: 0; transform: translateX(100%); }
      to { opacity: 1; transform: translateX(0); }
    }
    @keyframes fadeOut {
      from { opacity: 1; transform: translateX(0); }
      to { opacity: 0; transform: translateX(100%); }
    }

    /* Wizard Form Styles */
    .wizard-container {
      background: rgba(255, 255, 255, 0.95);
      border-radius: 15px;
      box-shadow: 0 20px 40px rgba(0,0,0,0.1);
      backdrop-filter: blur(10px);
      margin: 20px;
      max-width: 800px;
      margin-left: auto;
      margin-right: auto;
    }
    
    .wizard-steps {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 20px 30px;
      background: #f8f9fa;
      border-bottom: 1px solid #e9ecef;
    }
    
    .step {
      display: flex;
      flex-direction: column;
      align-items: center;
      flex: 1;
      position: relative;
    }
    
    .step:not(:last-child)::after {
      content: '';
      position: absolute;
      top: 20px;
      left: 50%;
      width: 100%;
      height: 2px;
      background: #e9ecef;
      z-index: 1;
    }
    
    .step.active:not(:last-child)::after {
      background: #6f42c1;
    }
    
    .step.completed:not(:last-child)::after {
      background: #28a745;
    }
    
    .step-circle {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: #e9ecef;
      color: #6c757d;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      position: relative;
      z-index: 2;
      transition: all 0.3s ease;
    }
    
    .step.active .step-circle {
      background: #6f42c1;
      color: white;
      box-shadow: 0 0 0 4px rgba(111, 66, 193, 0.2);
    }
    
    .step.completed .step-circle {
      background: #28a745;
      color: white;
    }
    
    .step-label {
      margin-top: 8px;
      font-size: 0.9rem;
      font-weight: 500;
      text-align: center;
    }
    
    .wizard-content {
      padding: 30px;
      min-height: 400px;
    }
    
    .step-content {
      display: none;
    }
    
    .step-content.active {
      display: block;
      animation: fadeIn 0.5s ease;
    }
    
    .form-control, .form-select {
      border-radius: 8px;
      border: 2px solid #e9ecef;
      transition: all 0.3s ease;
    }
    
    .form-control:focus, .form-select:focus {
      border-color: #6f42c1;
      box-shadow: 0 0 0 0.2rem rgba(111, 66, 193, 0.25);
    }
    
    /* .btn-primary {
      background: linear-gradient(45deg, #6f42c1, #5a2d91);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    } */
    
    .btn-success {
      background: linear-gradient(45deg, #28a745, #1e7e34);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    }
    
    .btn-secondary {
      background: linear-gradient(45deg, #6c757d, #545b62);
      border: none;
      border-radius: 25px;
      padding: 12px 30px;
      font-weight: 600;
    }
    
    .info-card {
      background: linear-gradient(45deg, #17a2b8, #138496);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .progress-card {
      background: linear-gradient(45deg, #fd7e14, #e55a00);
      color: white;
      border-radius: 10px;
      padding: 20px;
      margin-bottom: 20px;
    }
    
    .wizard-footer {
      padding: 20px 30px;
      background: #f8f9fa;
      border-top: 1px solid #e9ecef;
      border-radius: 0 0 15px 15px;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    
    .step-indicator {
      font-size: 0.9rem;
      color: #6c757d;
    }

  </style>
</head>
<body data-stage="xa">
  
  <!-- Sidebar will be generated by JavaScript -->

  <!-- Main Content -->
  <div class="main-content sidebar-collapsed" id="mainContent">
    <div class="content-area">
      <div class="container-fluid p-4">
      
      <!-- Stage Header -->
      <div class="stage-header">
        <h1>
          <i class="bi bi-bullseye me-2 text-primary"></i>
          C√¥ng ƒëo·∫°n X·∫¢
        </h1>
        <p class="mb-0">X·∫£ gi·∫•y cu·ªôn - Qu·∫£n l√Ω chi ti·∫øt s·∫£n xu·∫•t</p>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4" id="stageStats">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">T·ªïng l·ªánh</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalPlan">0</div>
            <div class="stat-label">SL K·∫ø ho·∫°ch</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalGood">0</div>
            <div class="stat-label">SL ƒê·∫°t</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card">
            <div class="stat-value" id="totalNg">0</div>
            <div class="stat-label">SL NG</div>
          </div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">Danh s√°ch l·ªánh s·∫£n xu·∫•t - C√¥ng ƒëo·∫°n X·∫£</h5>
          <div class="d-flex align-items-center">
            <!-- Performance Metrics Button -->
            <button class="btn btn-outline-info btn-sm me-3" onclick="showPerformanceMetrics()" title="Xem performance metrics">
              <i class="bi bi-graph-up"></i>
            </button>
            
            <!-- Fast Load Button -->
            <button class="btn btn-outline-success btn-sm me-2" onclick="loadOrdersDataFast()" title="Load nhanh (ch·ªâ 500 records)">
              <i class="bi bi-lightning"></i> Load nhanh
            </button>
            
            <!-- Main Actions -->
            <button class="btn btn-primary me-2" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>L√†m m·ªõi
            </button>
            <button class="btn btn-success" onclick="showNewOrderForm()">
              <i class="bi bi-plus-lg me-1"></i>Th√™m m·ªõi
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Ng√†y s·∫£n xu·∫•t:</label>
              <input type="date" class="form-control" id="dateFilter">
            </div>
            <div class="col-md-2">
              <label class="form-label">Ca:</label>
              <select class="form-select" id="shiftFilter">
                <option value="">T·∫•t c·∫£</option>
                <option value="Ca 1">Ca 1</option>
                <option value="Ca 2">Ca 2</option>
                <option value="Ca 3">Ca 3</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">M√°y:</label>
              <select class="form-select" id="machineFilter">
                <option value="">T·∫•t c·∫£</option>
                <option value="X·∫£ 1">X·∫£ 1</option>
                <option value="X·∫£ 2">X·∫£ 2</option>
                <option value="X·∫£ 3">X·∫£ 3</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">T√¨m ki·∫øm:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="T√¨m theo m√£ l·ªánh, s·∫£n ph·∫©m...">
                <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Table -->
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th width="50">#</th>
                  <th width="150">L·ªánh SX</th>
                  <th width="200">S·∫£n ph·∫©m</th>
                  <th width="80">Lo·∫°i gi·∫•y</th>
                  <th width="80">ƒê·ªãnh l∆∞·ª£ng</th>
                  <th width="100">KH</th>
                  <th width="100">ƒê·∫ßu v√†o</th>
                  <th width="100">OK</th>
                  <th width="100">NG</th>
                  <th width="120">Ti·∫øn ƒë·ªô</th>
                  <th width="120">M√°y/Th·ª£</th>
                  <th width="150">Thao t√°c</th>
                </tr>
              </thead>
              <tbody id="stageTableBody">
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add/Edit Order Modal -->
  <div class="modal fade" id="orderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-xl modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="modalTitle">Th√™m l·ªánh s·∫£n xu·∫•t m·ªõi - C√¥ng ƒëo·∫°n X·∫£</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="orderForm">
            <div class="row">
              <div class="col-md-6 mb-3">
                <label class="form-label">M√£ l·ªánh s·∫£n xu·∫•t *</label>
                <input type="text" class="form-control" id="orderCode" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">M√£ s·∫£n ph·∫©m *</label>
                <input type="text" class="form-control" id="productCode" required>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">T√™n s·∫£n ph·∫©m *</label>
                <input type="text" class="form-control" id="productName" required>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Lo·∫°i gi·∫•y *</label>
                <select class="form-select" id="paperType" required>
                  <option value="">Ch·ªçn lo·∫°i gi·∫•y</option>
                  <option value="BC">BC</option>
                  <option value="CC">CC</option>
                  <option value="WF">WF</option>
                  <option value="OF">OF</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">ƒê·ªãnh l∆∞·ª£ng (gsm) *</label>
                <input type="number" class="form-control" id="paperWeight" required min="100" max="1000">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Kh·ªï t·ªù</label>
                <input type="text" class="form-control" id="sheetSize" placeholder="VD: 1020x720mm">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">S·ªë l∆∞·ª£ng k·∫ø ho·∫°ch *</label>
                <input type="number" class="form-control" id="planQty" required min="1">
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">Ca s·∫£n xu·∫•t</label>
                <select class="form-select" id="shift">
                  <option value="Ca 1">Ca 1</option>
                  <option value="Ca 2">Ca 2</option>
                  <option value="Ca 3">Ca 3</option>
                </select>
              </div>
              <div class="col-md-6 mb-3">
                <label class="form-label">M√°y x·∫£</label>
                <select class="form-select" id="machine">
                  <option value="X·∫£ 1">X·∫£ 1</option>
                  <option value="X·∫£ 2">X·∫£ 2</option>
                  <option value="X·∫£ 3">X·∫£ 3</option>
                </select>
              </div>
              <div class="col-md-12 mb-3">
                <label class="form-label">Ghi ch√∫</label>
                <textarea class="form-control" id="orderNote" rows="3"></textarea>
              </div>
            </div>
          </form>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">H·ªßy</button>
          <button type="button" class="btn btn-primary" onclick="saveOrder()">L∆∞u</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal ho√†n th√†nh c√¥ng ƒëo·∫°n - Wizard Form -->
  <div class="modal fade" id="completeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-success text-white">
          <div class="d-flex align-items-center">
            <h5 class="modal-title mb-0">
              <i class="bi bi-magic me-2"></i>
              Ho√†n th√†nh & B√†n giao C√¥ng ƒëo·∫°n X·∫¢
            </h5>
            <div class="ms-3">
              <span class="badge bg-light text-dark fs-6" id="modalOrderCode">-</span>
            </div>
          </div>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body p-0">
          <!-- Wizard Container -->
          <div class="wizard-container" style="margin: 0; border-radius: 0; box-shadow: none;">
            <!-- Steps -->
            <div class="wizard-steps">
              <div class="step active" data-step="1">
                <div class="step-circle">1</div>
                <div class="step-label">K·∫øt qu·∫£ & Th√¥ng tin</div>
              </div>
              <div class="step" data-step="2">
                <div class="step-circle">2</div>
                <div class="step-label">B√†n giao</div>
              </div>
              <div class="step" data-step="3">
                <div class="step-circle">3</div>
                <div class="step-label">X√°c nh·∫≠n</div>
              </div>
            </div>

            <!-- Content -->
            <div class="wizard-content">
              <!-- Hidden fields for order information -->
              <input type="hidden" id="wizardOrderCode">
              <input type="hidden" id="wizardProductCode">
              <input type="hidden" id="wizardProductName">
              <input type="hidden" id="wizardPaperType">
              <input type="hidden" id="wizardPaperWeight">
              <input type="hidden" id="wizardQuantity">
              
              <!-- Step 1: Production Results & Information -->
              <div class="step-content active" id="step1">
                <div class="info-card">
                  <h5><i class="bi bi-clipboard-data me-2"></i>B∆∞·ªõc 1: K·∫øt qu·∫£ & Th√¥ng tin s·∫£n xu·∫•t</h5>
                  <p class="mb-0">Nh·∫≠p k·∫øt qu·∫£ s·∫£n xu·∫•t v√† th√¥ng tin m√°y m√≥c, nh√¢n s·ª±.</p>
                </div>
                
                <!-- Production Results Section -->
                <div class="alert alert-success mb-4">
                  <h6 class="alert-heading"><i class="bi bi-clipboard-check me-2"></i>K·∫øt qu·∫£ s·∫£n xu·∫•t</h6>
                  <div class="row">
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">S·ªë l∆∞·ª£ng ƒë·∫°t (OK) <span class="text-danger">*</span></label>
                      <input type="number" class="form-control" value="0" min="0" id="wizardGoodQty">
                      <div class="form-text">S·ªë l∆∞·ª£ng t·ªù gi·∫•y ƒë·∫°t ch·∫•t l∆∞·ª£ng</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">S·ªë l∆∞·ª£ng NG <span class="text-danger">*</span></label>
                      <input type="number" class="form-control" value="0" min="0" id="wizardNgQty">
                      <div class="form-text">S·ªë l∆∞·ª£ng t·ªù gi·∫•y kh√¥ng ƒë·∫°t ch·∫•t l∆∞·ª£ng</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">NG ƒê·∫ßu/Cu·ªëi</label>
                      <input type="number" class="form-control" value="0" min="0" id="wizardNgStartEndQty">
                      <div class="form-text">NG do setup m√°y</div>
                    </div>
                    <div class="col-md-6 mb-3">
                      <label class="form-label fw-bold">H√†ng tr·∫£</label>
                      <input type="number" class="form-control" value="0" min="0" id="wizardReturnQty">
                      <div class="form-text">S·ªë l∆∞·ª£ng h√†ng tr·∫£ l·∫°i</div>
                    </div>
                  </div>
                </div>
                
                <!-- Production Information Section -->
                <div class="alert alert-info mb-4">
                  <h6 class="alert-heading"><i class="bi bi-person-gear me-2"></i>Th√¥ng tin s·∫£n xu·∫•t</h6>
                  <div class="row">
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">M√°y s·∫£n xu·∫•t</label>
                      <select class="form-select" id="wizardMachine">
                        <option value="X·∫£ 1" selected>X·∫£ 1</option>
                        <option value="X·∫£ 2">X·∫£ 2</option>
                        <option value="X·∫£ 3">X·∫£ 3</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Ca s·∫£n xu·∫•t</label>
                      <select class="form-select" id="wizardShift">
                        <option value="Ca 1" selected>Ca 1 (6:00-14:00)</option>
                        <option value="Ca 2">Ca 2 (14:00-22:00)</option>
                        <option value="Ca 3">Ca 3 (22:00-6:00)</option>
                      </select>
                    </div>
                    <div class="col-md-4 mb-3">
                      <label class="form-label fw-bold">Th·ª£ ph·ª• tr√°ch</label>
                      <input type="text" class="form-control" id="wizardWorker" placeholder="Nh·∫≠p t√™n th·ª£">
                    </div>
                    <div class="col-md-12 mb-3">
                      <label class="form-label fw-bold">Ghi ch√∫ s·∫£n xu·∫•t</label>
                      <textarea class="form-control" id="wizardNote" rows="3" placeholder="Ghi ch√∫ v·ªÅ qu√° tr√¨nh s·∫£n xu·∫•t..."></textarea>
                    </div>
                  </div>
                </div>
              </div>

              <!-- Step 2: Handover Information -->
              <div class="step-content" id="step2">
                <div class="info-card">
                  <h5><i class="bi bi-arrow-right-circle me-2"></i>B∆∞·ªõc 2: Th√¥ng tin b√†n giao</h5>
                  <p class="mb-0">C·∫•u h√¨nh th√¥ng tin b√†n giao cho c√¥ng ƒëo·∫°n ti·∫øp theo.</p>
                </div>
                
                <div class="alert alert-info">
                  <h6><i class="bi bi-info-circle me-2"></i>C√¥ng ƒëo·∫°n ti·∫øp theo: <span id="wizardNextStage">X√âN</span></h6>
                  <p class="mb-0">S·∫£n ph·∫©m OK s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang c√¥ng ƒëo·∫°n ti·∫øp theo ƒë·ªÉ ti·∫øp t·ª•c x·ª≠ l√Ω</p>
                </div>
                
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">S·ªë l∆∞·ª£ng b√†n giao <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" value="0" min="0" id="wizardHandoverQty">
                    <div class="form-text">T·ª± ƒë·ªông = S·ªë l∆∞·ª£ng OK (c√≥ th·ªÉ ch·ªânh s·ª≠a)</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Ng√†y b√†n giao</label>
                    <input type="date" class="form-control" id="wizardHandoverDate">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Ng∆∞·ªùi b√†n giao</label>
                    <input type="text" class="form-control" id="wizardHandoverPerson" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi b√†n giao">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label fw-bold">Ng∆∞·ªùi nh·∫≠n</label>
                    <input type="text" class="form-control" id="wizardReceiverPerson" placeholder="Nh·∫≠p t√™n ng∆∞·ªùi nh·∫≠n">
                  </div>
                  <div class="col-md-12 mb-3">
                    <label class="form-label fw-bold">Ghi ch√∫ b√†n giao</label>
                    <textarea class="form-control" id="wizardHandoverNotes" rows="2" placeholder="Ghi ch√∫ v·ªÅ b√†n giao s·∫£n ph·∫©m..."></textarea>
                  </div>
                </div>
              </div>

              <!-- Step 3: Confirmation -->
              <div class="step-content" id="step3">
                <div class="info-card">
                  <h5><i class="bi bi-check-circle me-2"></i>B∆∞·ªõc 3: X√°c nh·∫≠n ho√†n th√†nh</h5>
                  <p class="mb-0">Ki·ªÉm tra l·∫°i t·∫•t c·∫£ th√¥ng tin tr∆∞·ªõc khi ho√†n th√†nh.</p>
                </div>
                
                <div class="row">
                  <div class="col-md-6">
                    <h6 class="text-primary mb-3">Th√¥ng tin l·ªánh s·∫£n xu·∫•t</h6>
                    <ul class="list-unstyled">
                      <li><strong>M√£ l·ªánh:</strong> <span id="confirmOrderCode"></span></li>
                      <li><strong>M√£ s·∫£n ph·∫©m:</strong> <span id="confirmProductCode"></span></li>
                      <li><strong>S·∫£n ph·∫©m:</strong> <span id="confirmProductName"></span></li>
                      <li><strong>Lo·∫°i gi·∫•y:</strong> <span id="confirmPaperType"></span></li>
                      <li><strong>Tr·ªçng l∆∞·ª£ng:</strong> <span id="confirmPaperWeight"></span></li>
                      <li><strong>S·ªë l∆∞·ª£ng k·∫ø ho·∫°ch:</strong> <span id="confirmQuantity"></span></li>
                    </ul>
                  </div>
                  <div class="col-md-6">
                    <h6 class="text-success mb-3">K·∫øt qu·∫£ s·∫£n xu·∫•t</h6>
                    <ul class="list-unstyled">
                      <li><strong>S·ªë l∆∞·ª£ng OK:</strong> <span id="confirmGoodQty">0</span> t·ªù</li>
                      <li><strong>S·ªë l∆∞·ª£ng NG:</strong> <span id="confirmNgQty">0</span> t·ªù</li>
                      <li><strong>Ti·∫øn ƒë·ªô:</strong> <span id="confirmProgress">0%</span></li>
                      <li><strong>M√°y s·∫£n xu·∫•t:</strong> <span id="confirmMachine">X·∫£ 1</span></li>
                      <li><strong>Th·ª£ ph·ª• tr√°ch:</strong> <span id="confirmWorker">Ch∆∞a nh·∫≠p</span></li>
                      <li><strong>Ca s·∫£n xu·∫•t:</strong> <span id="confirmShift">Ca 1</span></li>
                    </ul>
                  </div>
                </div>
                
                <div class="alert alert-warning mt-3">
                  <h6><i class="bi bi-exclamation-triangle me-2"></i>Th√¥ng tin b√†n giao</h6>
                  <p class="mb-2"><strong>S·ªë l∆∞·ª£ng b√†n giao:</strong> <span id="confirmHandoverQty">0</span> t·ªù</p>
                  <p class="mb-2"><strong>C√¥ng ƒëo·∫°n ti·∫øp theo:</strong> <span id="confirmNextStage">X√âN</span></p>
                  <p class="mb-2"><strong>Ng∆∞·ªùi b√†n giao:</strong> <span id="confirmHandoverPerson">Ch∆∞a nh·∫≠p</span></p>
                  <p class="mb-2"><strong>Ng∆∞·ªùi nh·∫≠n:</strong> <span id="confirmReceiverPerson">Ch∆∞a nh·∫≠p</span></p>
                  <p class="mb-0"><strong>Ghi ch√∫ b√†n giao:</strong> <span id="confirmHandoverNotes">Kh√¥ng c√≥</span></p>
                </div>
                
                <div class="alert alert-secondary">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="wizardConfirmHandover">
                    <label class="form-check-label" for="wizardConfirmHandover">
                      <strong>T√¥i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng cho c√¥ng ƒëo·∫°n ti·∫øp theo</strong>
                    </label>
                  </div>
                </div>
              </div>
            </div>

            <!-- Footer -->
            <div class="wizard-footer">
              <div class="step-indicator">
                B∆∞·ªõc <span id="wizardCurrentStep">1</span> / 3
              </div>
              <div>
                <button class="btn btn-secondary me-2" id="wizardPrevBtn" onclick="wizardPreviousStep()" style="display: none;">
                  <i class="bi bi-arrow-left me-1"></i>Quay l·∫°i
                </button>
                <button class="btn btn-primary me-2" id="wizardNextBtn" onclick="wizardNextStep()">
                  Ti·∫øp theo<i class="bi bi-arrow-right ms-1"></i>
                </button>
                <button class="btn btn-success" id="wizardFinishBtn" onclick="wizardFinish()" style="display: none;">
                  <i class="bi bi-check-lg me-1"></i>Ho√†n th√†nh
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * =================================================================
     * X·∫¢ STAGE MANAGEMENT - QU·∫¢N L√ù C√îNG ƒêO·∫†N X·∫¢
     * =================================================================
     * Ch·ª©c nƒÉng ch√≠nh:
     * 1. Hi·ªÉn th·ªã danh s√°ch l·ªánh s·∫£n xu·∫•t ·ªü c√¥ng ƒëo·∫°n X·∫¢
     * 2. Ho√†n th√†nh c√¥ng ƒëo·∫°n X·∫¢ (c·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng OK, NG)
     * 3. B√†n giao sang c√¥ng ƒëo·∫°n ti·∫øp theo theo workflow_definition
     */

    // === C·∫§U H√åNH API & WEBHOOK ===
    const API_BASE_URL = 'https://autoslp.duckdns.org/api';
    const WEBHOOK_BASE_URL = 'https://autoslp.duckdns.org:5678/webhook';

    // === C·∫§U H√åNH PERFORMANCE ===
    const PERFORMANCE_CONFIG = {
        RETRY_ATTEMPTS: 3,
        RETRY_DELAY: 1000, // 1 gi√¢y
        TIMEOUT: 10000 // 10 gi√¢y
    };

    // === C·∫§U H√åNH C√îNG ƒêO·∫†N ===
    const STAGE_CONFIG = {
        KEY: 'xa',           // T√™n key trong database
        NAME: 'X·∫¢',          // T√™n hi·ªÉn th·ªã
        NEXT_STAGE: null     // S·∫Ω ƒë∆∞·ª£c x√°c ƒë·ªãnh t·ª´ workflow_definition
    };

    // === BI·∫æN GLOBAL ===
    let ordersData = [];        // D·ªØ li·ªáu l·ªánh s·∫£n xu·∫•t
    let currentEditingOrder = null;  // ƒê∆°n h√†ng ƒëang ch·ªânh s·ª≠a
    let loadingStartTime = 0;   // Th·ªùi gian b·∫Øt ƒë·∫ßu load
    let performanceMetrics = {}; // Metrics hi·ªáu su·∫•t

    /**
     * =================================================================
     * PERFORMANCE & TIMING FUNCTIONS
     * =================================================================
     */

    /**
     * B·∫Øt ƒë·∫ßu ƒëo th·ªùi gian
     */
    function startTiming(operation) {
        const startTime = performance.now();
        performanceMetrics[operation] = { startTime };
        console.log(`‚è±Ô∏è [${operation}] B·∫Øt ƒë·∫ßu: ${new Date().toISOString()}`);
        return startTime;
    }

    /**
     * K·∫øt th√∫c ƒëo th·ªùi gian v√† log k·∫øt qu·∫£
     */
    function endTiming(operation, additionalInfo = '') {
        if (performanceMetrics[operation]) {
            const endTime = performance.now();
            const duration = endTime - performanceMetrics[operation].startTime;
            performanceMetrics[operation].endTime = endTime;
            performanceMetrics[operation].duration = duration;
            
            console.log(`‚úÖ [${operation}] Ho√†n th√†nh: ${duration.toFixed(2)}ms ${additionalInfo}`);
            
            // Hi·ªÉn th·ªã th√¥ng b√°o n·∫øu load qu√° ch·∫≠m
            if (duration > 3000) {
                showNotification(`‚ö†Ô∏è ${operation} ch·∫≠m: ${duration.toFixed(0)}ms`, 'warning');
            }
            
            return duration;
        }
        return 0;
    }

    /**
     * Log t·ªïng th·ªùi gian load
     */
    function logTotalLoadTime() {
        const totalTime = performance.now() - loadingStartTime;
        console.log(`üöÄ T·ªîNG TH·ªúI GIAN LOAD: ${totalTime.toFixed(2)}ms`);
        
        // Log chi ti·∫øt t·ª´ng b∆∞·ªõc
        Object.keys(performanceMetrics).forEach(operation => {
            const metric = performanceMetrics[operation];
            if (metric.duration) {
                const percentage = ((metric.duration / totalTime) * 100).toFixed(1);
                console.log(`  üìä ${operation}: ${metric.duration.toFixed(2)}ms (${percentage}%)`);
            }
        });
    }

    /**
     * Hi·ªÉn th·ªã performance metrics trong modal
     */
    function showPerformanceMetrics() {
        const totalTime = performance.now() - loadingStartTime;
        let metricsHtml = `
            <div class="table-responsive">
                <table class="table table-sm">
                    <thead>
                        <tr>
                            <th>Operation</th>
                            <th>Duration</th>
                            <th>Percentage</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody>
        `;
        
        Object.keys(performanceMetrics).forEach(operation => {
            const metric = performanceMetrics[operation];
            if (metric.duration) {
                const percentage = ((metric.duration / totalTime) * 100).toFixed(1);
                const status = metric.duration > 3000 ? '‚ö†Ô∏è Slow' : '‚úÖ Fast';
                const statusClass = metric.duration > 3000 ? 'text-warning' : 'text-success';
                
                metricsHtml += `
                    <tr>
                        <td><strong>${operation}</strong></td>
                        <td>${metric.duration.toFixed(2)}ms</td>
                        <td>${percentage}%</td>
                        <td class="${statusClass}">${status}</td>
                    </tr>
                `;
            }
        });
        
        metricsHtml += `
                    </tbody>
                </table>
            </div>
            <div class="alert alert-info">
                <strong>T·ªïng th·ªùi gian:</strong> ${totalTime.toFixed(2)}ms
            </div>
        `;
        
        // Show in modal
        const modal = new bootstrap.Modal(document.getElementById('performanceModal'));
        document.getElementById('performanceModalBody').innerHTML = metricsHtml;
        modal.show();
    }



    /**
     * =================================================================
     * ENHANCED API FUNCTIONS - API C·∫¢I TI·∫æN
     * =================================================================
     */

    /**
     * Fetch v·ªõi timeout v√† retry
     */
    async function fetchWithTimeout(url, options = {}, timeout = PERFORMANCE_CONFIG.TIMEOUT) {
        const controller = new AbortController();
        const timeoutId = setTimeout(() => controller.abort(), timeout);

        try {
            const response = await fetch(url, {
                ...options,
                signal: controller.signal
            });
            clearTimeout(timeoutId);
            return response;
        } catch (error) {
            clearTimeout(timeoutId);
            throw error;
        }
    }

    /**
     * Fetch v·ªõi retry logic - t·ªëi ∆∞u cho performance
     */
    async function fetchWithRetry(url, options = {}, maxRetries = PERFORMANCE_CONFIG.RETRY_ATTEMPTS) {
        let lastError;
        
        // T·ªëi ∆∞u: Gi·∫£m logging cho performance
        const shouldLog = maxRetries > 2; // Ch·ªâ log khi retry nhi·ªÅu
        
        for (let attempt = 1; attempt <= maxRetries; attempt++) {
            try {
                if (shouldLog) {
                    console.log(`üîÑ API attempt ${attempt}/${maxRetries}: ${url}`);
                }
                
                // T·ªëi ∆∞u: S·ª≠ d·ª•ng timeout ng·∫Øn h∆°n cho retry
                const timeout = attempt === 1 ? PERFORMANCE_CONFIG.TIMEOUT : 3000;
                const response = await fetchWithTimeout(url, options, timeout);
                
                if (response.ok) {
                    if (attempt > 1 && shouldLog) {
                        console.log(`‚úÖ API succeeded on attempt ${attempt}`);
                    }
                    return response;
                }
                
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                
            } catch (error) {
                lastError = error;
                if (shouldLog) {
                    console.warn(`‚ùå API attempt ${attempt} failed:`, error.message);
                }
                
                if (attempt < maxRetries) {
                    // T·ªëi ∆∞u: Gi·∫£m delay cho retry nhanh h∆°n
                    const delay = Math.min(PERFORMANCE_CONFIG.RETRY_DELAY * attempt, 2000);
                    if (shouldLog) {
                        console.log(`‚è≥ Retrying in ${delay}ms...`);
                    }
                    await new Promise(resolve => setTimeout(resolve, delay));
                }
            }
        }
        
        throw lastError;
    }

    /**
     * Load nhanh ch·ªâ 500 records ƒë·∫ßu ti√™n
     */
    async function loadOrdersDataFast() {
        const timingKey = 'loadOrdersDataFast';
        startTiming(timingKey);
        
        try {
            console.log('‚ö° Fast loading 500 records...');
            showLoading('ƒêang t·∫£i nhanh 500 records...');
            
            // Load ch·ªâ 500 records ƒë·∫ßu ti√™n
            const url = `${API_BASE_URL}/data/production_orders?limit=500`;
            const response = await fetchWithRetry(url, {}, 1); // Ch·ªâ retry 1 l·∫ßn
            const apiData = await response.json();
            
            console.log(`üìä Fast API response: ${Array.isArray(apiData) ? apiData.length : 'invalid'} records`);
            
            // Transform data
            const transformStart = performance.now();
            ordersData = transformApiData(apiData);
            const transformTime = performance.now() - transformStart;
            console.log(`üîÑ Fast transformation: ${transformTime.toFixed(2)}ms`);
            
            // Re-render
            renderOrdersTable();
            updateStatistics();
            
            endTiming(timingKey, `(Fast load, ${ordersData.length} orders)`);
            showNotification(`ƒê√£ t·∫£i nhanh ${ordersData.length} records`, 'success');
            
        } catch (error) {
            console.error('‚ùå Fast load error:', error.message);
            endTiming(timingKey, '(failed)');
            showNotification('L·ªói t·∫£i nhanh: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * T·∫£i d·ªØ li·ªáu l·ªánh s·∫£n xu·∫•t t·ª´ API v·ªõi performance optimization
     */
    async function loadOrdersData() {
        const timingKey = 'loadOrdersData';
        startTiming(timingKey);
        
        try {
            console.log('üåê Loading from API...');
            
            // T·ªëi ∆∞u: Th√™m pagination ƒë·ªÉ load nhanh h∆°n
            const pageSize = 500; // Load 500 records m·ªói l·∫ßn
            let allData = [];
            let page = 1;
            let hasMore = true;
            
            while (hasMore) {
                const url = `${API_BASE_URL}/data/production_orders?page=${page}&limit=${pageSize}`;
                
                // T·ªëi ∆∞u: Gi·∫£m timeout v√† retry cho load nhanh h∆°n
                const fastOptions = {
                    timeout: 5000, // Gi·∫£m timeout xu·ªëng 5s
                    maxRetries: 2   // Gi·∫£m retry xu·ªëng 2 l·∫ßn
                };
                
                // G·ªçi API v·ªõi timeout ng·∫Øn h∆°n
                const response = await fetchWithRetry(url, {}, fastOptions.maxRetries);
                const apiData = await response.json();
                
                if (!Array.isArray(apiData) || apiData.length === 0) {
                    hasMore = false;
                    break;
                }
                
                allData = allData.concat(apiData);
                console.log(`üìä Page ${page}: ${apiData.length} records (Total: ${allData.length})`);
                
                // N·∫øu √≠t h∆°n pageSize, ƒë√£ h·∫øt d·ªØ li·ªáu
                if (apiData.length < pageSize) {
                    hasMore = false;
                }
                
                page++;
                
                // Gi·ªõi h·∫°n t·ªëi ƒëa 3 pages ƒë·ªÉ tr√°nh load qu√° nhi·ªÅu
                if (page > 3) {
                    console.log('‚ö†Ô∏è Reached page limit, stopping pagination');
                    hasMore = false;
                }
            }
            
            console.log(`üìä Total API response: ${allData.length} records`);
            
            // T·ªëi ∆∞u: S·ª≠ d·ª•ng Web Workers n·∫øu c√≥ nhi·ªÅu d·ªØ li·ªáu (>1000 records)
            if (allData.length > 1000) {
                console.log('üöÄ Using optimized processing for large dataset...');
                ordersData = await transformApiDataOptimized(allData);
            } else {
                // Transform data v·ªõi performance optimization
                const transformStart = performance.now();
                ordersData = transformApiData(allData);
                const transformTime = performance.now() - transformStart;
                console.log(`üîÑ Data transformation: ${transformTime.toFixed(2)}ms`);
            }
            
            endTiming(timingKey, `(API hit, ${ordersData.length} orders)`);
            
        } catch (error) {
            console.error('‚ùå API error:', error.message);
            ordersData = [];
            endTiming(timingKey, '(failed, empty data)');
            showNotification('Kh√¥ng th·ªÉ t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
        }
    }

    /**
     * Transform API data v·ªõi performance optimization (cho dataset nh·ªè)
     */
    function transformApiData(apiData) {
        if (!Array.isArray(apiData)) {
            console.warn('API data is not an array:', apiData);
            return [];
        }

        // Pre-allocate array size for better performance
        const transformedData = new Array(apiData.length);
        
        // Batch process ƒë·ªÉ t·ªëi ∆∞u performance
        const batchSize = 100;
        for (let i = 0; i < apiData.length; i += batchSize) {
            const batch = apiData.slice(i, i + batchSize);
            
            batch.forEach((order, batchIndex) => {
                const index = i + batchIndex;
                transformedData[index] = transformOrder(order);
            });
        }
        
        return transformedData;
    }

    /**
     * Transform API data v·ªõi t·ªëi ∆∞u cho dataset l·ªõn
     */
    async function transformApiDataOptimized(apiData) {
        if (!Array.isArray(apiData)) {
            console.warn('API data is not an array:', apiData);
            return [];
        }

        console.log('‚ö° Using optimized transformation...');
        const transformStart = performance.now();
        
        // T·ªëi ∆∞u: S·ª≠ d·ª•ng Promise.all v·ªõi chunk processing
        const chunkSize = 200; // TƒÉng batch size
        const chunks = [];
        
        for (let i = 0; i < apiData.length; i += chunkSize) {
            chunks.push(apiData.slice(i, i + chunkSize));
        }
        
        // Process chunks in parallel
        const chunkPromises = chunks.map((chunk, chunkIndex) => {
            return new Promise(resolve => {
                // S·ª≠ d·ª•ng setTimeout ƒë·ªÉ kh√¥ng block main thread
                setTimeout(() => {
                    const transformedChunk = chunk.map(order => transformOrder(order));
                    resolve(transformedChunk);
                }, 0);
            });
        });
        
        const transformedChunks = await Promise.all(chunkPromises);
        const result = transformedChunks.flat();
        
        const transformTime = performance.now() - transformStart;
        console.log(`‚ö° Optimized transformation: ${transformTime.toFixed(2)}ms`);
        
        return result;
    }

    /**
     * Transform m·ªôt order v·ªõi optimization
     */
    function transformOrder(order) {
        let workflowDef = order.workflow_definition;
        
        // TEMPORARY FALLBACK: N·∫øu workflow_definition l√† null, t·∫°o workflow test d·ª±a tr√™n work_stage ho·∫∑c ID
        if (workflowDef === null || workflowDef === undefined || workflowDef === '') {
            // T·∫°o workflow test d·ª±a tr√™n ID ƒë·ªÉ demo
            if (order.id % 3 === 0) {
                workflowDef = "xa,in_offset,boi,kho"; // Test v·ªõi in_offset
            } else if (order.id % 3 === 1) {
                workflowDef = "xa,xen,be,dan,kho"; // Test v·ªõi xen
            } else {
                workflowDef = "xa,boi,kho"; // Test workflow ng·∫Øn
            }
        }
        
        const nextStage = getNextStageFromWorkflow(workflowDef, STAGE_CONFIG.KEY);
        
        return {
            id: order.id,
            production_order: order.order_code || order.production_order,
            product_name: order.product_name,
            internal_product_code: order.internal_product_code,
            customer_name: order.customer_name,
            total_quantity: order.quantity || order.total_quantity,
            xa_input_quantity: order.quantity || order.total_quantity || 0,
            xa_output_quantity: order.xa_output_quantity || 0,
            xa_good_quantity: order.xa_good_quantity || 0,
            xa_ng_quantity: order.xa_ng_quantity || 0,
            xa_status: order.xa_status || order.status || 'waiting',
            xa_machine_name: order.xa_machine_name || '',
            xa_worker_name: order.xa_worker_name || '',
            xa_note: order.xa_note || order.notes || '',
            paper_type: order.paper_type || '',
            paper_weight: order.paper_weight || 0,
            production_shift: order.shift || order.production_shift || '',
            delivery_date: order.delivery_date,
            deployment_date: order.deployment_date || order.created_at,
            workflow_definition: workflowDef,
            next_stage: nextStage,
            created_at: order.created_at,
            updated_at: order.updated_at
        };
    }

    /**
     * =================================================================
     * WORKFLOW FUNCTIONS - H√ÄM X·ª¨ L√ù WORKFLOW
     * =================================================================
     */

    /**
     * L·∫•y stage ti·∫øp theo t·ª´ workflow definition
     * @param {string} workflowDef - Workflow definition (VD: "xa,xen,in" ho·∫∑c "xa,in_offset")
     * @param {string} currentStage - Stage hi·ªán t·∫°i
     * @returns {string|null} Stage ti·∫øp theo ho·∫∑c null n·∫øu l√† stage cu·ªëi
     */
    function getNextStageFromWorkflow(workflowDef, currentStage) {
        if (!workflowDef) {
            return null;
        }
        
        const stages = workflowDef.split(',').map(s => s.trim());
        const currentIndex = stages.indexOf(currentStage);
        
        if (currentIndex === -1 || currentIndex >= stages.length - 1) {
            return null; // Kh√¥ng t√¨m th·∫•y ho·∫∑c ƒë√£ l√† stage cu·ªëi
        }
        
        const nextStage = stages[currentIndex + 1];
        return nextStage;
    }

    /**
     * L·∫•y t√™n hi·ªÉn th·ªã c·ªßa stage
     * @param {string} stageKey - Key c·ªßa stage
     * @returns {string} T√™n hi·ªÉn th·ªã
     */
    function getStageDisplayName(stageKey) {
        const stageNames = {
            'xa': 'X·∫¢',
            'xen': 'X√âN', 
            'in_offset': 'IN OFFSET',
            'boi': 'B·ªíI',
            'be': 'B·∫æ',
            'dan': 'D√ÅN',
            'kho': 'KHO'
        };
        
        return stageNames[stageKey] || stageKey.toUpperCase();
    }

    /**
     * L·∫•y m√†u s·∫Øc theo stage
     * @param {string} stageKey - Key c·ªßa stage
     * @returns {string} CSS class m√†u s·∫Øc
     */
    function getStageColor(stageKey) {
        const stageColors = {
            'xa': 'primary',
            'xen': 'success',
            'in_offset': 'purple',
            'boi': 'warning',
            'be': 'danger',
            'dan': 'dark',
            'kho': 'secondary'
        };
        
        return stageColors[stageKey] || 'secondary';
    }

    /**
     * =================================================================
     * WEBHOOK FUNCTIONS - H√ÄM G·ª¨I D·ªÆ LI·ªÜU QUA WEBHOOK
     * =================================================================
     */

    /**
     * G·ª≠i d·ªØ li·ªáu qua webhook n8n
     * @param {string} action - Lo·∫°i h√†nh ƒë·ªông
     * @param {Object} data - D·ªØ li·ªáu g·ª≠i ƒëi
     * @returns {Promise<Object>} K·∫øt qu·∫£ g·ª≠i webhook
     */
    async function sendWebhook(action, data) {
        try {
            const payload = {
                action: action,
                timestamp: new Date().toISOString(),
                source: 'xa_stage_frontend',
                data: data
            };

            const response = await fetch(`${WEBHOOK_BASE_URL}/production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }

            const result = await response.json();
            
            return {
                success: true,
                message: 'D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c g·ª≠i qua webhook th√†nh c√¥ng',
                webhook_response: result
            };

        } catch (error) {
            console.error('Error sending webhook:', error);
            
            // Fallback: L∆∞u v√†o localStorage ƒë·ªÉ retry sau
            saveToLocalStorage(action, data);
            
            return {
                success: true,
                message: 'ƒê√£ l∆∞u d·ªØ li·ªáu local (s·∫Ω ƒë·ªìng b·ªô khi c√≥ k·∫øt n·ªëi)',
                local_only: true
            };
        }
    }

    /**
     * L∆∞u d·ªØ li·ªáu v√†o localStorage ƒë·ªÉ retry sau
     */
    function saveToLocalStorage(action, data) {
        try {
            const key = 'pending_webhooks_xa';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            
            existing.push({
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(key, JSON.stringify(existing));
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }

    /**
     * ƒê·ªìng b·ªô d·ªØ li·ªáu ƒë√£ l∆∞u trong localStorage
     */
    async function syncPendingData() {
        try {
            const key = 'pending_webhooks_xa';
            const pending = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (pending.length === 0) return;
            
            for (const item of pending) {
                await sendWebhook(item.action, item.data);
            }
            
            // X√≥a d·ªØ li·ªáu ƒë√£ sync
            localStorage.removeItem(key);
            showNotification('ƒê√£ ƒë·ªìng b·ªô d·ªØ li·ªáu th√†nh c√¥ng', 'success');
            
        } catch (error) {
            console.error('Error syncing pending data:', error);
        }
    }

    /**
     * =================================================================
     * KH·ªûI T·∫†O TRANG - PAGE INITIALIZATION
     * =================================================================
     */
    
    // Kh·ªüi t·∫°o khi trang ƒë∆∞·ª£c load
    document.addEventListener('DOMContentLoaded', function() {
        initializePage();
    });

    /**
     * Kh·ªüi t·∫°o trang - load d·ªØ li·ªáu v√† setup UI v·ªõi performance tracking
     */
    async function initializePage() {
        loadingStartTime = performance.now();
        console.log('üöÄ B·∫Øt ƒë·∫ßu kh·ªüi t·∫°o trang...');
        
        try {
            showLoading('ƒêang t·∫£i d·ªØ li·ªáu...');
            
            // T·∫£i d·ªØ li·ªáu t·ª´ API
            await loadOrdersData();
            
            // Render giao di·ªán
            startTiming('renderOrdersTable');
            renderOrdersTable();
            endTiming('renderOrdersTable');
            
            startTiming('updateStatistics');
            updateStatistics();
            endTiming('updateStatistics');
            
            // Setup c√°c event listeners
            startTiming('setupEventListeners');
            setupEventListeners();
            endTiming('setupEventListeners');
            
            // Log t·ªïng th·ªùi gian
            logTotalLoadTime();
            
            showNotification('ƒê√£ t·∫£i d·ªØ li·ªáu th√†nh c√¥ng', 'success');
            
        } catch (error) {
            console.error('‚ùå Error initializing page:', error);
            showNotification('L·ªói t·∫£i d·ªØ li·ªáu: ' + error.message, 'error');
            
            // Fallback: s·ª≠ d·ª•ng d·ªØ li·ªáu m·∫´u
            startTiming('loadSampleData');
            loadSampleData();
            endTiming('loadSampleData');
            
            renderOrdersTable();
            updateStatistics();
        } finally {
            hideLoading();
        }
    }

    /**
     * =================================================================
     * QU·∫¢N L√ù D·ªÆ LI·ªÜU - DATA MANAGEMENT
     * =================================================================
     */



    /**
     * =================================================================
     * REFRESH FUNCTIONS
     * =================================================================
     */

    /**
     * Refresh d·ªØ li·ªáu t·ª´ API
     */
    async function refreshData() {
        console.log('üîÑ Refreshing data...');
        startTiming('refreshData');
        
        try {
            showLoading('ƒêang l√†m m·ªõi d·ªØ li·ªáu...');
            
            // Reload data t·ª´ API
            await loadOrdersData();
            
            // Re-render
            renderOrdersTable();
            updateStatistics();
            
            endTiming('refreshData');
            showNotification('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng', 'success');
            
        } catch (error) {
            console.error('‚ùå Refresh failed:', error);
            endTiming('refreshData');
            showNotification('L·ªói l√†m m·ªõi d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * =================================================================
     * HI·ªÇN TH·ªä D·ªÆ LI·ªÜU - DATA RENDERING
     * =================================================================
     */

    /**
     * Render b·∫£ng danh s√°ch l·ªánh s·∫£n xu·∫•t v·ªõi performance optimization
     */
    function renderOrdersTable() {
        const tableBody = document.getElementById('stageTableBody');
        if (!tableBody) {
            console.error('Table body element not found');
            return;
        }
        
        // X√≥a d·ªØ li·ªáu c≈©
        tableBody.innerHTML = '';
        
        // Ki·ªÉm tra c√≥ d·ªØ li·ªáu kh√¥ng
        if (ordersData.length === 0) {
            tableBody.innerHTML = `
                <tr>
                    <td colspan="12" class="text-center text-muted py-4">
                        <i class="bi bi-inbox fs-1 mb-2 d-block"></i>
                        Kh√¥ng c√≥ l·ªánh s·∫£n xu·∫•t n√†o cho c√¥ng ƒëo·∫°n ${STAGE_CONFIG.NAME}
                    </td>
                </tr>
            `;
            return;
        }
        
        // Performance optimization: Use DocumentFragment for batch DOM updates
        const fragment = document.createDocumentFragment();
        
        // Batch process ƒë·ªÉ t·ªëi ∆∞u performance
        const batchSize = 50;
        for (let i = 0; i < ordersData.length; i += batchSize) {
            const batch = ordersData.slice(i, i + batchSize);
            
            batch.forEach((order, batchIndex) => {
                const index = i + batchIndex;
                const row = createOrderTableRow(order, index);
                fragment.appendChild(row);
            });
            
            // Allow browser to process other tasks between batches
            if (i + batchSize < ordersData.length) {
                setTimeout(() => {
                    // Continue with next batch
                }, 0);
            }
        }
        
        // Append all rows at once
        tableBody.appendChild(fragment);
        
        console.log(`üìä Rendered ${ordersData.length} orders in table`);
    }

    /**
     * T·∫°o m·ªôt d√≤ng trong b·∫£ng cho m·ªôt l·ªánh s·∫£n xu·∫•t
     */
    function createOrderTableRow(order, index) {
        const row = document.createElement('tr');
        row.className = 'order-row';
        row.setAttribute('data-order-id', order.id);
        
        // T√≠nh to√°n tr·∫°ng th√°i v√† ti·∫øn ƒë·ªô
        const status = order.xa_status || 'waiting';
        const inputQty = order.xa_input_quantity || 0;
        const goodQty = order.xa_good_quantity || 0;
        const ngQty = order.xa_ng_quantity || 0;
        const progressPercent = inputQty > 0 ? Math.round((goodQty / inputQty) * 100) : 0;
        
        // X√°c ƒë·ªãnh icon v√† m√†u s·∫Øc theo tr·∫°ng th√°i
        let statusIcon = 'bi-clock';
        let statusClass = 'text-warning';
        let statusText = 'Ch·ªù x·ª≠ l√Ω';
        
        switch (status) {
            case 'in_progress':
                statusIcon = 'bi-play-circle';
                statusClass = 'text-primary';
                statusText = 'ƒêang x·ª≠ l√Ω';
                break;
            case 'completed':
                statusIcon = 'bi-check-circle';
                statusClass = 'text-success';
                statusText = 'Ho√†n th√†nh';
                break;
            case 'paused':
                statusIcon = 'bi-pause-circle';
                statusClass = 'text-warning';
                statusText = 'T·∫°m d·ª´ng';
                break;
        }
        
        // T·∫°o HTML cho d√≤ng
        row.innerHTML = `
            <td class="text-center">
                <span class="badge bg-light text-dark">${index + 1}</span>
            </td>
            <td>
                <div class="d-flex align-items-center">
                    <i class="bi ${statusIcon} ${statusClass} me-2"></i>
                    <div>
                        <div class="fw-bold">${order.production_order}</div>
                        <small class="text-muted">${formatDate(order.deployment_date)} - ${order.production_shift}</small>
                    </div>
                </div>
            </td>
            <td>
                <div>
                    <div class="fw-bold">${order.internal_product_code}</div>
                    <small class="text-muted" title="${order.product_name}">${truncateText(order.product_name, 30)}</small>
                </div>
            </td>
            <td class="text-center">
                <span class="badge bg-secondary">${order.paper_type || 'N/A'}</span>
            </td>
            <td class="text-center">
                <span class="fw-bold">${order.paper_weight || 0} gsm</span>
            </td>
            <td class="text-center">
                <div class="fw-bold text-info">${formatNumber(inputQty)}</div>
                <small class="text-muted">k·∫ø ho·∫°ch</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-primary">${formatNumber(inputQty)}</div>
                <small class="text-muted">ƒë·∫ßu v√†o</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-success">${formatNumber(goodQty)}</div>
                <small class="text-muted">OK</small>
            </td>
            <td class="text-center">
                <div class="fw-bold text-danger">${formatNumber(ngQty)}</div>
                <small class="text-muted">NG</small>
            </td>
            <td class="text-center">
                <div class="progress" style="height: 20px;">
                    <div class="progress-bar ${progressPercent >= 100 ? 'bg-success' : 'bg-primary'}" 
                         style="width: ${Math.min(progressPercent, 100)}%">
                        ${progressPercent}%
                    </div>
                </div>
                <small class="text-muted">${statusText}</small>
            </td>
            <td class="text-center">
                <small class="text-muted d-block">${order.xa_machine_name || 'Ch∆∞a g√°n'}</small>
                <small class="text-muted">${order.xa_worker_name || 'Ch∆∞a g√°n'}</small>
            </td>
            <td class="text-center">
                ${createActionButtons(order)}
            </td>
        `;
        
        // Add click event to show details panel
        row.style.cursor = 'pointer';
        row.onclick = (e) => {
            // Don't trigger if clicking on action buttons
            if (e.target.closest('.action-buttons')) {
                return;
            }
            showOrderDetails(order.id);
        };
        
        return row;
    }

    /**
     * T·∫°o c√°c n√∫t thao t√°c cho t·ª´ng d√≤ng
     */
    function createActionButtons(order) {
        const status = order.xa_status || 'waiting';
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HO√ÄN TH√ÄNH';
        
        let buttons = `
            <div class="btn-group btn-group-sm">
                <button class="btn btn-info rounded-pill px-3 me-1" 
                        onclick="viewOrderDetails(${order.id})" 
                        title="Xem chi ti·∫øt">
                    <i class="bi bi-eye me-1"></i>Chi ti·∫øt
                </button>
        `;
        
        // N√∫t Ho√†n th√†nh - ch·ªâ hi·ªán khi ch∆∞a ho√†n th√†nh
        if (status !== 'completed') {
            buttons += `
                <button class="btn btn-success rounded-pill px-3" 
                        onclick="showCompleteModal(${order.id})" 
                        title="Ho√†n th√†nh c√¥ng ƒëo·∫°n">
                    <i class="bi bi-check-lg me-1"></i>Ho√†n th√†nh
                </button>
            `;
        } else if (nextStage) {
            // N√∫t B√†n giao - ch·ªâ hi·ªán khi ƒë√£ ho√†n th√†nh v√† c√≥ stage ti·∫øp theo
            buttons += `
                <button class="btn btn-primary rounded-pill px-3" 
                        onclick="showHandoverModal(${order.id})" 
                        title="B√†n giao cho c√¥ng ƒëo·∫°n ${nextStageName}">
                    <i class="bi bi-arrow-right-circle me-1"></i>B√†n giao ${nextStageName}
                </button>
            `;
        } else {
            // ƒê√£ ho√†n th√†nh v√† kh√¥ng c√≥ stage ti·∫øp theo
            buttons += `
                <span class="badge bg-success">
                    <i class="bi bi-check-circle me-1"></i>Ho√†n th√†nh workflow
                </span>
            `;
        }
        
        buttons += `</div>`;
        return buttons;
    }

    /**
     * C·∫≠p nh·∫≠t th·ªëng k√™ t·ªïng quan
     */
    function updateStatistics() {
        const totalOrders = ordersData.length;
        const totalPlan = ordersData.reduce((sum, order) => sum + (order.xa_input_quantity || 0), 0);
        const totalGood = ordersData.reduce((sum, order) => sum + (order.xa_good_quantity || 0), 0);
        const totalNg = ordersData.reduce((sum, order) => sum + (order.xa_ng_quantity || 0), 0);
        
        // C·∫≠p nh·∫≠t c√°c th·∫ª th·ªëng k√™
        updateElementText('totalOrders', totalOrders);
        updateElementText('totalPlan', formatNumber(totalPlan));
        updateElementText('totalGood', formatNumber(totalGood));
        updateElementText('totalNg', formatNumber(totalNg));
    }

    /**
     * =================================================================
     * X·ª¨ L√ù S·ª∞ KI·ªÜN - EVENT HANDLERS
     * =================================================================
     */

    /**
     * Setup c√°c event listeners
     */
    function setupEventListeners() {
        // N√∫t l√†m m·ªõi d·ªØ li·ªáu
        const refreshBtn = document.querySelector('[onclick="refreshData()"]');
        if (refreshBtn) {
            refreshBtn.onclick = refreshData;
        }
        
        // N√∫t th√™m m·ªõi (t·∫°m th·ªùi disable)
        const addBtn = document.querySelector('[onclick="showNewOrderForm()"]');
        if (addBtn) {
            addBtn.onclick = () => showNotification('Ch·ª©c nƒÉng th√™m m·ªõi ƒëang ph√°t tri·ªÉn', 'info');
        }
        
        // Wizard event listeners
        setupWizardEventListeners();
    }

    /**
     * Setup event listeners cho wizard form
     */
    function setupWizardEventListeners() {
        // Event listeners cho c√°c input trong wizard
        const wizardGoodQty = document.getElementById('wizardGoodQty');
        const wizardNgQty = document.getElementById('wizardNgQty');
        const wizardHandoverQty = document.getElementById('wizardHandoverQty');
        
        if (wizardGoodQty) {
            wizardGoodQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardNgQty) {
            wizardNgQty.addEventListener('input', function() {
                updateWizardHandoverQuantity();
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
        
        if (wizardHandoverQty) {
            wizardHandoverQty.addEventListener('input', function() {
                if (wizardCurrentStep === 3) updateWizardConfirmation();
            });
        }
    }

    /**
     * L√†m m·ªõi d·ªØ li·ªáu
     */
    async function refreshData() {
        try {
            showLoading('ƒêang l√†m m·ªõi d·ªØ li·ªáu...');
            await loadOrdersData();
            renderOrdersTable();
            updateStatistics();
            showNotification('ƒê√£ l√†m m·ªõi d·ªØ li·ªáu th√†nh c√¥ng', 'info');
        } catch (error) {
            console.error('Error refreshing data:', error);
            showNotification('L·ªói l√†m m·ªõi d·ªØ li·ªáu: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * Xem chi ti·∫øt l·ªánh s·∫£n xu·∫•t
     */
    function viewOrderDetails(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Kh√¥ng t√¨m th·∫•y l·ªánh s·∫£n xu·∫•t', 'error');
            return;
        }
        
        // T·∫°o n·ªôi dung chi ti·∫øt
        const details = `
M√£ l·ªánh: ${order.production_order}
S·∫£n ph·∫©m: ${order.product_name}
M√£ n·ªôi b·ªô: ${order.internal_product_code}
Kh√°ch h√†ng: ${order.customer_name}
Lo·∫°i gi·∫•y: ${order.paper_type} - ${order.paper_weight} gsm
S·ªë l∆∞·ª£ng k·∫ø ho·∫°ch: ${formatNumber(order.xa_input_quantity)}
S·ªë l∆∞·ª£ng ƒë·∫°t: ${formatNumber(order.xa_good_quantity)}
S·ªë l∆∞·ª£ng NG: ${formatNumber(order.xa_ng_quantity)}
M√°y s·∫£n xu·∫•t: ${order.xa_machine_name || 'Ch∆∞a g√°n'}
Th·ª£ ph·ª• tr√°ch: ${order.xa_worker_name || 'Ch∆∞a g√°n'}
Tr·∫°ng th√°i: ${getStatusText(order.xa_status)}
Ghi ch√∫: ${order.xa_note || 'Kh√¥ng c√≥'}
        `.trim();
        
        alert('CHI TI·∫æT L·ªÜNH S·∫¢N XU·∫§T\n\n' + details);
    }

    /**
     * Hi·ªÉn th·ªã modal ho√†n th√†nh c√¥ng ƒëo·∫°n - Wizard Form
     */
    function showCompleteModal(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Kh√¥ng t√¨m th·∫•y l·ªánh s·∫£n xu·∫•t', 'error');
            return;
        }
        
        currentEditingOrder = order;
        
        // C·∫≠p nh·∫≠t th√¥ng tin v·ªÅ stage ti·∫øp theo
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HO√ÄN TH√ÄNH WORKFLOW';
        
        // C·∫≠p nh·∫≠t m√£ l·ªánh trong header modal
        updateElementText('modalOrderCode', order.production_order);
        
        // Populate wizard form v·ªõi th√¥ng tin l·ªánh (cho confirmation step)
        setElementValue('wizardOrderCode', order.production_order);
        setElementValue('wizardProductCode', order.internal_product_code || '');
        setElementValue('wizardProductName', order.product_name);
        setElementValue('wizardPaperType', order.paper_type || 'Ch∆∞a x√°c ƒë·ªãnh');
        setElementValue('wizardPaperWeight', (order.paper_weight || 0) + ' gsm');
        setElementValue('wizardQuantity', formatNumber(order.xa_input_quantity));
        
        // C·∫≠p nh·∫≠t th√¥ng tin c√¥ng ƒëo·∫°n ti·∫øp theo
        updateElementText('wizardNextStage', nextStageName);
        updateElementText('confirmNextStage', nextStageName);
        
        // C·∫≠p nh·∫≠t text trong checkbox x√°c nh·∫≠n
        const confirmLabel = document.querySelector('label[for="wizardConfirmHandover"]');
        if (confirmLabel && nextStage) {
            const newConfirmText = `T√¥i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng cho c√¥ng ƒëo·∫°n ${nextStageName}`;
            confirmLabel.textContent = newConfirmText;
        }
        
        // Populate form values v·ªõi d·ªØ li·ªáu hi·ªán t·∫°i
        setElementValue('wizardGoodQty', order.xa_good_quantity || 0);
        setElementValue('wizardNgQty', order.xa_ng_quantity || 0);
        setElementValue('wizardNgStartEndQty', 0);
        setElementValue('wizardReturnQty', 0);
        setElementValue('wizardMachine', order.xa_machine_name || 'X·∫£ 1');
        setElementValue('wizardShift', order.production_shift || 'Ca 1');
        setElementValue('wizardWorker', order.xa_worker_name || '');
        setElementValue('wizardNote', order.xa_note || '');
        
        // Populate form values - Ph·∫ßn b√†n giao
        setElementValue('wizardHandoverDate', formatDate(new Date()));
        setElementValue('wizardHandoverPerson', order.xa_worker_name || '');
        setElementValue('wizardReceiverPerson', '');
        setElementValue('wizardHandoverNotes', '');
        setElementValue('wizardConfirmHandover', false);
        
        // C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√†n giao (t·ª± ƒë·ªông = s·ªë l∆∞·ª£ng OK)
        updateWizardHandoverQuantity();
        
        // Reset wizard v·ªÅ b∆∞·ªõc 1
        resetWizard();
        
        // Hi·ªÉn th·ªã modal
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));
        modal.show();
    }

    /**
     * Hi·ªÉn th·ªã modal b√†n giao ƒë∆°n l·∫ª (cho c√°c ƒë∆°n ƒë√£ ho√†n th√†nh)
     */
    function showHandoverModal(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            showNotification('Kh√¥ng t√¨m th·∫•y l·ªánh s·∫£n xu·∫•t', 'error');
            return;
        }
        
        currentEditingOrder = order;
        
        // L·∫•y th√¥ng tin stage ti·∫øp theo
        const nextStage = order.next_stage;
        const nextStageName = nextStage ? getStageDisplayName(nextStage) : 'HO√ÄN TH√ÄNH';
        
        if (!nextStage) {
            showNotification('ƒê√¢y l√† c√¥ng ƒëo·∫°n cu·ªëi c√πng trong workflow', 'info');
            return;
        }
        
        // C·∫≠p nh·∫≠t th√¥ng tin v·ªÅ stage ti·∫øp theo
        const handoverAlert = document.querySelector('#handover-tab-pane .alert-warning p');
        if (handoverAlert) {
            handoverAlert.innerHTML = `Sau khi ho√†n th√†nh, s·∫£n ph·∫©m OK s·∫Ω ƒë∆∞·ª£c chuy·ªÉn sang c√¥ng ƒëo·∫°n <strong>${nextStageName}</strong>`;
        }
        
        // C·∫≠p nh·∫≠t label cho tab b√†n giao
        const handoverTabLabel = document.getElementById('handover-tab');
        if (handoverTabLabel) {
            handoverTabLabel.innerHTML = `<i class="bi bi-arrow-right-circle me-1"></i>B√†n giao c√¥ng ƒëo·∫°n ${nextStageName}`;
        }
        
        // C·∫≠p nh·∫≠t text trong checkbox x√°c nh·∫≠n
        const confirmLabel = document.querySelector('label[for="confirmHandover"]');
        if (confirmLabel) {
            confirmLabel.textContent = `T√¥i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng cho c√¥ng ƒëo·∫°n ${nextStageName}`;
        }
        
        // Populate th√¥ng tin b√†n giao
        updateElementText('handoverOrderCode', order.production_order);
        updateElementText('handoverProductName', order.product_name);
        setElementValue('handoverQty', order.xa_good_quantity || 0);
        setElementValue('handoverDate', formatDate(new Date()));
        setElementValue('handoverPerson', order.xa_worker_name || '');
        setElementValue('receiverPerson', '');
        setElementValue('handoverNotes', '');
        setElementValue('confirmHandover', false);
        
        // Chuy·ªÉn sang tab b√†n giao
        const handoverTab = document.getElementById('handover-tab');
        if (handoverTab) handoverTab.click();
        
        // Hi·ªÉn th·ªã modal
        const modal = new bootstrap.Modal(document.getElementById('completeModal'));
        modal.show();
    }

    /**
     * X·ª≠ l√Ω b√†n giao ƒë∆°n l·∫ª t·ª´ X·∫¢ sang X√âN
     */
    async function executeHandoverOnly() {
        if (!currentEditingOrder) {
            showNotification('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªánh s·∫£n xu·∫•t', 'error');
            return;
        }
        
        try {
            const handoverData = {
                handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
                handoverPerson: getElementValue('handoverPerson'),
                receiverPerson: getElementValue('receiverPerson'),
                handoverNotes: getElementValue('handoverNotes'),
                confirmHandover: getElementValue('confirmHandover')
            };
            
            // Validate
            if (handoverData.handoverQuantity <= 0) {
                showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
                return;
            }
            
            if (!handoverData.confirmHandover) {
                showNotification('B·∫°n ph·∫£i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng', 'warning');
                return;
            }
            
            showLoading('ƒêang b√†n giao...');
            
            // L·∫•y th√¥ng tin stage ti·∫øp theo t·ª´ workflow
            const nextStage = currentEditingOrder.next_stage;
            if (!nextStage) {
                showNotification('Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c c√¥ng ƒëo·∫°n ti·∫øp theo', 'error');
                return;
            }
            
            // Chu·∫©n b·ªã d·ªØ li·ªáu b√†n giao
            const handoverWebhookData = {
                order_id: currentEditingOrder.id,
                from_stage: STAGE_CONFIG.KEY,
                to_stage: nextStage,
                quantity: handoverData.handoverQuantity,
                handover_person: handoverData.handoverPerson,
                receiver_person: handoverData.receiverPerson,
                notes: handoverData.handoverNotes,
                handover_date: new Date().toISOString()
            };
            
            // G·ª≠i qua webhook
            const result = await sendWebhook(`handover_${STAGE_CONFIG.KEY}_to_${nextStage}`, handoverWebhookData);
            
            if (result.success) {
                showNotification(`ƒê√£ b√†n giao ${handoverData.handoverQuantity} s·∫£n ph·∫©m cho c√¥ng ƒëo·∫°n ${getStageDisplayName(nextStage)}`, 'success');
            }
            
            // Refresh d·ªØ li·ªáu v√† ƒë√≥ng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error executing handover only:', error);
            showNotification('L·ªói b√†n giao: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√†n giao khi thay ƒë·ªïi s·ªë l∆∞·ª£ng OK
     */
    function updateHandoverQuantity() {
        const goodQty = getElementValue('completeGoodQty') || 0;
        setElementValue('handoverQty', goodQty);
    }
    
    /**
     * Alias cho updateHandoverQuantity (ƒë∆∞·ª£c g·ªçi t·ª´ HTML)
     */
    function updateHandoverQty() {
        updateHandoverQuantity();
    }

    /**
     * X·ª≠ l√Ω ho√†n th√†nh c√¥ng ƒëo·∫°n
     */
    async function completeOrder() {
        if (!currentEditingOrder) {
            showNotification('L·ªói: Kh√¥ng x√°c ƒë·ªãnh ƒë∆∞·ª£c l·ªánh s·∫£n xu·∫•t', 'error');
            return;
        }
        
        try {
            // L·∫•y d·ªØ li·ªáu t·ª´ form
            const completionData = getCompletionDataFromForm();
            
            // Validate d·ªØ li·ªáu
            if (!validateCompletionData(completionData)) {
                return;
            }
            
            showLoading('ƒêang x·ª≠ l√Ω...');
            
            // Lu√¥n th·ª±c hi·ªán c·∫£ ho√†n th√†nh v√† b√†n giao (v√¨ ƒë√£ g·ªôp chung th√†nh 1 form)
            await handleCompleteAndHandover(completionData);
            
            // Refresh d·ªØ li·ªáu v√† ƒë√≥ng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
        } catch (error) {
            console.error('Error completing order:', error);
            showNotification('L·ªói: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * L·∫•y d·ªØ li·ªáu t·ª´ form ho√†n th√†nh
     */
    function getCompletionDataFromForm() {
        return {
            // D·ªØ li·ªáu ho√†n th√†nh
            goodQuantity: parseInt(getElementValue('completeGoodQty')) || 0,
            ngQuantity: parseInt(getElementValue('completeNgQty')) || 0,
            ngStartEndQuantity: parseInt(getElementValue('completeNgStartEndQty')) || 0,
            returnQuantity: parseInt(getElementValue('completeReturnQty')) || 0,
            machine: getElementValue('completeMachine'),
            shift: getElementValue('completeShift'),
            workerName: getElementValue('completeWorker'),
            notes: getElementValue('completeNote'),
            
            // D·ªØ li·ªáu b√†n giao
            handoverQuantity: parseInt(getElementValue('handoverQty')) || 0,
            handoverDate: getElementValue('handoverDate'),
            handoverPerson: getElementValue('handoverPerson'),
            receiverPerson: getElementValue('receiverPerson'),
            handoverNotes: getElementValue('handoverNotes'),
            confirmHandover: getElementValue('confirmHandover')
        };
    }

    /**
     * Validate d·ªØ li·ªáu ho√†n th√†nh
     */
    function validateCompletionData(data) {
        // Validate d·ªØ li·ªáu ho√†n th√†nh c∆° b·∫£n
        if (data.goodQuantity + data.ngQuantity === 0) {
            showNotification('T·ªïng s·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0', 'error');
            return false;
        }
        
        // Validate d·ªØ li·ªáu b√†n giao (lu√¥n ki·ªÉm tra v√¨ ƒë√£ g·ªôp chung form)
        if (data.handoverQuantity <= 0) {
            showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
            return false;
        }
        
        if (!data.confirmHandover) {
            showNotification('B·∫°n ph·∫£i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng', 'warning');
            return false;
        }
        
        // Ki·ªÉm tra s·ªë l∆∞·ª£ng b√†n giao kh√¥ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng OK
        if (data.handoverQuantity > data.goodQuantity) {
            showNotification('S·ªë l∆∞·ª£ng b√†n giao kh√¥ng th·ªÉ l·ªõn h∆°n s·ªë l∆∞·ª£ng OK', 'error');
            return false;
        }
        
        return true;
    }

    /**
     * X·ª≠ l√Ω ho√†n th√†nh v√† b√†n giao t·ª´ X·∫¢ sang stage ti·∫øp theo
     */
    async function handleCompleteAndHandover(data) {
        try {
            const nextStage = currentEditingOrder.next_stage;
            
            if (!nextStage) {
                // N·∫øu kh√¥ng c√≥ stage ti·∫øp theo, ch·ªâ ho√†n th√†nh
                return await handleCompleteStageOnly(data);
            }
            
            const completeHandoverData = {
                order_id: currentEditingOrder.id,
                action_type: 'complete_and_handover',
                from_stage: 'xa',
                to_stage: nextStage,
                workflow_definition: currentEditingOrder.workflow_definition,
                
                // Th√¥ng tin ho√†n th√†nh
                completion: {
                    output_quantity: data.goodQuantity + data.ngQuantity,
                    good_quantity: data.goodQuantity,
                    ng_quantity: data.ngQuantity,
                    worker_name: data.workerName,
                    machine_name: data.machine,
                    shift: data.shift,
                    notes: data.notes
                },
                
                // Th√¥ng tin b√†n giao
                handover: {
                    handover_quantity: data.handoverQuantity,
                    handover_person: data.handoverPerson,
                    receiver_person: data.receiverPerson,
                    handover_date: data.handoverDate,
                    handover_notes: data.handoverNotes
                },
                
                completed_at: new Date().toISOString()
            };
            
            // G·ª≠i qua webhook n8n
            const result = await sendWebhook(`complete_xa_and_handover_to_${nextStage}`, completeHandoverData);
            
            if (result.success) {
                const nextStageName = getStageDisplayName(nextStage);
                showNotification(
                    `‚úÖ ƒê√£ ho√†n th√†nh c√¥ng ƒëo·∫°n X·∫¢ v√† b√†n giao ${formatNumber(data.handoverQuantity)} s·∫£n ph·∫©m cho c√¥ng ƒëo·∫°n ${nextStageName} th√†nh c√¥ng!`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error complete and handover:', error);
            showNotification('L·ªói khi ho√†n th√†nh v√† b√†n giao: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * X·ª≠ l√Ω ch·ªâ ho√†n th√†nh c√¥ng ƒëo·∫°n
     */
    async function handleCompleteStageOnly(data) {
        try {
            const updateData = {
                order_id: currentEditingOrder.id,
                stage: STAGE_CONFIG.KEY,
                output_quantity: data.goodQuantity + data.ngQuantity,
                good_quantity: data.goodQuantity,
                ng_quantity: data.ngQuantity,
                worker_name: data.workerName,
                machine_name: data.machine,
                shift: data.shift,
                notes: data.notes,
                updated_at: new Date().toISOString()
            };
            
            // G·ª≠i qua webhook n8n
            const result = await sendWebhook('update_stage_output', updateData);
            
            if (result.success) {
                showNotification(
                    `‚úÖ ƒê√£ c·∫≠p nh·∫≠t ho√†n th√†nh c√¥ng ƒëo·∫°n X·∫¢: ${formatNumber(data.goodQuantity + data.ngQuantity)} s·∫£n ph·∫©m`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error completing stage:', error);
            showNotification('L·ªói khi ho√†n th√†nh c√¥ng ƒëo·∫°n: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * =================================================================
     * WIZARD FUNCTIONS - C√ÅC H√ÄM X·ª¨ L√ù WIZARD FORM
     * =================================================================
     */

    let wizardCurrentStep = 1;
    const wizardTotalSteps = 3;

    /**
     * Reset wizard v·ªÅ b∆∞·ªõc 1
     */
    function resetWizard() {
        wizardCurrentStep = 1;
        updateWizardStepDisplay();
    }

    /**
     * C·∫≠p nh·∫≠t hi·ªÉn th·ªã b∆∞·ªõc wizard
     */
    function updateWizardStepDisplay() {
        // Update step indicators
        document.querySelectorAll('.step').forEach((step, index) => {
            const stepNum = index + 1;
            step.classList.remove('active', 'completed');
            
            if (stepNum < wizardCurrentStep) {
                step.classList.add('completed');
            } else if (stepNum === wizardCurrentStep) {
                step.classList.add('active');
            }
        });
        
        // Update step content
        document.querySelectorAll('.step-content').forEach((content, index) => {
            content.classList.remove('active');
            if (index + 1 === wizardCurrentStep) {
                content.classList.add('active');
            }
        });
        
        // Update buttons
        const prevBtn = document.getElementById('wizardPrevBtn');
        const nextBtn = document.getElementById('wizardNextBtn');
        const finishBtn = document.getElementById('wizardFinishBtn');
        
        prevBtn.style.display = wizardCurrentStep > 1 ? 'inline-block' : 'none';
        nextBtn.style.display = wizardCurrentStep < wizardTotalSteps ? 'inline-block' : 'none';
        finishBtn.style.display = wizardCurrentStep === wizardTotalSteps ? 'inline-block' : 'none';
        
        // Update step indicator
        document.getElementById('wizardCurrentStep').textContent = wizardCurrentStep;
        
        // Update handover quantity in step 1
        if (wizardCurrentStep === 1) {
            updateWizardHandoverQuantity();
        }
        
        // Update confirmation data in step 3
        if (wizardCurrentStep === 3) {
            updateWizardConfirmation();
        }
    }

    /**
     * Chuy·ªÉn ƒë·∫øn b∆∞·ªõc ti·∫øp theo
     */
    function wizardNextStep() {
        if (wizardCurrentStep < wizardTotalSteps) {
            // Validate current step
            if (!validateWizardCurrentStep()) {
                return;
            }
            
            wizardCurrentStep++;
            updateWizardStepDisplay();
        }
    }

    /**
     * Quay l·∫°i b∆∞·ªõc tr∆∞·ªõc
     */
    function wizardPreviousStep() {
        if (wizardCurrentStep > 1) {
            wizardCurrentStep--;
            updateWizardStepDisplay();
        }
    }

    /**
     * Validate b∆∞·ªõc hi·ªán t·∫°i
     */
    function validateWizardCurrentStep() {
        switch (wizardCurrentStep) {
            case 1:
                const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
                const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
                if (goodQty + ngQty === 0) {
                    showNotification('T·ªïng s·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0', 'error');
                    return false;
                }
                break;
            case 2:
                const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
                if (handoverQty <= 0) {
                    showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
                    return false;
                }
                break;
        }
        return true;
    }



    /**
     * C·∫≠p nh·∫≠t s·ªë l∆∞·ª£ng b√†n giao trong wizard
     */
    function updateWizardHandoverQuantity() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        setElementValue('wizardHandoverQty', goodQty);
    }

    /**
     * C·∫≠p nh·∫≠t d·ªØ li·ªáu x√°c nh·∫≠n trong wizard
     */
    function updateWizardConfirmation() {
        const goodQty = parseInt(getElementValue('wizardGoodQty')) || 0;
        const ngQty = parseInt(getElementValue('wizardNgQty')) || 0;
        const handoverQty = parseInt(getElementValue('wizardHandoverQty')) || 0;
        const total = goodQty + ngQty;
        const progress = total > 0 ? Math.round((goodQty / total) * 100) : 0;
        const machine = getElementValue('wizardMachine');
        const worker = getElementValue('wizardWorker');
        const shift = getElementValue('wizardShift');
        const handoverPerson = getElementValue('wizardHandoverPerson');
        const receiverPerson = getElementValue('wizardReceiverPerson');
        const handoverNotes = getElementValue('wizardHandoverNotes');
        
        // Update confirmation data
        updateElementText('confirmOrderCode', getElementValue('wizardOrderCode'));
        updateElementText('confirmProductCode', getElementValue('wizardProductCode'));
        updateElementText('confirmProductName', getElementValue('wizardProductName'));
        updateElementText('confirmPaperType', getElementValue('wizardPaperType'));
        updateElementText('confirmPaperWeight', getElementValue('wizardPaperWeight'));
        updateElementText('confirmQuantity', getElementValue('wizardQuantity'));
        updateElementText('confirmGoodQty', goodQty.toLocaleString());
        updateElementText('confirmNgQty', ngQty.toLocaleString());
        updateElementText('confirmProgress', progress + '%');
        updateElementText('confirmMachine', machine);
        updateElementText('confirmWorker', worker || 'Ch∆∞a nh·∫≠p');
        updateElementText('confirmShift', shift || 'Ca 1');
        updateElementText('confirmHandoverQty', handoverQty.toLocaleString());
        updateElementText('confirmHandoverPerson', handoverPerson || 'Ch∆∞a nh·∫≠p');
        updateElementText('confirmReceiverPerson', receiverPerson || 'Ch∆∞a nh·∫≠p');
        updateElementText('confirmHandoverNotes', handoverNotes || 'Kh√¥ng c√≥');
    }

    /**
     * Ho√†n th√†nh wizard
     */
    async function wizardFinish() {
        if (!document.getElementById('wizardConfirmHandover').checked) {
            showNotification('Vui l√≤ng x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng!', 'error');
            return;
        }
        
        try {
            // L·∫•y d·ªØ li·ªáu t·ª´ wizard form
            const completionData = getWizardCompletionData();
            
            // Validate d·ªØ li·ªáu
            if (!validateWizardCompletionData(completionData)) {
                return;
            }
            
            showLoading('ƒêang x·ª≠ l√Ω...');
            
            // X·ª≠ l√Ω ho√†n th√†nh v√† b√†n giao
            await handleCompleteAndHandover(completionData);
            
            // Refresh d·ªØ li·ªáu v√† ƒë√≥ng modal
            await refreshData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeModal'));
            modal.hide();
            
            showNotification('üéâ Ho√†n th√†nh! D·ªØ li·ªáu ƒë√£ ƒë∆∞·ª£c l∆∞u th√†nh c√¥ng.', 'success');
            
        } catch (error) {
            console.error('Error completing wizard:', error);
            showNotification('L·ªói: ' + error.message, 'error');
        } finally {
            hideLoading();
        }
    }

    /**
     * L·∫•y d·ªØ li·ªáu t·ª´ wizard form
     */
    function getWizardCompletionData() {
        return {
            // D·ªØ li·ªáu ho√†n th√†nh
            goodQuantity: parseInt(getElementValue('wizardGoodQty')) || 0,
            ngQuantity: parseInt(getElementValue('wizardNgQty')) || 0,
            ngStartEndQuantity: parseInt(getElementValue('wizardNgStartEndQty')) || 0,
            returnQuantity: parseInt(getElementValue('wizardReturnQty')) || 0,
            machine: getElementValue('wizardMachine'),
            shift: getElementValue('wizardShift'),
            workerName: getElementValue('wizardWorker'),
            notes: getElementValue('wizardNote'),
            
            // D·ªØ li·ªáu b√†n giao
            handoverQuantity: parseInt(getElementValue('wizardHandoverQty')) || 0,
            handoverDate: getElementValue('wizardHandoverDate'),
            handoverPerson: getElementValue('wizardHandoverPerson'),
            receiverPerson: getElementValue('wizardReceiverPerson'),
            handoverNotes: getElementValue('wizardHandoverNotes'),
            confirmHandover: getElementValue('wizardConfirmHandover')
        };
    }

    /**
     * Validate d·ªØ li·ªáu ho√†n th√†nh t·ª´ wizard
     */
    function validateWizardCompletionData(data) {
        // Validate d·ªØ li·ªáu ho√†n th√†nh c∆° b·∫£n
        if (data.goodQuantity + data.ngQuantity === 0) {
            showNotification('T·ªïng s·ªë l∆∞·ª£ng ph·∫£i l·ªõn h∆°n 0', 'error');
            return false;
        }
        
        // Validate d·ªØ li·ªáu b√†n giao
        if (data.handoverQuantity <= 0) {
            showNotification('S·ªë l∆∞·ª£ng b√†n giao ph·∫£i l·ªõn h∆°n 0', 'error');
            return false;
        }
        
        if (!data.confirmHandover) {
            showNotification('B·∫°n ph·∫£i x√°c nh·∫≠n ƒë√£ b√†n giao ƒë·ªß s·ªë l∆∞·ª£ng v√† ch·∫•t l∆∞·ª£ng', 'warning');
            return false;
        }
        
        // Ki·ªÉm tra s·ªë l∆∞·ª£ng b√†n giao kh√¥ng v∆∞·ª£t qu√° s·ªë l∆∞·ª£ng OK
        if (data.handoverQuantity > data.goodQuantity) {
            showNotification('S·ªë l∆∞·ª£ng b√†n giao kh√¥ng th·ªÉ l·ªõn h∆°n s·ªë l∆∞·ª£ng OK', 'error');
            return false;
        }
        
        return true;
    }

    /**
     * =================================================================
     * UTILITY FUNCTIONS - C√ÅC H√ÄM TI·ªÜN √çCH
     * =================================================================
     */

    // Hi·ªÉn th·ªã loading
    function showLoading(message = 'ƒêang t·∫£i...') {
        const loading = document.getElementById('loadingOverlay');
        if (loading) {
            loading.style.display = 'flex';
            const loadingText = loading.querySelector('.loading-text');
            if (loadingText) loadingText.textContent = message;
        }
    }

    // ·∫®n loading  
    function hideLoading() {
        const loading = document.getElementById('loadingOverlay');
        if (loading) loading.style.display = 'none';
    }

    // Hi·ªÉn th·ªã th√¥ng b√°o
    function showNotification(message, type = 'success') {
        // T·∫°o toast notification ƒë∆°n gi·∫£n
        const toast = document.createElement('div');
        toast.className = `alert alert-${type === 'error' ? 'danger' : type === 'warning' ? 'warning' : 'success'} position-fixed`;
        toast.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px; animation: fadeIn 0.3s ease;';
        toast.innerHTML = `
            <div class="d-flex align-items-center">
                <i class="bi bi-${type === 'error' ? 'exclamation-triangle' : type === 'warning' ? 'exclamation-triangle' : 'check-circle'} me-2"></i>
                <span>${message}</span>
                <button type="button" class="btn-close ms-auto" onclick="this.parentElement.parentElement.remove()"></button>
            </div>
        `;
        document.body.appendChild(toast);
        
        // T·ª± ƒë·ªông x√≥a sau 5 gi√¢y
        setTimeout(() => {
            if (toast.parentElement) {
                toast.style.animation = 'fadeOut 0.3s ease';
                setTimeout(() => toast.remove(), 300);
            }
        }, 5000);
    }

    // Format s·ªë theo ƒë·ªãnh d·∫°ng Vi·ªát Nam
    function formatNumber(num) {
        if (!num && num !== 0) return '';
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    // Format ng√†y
    function formatDate(date, format = 'dd/mm/yyyy') {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        
        return format
            .replace('dd', day)
            .replace('mm', month)
            .replace('yyyy', year);
    }

    // C·∫≠p nh·∫≠t text c·ªßa element
    function updateElementText(elementId, text) {
        const element = document.getElementById(elementId);
        if (element) element.textContent = text;
    }

    // Set gi√° tr·ªã cho element
    function setElementValue(elementId, value) {
        const element = document.getElementById(elementId);
        if (element) {
            if (element.type === 'checkbox') {
                element.checked = value;
            } else {
                element.value = value;
            }
        }
    }

    // L·∫•y gi√° tr·ªã t·ª´ element
    function getElementValue(elementId) {
        const element = document.getElementById(elementId);
        if (!element) return '';
        
        if (element.type === 'checkbox') {
            return element.checked;
        } else {
            return element.value;
        }
    }

    // C·∫Øt ng·∫Øn text
    function truncateText(text, maxLength) {
        if (!text) return '';
        return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
    }

    // Chuy·ªÉn ƒë·ªïi status th√†nh text
    function getStatusText(status) {
        const statusMap = {
            'waiting': 'Ch·ªù x·ª≠ l√Ω',
            'in_progress': 'ƒêang x·ª≠ l√Ω', 
            'completed': 'Ho√†n th√†nh',
            'paused': 'T·∫°m d·ª´ng'
        };
        return statusMap[status] || 'Kh√¥ng x√°c ƒë·ªãnh';
    }

    /**
     * =================================================================
     * SIDEBAR TOGGLE - ƒêI·ªÄU KHI·ªÇN SIDEBAR
     * =================================================================
     * ƒê√£ ƒë∆∞·ª£c chuy·ªÉn sang sidebar-generator.js
     */

    /**
     * =================================================================
     * DETAILS PANEL - PANEL CHI TI·∫æT
     * =================================================================
     */

    function showOrderDetails(orderId) {
        const order = ordersData.find(o => o.id === orderId);
        if (!order) {
            console.error('Order not found:', orderId);
            return;
        }

        // Remove previous selection
        const previousSelected = document.querySelector('.table tbody tr.selected');
        if (previousSelected) {
            previousSelected.classList.remove('selected');
        }

        // Add selection to current row
        const currentRow = document.querySelector(`[data-order-id="${orderId}"]`);
        if (currentRow) {
            currentRow.classList.add('selected');
        }

        // Show details panel
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        
        detailsPanel.classList.add('show');
        contentArea.classList.add('details-open');

        // Populate details content
        const detailsContent = document.getElementById('detailsContent');
        detailsContent.innerHTML = `
            <div class="detail-section">
                <h6><i class="bi bi-clipboard-data me-2"></i>Th√¥ng tin c∆° b·∫£n</h6>
                <div class="detail-item">
                    <div class="detail-label">M√£ l·ªánh</div>
                    <div class="detail-value">${order.order_code || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Kh√°ch h√†ng</div>
                    <div class="detail-value">${order.customer_name || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">S·∫£n ph·∫©m</div>
                    <div class="detail-value">${order.product_name || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">K√≠ch th∆∞·ªõc</div>
                    <div class="detail-value">${order.size || 'N/A'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">S·ªë l∆∞·ª£ng KH</div>
                    <div class="detail-value">${order.plan_quantity || 'N/A'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h6><i class="bi bi-gear me-2"></i>Tr·∫°ng th√°i s·∫£n xu·∫•t</h6>
                <div class="detail-item">
                    <div class="detail-label">Tr·∫°ng th√°i</div>
                    <div class="detail-value">
                        <span class="badge ${getStatusBadgeClass(order.status)}">${getStatusText(order.status)}</span>
                    </div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">SL ƒê·∫°t</div>
                    <div class="detail-value">${order.good_quantity || '0'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">SL NG</div>
                    <div class="detail-value">${order.ng_quantity || '0'}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">SL B√†n giao</div>
                    <div class="detail-value">${order.handover_quantity || '0'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h6><i class="bi bi-calendar me-2"></i>Th√¥ng tin th·ªùi gian</h6>
                <div class="detail-item">
                    <div class="detail-label">Ng√†y t·∫°o</div>
                    <div class="detail-value">${formatDate(order.created_at)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ng√†y c·∫≠p nh·∫≠t</div>
                    <div class="detail-value">${formatDate(order.updated_at)}</div>
                </div>
                <div class="detail-item">
                    <div class="detail-label">Ng√†y ho√†n th√†nh</div>
                    <div class="detail-value">${order.completed_at ? formatDate(order.completed_at) : 'Ch∆∞a ho√†n th√†nh'}</div>
                </div>
            </div>

            <div class="detail-section">
                <h6><i class="bi bi-chat-text me-2"></i>Ghi ch√∫</h6>
                <div class="detail-item">
                    <div class="detail-label">Ghi ch√∫</div>
                    <div class="detail-value">${order.notes || 'Kh√¥ng c√≥ ghi ch√∫'}</div>
                </div>
            </div>
        `;
    }

    function closeDetailsPanel() {
        const detailsPanel = document.getElementById('detailsPanel');
        const contentArea = document.querySelector('.content-area');
        
        detailsPanel.classList.remove('show');
        contentArea.classList.remove('details-open');
        
        // Remove selection from table row
        const selectedRow = document.querySelector('.table tbody tr.selected');
        if (selectedRow) {
            selectedRow.classList.remove('selected');
        }
    }

    function getStatusBadgeClass(status) {
        const statusMap = {
            'waiting': 'bg-warning',
            'in_progress': 'bg-primary',
            'completed': 'bg-success',
            'paused': 'bg-secondary'
        };
        return statusMap[status] || 'bg-secondary';
    }

    function formatDate(dateString) {
        if (!dateString) return 'N/A';
        try {
            const date = new Date(dateString);
            return date.toLocaleDateString('vi-VN', {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit'
            });
        } catch (e) {
            return 'N/A';
        }
    }

    // Export functions for global access
    window.refreshData = refreshData;
    window.loadOrdersDataFast = loadOrdersDataFast;
    window.showPerformanceMetrics = showPerformanceMetrics;
    window.viewOrderDetails = viewOrderDetails;
    window.showCompleteModal = showCompleteModal;
    window.showHandoverModal = showHandoverModal;
    window.executeHandoverOnly = executeHandoverOnly;
    window.completeOrder = completeOrder;
    window.updateHandoverQuantity = updateHandoverQuantity;
    
    // Wizard functions
    window.wizardNextStep = wizardNextStep;
    window.wizardPreviousStep = wizardPreviousStep;
    window.wizardFinish = wizardFinish;
    window.updateWizardHandoverQuantity = updateWizardHandoverQuantity;
    
    // Details panel functions
    window.showOrderDetails = showOrderDetails;
    window.closeDetailsPanel = closeDetailsPanel;

    // Add click outside listener to close details panel
    document.addEventListener('click', function(e) {
        const detailsPanel = document.getElementById('detailsPanel');
        const tableContainer = document.querySelector('.table-container');
        
        // Debug: Log click events
        console.log('Click detected:', e.target);
        console.log('Details panel open:', detailsPanel.classList.contains('show'));
        console.log('Clicked inside details panel:', detailsPanel.contains(e.target));
        console.log('Clicked inside table container:', tableContainer.contains(e.target));
        
        // If details panel is open and click is outside table and details panel
        if (detailsPanel.classList.contains('show') && 
            !detailsPanel.contains(e.target) && 
            !tableContainer.contains(e.target)) {
            console.log('Closing details panel due to outside click');
            closeDetailsPanel();
        }
    });
  </script>
  
  <!-- Performance Metrics Modal -->
  <div class="modal fade" id="performanceModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-info text-white">
          <h5 class="modal-title">
            <i class="bi bi-graph-up me-2"></i>
            Performance Metrics
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body" id="performanceModalBody">
          <!-- Performance data will be loaded here -->
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">ƒê√≥ng</button>
          <button type="button" class="btn btn-primary" onclick="refreshData()">
            <i class="bi bi-arrow-clockwise me-1"></i>Refresh Data
          </button>
        </div>
      </div>
    </div>
  </div>
  
  <!-- Details Panel -->
  <div class="details-panel" id="detailsPanel">
    <div class="details-header">
      <h5 class="mb-0">
        <i class="bi bi-info-circle me-2"></i>
        Chi ti·∫øt l·ªánh s·∫£n xu·∫•t
      </h5>
      <button type="button" class="detail-close" onclick="closeDetailsPanel()">
        <i class="bi bi-x-lg"></i>
      </button>
    </div>
    <div class="details-content" id="detailsContent">
      <!-- Details will be loaded here -->
    </div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">ƒêang t·∫£i d·ªØ li·ªáu t·ª´ API...</div>
    </div>
  </div>
</body>
</html>
