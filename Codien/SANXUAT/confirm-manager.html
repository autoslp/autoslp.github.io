<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Quản lý xác nhận bàn giao</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.1/font/bootstrap-icons.css">
  <style>
    body { background:#f6f8fb; }
    .card { border-radius: 12px; }
    .request-item { border:1px solid #e2e8f0; border-radius:12px; padding:16px; background:#fff; }
    .request-item + .request-item { margin-top:12px; }
    .badge-stage { background: #0d6efd; }
    .actions .btn { min-width:120px; }
  </style>
</head>
<body>
  <div class="container py-4">
    <div class="d-flex align-items-center mb-3">
      <i class="bi bi-shield-check text-primary me-2"></i>
      <h3 class="mb-0">Quản lý xác nhận bàn giao</h3>
      <button class="btn btn-sm btn-outline-primary ms-auto" id="refreshBtn"><i class="bi bi-arrow-clockwise me-1"></i>Làm mới</button>
    </div>

    <div class="card">
      <div class="card-body">
        <div id="requestsContainer">
          <div class="text-center text-muted py-4" id="emptyState">
            <i class="bi bi-inboxes fs-1 d-block mb-2"></i>
            Không có yêu cầu chờ xác nhận
          </div>
        </div>
      </div>
    </div>
  </div>

  <script>
    const WEBHOOK_BASE_URL = 'https://api.autoslp.com:5678/webhook';

    async function fetchPendingRequests() {
      try {
        // Lấy toàn bộ danh sách và lọc pending để linh hoạt với backend
        const res = await fetch(`${WEBHOOK_BASE_URL}/get_status_confirmations`);
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || data.error || 'Lỗi tải danh sách');
        const list = Array.isArray(data) ? data : (data.items || []);
        return list.filter(i => (i.status || '').toLowerCase() === 'pending');
      } catch (e) {
        alert('Lỗi tải danh sách: ' + e.message);
        return [];
      }
    }

    function renderRequests(list) {
      const container = document.getElementById('requestsContainer');
      container.innerHTML = '';
      if (!list.length) {
        const div = document.createElement('div');
        div.className = 'text-center text-muted py-4';
        div.innerHTML = '<i class="bi bi-inboxes fs-1 d-block mb-2"></i>Không có yêu cầu chờ xác nhận';
        container.appendChild(div);
        return;
      }

      list.forEach(req => {
        // Parse info_confirm_json
        let info = {};
        try { info = req.info_confirm_json ? JSON.parse(req.info_confirm_json) : {}; } catch(e){ info = {}; }
        const q = (info.quantities) || {};
        const el = document.createElement('div');
        el.className = 'request-item';
        el.innerHTML = `
          <div class="d-flex align-items-start">
            <div>
              <div class="fw-bold">${(info.order_code || ('#'+req.production_order_id))}</div>
              <div class="text-muted small">Máy: ${(info.machine_name || '--')} | Ca: ${(info.shift_name || '--')}</div>
              <div class="text-muted small">Thợ: ${(info.worker_name || '--')}</div>
              <div class="mt-1 small">SL: OK ${q.good||0} | NG ${q.ng||0} | NG đầu/cuối ${q.ng_start_end||0} | Trả ${q.return||0} | Bàn giao ${q.handover||0}</div>
            </div>
            <span class="badge bg-primary ms-auto">${((info.stage||'')+'').toUpperCase()}</span>
          </div>
          <div class="mt-3 d-flex gap-2 actions">
            <button class="btn btn-success" onclick='updateStatus(${req.production_order_id}, "approved")'><i class="bi bi-check-lg me-1"></i>Xác nhận</button>
            <button class="btn btn-danger" onclick='updateStatus(${req.production_order_id}, "rejected")'><i class="bi bi-x-lg me-1"></i>Từ chối</button>
          </div>
        `;
        container.appendChild(el);
      });
    }

    async function updateStatus(orderId, status) {
      const isApprove = status === 'approved';
      if (!confirm(isApprove ? 'Xác nhận phê duyệt yêu cầu này?' : 'Xác nhận từ chối yêu cầu này?')) return;
      const reason = isApprove ? undefined : (prompt('Nhập lý do từ chối (tuỳ chọn):') || '');
      try {
        const res = await fetch(`${WEBHOOK_BASE_URL}/update_status_confirmations`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ production_order_id: orderId, status, reason })
        });
        const data = await res.json();
        if (!res.ok) throw new Error(data.message || data.error || 'Cập nhật thất bại');
        await load();
      } catch (e) {
        alert('Lỗi: ' + e.message);
      }
    }

    async function load() {
      const list = await fetchPendingRequests();
      renderRequests(list);
    }

    document.getElementById('refreshBtn').addEventListener('click', load);
    load();
  </script>
</body>
</html>


