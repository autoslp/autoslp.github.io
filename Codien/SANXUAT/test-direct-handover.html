<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test B√†n Giao Tr·ª±c Ti·∫øp - X·∫¢ ‚Üí X√âN</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .stage-box {
            border: 2px solid #ddd;
            border-radius: 10px;
            padding: 20px;
            margin: 15px 0;
            text-align: center;
        }
        .stage-active {
            border-color: #2196f3;
            background: #e3f2fd;
        }
        .stage-completed {
            border-color: #4caf50;
            background: #e8f5e8;
        }
        .stage-waiting {
            border-color: #ff9800;
            background: #fff3e0;
        }
        .handover-arrow {
            font-size: 48px;
            color: #2196f3;
            text-align: center;
            margin: 20px 0;
        }
        .quantity-display {
            font-size: 24px;
            font-weight: bold;
            color: #1976d2;
        }
        .console-log {
            background: #000;
            color: #0f0;
            padding: 15px;
            border-radius: 5px;
            font-family: monospace;
            max-height: 200px;
            overflow-y: auto;
            margin-top: 20px;
        }
    </style>
</head>
<body>
    <div class="container mt-4">
        <h1 class="text-center">üîÑ Test B√†n Giao Tr·ª±c Ti·∫øp</h1>
        <p class="text-center text-muted">Khi X·∫¢ b√†n giao ‚Üí s·ªë l∆∞·ª£ng s·∫Ω ghi tr·ª±c ti·∫øp v√†o c·ªôt xen_input_quantity</p>
        
        <!-- Ch·ªçn ƒë∆°n h√†ng -->
        <div class="row mb-4">
            <div class="col-md-8">
                <select id="order-select" class="form-select" onchange="loadOrderData()">
                    <option value="">-- Ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ test --</option>
                </select>
            </div>
            <div class="col-md-4">
                <button onclick="loadOrders()" class="btn btn-info">T·∫£i danh s√°ch</button>
                <button onclick="createTestOrder()" class="btn btn-success">T·∫°o ƒë∆°n test</button>
            </div>
        </div>

        <!-- Hi·ªÉn th·ªã 2 stage: X·∫¢ v√† X√âN -->
        <div id="stages-display" style="display: none;">
            <div class="row">
                <!-- Stage X·∫¢ -->
                <div class="col-md-5">
                    <div id="xa-stage" class="stage-box stage-active">
                        <h3>üî• X·∫¢ (C√¥ng ƒëo·∫°n hi·ªán t·∫°i)</h3>
                        <div class="mb-3">
                            <label>Input Quantity:</label>
                            <div id="xa-input" class="quantity-display">-</div>
                        </div>
                        <div class="mb-3">
                            <label>Output Quantity:</label>
                            <input type="number" id="xa-output" class="form-control" min="0" placeholder="Nh·∫≠p s·ªë l∆∞·ª£ng b√†n giao">
                        </div>
                        <div class="mb-3">
                            <label>Ng∆∞·ªùi b√†n giao:</label>
                            <input type="text" id="handover-person" class="form-control" placeholder="T√™n ng∆∞·ªùi b√†n giao">
                        </div>
                        <button onclick="performHandover()" class="btn btn-primary btn-lg">
                            B√†n giao cho X√âN
                        </button>
                    </div>
                </div>

                <!-- Arrow -->
                <div class="col-md-2">
                    <div class="handover-arrow">‚Üí</div>
                    <div class="text-center">
                        <strong>B√†n giao</strong><br>
                        <small class="text-muted">xa_output_quantity ‚Üí xen_input_quantity</small>
                    </div>
                </div>

                <!-- Stage X√âN -->
                <div class="col-md-5">
                    <div id="xen-stage" class="stage-box stage-waiting">
                        <h3>‚úÇÔ∏è X√âN (Stage ti·∫øp theo)</h3>
                        <div class="mb-3">
                            <label>Input Quantity:</label>
                            <div id="xen-input" class="quantity-display text-warning">Ch·ªù b√†n giao</div>
                        </div>
                        <div class="mb-3">
                            <label>Status:</label>
                            <div id="xen-status" class="badge bg-warning">Waiting</div>
                        </div>
                        <div class="mb-3">
                            <label>Ng∆∞·ªùi nh·∫≠n:</label>
                            <input type="text" id="receiver-person" class="form-control" placeholder="T√™n ng∆∞·ªùi nh·∫≠n">
                        </div>
                        <div class="text-muted">
                            <small>S·∫Ω t·ª± ƒë·ªông nh·∫≠n s·ªë l∆∞·ª£ng t·ª´ X·∫¢</small>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Console log -->
        <div id="console-log" class="console-log">
            <div>üöÄ H·ªá th·ªëng b√†n giao tr·ª±c ti·∫øp ƒë√£ s·∫µn s√†ng</div>
        </div>
        
        <div class="text-center mt-3">
            <button onclick="clearLog()" class="btn btn-secondary btn-sm">X√≥a log</button>
            <button onclick="refreshData()" class="btn btn-info btn-sm">Refresh d·ªØ li·ªáu</button>
        </div>
    </div>

    <script>
        let currentOrderId = null;
        let currentOrderData = null;

        // Utility functions
        function log(message, type = 'info') {
            const console = document.getElementById('console-log');
            const timestamp = new Date().toLocaleTimeString();
            const color = type === 'error' ? '#f44336' : type === 'success' ? '#4caf50' : '#0f0';
            console.innerHTML += `<div style="color: ${color}">[${timestamp}] ${message}</div>`;
            console.scrollTop = console.scrollHeight;
        }

        function clearLog() {
            document.getElementById('console-log').innerHTML = '<div>üöÄ Console ƒë√£ ƒë∆∞·ª£c x√≥a</div>';
        }

        // Load danh s√°ch ƒë∆°n h√†ng
        async function loadOrders() {
            try {
                log('üîÑ ƒêang t·∫£i danh s√°ch ƒë∆°n h√†ng...');
                const response = await fetch('/api/production_orders');
                const data = await response.json();
                
                const select = document.getElementById('order-select');
                select.innerHTML = '<option value="">-- Ch·ªçn ƒë∆°n h√†ng ƒë·ªÉ test --</option>';
                
                data.orders.forEach(order => {
                    const option = document.createElement('option');
                    option.value = order.id;
                    option.textContent = `${order.production_order} - ${order.current_stage.toUpperCase()} - ${order.product_name}`;
                    select.appendChild(option);
                });
                
                log(`‚úÖ ƒê√£ t·∫£i ${data.orders.length} ƒë∆°n h√†ng`, 'success');
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i ƒë∆°n h√†ng: ${error.message}`, 'error');
            }
        }

        // T·∫°o ƒë∆°n h√†ng test
        async function createTestOrder() {
            try {
                log('üîÑ ƒêang t·∫°o ƒë∆°n h√†ng test...');
                
                const testOrder = {
                    production_order: `TEST-HANDOVER-${Date.now()}`,
                    po_number: `PO-${Date.now()}`,
                    internal_product_code: `TEST-CODE-${Date.now()}`,
                    customer_code: 'TEST001',
                    customer_name: 'Kh√°ch h√†ng Test B√†n Giao',
                    product_name: 'S·∫£n ph·∫©m Test B√†n Giao Tr·ª±c Ti·∫øp',
                    order_quantity: 1000,
                    required_quantity: 1000,
                    deployed_quantity: 1200,
                    current_stage: 'xa',
                    current_stage_index: 0,
                    xa_input_quantity: 1200,
                    xa_status: 'in_progress'
                };

                const response = await fetch('/api/production_orders', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(testOrder)
                });

                if (response.ok) {
                    const result = await response.json();
                    log(`‚úÖ ƒê√£ t·∫°o ƒë∆°n h√†ng test ID: ${result.id}`, 'success');
                    loadOrders();
                } else {
                    throw new Error('Kh√¥ng th·ªÉ t·∫°o ƒë∆°n h√†ng test');
                }
                
            } catch (error) {
                log(`‚ùå L·ªói t·∫°o ƒë∆°n h√†ng test: ${error.message}`, 'error');
            }
        }

        // Load d·ªØ li·ªáu ƒë∆°n h√†ng
        async function loadOrderData() {
            const orderId = document.getElementById('order-select').value;
            if (!orderId) {
                document.getElementById('stages-display').style.display = 'none';
                return;
            }

            currentOrderId = orderId;
            
            try {
                log(`üîÑ ƒêang t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng ${orderId}...`);
                
                const response = await fetch(`/api/production_orders/${orderId}/stages`);
                const data = await response.json();
                currentOrderData = data;
                
                // Hi·ªÉn th·ªã d·ªØ li·ªáu X·∫¢
                document.getElementById('xa-input').textContent = data.stages.xa.input_quantity || 0;
                document.getElementById('xa-output').value = data.stages.xa.output_quantity || '';
                
                // Hi·ªÉn th·ªã d·ªØ li·ªáu X√âN
                const xenInput = data.stages.xen.input_quantity || 0;
                document.getElementById('xen-input').textContent = xenInput > 0 ? xenInput : 'Ch·ªù b√†n giao';
                document.getElementById('xen-input').className = xenInput > 0 ? 'quantity-display text-success' : 'quantity-display text-warning';
                
                const xenStatus = data.stages.xen.status || 'waiting';
                document.getElementById('xen-status').textContent = xenStatus.toUpperCase();
                document.getElementById('xen-status').className = xenStatus === 'in_progress' ? 'badge bg-success' : 'badge bg-warning';
                
                // C·∫≠p nh·∫≠t UI
                document.getElementById('xen-stage').className = xenInput > 0 ? 'stage-box stage-active' : 'stage-box stage-waiting';
                
                document.getElementById('stages-display').style.display = 'block';
                log(`‚úÖ ƒê√£ t·∫£i d·ªØ li·ªáu ƒë∆°n h√†ng ${data.production_order}`, 'success');
                
            } catch (error) {
                log(`‚ùå L·ªói t·∫£i d·ªØ li·ªáu: ${error.message}`, 'error');
            }
        }

        // Th·ª±c hi·ªán b√†n giao
        async function performHandover() {
            if (!currentOrderId) {
                alert('Vui l√≤ng ch·ªçn ƒë∆°n h√†ng');
                return;
            }

            const outputQuantity = parseInt(document.getElementById('xa-output').value) || 0;
            const handoverPerson = document.getElementById('handover-person').value.trim();
            const receiverPerson = document.getElementById('receiver-person').value.trim();

            if (outputQuantity <= 0) {
                alert('Vui l√≤ng nh·∫≠p s·ªë l∆∞·ª£ng b√†n giao > 0');
                return;
            }

            try {
                log(`üîÑ ƒêang th·ª±c hi·ªán b√†n giao ${outputQuantity} s·∫£n ph·∫©m t·ª´ X·∫¢ sang X√âN...`);
                
                // G·ªçi API b√†n giao tr·ª±c ti·∫øp
                const response = await fetch('/api/handover_to_next_stage', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        order_id: currentOrderId,
                        current_stage: 'xa',
                        handover_quantity: outputQuantity,
                        handover_person: handoverPerson || 'Ng∆∞·ªùi test',
                        receiver_person: receiverPerson || 'Ng∆∞·ªùi nh·∫≠n test',
                        notes: 'Test b√†n giao tr·ª±c ti·∫øp t·ª´ giao di·ªán'
                    })
                });

                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }

                const result = await response.json();
                
                log(`‚úÖ ${result.message}`, 'success');
                log(`üìù ƒê√£ c·∫≠p nh·∫≠t c·ªôt: ${result.updated_column}`, 'success');
                
                // Refresh d·ªØ li·ªáu ƒë·ªÉ th·∫•y thay ƒë·ªïi
                setTimeout(() => {
                    refreshData();
                }, 1000);
                
            } catch (error) {
                log(`‚ùå L·ªói b√†n giao: ${error.message}`, 'error');
            }
        }

        // Refresh d·ªØ li·ªáu
        async function refreshData() {
            if (currentOrderId) {
                await loadOrderData();
                log('üîÑ ƒê√£ refresh d·ªØ li·ªáu', 'info');
            }
        }

        // Kh·ªüi t·∫°o khi trang load
        window.onload = function() {
            log('üöÄ Kh·ªüi t·∫°o Test B√†n Giao Tr·ª±c Ti·∫øp');
            loadOrders();
        };
    </script>
</body>
</html>
