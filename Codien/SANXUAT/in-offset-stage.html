<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Công đoạn IN OFFSET - Carton Manager</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">
  <link rel="stylesheet" href="universal-stage.css">
  <style>
    /* Đảm bảo modal hiển thị đúng và ở giữa màn hình */
    .modal {
      z-index: 1050 !important;
    }
    
    .modal-backdrop {
      z-index: 1040 !important;
    }
    
    .modal-dialog {
      display: flex;
      align-items: center;
      justify-content: center;
      margin: 1.75rem auto;
    }
    
    .modal-content {
      max-width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
      border-radius: 8px;
    }
    
    /* Đảm bảo các tab hiển thị đúng */
    .nav-tabs .nav-link.active {
      font-weight: bold;
      border-bottom-color: transparent;
    }
    
    /* Cải thiện hiển thị của form */
    .form-control, .form-select {
      margin-bottom: 0.5rem;
      border-radius: 6px;
    }
    
    /* Tạo khoảng cách rõ ràng giữa các phần của form */
    .form-label {
      font-weight: 500;
      margin-bottom: 0.25rem;
    }
    
    /* Làm nổi bật thông tin quan trọng */
    .alert {
      border-radius: 6px;
    }
    
    /* Đảm bảo modal không bị tràn màn hình trên thiết bị di động */
    @media (max-width: 768px) {
      .modal-dialog {
        margin: 0.5rem;
        max-width: 95%;
      }
      
      .modal-dialog-centered {
        min-height: calc(100% - 1rem);
      }
    }
    
    /* Fix cho nút đóng trên modal header */
    .modal-header .btn-close {
      padding: 0.5rem;
      margin: -0.5rem -0.5rem -0.5rem auto;
    }
    
    /* Hiệu ứng hover cho các nút */
    .btn {
      transition: all 0.2s;
    }
    
    .btn:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    
    /* Style đặc biệt cho công đoạn in offset */
    .offset-card {
      border-left: 4px solid #6f42c1;
    }
    
    .offset-badge {
      background: linear-gradient(45deg, #6f42c1, #e83e8c);
      color: white;
    }
  </style>
</head>
<body data-stage="in_offset">
  
  <!-- Sidebar -->
  <div class="sidebar collapsed" id="sidebar">
    <div class="sidebar-content">
      <div class="sidebar-header">
        <div class="sidebar-brand">
          <div class="bg-primary text-white rounded d-flex align-items-center justify-content-center" style="width:32px;height:32px;">
            <i class="bi bi-box"></i>
          </div>
          <h5 class="mb-0 text-primary">Carton Manager</h5>
        </div>
        <button class="btn btn-primary sidebar-toggle" onclick="toggleSidebar()" id="toggleBtn" title="Thu nhỏ/Mở rộng">
          <span id="toggleIcon"><i class="bi bi-chevron-right"></i></span>
        </button>
      </div>
      
      <nav class="sidebar-nav">
        <a href="dashboard.html" class="nav-link">
          <i class="bi bi-house"></i>
          <span class="nav-text">Trang chủ</span>
        </a>
        <a href="production-orders.html" class="nav-link">
          <i class="bi bi-clipboard-data"></i>
          <span class="nav-text">Lệnh sản xuất</span>
        </a>
        <a href="progress.html" class="nav-link">
          <i class="bi bi-lightning"></i>
          <span class="nav-text">Quản lý tiến độ</span>
        </a>
        <a href="materials.html" class="nav-link">
          <i class="bi bi-box-seam"></i>
          <span class="nav-text">Vật tư</span>
        </a>
        <a href="workflow.html" class="nav-link">
          <i class="bi bi-arrow-repeat"></i>
          <span class="nav-text">Công đoạn</span>
        </a>
        <a href="reports.html" class="nav-link">
          <i class="bi bi-graph-up"></i>
          <span class="nav-text">Báo cáo</span>
        </a>
        <a href="xa-stage.html" class="nav-link">
          <i class="bi bi-bullseye"></i>
          <span class="nav-text">Công đoạn XẢ</span>
        </a>
        <a href="xen-stage.html" class="nav-link">
          <i class="bi bi-scissors"></i>
          <span class="nav-text">Công đoạn XÉN</span>
        </a>
        <a href="in-stage.html" class="nav-link">
          <i class="bi bi-printer"></i>
          <span class="nav-text">Công đoạn IN</span>
        </a>
        <a href="in-offset-stage.html" class="nav-link active">
          <i class="bi bi-printer-fill"></i>
          <span class="nav-text">Công đoạn IN OFFSET</span>
        </a>
        <a href="boi-stage.html" class="nav-link">
          <i class="bi bi-file-text"></i>
          <span class="nav-text">Công đoạn BỒI</span>
        </a>
        <a href="be-stage.html" class="nav-link">
          <i class="bi bi-knife"></i>
          <span class="nav-text">Công đoạn BẾ</span>
        </a>
        <a href="dan-stage.html" class="nav-link">
          <i class="bi bi-link"></i>
          <span class="nav-text">Công đoạn DÁN</span>
        </a>
        <a href="kho-stage.html" class="nav-link">
          <i class="bi bi-building"></i>
          <span class="nav-text">KHO THÀNH PHẨM</span>
        </a>
      </nav>
      
      <div class="sidebar-footer">
        © 2025 Carton Manager
      </div>
    </div>
  </div>

  <!-- Main Content -->
  <div class="main-content sidebar-collapsed" id="mainContent">
    <div class="container-fluid p-4">
      
      <!-- Stage Header -->
      <div class="stage-header">
        <h1>
          <i class="bi bi-printer-fill me-2 text-purple"></i>
          Công đoạn IN OFFSET
        </h1>
        <p class="mb-0">In offset chất lượng cao - In màu CMYK chuyên nghiệp</p>
      </div>
      
      <!-- Statistics -->
      <div class="row mb-4" id="stageStats">
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card offset-card">
            <div class="stat-value" id="totalOrders">0</div>
            <div class="stat-label">Tổng lệnh</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card offset-card">
            <div class="stat-value" id="totalPlan">0</div>
            <div class="stat-label">SL Kế hoạch</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card offset-card">
            <div class="stat-value" id="totalGood">0</div>
            <div class="stat-label">SL Đạt</div>
          </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
          <div class="stat-card offset-card">
            <div class="stat-value" id="totalNg">0</div>
            <div class="stat-label">SL NG</div>
          </div>
        </div>
      </div>
      
      <!-- Main Card -->
      <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
          <h5 class="mb-0">
            <span class="offset-badge badge me-2">IN OFFSET</span>
            Danh sách lệnh sản xuất - Công đoạn In Offset
          </h5>
          <div>
            <button class="btn btn-primary me-2" onclick="refreshData()">
              <i class="bi bi-arrow-clockwise me-1"></i>Làm mới
            </button>
            <button class="btn btn-success" onclick="showNewOrderForm()">
              <i class="bi bi-plus-lg me-1"></i>Thêm mới
            </button>
          </div>
        </div>
        
        <div class="card-body">
          <!-- Filters -->
          <div class="row mb-3">
            <div class="col-md-3">
              <label class="form-label">Ngày sản xuất:</label>
              <input type="date" class="form-control" id="dateFilter">
            </div>
            <div class="col-md-2">
              <label class="form-label">Ca:</label>
              <select class="form-select" id="shiftFilter">
                <option value="">Tất cả</option>
                <option value="Ca 1">Ca 1</option>
                <option value="Ca 2">Ca 2</option>
                <option value="Ca 3">Ca 3</option>
              </select>
            </div>
            <div class="col-md-2">
              <label class="form-label">Máy in:</label>
              <select class="form-select" id="machineFilter">
                <option value="">Tất cả</option>
                <option value="Offset 1">Offset 1</option>
                <option value="Offset 2">Offset 2</option>
                <option value="Offset 3">Offset 3</option>
                <option value="Offset 4">Offset 4</option>
              </select>
            </div>
            <div class="col-md-5">
              <label class="form-label">Tìm kiếm:</label>
              <div class="input-group">
                <input type="text" class="form-control" id="searchInput" placeholder="Tìm theo mã lệnh, sản phẩm...">
                <button class="btn btn-outline-secondary" type="button" onclick="applyFilters()">
                  <i class="bi bi-search"></i>
                </button>
              </div>
            </div>
          </div>
          
          <!-- Table -->
          <div class="table-container">
            <table class="table table-striped table-hover">
              <thead>
                <tr>
                  <th width="50">#</th>
                  <th width="150">Lệnh SX</th>
                  <th width="200">Sản phẩm</th>
                  <th width="120">Màu sắc</th>
                  <th width="100">KH</th>
                  <th width="100">Đầu vào</th>
                  <th width="100">OK</th>
                  <th width="100">NG</th>
                  <th width="120">Tiến độ</th>
                  <th width="120">Máy/Thợ</th>
                  <th width="150">Thao tác</th>
                </tr>
              </thead>
              <tbody id="stageTableBody">
              </tbody>
            </table>
          </div>
          
          <!-- Loading and No Data States -->
          <div id="loadingState" class="text-center py-5 d-none">
            <div class="spinner-border text-primary" role="status">
              <span class="visually-hidden">Đang tải...</span>
            </div>
            <p class="mt-2">Đang tải dữ liệu...</p>
          </div>
          
          <div id="noDataState" class="text-center py-5 d-none">
            <i class="bi bi-inbox display-1 text-muted"></i>
            <p class="mt-2 text-muted">Không có lệnh sản xuất nào cho công đoạn In Offset</p>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Completing Stage -->
  <div class="modal fade" id="completeStageModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header bg-purple text-white">
          <h5 class="modal-title">
            <i class="bi bi-printer-fill me-2"></i>
            Hoàn thành công đoạn In Offset
          </h5>
          <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <!-- Form tabs -->
          <ul class="nav nav-tabs mb-3" id="modalTabs" role="tablist">
            <li class="nav-item" role="presentation">
              <button class="nav-link active" id="complete-tab" data-bs-toggle="tab" data-bs-target="#complete-tab-pane" type="button" role="tab">
                <i class="bi bi-check-circle me-1"></i>Hoàn thành công đoạn
              </button>
            </li>
            <li class="nav-item" role="presentation">
              <button class="nav-link" id="handover-tab" data-bs-toggle="tab" data-bs-target="#handover-tab-pane" type="button" role="tab">
                <i class="bi bi-arrow-right-circle me-1"></i>Bàn giao công đoạn BỒI
              </button>
            </li>
          </ul>

          <!-- Tab content -->
          <div class="tab-content" id="modalTabContent">
            <!-- Complete stage tab -->
            <div class="tab-pane fade show active" id="complete-tab-pane" role="tabpanel" tabindex="0">
              <form id="completeStageForm">
                <input type="hidden" id="completeOrderId">
                
                <!-- Order Info -->
                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Mã lệnh:</strong> <span id="modalOrderCode"></span>
                  </div>
                  <div class="col-md-6">
                    <strong>Sản phẩm:</strong> <span id="modalProductName"></span>
                  </div>
                </div>
                
                <!-- Current Stage Info -->
                <div class="alert alert-info">
                  <h6><i class="bi bi-info-circle me-2"></i>Thông tin đầu vào:</h6>
                  <div class="row">
                    <div class="col-md-6">
                      <strong>Số lượng đầu vào:</strong> <span id="modalInputQty" class="text-primary">0</span>
                    </div>
                    <div class="col-md-6">
                      <strong>Màu sắc in:</strong> <span id="modalColors"></span>
                    </div>
                  </div>
                </div>
                
                <!-- Production Results -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Số lượng đạt (OK) *</label>
                    <input type="number" class="form-control" id="modalGoodQty" required min="0" onchange="updateHandoverQty()">
                    <div class="form-text">Số lượng sản phẩm đạt chất lượng</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Số lượng NG *</label>
                    <input type="number" class="form-control" id="modalNgQty" required min="0">
                    <div class="form-text">Số lượng sản phẩm không đạt chất lượng</div>
                  </div>
                </div>
                
                <!-- In Offset Specific Fields -->
                <div class="row">
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Máy in Offset</label>
                    <select class="form-select" id="modalMachine">
                      <option value="">Chọn máy</option>
                      <option value="Offset 1">Offset 1 (4 màu)</option>
                      <option value="Offset 2">Offset 2 (4 màu)</option>
                      <option value="Offset 3">Offset 3 (6 màu)</option>
                      <option value="Offset 4">Offset 4 (8 màu)</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Chất lượng in</label>
                    <select class="form-select" id="modalQuality">
                      <option value="A">A - Xuất sắc</option>
                      <option value="B" selected>B - Tốt</option>
                      <option value="C">C - Trung bình</option>
                    </select>
                  </div>
                  <div class="col-md-4 mb-3">
                    <label class="form-label">Giờ sản xuất</label>
                    <select class="form-select" id="modalShift">
                      <option value="Ca 1">Ca 1 (6:00-14:00)</option>
                      <option value="Ca 2">Ca 2 (14:00-22:00)</option>
                      <option value="Ca 3">Ca 3 (22:00-6:00)</option>
                    </select>
                  </div>
                </div>
                
                <!-- Worker and Materials -->
                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Thợ in phụ trách</label>
                    <input type="text" class="form-control" id="modalWorker" placeholder="Tên thợ in">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Loại mực sử dụng</label>
                    <input type="text" class="form-control" id="modalInkType" placeholder="VD: CMYK Standard">
                  </div>
                </div>
                
                <!-- Note -->
                <div class="mb-3">
                  <label class="form-label">Ghi chú về chất lượng in</label>
                  <textarea class="form-control" id="modalNotes" rows="3" placeholder="Ghi chú về màu sắc, chất lượng in, vấn đề gặp phải..."></textarea>
                </div>
              </form>
            </div>

            <!-- Handover tab -->
            <div class="tab-pane fade" id="handover-tab-pane" role="tabpanel" tabindex="0">
              <form id="handoverForm">
                <!-- Next Stage Info -->
                <div class="alert alert-warning">
                  <h6><i class="bi bi-arrow-right me-2"></i>Công đoạn tiếp theo:</h6>
                  <p class="mb-1">Sau khi hoàn thành in offset, sản phẩm OK sẽ được chuyển sang công đoạn <strong>BỒI</strong></p>
                </div>

                <div class="row mb-3">
                  <div class="col-md-6">
                    <strong>Mã lệnh:</strong> <span id="handoverOrderCode"></span>
                  </div>
                  <div class="col-md-6">
                    <strong>Sản phẩm:</strong> <span id="handoverProductName"></span>
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Số lượng bàn giao: <span class="text-danger">*</span></label>
                    <input type="number" class="form-control" id="handoverQty" min="0">
                    <div class="form-text">Số lượng chuyển sang công đoạn BỒI</div>
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Ngày bàn giao:</label>
                    <input type="date" class="form-control" id="handoverDate">
                  </div>
                </div>

                <div class="row">
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Người bàn giao:</label>
                    <input type="text" class="form-control" id="handoverPerson" placeholder="Nhập tên người bàn giao">
                  </div>
                  <div class="col-md-6 mb-3">
                    <label class="form-label">Người nhận:</label>
                    <input type="text" class="form-control" id="receiverPerson" placeholder="Nhập tên người nhận">
                  </div>
                </div>

                <div class="mb-3">
                  <label class="form-label">Ghi chú bàn giao:</label>
                  <textarea class="form-control" id="handoverNotes" rows="3" placeholder="Ghi chú về chất lượng in, lưu ý cho công đoạn bồi..."></textarea>
                </div>

                <div class="alert alert-secondary">
                  <div class="form-check">
                    <input class="form-check-input" type="checkbox" id="confirmHandover">
                    <label class="form-check-label" for="confirmHandover">
                      Tôi xác nhận đã kiểm tra chất lượng in và bàn giao đủ số lượng cho công đoạn tiếp theo
                    </label>
                  </div>
                </div>
              </form>
            </div>
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
          <button type="button" class="btn btn-success" onclick="completeStage()">
            <i class="bi bi-check-lg me-1"></i>Hoàn thành & Bàn giao
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- Include Dependencies -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    /**
     * =================================================================
     * IN OFFSET STAGE MANAGEMENT - QUẢN LÝ CÔNG ĐOẠN IN OFFSET
     * =================================================================
     * Chức năng chính:
     * 1. Hiển thị danh sách lệnh sản xuất ở công đoạn IN OFFSET
     * 2. Hoàn thành công đoạn IN OFFSET (cập nhật số lượng OK, NG, chất lượng in)
     * 3. Bàn giao sang công đoạn BỒI (ghi trực tiếp vào cột boi_input_quantity)
     */

    // === CẤU HÌNH API & WEBHOOK ===
    const API_BASE_URL = 'https://autoslp.duckdns.org/api';
    const WEBHOOK_BASE_URL = 'https://autoslp.duckdns.org:5678/webhook';

    // === CẤU HÌNH CÔNG ĐOẠN ===
    const STAGE_CONFIG = {
        KEY: 'in_offset',        // Tên key trong database
        NAME: 'IN OFFSET',       // Tên hiển thị
        NEXT_STAGE: 'boi'        // Công đoạn tiếp theo
    };

    // === BIẾN GLOBAL ===
    let stageOrders = [];        // Dữ liệu lệnh sản xuất
    let editingOrderId = null;   // Đơn hàng đang chỉnh sửa

    /**
     * =================================================================
     * WEBHOOK FUNCTIONS - HÀM GỬI DỮ LIỆU QUA WEBHOOK
     * =================================================================
     */

    /**
     * Gửi dữ liệu qua webhook n8n
     * @param {string} action - Loại hành động
     * @param {Object} data - Dữ liệu gửi đi
     * @returns {Promise<Object>} Kết quả gửi webhook
     */
    async function sendWebhook(action, data) {
        try {
            const payload = {
                action: action,
                timestamp: new Date().toISOString(),
                source: 'in_offset_stage_frontend',
                data: data
            };

            console.log(`Sending webhook for action: ${action}`, payload);

            const response = await fetch(`${WEBHOOK_BASE_URL}/production`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(payload)
            });

            if (!response.ok) {
                throw new Error(`Webhook failed: ${response.status}`);
            }

            const result = await response.json();
            console.log('Webhook response:', result);
            
            return {
                success: true,
                message: 'Dữ liệu đã được gửi qua webhook thành công',
                webhook_response: result
            };

        } catch (error) {
            console.error('Error sending webhook:', error);
            
            // Fallback: Lưu vào localStorage để retry sau
            saveToLocalStorage(action, data);
            
            return {
                success: true,
                message: 'Đã lưu dữ liệu local (sẽ đồng bộ khi có kết nối)',
                local_only: true
            };
        }
    }

    /**
     * Lưu dữ liệu vào localStorage để retry sau
     */
    function saveToLocalStorage(action, data) {
        try {
            const key = 'pending_webhooks_in_offset';
            const existing = JSON.parse(localStorage.getItem(key) || '[]');
            
            existing.push({
                action: action,
                data: data,
                timestamp: new Date().toISOString()
            });
            
            localStorage.setItem(key, JSON.stringify(existing));
            console.log('Data saved to localStorage for later sync');
        } catch (error) {
            console.error('Error saving to localStorage:', error);
        }
    }

    /**
     * Đồng bộ dữ liệu đã lưu trong localStorage
     */
    async function syncPendingData() {
        try {
            const key = 'pending_webhooks_in_offset';
            const pending = JSON.parse(localStorage.getItem(key) || '[]');
            
            if (pending.length === 0) return;
            
            console.log(`Syncing ${pending.length} pending webhooks...`);
            
            for (const item of pending) {
                await sendWebhook(item.action, item.data);
            }
            
            // Xóa dữ liệu đã sync
            localStorage.removeItem(key);
            App.notify('Đã đồng bộ dữ liệu thành công', 'success');
            
        } catch (error) {
            console.error('Error syncing pending data:', error);
        }
    }

    /**
     * =================================================================
     * KHỞI TẠO TRANG - PAGE INITIALIZATION
     * =================================================================
     */
    
    // Khởi tạo khi trang được load
    document.addEventListener('DOMContentLoaded', function() {
        console.log('=== IN OFFSET STAGE PAGE LOADED ===');
        initData();
    });

    /**
     * Khởi tạo trang - load dữ liệu và setup UI
     */
    async function initData() {
        try {
            showLoading(true);
            
            // Đồng bộ dữ liệu pending trước
            await syncPendingData();
            
            // Tải dữ liệu từ API
            await loadOrdersData();
            
            // Render giao diện
            renderStageData();
            updateStatistics();
            
            App.notify('Đã tải dữ liệu thành công', 'success');
            
        } catch (error) {
            console.error('Error initializing page:', error);
            App.notify('Lỗi tải dữ liệu: ' + error.message, 'error');
            
            // Fallback: sử dụng mảng rỗng
            stageOrders = [];
            renderStageData();
            updateStatistics();
        } finally {
            showLoading(false);
        }
    }

    /**
     * =================================================================
     * QUẢN LÝ DỮ LIỆU - DATA MANAGEMENT
     * =================================================================
     */

    /**
     * Tải dữ liệu lệnh sản xuất từ API
     */
    async function loadOrdersData() {
        try {
            console.log('Loading orders data for stage:', STAGE_CONFIG.KEY);
            
            // Gọi API để lấy danh sách lệnh sản xuất từ bảng production_orders
            const response = await fetch(`${API_BASE_URL}/data/production_orders`);
            
            if (!response.ok) {
                throw new Error(`API response: ${response.status}`);
            }
            
            const apiData = await response.json();
            console.log('API data received:', apiData);
            console.log('Total records from API:', Array.isArray(apiData) ? apiData.length : 'Not an array');
            
            if (Array.isArray(apiData) && apiData.length > 0) {
                console.log('Sample record structure:', apiData[0]);
                console.log('Available fields:', Object.keys(apiData[0]));
            }
            
            // Chuyển đổi dữ liệu API từ bảng production_orders thành format internal
            // Hiển thị tất cả lệnh sản xuất (không filter để debug)
            stageOrders = Array.isArray(apiData) ? apiData
                .map((order, index) => {
                    console.log(`Processing order ${index + 1}:`, order);
                    return {
                        id: order.id || index + 1,
                        production_order: order.order_code || order.production_order || order.code || `LSX-${String(index + 1).padStart(3, '0')}`,
                        product_name: order.product_name || order.name || 'Sản phẩm carton',
                        internal_product_code: order.internal_product_code || order.internal_code || '',
                        customer_name: order.customer_name || order.customer || 'Khách hàng',
                        deployed_quantity: order.quantity || order.total_quantity || order.deployed_quantity || 1000,
                        colors: order.colors || order.print_colors || order.color_info || 'CMYK',
                        in_offset_input_qty: order.in_offset_input_quantity || order.in_input_quantity || order.input_quantity || order.quantity || 0,
                        in_offset_good_qty: order.in_offset_good_quantity || order.good_quantity || 0,
                        in_offset_ng_qty: order.in_offset_ng_quantity || order.ng_quantity || 0,
                        in_offset_status: order.in_offset_status || order.status || 'pending',
                        assigned_machine: order.in_offset_machine_name || order.machine_name || order.machine || '',
                        worker: order.in_offset_worker_name || order.worker_name || order.worker || '',
                        production_date: order.deployment_date || order.production_date || order.created_at || new Date().toISOString().split('T')[0],
                        shift: order.shift || order.production_shift || order.work_shift || 'Ca 1',
                        stage_status: order.in_offset_status || order.stage_status || 'pending',
                        notes: order.in_offset_note || order.notes || order.note || '',
                        quality_grade: order.quality_grade || 'B',
                        ink_type: order.ink_type || 'CMYK Standard',
                        created_at: order.created_at || new Date().toISOString(),
                        updated_at: order.updated_at || new Date().toISOString()
                    };
                }) : [];
            
            console.log('Stage orders processed:', stageOrders.length, 'items');
            
        } catch (error) {
            console.error('API error:', error.message);
            stageOrders = []; // Khởi tạo mảng rỗng
            App.notify('Không thể tải dữ liệu: ' + error.message, 'warning');
        }
    }

    /**
     * =================================================================
     * HIỂN THỊ DỮ LIỆU - DATA RENDERING
     * =================================================================
     */

    // Show/hide loading state
    function showLoading(show) {
        document.getElementById('loadingState').classList.toggle('d-none', !show);
        document.getElementById('stageTableBody').classList.toggle('d-none', show);
        document.getElementById('noDataState').classList.toggle('d-none', show || stageOrders.length > 0);
    }

    // Render stage data in table
    function renderStageData() {
        const tbody = document.getElementById('stageTableBody');
        
        if (!stageOrders || stageOrders.length === 0) {
            tbody.innerHTML = '';
            document.getElementById('noDataState').classList.remove('d-none');
            return;
        }
        
        document.getElementById('noDataState').classList.add('d-none');
        
        tbody.innerHTML = stageOrders.map((order, index) => {
            const progressPercent = order.in_offset_input_qty > 0 
                ? Math.round((order.in_offset_good_qty / order.in_offset_input_qty) * 100) 
                : 0;
            
            const statusClass = order.stage_status === 'completed' ? 'success' : 
                               order.stage_status === 'in_progress' ? 'warning' : 'secondary';
            
            const statusText = order.stage_status === 'completed' ? 'Hoàn thành' :
                              order.stage_status === 'in_progress' ? 'Đang thực hiện' : 'Chờ thực hiện';
            
            return `
                <tr>
                    <td>${index + 1}</td>
                    <td>
                        <strong>${order.production_order}</strong>
                        <br><small class="text-muted">${formatDate(order.production_date)}</small>
                    </td>
                    <td>
                        <div>${order.product_name}</div>
                        <small class="text-muted">${order.shift || 'N/A'}</small>
                    </td>
                    <td>
                        <span class="badge offset-badge">${order.colors}</span>
                    </td>
                    <td class="text-end">
                        <strong>${formatNumber(order.deployed_quantity)}</strong>
                    </td>
                    <td class="text-end">
                        <span class="text-primary">${formatNumber(order.in_offset_input_qty)}</span>
                    </td>
                    <td class="text-end">
                        <span class="text-success fw-bold">${formatNumber(order.in_offset_good_qty)}</span>
                    </td>
                    <td class="text-end">
                        <span class="text-danger">${formatNumber(order.in_offset_ng_qty)}</span>
                    </td>
                    <td>
                        <div class="progress mb-1" style="height: 8px;">
                            <div class="progress-bar bg-${statusClass}" style="width: ${progressPercent}%"></div>
                        </div>
                        <small class="text-${statusClass}">${statusText}</small>
                    </td>
                    <td>
                        <div><strong>${order.assigned_machine || 'Chưa phân'}</strong></div>
                        <small class="text-muted">${order.worker || 'Chưa có'}</small>
                    </td>
                    <td>
                        <div class="btn-group btn-group-sm">
                            <button class="btn btn-info rounded-pill px-3 me-1" onclick="viewOrderDetails(${order.id})" title="Xem chi tiết">
                                <i class="bi bi-eye me-1"></i>Chi tiết
                            </button>
                            ${order.stage_status !== 'completed' ? `
                                <button class="btn btn-success rounded-pill px-3" onclick="showCompleteModal(${order.id})" title="Hoàn thành">
                                    <i class="bi bi-check-lg me-1"></i>Hoàn thành
                                </button>
                            ` : `
                                <button class="btn btn-primary rounded-pill px-3" onclick="showHandoverModal(${order.id})" title="Bàn giao cho công đoạn BỒI">
                                    <i class="bi bi-arrow-right-circle me-1"></i>Bàn giao BỒI
                                </button>
                            `}
                        </div>
                    </td>
                </tr>
            `;
        }).join('');
    }

    // Update statistics
    function updateStatistics() {
        const stats = {
            totalOrders: stageOrders.length,
            totalPlan: stageOrders.reduce((sum, order) => sum + (order.in_offset_input_qty || 0), 0),
            totalGood: stageOrders.reduce((sum, order) => sum + (order.in_offset_good_qty || 0), 0),
            totalNg: stageOrders.reduce((sum, order) => sum + (order.in_offset_ng_qty || 0), 0)
        };
        
        document.getElementById('totalOrders').textContent = formatNumber(stats.totalOrders);
        document.getElementById('totalPlan').textContent = formatNumber(stats.totalPlan);
        document.getElementById('totalGood').textContent = formatNumber(stats.totalGood);
        document.getElementById('totalNg').textContent = formatNumber(stats.totalNg);
    }

    /**
     * =================================================================
     * XỬ LÝ SỰ KIỆN - EVENT HANDLERS
     * =================================================================
     */

    // Complete stage
    async function completeStage() {
        if (!editingOrderId) {
            App.notify('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        const goodQty = parseInt(document.getElementById('modalGoodQty').value) || 0;
        const ngQty = parseInt(document.getElementById('modalNgQty').value) || 0;
        const machine = document.getElementById('modalMachine').value;
        const worker = document.getElementById('modalWorker').value;
        const notes = document.getElementById('modalNotes').value;
        const shift = document.getElementById('modalShift').value;
        const quality = document.getElementById('modalQuality').value;
        const inkType = document.getElementById('modalInkType').value;
        
        // Thông tin bàn giao
        const handoverQty = parseInt(document.getElementById('handoverQty').value) || 0;
        const handoverDate = document.getElementById('handoverDate').value;
        const handoverPerson = document.getElementById('handoverPerson').value;
        const receiverPerson = document.getElementById('receiverPerson').value;
        const handoverNotes = document.getElementById('handoverNotes').value;
        const confirmHandover = document.getElementById('confirmHandover').checked;
        
        // Validate đầu vào
        if (goodQty <= 0) {
            App.notify('Vui lòng nhập số lượng OK hợp lệ', 'error');
            return;
        }
        
        if (handoverQty <= 0) {
            App.notify('Vui lòng nhập số lượng bàn giao', 'error');
            return;
        }
        
        if (handoverQty > goodQty) {
            App.notify('Số lượng bàn giao không được lớn hơn số lượng OK', 'error');
            return;
        }
        
        if (!confirmHandover) {
            App.notify('Vui lòng xác nhận bàn giao sản phẩm', 'error');
            return;
        }
        
        try {
            // Kiểm tra tab hiện tại để xác định loại thao tác
            const activeTab = document.querySelector('#modalTabs .nav-link.active');
            const isHandoverTab = activeTab && activeTab.id === 'handover-tab';
            
            if (isHandoverTab) {
                // Hoàn thành và bàn giao luôn
                await handleCompleteAndHandover({
                    goodQuantity: goodQty,
                    ngQuantity: ngQty,
                    machine: machine,
                    workerName: worker,
                    shift: shift,
                    notes: notes,
                    qualityGrade: quality,
                    inkType: inkType,
                    handoverQuantity: handoverQty,
                    handoverDate: handoverDate,
                    handoverPerson: handoverPerson,
                    receiverPerson: receiverPerson,
                    handoverNotes: handoverNotes
                });
            } else {
                // Chỉ hoàn thành công đoạn
                await handleCompleteStageOnly({
                    goodQuantity: goodQty,
                    ngQuantity: ngQty,
                    machine: machine,
                    workerName: worker,
                    shift: shift,
                    notes: notes,
                    qualityGrade: quality,
                    inkType: inkType
                });
            }
            
            // Refresh dữ liệu và đóng modal
            await initData();
            
            const modal = bootstrap.Modal.getInstance(document.getElementById('completeStageModal'));
            modal.hide();
            
            editingOrderId = null;
            App.notify('Đã hoàn thành công đoạn IN OFFSET thành công!', 'success');
            
        } catch (error) {
            console.error('Error completing stage:', error);
            App.notify('Lỗi: ' + error.message, 'error');
        }
    }

    /**
     * Xử lý hoàn thành và bàn giao từ IN OFFSET sang BỒI
     */
    async function handleCompleteAndHandover(data) {
        try {
            const completeHandoverData = {
                order_id: editingOrderId,
                action_type: 'complete_and_handover',
                from_stage: 'in_offset',
                to_stage: 'boi',
                
                // Thông tin hoàn thành
                completion: {
                    output_quantity: data.goodQuantity + data.ngQuantity,
                    good_quantity: data.goodQuantity,
                    ng_quantity: data.ngQuantity,
                    worker_name: data.workerName,
                    machine_name: data.machine,
                    shift: data.shift,
                    notes: data.notes,
                    quality_grade: data.qualityGrade,
                    ink_type: data.inkType
                },
                
                // Thông tin bàn giao
                handover: {
                    handover_quantity: data.handoverQuantity,
                    handover_person: data.handoverPerson,
                    receiver_person: data.receiverPerson,
                    handover_date: data.handoverDate,
                    handover_notes: data.handoverNotes
                },
                
                completed_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook('complete_in_offset_and_handover_to_boi', completeHandoverData);
            
            if (result.success) {
                App.notify(
                    `✅ Đã hoàn thành công đoạn IN OFFSET và bàn giao ${formatNumber(data.handoverQuantity)} sản phẩm cho công đoạn BỒI thành công!`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error complete and handover:', error);
            App.notify('Lỗi khi hoàn thành và bàn giao: ' + error.message, 'error');
            throw error;
        }
    }

    /**
     * Xử lý chỉ hoàn thành công đoạn
     */
    async function handleCompleteStageOnly(data) {
        try {
            const updateData = {
                order_id: editingOrderId,
                stage: STAGE_CONFIG.KEY,
                output_quantity: data.goodQuantity + data.ngQuantity,
                good_quantity: data.goodQuantity,
                ng_quantity: data.ngQuantity,
                worker_name: data.workerName,
                machine_name: data.machine,
                shift: data.shift,
                notes: data.notes,
                quality_grade: data.qualityGrade,
                ink_type: data.inkType,
                updated_at: new Date().toISOString()
            };
            
            // Gửi qua webhook n8n
            const result = await sendWebhook('update_stage_output', updateData);
            
            if (result.success) {
                App.notify(
                    `✅ Đã hoàn thành công đoạn IN OFFSET: ${formatNumber(data.goodQuantity)} OK, ${formatNumber(data.ngQuantity)} NG`,
                    'success'
                );
            }
            
        } catch (error) {
            console.error('Error completing stage:', error);
            App.notify('Lỗi khi hoàn thành công đoạn: ' + error.message, 'error');
            throw error;
        }
    }
    
    // Hiển thị thông tin chi tiết lệnh để hoàn thành
    function showCompleteModal(orderId) {
        const order = stageOrders.find(o => o.id == orderId);
        if (!order) {
            App.notify('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        editingOrderId = orderId;
        
        // Chuyển đến tab hoàn thành công đoạn
        setTimeout(() => {
            document.getElementById('complete-tab').click();
        }, 200);
        
        // Populate modal fields - Tab hoàn thành
        document.getElementById('completeOrderId').value = order.id;
        document.getElementById('modalOrderCode').textContent = order.production_order;
        document.getElementById('modalProductName').textContent = order.product_name;
        document.getElementById('modalInputQty').textContent = formatNumber(order.in_offset_input_qty);
        document.getElementById('modalColors').textContent = order.colors;
        document.getElementById('modalGoodQty').value = order.in_offset_good_qty || '';
        document.getElementById('modalNgQty').value = order.in_offset_ng_qty || 0;
        document.getElementById('modalMachine').value = order.assigned_machine || '';
        document.getElementById('modalWorker').value = order.worker || '';
        document.getElementById('modalNotes').value = order.notes || '';
        document.getElementById('modalShift').value = order.shift || 'Ca 1';
        document.getElementById('modalQuality').value = order.quality_grade || 'B';
        document.getElementById('modalInkType').value = order.ink_type || '';
        
        // Populate modal fields - Tab bàn giao
        document.getElementById('handoverOrderCode').textContent = order.production_order;
        document.getElementById('handoverProductName').textContent = order.product_name;
        document.getElementById('handoverQty').value = order.in_offset_good_qty || '';
        document.getElementById('handoverDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('handoverPerson').value = order.worker || '';
        document.getElementById('receiverPerson').value = '';
        document.getElementById('handoverNotes').value = '';
        document.getElementById('confirmHandover').checked = false;
        
        // Cập nhật handover quantity khi có thay đổi good quantity
        updateHandoverQty();
        
        const modal = new bootstrap.Modal(document.getElementById('completeStageModal'));
        modal.show();
    }
    
    // Hiển thị modal bàn giao cho công đoạn BỒI
    function showHandoverModal(orderId) {
        const order = stageOrders.find(o => o.id == orderId);
        if (!order) {
            App.notify('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        editingOrderId = orderId;
        
        // Chuyển đến tab bàn giao trong modal
        document.getElementById('handover-tab').click();
        
        // Populate modal fields - Tab bàn giao
        document.getElementById('handoverOrderCode').textContent = order.production_order;
        document.getElementById('handoverProductName').textContent = order.product_name;
        document.getElementById('handoverQty').value = order.in_offset_good_qty || '';
        document.getElementById('handoverDate').value = new Date().toISOString().split('T')[0];
        document.getElementById('handoverPerson').value = order.worker || '';
        document.getElementById('receiverPerson').value = '';
        document.getElementById('handoverNotes').value = '';
        document.getElementById('confirmHandover').checked = false;
        
        // Hiển thị modal
        const modal = new bootstrap.Modal(document.getElementById('completeStageModal'));
        modal.show();
    }

    // Cập nhật số lượng bàn giao theo số lượng OK
    function updateHandoverQty() {
        const goodQty = parseInt(document.getElementById('modalGoodQty').value) || 0;
        document.getElementById('handoverQty').value = goodQty;
    }

    // Show new order form
    function showNewOrderForm() {
        App.notify('Chức năng thêm mới đang được phát triển', 'info');
    }

    // View order details
    function viewOrderDetails(orderId) {
        const order = stageOrders.find(o => o.id == orderId);
        if (!order) {
            App.notify('Không tìm thấy lệnh sản xuất', 'error');
            return;
        }
        
        const details = `
Mã lệnh: ${order.production_order}
Sản phẩm: ${order.product_name}
Màu sắc: ${order.colors}
Kế hoạch: ${formatNumber(order.deployed_quantity)}
Đầu vào: ${formatNumber(order.in_offset_input_qty)}
Đã hoàn thành: ${formatNumber(order.in_offset_good_qty || 0)}
Lỗi: ${formatNumber(order.in_offset_ng_qty || 0)}
Máy in: ${order.assigned_machine || 'Chưa phân công'}
Thợ in: ${order.worker || 'Chưa phân công'}
Chất lượng: ${order.quality_grade || 'B'}
Loại mực: ${order.ink_type || 'N/A'}
Ghi chú: ${order.notes || 'Không có'}
        `.trim();
        
        alert('CHI TIẾT LỆNH SẢN XUẤT - IN OFFSET\n\n' + details);
    }
    
    // Refresh data
    async function refreshData() {
        await initData();
        App.notify('Làm mới dữ liệu thành công!', 'info');
    }
    
    // Apply filters
    function applyFilters() {
        // Implementation for filtering functionality
        App.notify('Chức năng lọc đang được phát triển', 'info');
    }
    
    // Toggle sidebar
    function toggleSidebar() {
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const toggleIcon = document.getElementById('toggleIcon');
        
        if (sidebar.classList.contains('collapsed')) {
            sidebar.classList.remove('collapsed');
            mainContent.classList.remove('sidebar-collapsed');
            toggleIcon.innerHTML = '<i class="bi bi-chevron-left"></i>';
        } else {
            sidebar.classList.add('collapsed');
            mainContent.classList.add('sidebar-collapsed');
            toggleIcon.innerHTML = '<i class="bi bi-chevron-right"></i>';
        }
    }

    /**
     * =================================================================
     * UTILITY FUNCTIONS - CÁC HÀM TIỆN ÍCH
     * =================================================================
     */

    // Utility functions
    const App = {
        formatNumber: function(num) {
            return new Intl.NumberFormat('vi-VN').format(num || 0);
        },
        
        notify: function(message, type = 'info') {
            // Simple notification
            const alertClass = type === 'error' ? 'danger' : type;
            const alert = document.createElement('div');
            alert.className = `alert alert-${alertClass} alert-dismissible fade show position-fixed`;
            alert.style.cssText = 'top: 20px; right: 20px; z-index: 9999; min-width: 300px;';
            alert.innerHTML = `
                ${message}
                <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
            `;
            document.body.appendChild(alert);
            
            // Auto remove after 5 seconds
            setTimeout(() => {
                if (alert.parentNode) {
                    alert.remove();
                }
            }, 5000);
        }
    };

    // Format số theo định dạng Việt Nam
    function formatNumber(num) {
        if (!num && num !== 0) return '0';
        return new Intl.NumberFormat('vi-VN').format(num);
    }

    // Format ngày
    function formatDate(date) {
        if (!date) return '';
        const d = new Date(date);
        const day = String(d.getDate()).padStart(2, '0');
        const month = String(d.getMonth() + 1).padStart(2, '0');
        const year = d.getFullYear();
        return `${day}/${month}/${year}`;
    }
  </script>
  
  <!-- Loading Overlay -->
  <div id="loadingOverlay" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5); z-index: 9999; justify-content: center; align-items: center;">
    <div class="text-center text-white">
      <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
      </div>
      <div class="mt-2">Đang tải dữ liệu từ API...</div>
    </div>
  </div>
</body>
</html>
