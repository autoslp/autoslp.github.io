<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Button Visibility</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test-container { margin: 20px 0; padding: 20px; border: 1px solid #ddd; border-radius: 5px; }
        .btn { padding: 10px 20px; margin: 5px; border: none; border-radius: 3px; cursor: pointer; }
        .btn-success { background: #28a745; color: white; }
        .btn-info { background: #17a2b8; color: white; }
        .btn-warning { background: #ffc107; color: black; }
        .btn-primary { background: #007bff; color: white; }
        .btn-secondary { background: #6c757d; color: white; }
        .log { margin-top: 10px; padding: 10px; background: #f8f9fa; border-radius: 3px; font-family: monospace; }
        .order-status { margin: 10px 0; padding: 10px; background: #e9ecef; border-radius: 3px; }
        .hidden { display: none !important; }
        .visible { display: flex !important; }
    </style>
</head>
<body>
    <h1>Test Button Visibility Logic</h1>
    
    <div class="test-container">
        <h3>Order Status</h3>
        <div class="order-status">
            <label>Status: <select id="orderStatus">
                <option value="waiting">waiting</option>
                <option value="in_progress">in_progress</option>
                <option value="completed">completed</option>
                <option value="paused">paused</option>
                <option value="handed_over">handed_over</option>
            </select></label>
            <br><br>
            <label>Start Time: <input type="text" id="startTime" placeholder="YYYY-MM-DD HH:MM:SS or leave empty"></label>
            <br><br>
                         <label>End Time: <input type="text" id="endTime" placeholder="YYYY-MM-DD HH:MM:SS or leave empty"></label>
             <br><br>
             <label>Shift Status: <select id="shiftStatus">
                 <option value="">No shift</option>
                 <option value="waiting">waiting</option>
                 <option value="in_progress">in_progress</option>
                 <option value="completed">completed</option>
                 <option value="paused">paused</option>
                 <option value="handed_over">handed_over</option>
             </select></label>
             <br><br>
             <button class="btn btn-success" onclick="updateOrderStatus()">Update Order Status</button>
        </div>
    </div>
    
    <div class="test-container">
        <h3>Button Visibility Test</h3>
        <div id="buttonContainer">
            <button class="btn btn-success" id="startBtn">B·∫Øt ƒë·∫ßu</button>
            <button class="btn btn-info" id="handoverShiftBtn">B√†n giao ca</button>
            <button class="btn btn-secondary" id="resetBtn">H·ªßy l√†m</button>
        </div>
        <div id="log" class="log"></div>
    </div>

    <script>
        // Copy c√°c h√†m t·ª´ xen-stage.html
        function getOrderField(order, field) {
            return order[field] || null;
        }
        
        function getButtonDisplayStyle(buttonType, order, currentShift = null) {
            const startTime = getOrderField(order, 'start_time');
            const endTime = getOrderField(order, 'end_time');
            
            // Ch·ªâ s·ª≠ d·ª•ng status t·ª´ shift, kh√¥ng d√πng order status
            // Status h·ª£p l·ªá: 'waiting', 'in_progress', 'completed', 'paused', 'handed_over'
            const status = currentShift?.status || 'waiting';
            
            console.log(`üîç Button display check - ${buttonType}:`, {
                shiftStatus: currentShift?.status,
                finalStatus: status,
                startTime: startTime ? 'has start time' : 'no start time',
                endTime: endTime ? 'has end time' : 'no end time'
            });
            
            switch (buttonType) {
                case 'start':
                    // Hi·ªÉn th·ªã n√∫t "B·∫Øt ƒë·∫ßu" khi ch∆∞a c√≥ start_time v√† shift ƒëang ch·ªù (waiting)
                    return (!startTime && status === 'waiting') ? 'display: flex;' : 'display: none;';
                    
                case 'handoverShift':
                    // Hi·ªÉn th·ªã n√∫t "B√†n giao ca" khi ƒë√£ c√≥ start_time, ch∆∞a c√≥ end_time v√† ƒëang trong qu√° tr√¨nh
                    return (startTime && !endTime && status === 'in_progress') ? 'display: flex;' : 'display: none;';
                    
                case 'reset':
                    // Hi·ªÉn th·ªã n√∫t "H·ªßy l√†m" khi ƒëang trong qu√° tr√¨nh s·∫£n xu·∫•t
                    return (startTime && status === 'in_progress') ? 'display: flex; max-width: 100px;' : 'display: none;';
                    
                default:
                    return 'display: none;';
            }
        }
        
        function getButtonDisabledState(buttonType, currentShift = null) {
            // Ch·ªâ s·ª≠ d·ª•ng status t·ª´ shift, kh√¥ng d√πng order status
            // Status h·ª£p l·ªá: 'waiting', 'in_progress', 'completed', 'paused', 'handed_over'
            const status = currentShift?.status || 'waiting';
            
            console.log(`üîç Button disabled check - ${buttonType}:`, {
                shiftStatus: currentShift?.status,
                finalStatus: status
            });
            
            switch (buttonType) {
                case 'start':
                    // Disable n√∫t "B·∫Øt ƒë·∫ßu" khi shift ƒë√£ ho√†n th√†nh, ƒë√£ b√†n giao, ho·∫∑c ƒëang t·∫°m d·ª´ng
                    return (status === 'completed' || status === 'handed_over' || status === 'paused') ? 'disabled' : '';
                    
                case 'handoverShift':
                    // Disable n√∫t "B√†n giao ca" khi shift ch∆∞a b·∫Øt ƒë·∫ßu, ƒë√£ b√†n giao, ho·∫∑c ƒëang t·∫°m d·ª´ng
                    return (status === 'waiting' || status === 'handed_over' || status === 'paused') ? 'disabled' : '';
               
                case 'reset':
                    // Disable n√∫t "H·ªßy l√†m" khi kh√¥ng trong qu√° tr√¨nh s·∫£n xu·∫•t
                    return (status !== 'in_progress') ? 'disabled' : '';
                    
                default:
                    return '';
            }
        }
        
        function updateButtonVisibility(order, currentShift = null) {
            if (!order) {
                console.warn('‚ö†Ô∏è No order provided for updateButtonVisibility');
                return;
            }
            
            const buttons = {
                'startBtn': 'start',
                'handoverShiftBtn': 'handoverShift', 
                'resetBtn': 'reset'
            };
            
            const log = document.getElementById('log');
            log.innerHTML = '';
            
            Object.entries(buttons).forEach(([buttonId, buttonType]) => {
                const button = document.getElementById(buttonId);
                if (button) {
                    const displayStyle = getButtonDisplayStyle(buttonType, order, currentShift);
                    const disabledState = getButtonDisabledState(buttonType, currentShift);
                    
                    button.style.cssText = displayStyle;
                    button.disabled = disabledState === 'disabled';
                    
                    const isVisible = displayStyle.includes('display: flex');
                    const isDisabled = button.disabled;
                    const statusText = isVisible ? (isDisabled ? '‚úÖ Hi·ªÉn th·ªã (Disabled)' : '‚úÖ Hi·ªÉn th·ªã') : '‚ùå ·∫®n';
                    
                    log.innerHTML += `<div>${buttonId} (${buttonType}): ${statusText}</div>`;
                    
                    console.log(`üîÑ Updated ${buttonId}:`, {
                        buttonType,
                        displayStyle,
                        disabledState,
                        visible: isVisible,
                        disabled: isDisabled,
                        shiftStatus: currentShift?.status || 'no shift'
                    });
                } else {
                    console.warn(`‚ö†Ô∏è Button not found: ${buttonId}`);
                }
            });
        }
        
        function updateOrderStatus() {
            const status = document.getElementById('orderStatus').value;
            const startTime = document.getElementById('startTime').value.trim();
            const endTime = document.getElementById('endTime').value.trim();
            const shiftStatus = document.getElementById('shiftStatus').value;
            
            const order = {
                status: status,
                start_time: startTime || null,
                end_time: endTime || null
            };
            
            const currentShift = shiftStatus ? { status: shiftStatus } : null;
            
            console.log('üìã Current order:', order);
            console.log('üìã Current shift:', currentShift);
            
            // C·∫≠p nh·∫≠t button visibility
            updateButtonVisibility(order, currentShift);
        }
        
        // Auto test khi load trang
        window.onload = function() {
            console.log('üöÄ Test page loaded');
            updateOrderStatus();
        };
    </script>
</body>
</html>
